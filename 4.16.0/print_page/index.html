
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://smallrye.io/smallrye-reactive-messaging/4.16.0/print_page/">
      
      
      
      
      <link rel="icon" href="../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.8">
    
    
      
        <title>Print Site - SmallRye Reactive Messaging</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4b4a2bd9.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Red+Hat+Text:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Red Hat Text";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../css/smallrye.css">
    
    <script>__md_scope=new URL("/smallrye-reactive-messaging/4.16.0",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="SmallRye Reactive Messaging" class="md-header__button md-logo" aria-label="SmallRye Reactive Messaging" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SmallRye Reactive Messaging
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Print Site
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/smallrye/smallrye-reactive-messaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="SmallRye Reactive Messaging" class="md-nav__button md-logo" aria-label="SmallRye Reactive Messaging" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    SmallRye Reactive Messaging
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/smallrye/smallrye-reactive-messaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/emitter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Emitters and Channel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connectors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/contributing-connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing Connectors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/acknowledgement/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acknowledgement
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/blocking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blocking Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/signatures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method Signatures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/skipping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skipping Messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/converters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Message Converters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/keyed-multi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Keyed Streams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/decorators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Channel Decorators and Interceptors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/broadcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/merge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Merge channels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/incoming-concurrency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Incoming Channel Concurrency
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/incomings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    @Incomings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/outgoings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    @Outgoings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/advanced-config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/message-context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Message Context
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/incoming-metadata-injection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata Injection
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Kafka
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Kafka
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/kafka/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Kafka Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/receiving-kafka-records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/writing-kafka-records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writing records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/avro-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Avro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/protobuf-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Protobuf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/consumer-rebalance-listener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rebalance Listeners
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/kerberos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos authentication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/client-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing the client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/default-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customizing Default Kafka Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/test-companion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Companion for Kafka
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/transactions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Transactions and Exactly-Once Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/request-reply/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Request/Reply
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AMQP 1.0
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            AMQP 1.0
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/amqp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMQP 1.0 Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/receiving-amqp-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/sending-amqp-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../amqp/rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using RabbitMQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    RabbitMQ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            RabbitMQ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RabbitMQ Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/receiving-messages-from-rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/sending-messages-to-rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/rabbitmq-health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/rabbitmq-client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../rabbitmq/rabbitmq-cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connecting to managed instances
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Pulsar
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Pulsar
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/pulsar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Pulsar Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/receiving-pulsar-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/sending-messages-to-pulsar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/schema-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring the Schema
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/client-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring the Pulsar client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/client-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing the client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../pulsar/transactions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pulsar Transactions and Exactly-Once Processing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Apache Camel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Apache Camel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../camel/camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Camel Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../camel/receiving-messages-from-camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages from Camel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../camel/sending-messages-to-camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages to Camel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../camel/camel-processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Implementing Camel processor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../camel/using-existing-routes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using existing Camel routes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    JMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            JMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../jms/jms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The JMS connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../jms/receiving-jms-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving JMS messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../jms/sending-jms-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending JMS messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../jms/advanced-jms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    MQTT
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            MQTT
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../mqtt/mqtt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MQTT Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../mqtt/receiving-mqtt-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving MQTT messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../mqtt/sending-messages-to-mqtt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending MQTT messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../mqtt/client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customizing the MQTT client
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    1. Home
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-core" class="md-nav__link">
    I. Core
  </a>
  
    <nav class="md-nav" aria-label="I. Core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-started" class="md-nav__link">
    2. Getting Started
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-kafka" class="md-nav__link">
    II. Kafka
  </a>
  
    <nav class="md-nav" aria-label="II. Kafka">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kafka-kafka" class="md-nav__link">
    3. Apache Kafka Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-receiving-kafka-records" class="md-nav__link">
    4. Receiving records
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-writing-kafka-records" class="md-nav__link">
    5. Writing records
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-health" class="md-nav__link">
    6. Health Checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-avro-configuration" class="md-nav__link">
    7. Using Avro
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-protobuf-configuration" class="md-nav__link">
    8. Using Protobuf
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-consumer-rebalance-listener" class="md-nav__link">
    9. Rebalance Listeners
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-kerberos" class="md-nav__link">
    10. Kerberos authentication
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-client-service" class="md-nav__link">
    11. Accessing the client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-default-configuration" class="md-nav__link">
    12. Customizing Default Kafka Configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-test-companion" class="md-nav__link">
    13. Test Companion for Kafka
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-transactions" class="md-nav__link">
    14. Kafka Transactions and Exactly-Once Processing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kafka-request-reply" class="md-nav__link">
    15. Kafka Request/Reply
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-amqp-1-0" class="md-nav__link">
    III. AMQP 1.0
  </a>
  
    <nav class="md-nav" aria-label="III. AMQP 1.0">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#amqp-amqp" class="md-nav__link">
    16. AMQP 1.0 Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amqp-receiving-amqp-messages" class="md-nav__link">
    17. Receiving messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amqp-sending-amqp-messages" class="md-nav__link">
    18. Sending messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amqp-health" class="md-nav__link">
    19. Health Checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amqp-client-customization" class="md-nav__link">
    20. Client Customization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#amqp-rabbitmq" class="md-nav__link">
    21. Using RabbitMQ
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-rabbitmq" class="md-nav__link">
    IV. RabbitMQ
  </a>
  
    <nav class="md-nav" aria-label="IV. RabbitMQ">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rabbitmq-rabbitmq" class="md-nav__link">
    22. RabbitMQ Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-receiving-messages-from-rabbitmq" class="md-nav__link">
    23. Receiving messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-sending-messages-to-rabbitmq" class="md-nav__link">
    24. Sending messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-rabbitmq-health" class="md-nav__link">
    25. Health Checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-rabbitmq-client-customization" class="md-nav__link">
    26. Client Customization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-rabbitmq-cloud" class="md-nav__link">
    27. Connecting to managed instances
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-pulsar" class="md-nav__link">
    V. Pulsar
  </a>
  
    <nav class="md-nav" aria-label="V. Pulsar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pulsar-pulsar" class="md-nav__link">
    28. Apache Pulsar Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-receiving-pulsar-messages" class="md-nav__link">
    29. Receiving messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-sending-messages-to-pulsar" class="md-nav__link">
    30. Sending messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-schema-configuration" class="md-nav__link">
    31. Configuring the Schema
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-client-configuration" class="md-nav__link">
    32. Configuring the Pulsar client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-health" class="md-nav__link">
    33. Health Checks
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-client-service" class="md-nav__link">
    34. Accessing the client
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pulsar-transactions" class="md-nav__link">
    35. Pulsar Transactions and Exactly-Once Processing
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-apache-camel" class="md-nav__link">
    VI. Apache Camel
  </a>
  
    <nav class="md-nav" aria-label="VI. Apache Camel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#camel-camel" class="md-nav__link">
    36. Apache Camel Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#camel-receiving-messages-from-camel" class="md-nav__link">
    37. Receiving messages from Camel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#camel-sending-messages-to-camel" class="md-nav__link">
    38. Sending messages to Camel
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#camel-camel-processor" class="md-nav__link">
    39. Implementing Camel processor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#camel-using-existing-routes" class="md-nav__link">
    40. Using existing Camel routes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-jms" class="md-nav__link">
    VII. JMS
  </a>
  
    <nav class="md-nav" aria-label="VII. JMS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#jms-jms" class="md-nav__link">
    41. The JMS connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jms-receiving-jms-messages" class="md-nav__link">
    42. Receiving JMS messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jms-sending-jms-messages" class="md-nav__link">
    43. Sending JMS messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jms-advanced-jms" class="md-nav__link">
    44. Advanced configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-mqtt" class="md-nav__link">
    VIII. MQTT
  </a>
  
    <nav class="md-nav" aria-label="VIII. MQTT">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mqtt-mqtt" class="md-nav__link">
    45. MQTT Connector
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mqtt-receiving-mqtt-messages" class="md-nav__link">
    46. Receiving MQTT messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mqtt-sending-messages-to-mqtt" class="md-nav__link">
    47. Sending MQTT messages
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mqtt-client-customization" class="md-nav__link">
    48. Customizing the MQTT client
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-smallrye-reactive-messaging">SmallRye Reactive Messaging</h1>
<p><strong>SmallRye Reactive Messaging is a framework for building event-driven, data streaming, and event-sourcing applications.</strong></p>
<p>It lets your application interact using various messaging technologies such as Apache Kafka, AMQP or MQTT.
The framework provides a flexible programming model bridging <a href="https://www.cdi-spec.org/">CDI</a> and event-driven.</p>
<p>SmallRye Reactive Messaging is an implementation of the Eclipse MicroProfile Reactive Messaging specification 3.0.</p>
<figure class="docissimo, docissimo-figure">
              <img src="../images/overview.png" style="margin-left:auto; margin-right:auto;" alt="Event-Driven Architectures">
              <figcaption style="margin-left:auto; margin-right:auto;">Event-Driven Architectures</figcaption>
            </figure>

<p>SmallRye Reactive Messaging is used in <a href="http://quarkus.io">Quarkus</a>, and <a href="https://openliberty.io/">Open Liberty</a>.</p>
<p>Start with the <a href="#getting-started">Getting Started</a> guide to know how it can be used and introduce various features.</p></section>
                        <h1 class='nav-section-title' id='section-core'>
                            Core <a class='headerlink' href='#section-core' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="getting-started"><h1 id="getting-started-getting-started">Getting Started</h1>
<p>The easiest way to start using SmallRye Reactive Messaging is from <a href="https://quarkus.io">Quarkus</a>.
SmallRye Reactive Messaging can also be used standalone, or with <a href="https://openliberty.io/guides/microprofile-reactive-messaging.html">Open Liberty</a>.</p>
<p>First, go to <a href="https://code.quarkus.io/?g=io.smallrye&amp;a=getting-started-with-reactive-messaging&amp;e=smallrye-reactive-messaging">code.quarkus.io</a>.
Select the <code>smallrye-reactive-messaging</code> extension (already done if you use the link), and then click on the generate button to download the code.</p>
<p>One downloaded, unzip the project and import it in your IDE.</p>
<p>If you look at the <code>pom.xml</code> file, you will see the following dependency:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#getting-started-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#getting-started-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#getting-started-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#getting-started-__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="w"> </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.quarkus<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>quarkus-smallrye-reactive-messaging<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>It provides the support for SmallRye Reactive Messaging.</p>
<p>Ok, so far so good, but we need event-driven <em>beans</em>.</p>
<p>Create the <code>quickstart</code> package, and copy the following class into it:</p>
<p>For instance:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#getting-started-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#getting-started-__codelineno-1-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">quickstart</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ReactiveMessagingExample</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">source</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">items</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;from&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SmallRye&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reactive&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;messaging&quot;</span><span class="p">);</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed-a&quot;</span><span class="p">)</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">toUpperCase</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;processed-a&quot;</span><span class="p">)</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed-b&quot;</span><span class="p">)</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">select</span><span class="p">().</span><span class="na">where</span><span class="p">(</span><span class="n">item</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">item</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;processed-b&quot;</span><span class="p">)</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sink</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">word</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;&gt;&gt; &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">word</span><span class="p">);</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This class contains a set of methods:</p>
<ul>
<li>producing messages (<code>source</code>)</li>
<li>processing messages (<code>toUpperCase</code>)</li>
<li>transforming the stream by skipping messages (<code>filter</code>)</li>
<li>consuming messages (<code>sink</code>)</li>
</ul>
<p>Each of these methods are connected through <em>channels</em>.</p>
<p>Now, let's see this in action.
For the terminal, run:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#getting-started-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>&gt;<span class="w"> </span>./mvnw<span class="w"> </span>quarkus:dev
</code></pre></div></td></tr></table></div>
<p>Running the previous example should give the following output:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#getting-started-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#getting-started-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#getting-started-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#getting-started-__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>&gt;&gt; HELLO
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>&gt;&gt; SMALLRYE
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>&gt;&gt; REACTIVE
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>&gt;&gt; MESSAGE
</code></pre></div></td></tr></table></div>
<p>Of course, this is a very simple example.
To go further, let's have a look to the core <a href="#concepts-concepts">concepts</a> behind SmallRye Reactive Messaging.</p></section>
                        <h2 class='nav-section-title' id='section-concepts'>
                            Concepts <a class='headerlink' href='#section-concepts' title='Permanent link'>â†µ</a>
                        </h2>
                        <section class="print-page" id="concepts-concepts"><h1 id="concepts-concepts-concepts">Concepts</h1>
<p>When dealing with event-driven or data streaming applications, there are
a few concepts and vocabulary to introduce.</p>
<h2 id="concepts-concepts-messages-payload-metadata">Messages, Payload, Metadata</h2>
<p>A <code>Message</code> is an <em>envelope</em> around a <code>payload</code>. Your application is
going to receive, process, and send <code>Messages</code>.</p>
<p>Your applicationâ€™s logic can generate these <code>Messages</code> or receive them
from a message broker. They can also be consumed by your application or
sent to a message broker.</p>
<figure class="docissimo, docissimo-figure">
              <img src="../images/messages.png" style="margin-left:auto; margin-right:auto;" alt="An application can receive a message, process it and send a resulting message">
              <figcaption style="margin-left:auto; margin-right:auto;">An application can receive a message, process it and send a resulting message</figcaption>
            </figure>

<p>In Reactive Messaging, <code>Message</code> are represented by the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/eclipse/microprofile/reactive/messaging/Message.html'>Message</a> interface.
Each <code>Message&lt;T&gt;</code> contains a <em>payload</em> of type <code>&lt;T&gt;</code>. This payload can be retrieved using <code>message.getPayload()</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-concepts-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-concepts-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>As you can see in the previous snippet, <code>Messages</code> can also have
<em>metadata</em>. <em>Metadata</em> is a way to extend messages with additional data.
It can be metadata related to the message broker
(like <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/kafka/api/KafkaMessageMetadata.html'>KafkaMessageMetadata</a>), or contain operational data (such as tracing metadata), or business-related data.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When retrieving metadata, you get an <code>Optional</code> as it may not be  present.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Metadata is also used to influence the outbound dispatching (how the  message will be sent to the broker).</p>
</div>
<h2 id="concepts-concepts-channels-and-streams">Channels and Streams</h2>
<p>Inside your application, <code>Messages</code> transit on <em>channel</em>. A <em>channel</em> is
a virtual destination identified by a name.</p>
<figure class="docissimo, docissimo-figure">
              <img src="../images/channels.png" style="margin-left:auto; margin-right:auto;" alt="The application is a set of channels">
              <figcaption style="margin-left:auto; margin-right:auto;">The application is a set of channels</figcaption>
            </figure>

<p>SmallRye Reactive Messaging connects the component to the channel they read and to the channel they populate.
The resulting structure is a  stream: Messages flow between components through channels.</p>
<div class="admonition note">
<p class="admonition-title">What about Reactive Streams?</p>
<p>You may wonder why <em>Reactive Messaging</em> has <em>Reactive</em> in the name. The
Messaging part is kind of obvious. The Reactive part comes from the
streams that are created by binding components. These streams are
<a href="https://www.reactive-streams.org/">Reactive Streams</a>. They follow the
subscription and request protocol and implement back-pressure. It also
means that <a href="#concepts-concepts-connectors">Connectors</a> are intended to use non-blocking IO
to interact with the various message brokers.</p>
</div>
<h2 id="concepts-concepts-connectors">Connectors</h2>
<p>Your application is interacting with messaging brokers or event backbone  using <em>connectors</em>.
A <em>connector</em> is a piece of code that connects to a broker and:</p>
<ol>
<li>
<p>subscribe/poll/receive messages from the broker and propagate them to the application</p>
</li>
<li>
<p>send/write/dispatch messages provided by the application to the broker</p>
</li>
</ol>
<p>Connectors are configured to map incoming messages to a specific
<em>channel</em> (consumed by the application) and collect outgoing messages
sent to a specific channel. These collected messages are sent to the
external broker.</p>
<figure class="docissimo, docissimo-figure">
              <img src="../images/connectors.png" style="margin-left:auto; margin-right:auto;" alt="Connectors manages the communication between the application and the brokers">
              <figcaption style="margin-left:auto; margin-right:auto;">Connectors manages the communication between the application and the brokers</figcaption>
            </figure>

<p>Each connector is dedicated to a specific technology.
For example, a  Kafka Connector only deals with Kafka.</p>
<p>You donâ€™t necessarily need a connector.
When your application does not  use connectors, everything happens <em>in-memory</em>, and the streams are created by chaining methods altogether.
Each chain is still a reactive  stream and enforces the back-pressure protocol.
When you donâ€™t use  connectors, you need to make sure the chain is complete, meaning it  starts with a message source, and it ends with a sink.
In other words,  you need to generate messages from within the application (using a method with only <code>@Outgoing</code>, or an <code>Emitter</code>) and consume the messages
from within the application (using a method with only <code>@Incoming</code> or using an unmanaged stream).</p></section><section class="print-page" id="concepts-model"><h1 id="concepts-model-development-model">Development Model</h1>
<p>Reactive Messaging proposes a CDI-based programming model to implement event-driven applications.
Following the CDI principles, <em>beans</em> are forming the main building block of your application.
Reactive Messaging provides a set of annotations and types to implement beans that generate, consume or process messages.</p>
<h2 id="concepts-model-incoming-and-outgoing">@Incoming and @Outgoing</h2>
<p>Reactive Messaging provides two main annotations:</p>
<ul>
<li><a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Incoming.html'>org.eclipse.microprofile.reactive.messaging.Incoming</a> - indicates the consumed channel</li>
<li><a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Outgoing.html'>org.eclipse.microprofile.reactive.messaging.Outgoing</a> - indicates the populated channel</li>
</ul>
<p>These annotations are used on <em>methods</em>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-0-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">beans</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MessageProcessingBean</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;consumed-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;populated-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="c1">// Process the payload</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="c1">// Create a new message from `in` and just update the payload</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<p>Reactive Messaging beans can either be in the <em>application</em> scope (<code>@ApplicationScoped</code>) or dependent scope (<code>@Dependent</code>).</p>
<p>Manipulating messages can be cumbersome.
When you are only interested in the payload, you can use the following syntax: The following code is equivalent to the snippet from above:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">beans</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PayloadProcessingBean</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;consumed-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;populated-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
</div>
<p>You should not call methods annotated with <code>@Incoming</code> and/or
<code>@Outgoing</code> directly from your code. They are invoked by the framework.
Having user code invoking them would not have the expected outcome.</p>
<p>SmallRye Reactive Messaging automatically binds matching <code>@Outgoing</code> to
<code>@Incoming</code> to form a chain:</p>
<figure class="docissimo, docissimo-figure">
              <img src="../images/chain.png" style="margin-left:auto; margin-right:auto;" alt="A chain of components">
              <figcaption style="margin-left:auto; margin-right:auto;">A chain of components</figcaption>
            </figure>

<p>If we consider the following code:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-2-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">items</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;from&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reactive&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;messaging&quot;</span><span class="p">);</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="p">}</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="p">}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">processed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">processed</span><span class="p">);</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It would generate the following chain:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a>generate --&gt; [ source ] --&gt; process --&gt; [ sink ] --&gt; consume
</code></pre></div></td></tr></table></div>
<p>Methods annotated with <code>@Incoming</code> or <code>@Outgoing</code> donâ€™t have to be in the same <em>bean</em> (<em>class</em>).
You can distribute them among a set of beans.
Remote interactions are also possible when using connectors.</p>
<p>Methods annotated with:</p>
<ul>
<li>only <code>@Outgoing</code> are used to generate messages or payloads</li>
<li>only <code>@Incoming</code> are used to consume messages or payloads</li>
<li>both <code>@Incoming</code> and <code>@Outgoing</code> are used to process messages or payloads; or transform the stream</li>
</ul>
<h2 id="concepts-model-creating-messages">Creating messages</h2>
<p>Messages are envelopes around payload.
They are the vehicle.
While manipulating payload is convenient, messages let you add metadata, handle acknowledgement...</p>
<p>Creating <code>Messages</code> is done using the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/eclipse/microprofile/reactive/messaging/Message.html'>Message</a> interface directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-4-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Create a simple message wrapping a payload</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">price</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="c1">// Create a message with metadata</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PriceMetadata</span><span class="p">()));</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c1">// Create a message with several metadata</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">price</span><span class="p">,</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PriceMetadata</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyMetadata</span><span class="p">()));</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="c1">// Create a message with an acknowledgement callback</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">price</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="c1">// Called when the message is acknowledged by the next consumer.</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="p">});</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="c1">// Create a message with both metadata and acknowledgement callback</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">price</span><span class="p">,</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">        </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PriceMetadata</span><span class="p">()),</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">        </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">            </span><span class="c1">// Called when the message is acknowledged by the next consumer.</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>Messages accept <code>null</code> as payload.
Channels connected to outbound connectors interpret messages with <code>null</code> payload differently depending on the technology.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">// Create a message with null payload</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PriceMetadata</span><span class="p">()));</span>
</code></pre></div></td></tr></table></div></p>
<p>You can also create new instance of <code>Message</code> from an existing one:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-15">15</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-16">16</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-6-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">// Create a new message with a new payload but with the same metadata</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Price</span><span class="p">(</span><span class="mf">12.4</span><span class="p">));</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="c1">// Create a new message with a new payload and add another metadata</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">        </span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Price</span><span class="p">(</span><span class="mf">15.0</span><span class="p">))</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">        </span><span class="p">.</span><span class="na">withMetadata</span><span class="p">(</span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">PriceMetadata</span><span class="p">()));</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="c1">// Create a new message with a new payload and a custom acknowledgement</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">        </span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Price</span><span class="p">(</span><span class="mf">15.0</span><span class="p">))</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">        </span><span class="p">.</span><span class="na">withAck</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">        </span><span class="c1">// acknowledge the incoming message</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">        </span><span class="n">message</span><span class="p">.</span><span class="na">ack</span><span class="p">()</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">                </span><span class="p">.</span><span class="na">thenAccept</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">                    </span><span class="c1">// do something</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">                </span><span class="p">}));</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Acknowledgement?</p>
</div>
<p>Acknowledgement is an important part of messaging systems. This will be
covered in the <a href="#concepts-acknowledgement">acknowledgement</a>
section.</p>
<div class="admonition note">
<p class="admonition-title">Connector Metadata</p>
</div>
<p>Most connectors are providing metadata to let you extract technical
details about the message, but also customize the outbound dispatching.</p>
<h2 id="concepts-model-generating-messages">Generating Messages</h2>
<p>To produce messages to a channel, you need to use the <code>@Outgoing</code>
annotation. This annotation takes a single parameter: the name of the
populated channel.</p>
<h3 id="concepts-model-generating-messages-synchronously">Generating messages synchronously</h3>
<p>You can generate messages synchronously. In this case, the method is
called for every <em>request</em> from the downstream:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-7-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generateMessagesSynchronously</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">());</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Requests?</p>
</div>
<p>Reactive Messaging connects components to build a reactive stream.
In a  reactive stream, the emissions are controlled by the consumer
(downstream) indicating to the publisher (upstream) how many items it
can consume. With this protocol, the consumers are never flooded.</p>
<h3 id="concepts-model-generating-messages-using-completionstage">Generating messages using CompletionStage</h3>
<p>You can also return a <code>CompletionStage</code> / <code>CompletableFuture</code>.
In this  case, Reactive Messaging waits until the <code>CompletionStage</code> gets  completed before calling it again.</p>
<p>For instance, this signature is useful to poll messages from a source  using an asynchronous client:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-8-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generateMessagesAsCompletionStage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">asyncClient</span><span class="p">.</span><span class="na">poll</span><span class="p">()</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">            </span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">Message</span><span class="p">::</span><span class="n">of</span><span class="p">);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-model-generating-messages-using-uni">Generating messages using Uni</h3>
<p>You can also return a <a href="https://smallrye.io/smallrye-mutiny/#_uni_and_multi">Uni</a> instance.
In  this case, Reactive Messaging waits until the <code>Uni</code> emits its item  before calling it again.</p>
<p>This signature is useful when integrating asynchronous clients providing  a Mutiny API.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-9-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generateMessagesAsync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">counter</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">()));</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-model-generating-reactive-streams-of-messages">Generating Reactive Streams of messages</h3>
<p>Instead of producing the message one by one, you can return the stream
directly. If you have a data source producing Reactive Streams
<code>Publisher</code> (or sub-types, such as <code>Multi</code>), this is the signature you are looking for:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Publisher</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generateMessageStream</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">multi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactiveClient</span><span class="p">.</span><span class="na">getStream</span><span class="p">();</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">multi</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Message</span><span class="p">::</span><span class="n">of</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this case, the method is called once to retrieve the <code>Publisher</code>.</p>
<h2 id="concepts-model-generating-payloads">Generating Payloads</h2>
<p>Instead of <code>Message</code>, you can produce <em>payloads</em>. In this case, Reactive
Messaging produces a simple message from the <em>payload</em> using
<code>Message.of</code>.</p>
<h3 id="concepts-model-generating-payload-synchronously">Generating payload synchronously</h3>
<p>You can produce <em>payloads</em> synchronously. The framework calls the method
upon request and create <code>Messages</code> around the produced payloads.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-11-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-11-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="nf">generatePayloadsSynchronously</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">();</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-model-generating-payload-using-completionstage">Generating payload using CompletionStage</h3>
<p>You can also return <code>CompletionStage</code> or <code>CompletableFuture</code>. For
example, if you have an asynchronous client returning <code>CompletionStage</code>,
you can use it as follows, to poll the data one by one:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-12-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-12-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-12-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generatePayloadsAsCompletionStage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">asyncClient</span><span class="p">.</span><span class="na">poll</span><span class="p">();</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-model-generating-payload-by-producing-unis">Generating payload by producing Unis</h3>
<p>You can also return a <code>Uni</code> if you have a client using Mutiny types:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-13-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-13-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-13-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-13-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generatePayloadsAsync</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">counter</span><span class="p">.</span><span class="na">getAndIncrement</span><span class="p">());</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-model-generating-reactive-streams-of-payloads">Generating Reactive Streams of payloads</h3>
<p>Finally, you can return a <code>Publisher</code> (or a sub-type such as a <code>Multi</code>):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-14-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-14-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-14-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-14-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-14-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generatePayloadsStream</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">multi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reactiveClient</span><span class="p">.</span><span class="na">getStream</span><span class="p">();</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">multi</span><span class="p">;</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this case, Reactive Messaging calls the method only once to retrieve
the <code>Publisher</code>.</p>
<h2 id="concepts-model-consuming-messages">Consuming Messages</h2>
<p>To consume messages from a channel, you need to use the <code>@Incoming</code>
annotation. This annotation takes a single parameter: the name of the
consumed channel.</p>
<p>Because <code>Messages</code> must be acknowledged, consuming messages requires
returning <em>asynchronous results</em> that would complete when the incoming
message get acknowledged.</p>
<p>For example, you can receive the <code>Message</code>, process it and return the
acknowledgement as result:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-15-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-15-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-15-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-15-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-15-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-15-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumeMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="n">handle</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">());</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="p">}</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="err">&#39;</span>
</code></pre></div></td></tr></table></div>
<p>You can also return a <code>Uni</code> if you need to implement more complicated
processing:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-16-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-16-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-16-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-16-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-16-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-16-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumeMessageUni</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handle</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()))</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">ack</span><span class="p">()));</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="concepts-model-consuming-payloads">Consuming Payloads</h2>
<p>Unlike consuming messages, consuming payloads support both synchronous
and asynchronous consumption.</p>
<p>For example, you can consume a payload as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-17-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-17-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-17-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-17-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumePayload</span><span class="p">(</span><span class="n">Price</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="c1">// do something</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this case, you donâ€™t need to deal with the acknowledgement yourself.
The framework acknowledges the incoming message (that wrapped the
payload) once your method returns successfully.</p>
<p>If you need to achieve asynchronous actions, you can return a
<code>CompletionStage</code> or a <code>Uni</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-18-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-18-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-18-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-18-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-18-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumePayloadCS</span><span class="p">(</span><span class="n">Price</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">handleAsync</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cs</span><span class="p">;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-19-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-19-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-19-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-19-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-19-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-19-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumePayloadUni</span><span class="p">(</span><span class="n">Price</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="k">this</span><span class="p">::</span><span class="n">handle</span><span class="p">)</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">ignore</span><span class="p">().</span><span class="na">andContinueWithNull</span><span class="p">();</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In these 2 cases, the framework acknowledges the incoming message when
the returned construct gets <em>completed</em>.</p>
<h2 id="concepts-model-processing-messages">Processing Messages</h2>
<p>You can process <code>Message</code> both synchronously or asynchronously.
This  later case is useful when you need to execute an asynchronous action during your processing such as invoking a remote service.</p>
<p>Do process <code>Messages</code> synchronously uses:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-20-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-20-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-20-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-20-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-20-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()));</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This method transforms the <code>int</code> payload to a <code>String</code>, and wraps it
into a <code>Message</code>.</p>
<p>'''important "Using <code>Message.withX</code> methods"
You may be surprised by the usage of <code>Message.withX</code> methods. It allows
metadata propagation as the metadata would be copied from the incoming
message and so dispatched to the next method.</p>
<p>You can also process <code>Messages</code> asynchronously:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-21-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-21-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-21-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-21-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-21-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-21-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessageCS</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">());</span>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cs</span><span class="p">.</span><span class="na">thenApply</span><span class="p">(</span><span class="n">in</span><span class="p">::</span><span class="n">withPayload</span><span class="p">);</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or using Mutiny:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-22-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-22-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-22-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-22-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-22-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-22-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessageUni</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">in</span><span class="p">::</span><span class="n">withPayload</span><span class="p">);</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In general, you want to create the new <code>Message</code> from the incoming one.
It enables metadata propagation and post-acknowledgement. For this, use
the <code>withX</code> method from the <code>Message</code> class returning a new <code>Message</code>
instance but copy the <em>content</em> (metadata, ack/nack...).</p>
<h2 id="concepts-model-processing-payloads">Processing payloads</h2>
<p>If you donâ€™t need to manipulate the envelope, you can process payload
directly either synchronously or asynchronously:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-23-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-23-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-23-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-23-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-23-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">processPayload</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-24-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-24-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-24-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-24-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-24-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayloadCS</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-25-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-25-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-25-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-25-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-25-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayload</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
<a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">What about metadata?</p>
</div>
<p>With these methods, the metadata are automatically propagated.</p>
<h2 id="concepts-model-processing-streams">Processing streams</h2>
<p>The previous processing method were taking single <code>Message</code> or payload.
Sometimes you need more advanced manipulation. For this, SmallRye
Reactive Messaging lets you process the stream of <code>Message</code> or the
stream of payloads directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-26-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessageStream</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">                    </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">recoverWithItem</span><span class="p">(</span><span class="s">&quot;fallback&quot;</span><span class="p">)</span>
<a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">                    </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transform</span><span class="p">(</span><span class="n">message</span><span class="p">::</span><span class="n">withPayload</span><span class="p">))</span>
<a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">            </span><span class="p">.</span><span class="na">concatenate</span><span class="p">();</span>
<a id="__codelineno-26-9" name="__codelineno-26-9"></a>
<a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-model-__codelineno-27-1">1</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-2">2</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-3">3</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-4">4</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-5">5</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-6">6</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-7">7</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-8">8</a></span>
<span class="normal"><a href="#concepts-model-__codelineno-27-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayloadStream</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">payload</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">invokeService</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">                    </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">recoverWithItem</span><span class="p">(</span><span class="s">&quot;fallback&quot;</span><span class="p">))</span>
<a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">            </span><span class="p">.</span><span class="na">concatenate</span><span class="p">();</span>
<a id="__codelineno-27-8" name="__codelineno-27-8"></a>
<a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can receive either a (Reactive Streams) <code>Publisher</code>, a
<code>PublisherBuilder</code> or (Mutiny) <code>Multi</code>. You can return any subclass of
<code>Publisher</code> or a <code>Publisher</code> directly.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
</div>
<p>These signatures do not support metadata propagation. In the case of a
stream of <code>Message</code>, you need to propagate the metadata manually. In the
case of a stream of payload, propagation is not supported, and incoming
metadata are lost.</p></section><section class="print-page" id="concepts-emitter"><h1 id="concepts-emitter-emitter-and-channels">Emitter and Channels</h1>
<p>It is not rare to combine in a single application imperative parts
(Jax-RS, regular CDI <em>beans</em>) and reactive parts (<em>beans</em> with
<code>@Incoming</code> and <code>@Outgoing</code> annotations). In these case, itâ€™s often
required to send <em>messages</em> from the imperative part to the reactive
part. In other words, send messages to channels handled by reactive
messaging and how can you retrieve messages.</p>
<h2 id="concepts-emitter-emitter-and-channel">Emitter and @Channel</h2>
<p>To send <em>things</em> (payload or <code>Message</code>) from imperative code to a
specific channel you need to use:</p>
<ol>
<li>the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Channel.html'>org.eclipse.microprofile.reactive.messaging.Channel</a> annotations</li>
<li>the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Emitter.html'>org.eclipse.microprofile.reactive.messaging.Emitter</a> type</li>
</ol>
<p>The <code>@Channel</code> lets you indicate to which channel you are going to send
your payloads or messages. The <code>Emitter</code> is the object to use to send
these payloads or messages.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-0-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Emitter</span><span class="p">;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyImperativeBean</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>Emitter</code> class takes a type parameter. Itâ€™s the type of payload.
Even if you want to send <code>Messages</code>, the type is the payload type.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You must have a <code>@Incoming("prices")</code> somewhere in your application
(meaning a method consuming messages transiting on the channel
<code>prices</code>), or an outbound connector configured to manage the <code>prices</code>
channel (<code>mp.messaging.outgoing.prices...</code>)</p>
</div>
<h2 id="concepts-emitter-sending-payloads">Sending payloads</h2>
<p>Sending payloads is done as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitterForPrices</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">emitterForPrices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When sending a payload, the emitter returns a <code>CompletionStage</code>. This
<code>CompletionStage</code> gets completed once the message created from the
payload is acknowledged:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAndAwaitAcknowledgement</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">acked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emitterForPrices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="c1">// sending a payload returns a CompletionStage completed</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="c1">// when the message is acknowledged</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="n">acked</span><span class="p">.</span><span class="na">toCompletableFuture</span><span class="p">().</span><span class="na">join</span><span class="p">();</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If the processing fails, the <code>CompletionStage</code> gets completed
exceptionally (with the reason of the nack).</p>
<h2 id="concepts-emitter-sending-messages">Sending messages</h2>
<p>You can also send <code>Messages</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-3-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAsMessage</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">emitterForPrices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When sending a <code>Message</code>, the emitter does not return a
<code>CompletionStage</code>, but you can pass the ack/nack callback, and be called
when the message is acked/nacked.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-4-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAsMessageWithAck</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="n">emitterForPrices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span><span class="c1">// Called when the message is acknowledged.</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="p">},</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">            </span><span class="n">reason</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">                </span><span class="c1">// Called when the message is acknowledged negatively.</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">            </span><span class="p">}));</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Sending messages also let you pass metadata.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-5-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAsMessageWithAckAndMetadata</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="n">MyMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyMetadata</span><span class="p">();</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="n">emitterForPrices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">metadata</span><span class="p">),</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">                </span><span class="c1">// Called when the message is acknowledged.</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">            </span><span class="p">},</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">            </span><span class="n">reason</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">                </span><span class="c1">// Called when the message is acknowledged negatively.</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">            </span><span class="p">}));</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Metadata can be used to propagate some context objects with the message.</p>
<h2 id="concepts-emitter-overflow-management">Overflow management</h2>
<p>When sending messages from imperative code to reactive code, you must be
aware of back-pressure. Indeed, messages sent using the emitter and
stored in a <em>queue</em>. If the consumer does not process the messages
quickly enough, this queue can become a memory hog and you may even run
out of memory.</p>
<p>To control what need to happen when the queue becomes out of control,
use the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/OnOverflow.html'>OnOverflow</a> annotation. <code>@OnOverflow</code> lets you configure:</p>
<ul>
<li>the maximum size of the queue (default is 256)</li>
<li>what needs to happen when this size is reached (fail, drop...)</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-15">15</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-16">16</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-17">17</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-18">18</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-19">19</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-20">20</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-21">21</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-22">22</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-6-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">// Set the max size to 10 and fail if reached</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@OnOverflow</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OnOverflow</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">BUFFER</span><span class="p">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="nd">@Inject</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;channel&quot;</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitterWithBuffer</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="c1">// [DANGER ZONE] no limit</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="nd">@OnOverflow</span><span class="p">(</span><span class="n">OnOverflow</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">UNBOUNDED_BUFFER</span><span class="p">)</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="nd">@Inject</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;channel&quot;</span><span class="p">)</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">danger</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="c1">// Drop the new messages if the size is reached</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="nd">@OnOverflow</span><span class="p">(</span><span class="n">OnOverflow</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">DROP</span><span class="p">)</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="nd">@Inject</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;channel&quot;</span><span class="p">)</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dropping</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="c1">// Drop the previously sent messages if the size is reached</span>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="nd">@OnOverflow</span><span class="p">(</span><span class="n">OnOverflow</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">LATEST</span><span class="p">)</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="nd">@Inject</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;channel&quot;</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dropOldMessages</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>The supported strategies are:</p>
<ul>
<li>
<p><code>OnOverflow.Strategy.BUFFER</code> - use a buffer to store the elements
    until they are consumed. If the buffer is full, a failure is
    propagated (and the thread using the emitted gets an exception)</p>
</li>
<li>
<p><code>OnOverflow.Strategy.UNBOUNDED_BUFFER</code> - use an unbounded buffer to
    store the elements</p>
</li>
<li>
<p><code>OnOverflow.Strategy.DROP</code> - drops the most recent value if the
    downstream canâ€™t keep up. It means that new value emitted by the
    emitter are ignored.</p>
</li>
<li>
<p><code>OnOverflow.Strategy.FAIL</code> - propagates a failure in case the
    downstream canâ€™t keep up.</p>
</li>
<li>
<p><code>OnOverflow.Strategy.LATEST</code> - keeps only the latest value, dropping
    any previous value if the downstream canâ€™t keep up.</p>
</li>
<li>
<p><code>OnOverflow.Strategy.NONE</code> - ignore the back-pressure signals
    letting the downstream consumer to implement a strategy.</p>
</li>
</ul>
<h3 id="concepts-emitter-defensive-emission">Defensive emission</h3>
<p>Having an emitter injected into your code does not guarantee that
someone is ready to consume the message. For example, a subscriber may
be connecting to a remote broker. If there are no subscribers, using the
<code>send</code> method will throw an exception.</p>
<p>The <code>emitter.hasRequests()</code> method indicates that a subscriber
subscribes to the channel and requested items. So, you can wrap your
emission with:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">emitter</span><span class="p">.</span><span class="na">hasRequests</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If you use the <code>OnOverflow.Strategy.DROP</code>, you can use the <code>send</code> method
even with no subscribers nor demands. The message will be nacked
immediately.</p>
<h2 id="concepts-emitter-retrieving-channels">Retrieving channels</h2>
<p>You can use the <code>@Channel</code> annotation to inject in your bean the
underlying stream. Note that in this case, you will be responsible for
the subscription:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-8-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">streamOfPayloads</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="nd">@Inject</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">streamOfMessages</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="nd">@Inject</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">publisherOfPayloads</span><span class="p">;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="nd">@Inject</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">publisherOfMessages</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You must have a <code>@Outgoing("my-channel")</code> somewhere in your application
(meaning a method generating messages transiting on the channel
<code>my-channel</code>), or an inbound connector configured to manage the <code>prices</code>
channel (<code>mp.messaging.incoming.prices...</code>)</p>
</div>
<p>Injected <em>channels</em> merge all the matching <em>outgoing</em> - so if you have
multiple <code>@Outgoing("out")</code>, <code>@Inject @Channel("out")</code> gets all the
messages.</p>
<p>If your injected <em>channel</em> receives <em>payloads</em> (<code>Multi&lt;T&gt;</code>), it
acknowledges the message automatically, and support multiple
subscribers. If you injected <em>channel</em> receives <code>Message</code>
(<code>Multi&lt;Message&lt;T&gt;&gt;</code>), you will be responsible for the acknowledgement
and broadcasting.</p>
<h2 id="concepts-emitter-emitter-and-broadcast">Emitter and @Broadcast</h2>
<p>When using an <code>Emitter</code>, you can now <code>@Broadcast</code> what is emitted to all
subscribers.</p>
<p>Here is an example of emitting a price with two methods marked
<code>@Incoming</code> to receive the broadcast:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-9-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nd">@Broadcast</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="p">}</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="c1">// Handle the new price</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="p">}</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">audit</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="c1">// Audit the price change</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>For more details see <a href="#concepts-broadcast">@Broadcast</a>
documentation.</p>
<h2 id="concepts-emitter-mutiny-emitter">Mutiny Emitter</h2>
<p>If you prefer to utilize <code>Uni</code> in all your code, there is now a
<code>MutinyEmitter</code> that will return <code>Uni&lt;Void&gt;</code> instead of <code>void</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-5">5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-6">6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">MutinyEmitter</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Thereâ€™s also the ability to block on sending the event to the emitter.
It will only return from the method when the event is acknowledged, or
nacked, by the receiver:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-11-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-11-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAwait</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="n">emitter</span><span class="p">.</span><span class="na">sendAndAwait</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>And if you donâ€™t need to worry about the success or failure of sending
an event, you can <code>sendAndForget</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-12-2">2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-12-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">Cancellable</span><span class="w"> </span><span class="nf">sendForget</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">d</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">emitter</span><span class="p">.</span><span class="na">sendAndForget</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="concepts-emitter-custom-emitter-implementations">Custom Emitter Implementations</h2>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Custom emitter implementations is an experimental feature.</p>
</div>
<p><code>Emitter</code> and <code>MutinyEmitter</code> are two implementations of the emitter concept,
where imperative code in your application can send messages to Reactive Messaging channels.</p>
<p>With <code>EmitterFactory</code> it is possible to provide custom implementations, and application facing emitter interfaces.</p>
<p>In the following example, the injectable custom emitter interface is <code>CustomEmitter</code>,
and it is implemented by <code>CustomEmitterImpl</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-17">17</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-18">18</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-19">19</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-20">20</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-21">21</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-22">22</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-23">23</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-13-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">CustomEmitter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">EmitterType</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">M</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAndForget</span><span class="p">(</span><span class="n">M</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="p">}</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomEmitterImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CustomEmitter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">MessagePublisherProvider</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">publisher</span><span class="p">;</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">CustomEmitterImpl</span><span class="p">(</span><span class="n">EmitterConfiguration</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">defaultBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">        </span><span class="c1">//... initialize emitter with configuration</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getPublisher</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">publisher</span><span class="p">;</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">M</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendAndForget</span><span class="p">(</span><span class="n">M</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">        </span><span class="c1">//... send to stream</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Note that <code>CustomEmitter</code> interface extends <code>EmitterType</code>, which is a marker interface for discovering custom emitter types.
Also, <code>CustomEmitterImpl</code> implements the <code>MessagePublisherProvider</code>, which is used by the framework to transform this emitter to a channel.</p>
<p>Then we need to provide an implementation of the <code>EmitterFactory</code> interface:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-11">11</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-12">12</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-13">13</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-14">14</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-15">15</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-16">16</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-14-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@EmitterFactoryFor</span><span class="p">(</span><span class="n">CustomEmitter</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomEmitterFactory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">EmitterFactory</span><span class="o">&lt;</span><span class="n">CustomEmitterImpl</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="n">ChannelRegistry</span><span class="w"> </span><span class="n">channelRegistry</span><span class="p">;</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CustomEmitterImpl</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createEmitter</span><span class="p">(</span><span class="n">EmitterConfiguration</span><span class="w"> </span><span class="n">configuration</span><span class="p">,</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">defaultBufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CustomEmitterImpl</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span><span class="w"> </span><span class="n">defaultBufferSize</span><span class="p">);</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Stream name is ignored during type-safe resolution</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">    </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">CustomEmitter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">produce</span><span class="p">(</span><span class="n">InjectionPoint</span><span class="w"> </span><span class="n">injectionPoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">channelName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ChannelProducer</span><span class="p">.</span><span class="na">getChannelName</span><span class="p">(</span><span class="n">injectionPoint</span><span class="p">);</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">channelRegistry</span><span class="p">.</span><span class="na">getEmitter</span><span class="p">(</span><span class="n">channelName</span><span class="p">,</span><span class="w"> </span><span class="n">CustomEmitter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>CustomEmitterFactory</code> is a CDI managed bean, which implements the <code>EmitterFactory</code>.
It is qualified with <code>EmitterFactoryFor</code> annotation which is configured with the emitter interface <code>CustomEmitter</code> that this factory provides.</p>
<p>Smallrye Reactive Messaging discovers the emitter factory during the CDI deployment validation
and verifies that custom emitters used by the application have corresponding emitter factories.
It'll use the emitter factory to create the emitter implementation and will register the implementation into the <code>ChannelRegistry</code>.</p>
<p>Note that the <code>CustomEmitterFactory</code> also uses the <code>ChannelRegistry</code> and provides the custom emitter with <code>@Produces</code>.</p>
<p>Finally, the application can inject and use the <code>CustomEmitter</code> as a normal emitter channel:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-emitter-__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-10">10</a></span>
<span class="normal"><a href="#concepts-emitter-__codelineno-15-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;custom-emitter-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="n">CustomEmitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">customEmitter</span><span class="p">;</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="c1">//...</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">emitMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="n">customEmitter</span><span class="p">.</span><span class="na">sendAndForget</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">));</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="n">customEmitter</span><span class="p">.</span><span class="na">sendAndForget</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">));</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="n">customEmitter</span><span class="p">.</span><span class="na">sendAndForget</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">));</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-connectors"><h1 id="concepts-connectors-connectors">Connectors</h1>
<p>Reactive Messaging can handle messages generated from within the
application but also interact with remote <em>brokers</em>. Reactive Messaging
Connectors interacts with these remote <em>brokers</em> to retrieve messages
and send messages using various protocols and technology.</p>
<p>Each connector handles to a specific technology. For example, a Kafka
Connector is responsible for interacting with Kafka, while an MQTT
Connector is responsible for MQTT interactions.</p>
<h2 id="concepts-connectors-connector-name">Connector name</h2>
<p>Each connector has a name. This name is referenced by the application to
indicate that this connector manages a specific channel.</p>
<p>For example, the SmallRye Kafka Connector is named: <code>smallrye-kafka</code>.</p>
<h2 id="concepts-connectors-inbound-and-outbound-connectors">Inbound and Outbound connectors</h2>
<p>Connector can:</p>
<ol>
<li>
<p>retrieve messages from a remote broker (inbound)</p>
</li>
<li>
<p>send messages to a remote broker (outbound)</p>
</li>
</ol>
<p>A connector can, of course, implement both directions.</p>
<p>Inbound connectors are responsible for:</p>
<ol>
<li>
<p>Getting messages from the remote broker,</p>
</li>
<li>
<p>Creating a Reactive Messaging <code>Message</code> associated with the
    retrieved message.</p>
</li>
<li>
<p>Potentially associating technical metadata with the message. It
    includes unmarshalling the payload.</p>
</li>
<li>
<p>Associating an acknowledgment callback to acknowledge the incoming
    message when the Reactive Messaging message is
    processed/acknowledged.</p>
</li>
</ol>
<div class="admonition important">
<p class="admonition-title">Reactive matters</p>
<p>The first step should follow the reactive streams principle: uses
non-blocking technology, respects downstream requests.</p>
</div>
<p>Outbound connectors are responsible for:</p>
<ol>
<li>
<p>Receiving Reactive Messaging <code>Message</code> and transform it into a
    structure understood by the remote broker. It includes marshaling
    the payload.</p>
</li>
<li>
<p>If the <code>Message</code> contains outbound metadata (metadata set during the
    processing to influence the outbound structure and routing), taking
    them into account.</p>
</li>
<li>
<p>Sending the message to the remote broker.</p>
</li>
<li>
<p>Acknowledging the Reactive Messaging <code>Message</code> when the broker has
    accepted/acknowledged the message.</p>
</li>
</ol>
<h2 id="concepts-connectors-configuring-connectors">Configuring connectors</h2>
<p>Applications need to configure the connector used by expressing which
channel is managed by which connector. Non-mapped channels are local /
in-memory.</p>
<p>To configure connectors, you need to have an implementation of
MicroProfile Config. If you donâ€™t have one, add an implementation of
MicroProfile Config in your <em>classpath</em>, such as:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-connectors-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.config<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-config<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>3.5.2<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Then edit the application configuration, generally
<code>src/main/resources/META-INF/microprofile-config.properties</code>.</p>
<p>The application configures the connector with a set of properties
structured as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.[incoming|outgoing].[channel-name].[attribute]=[value]
</code></pre></div></td></tr></table></div>
<p>For example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.dummy-incoming-channel.connector=dummy
mp.messaging.incoming.dummy-incoming-channel.attribute=value
mp.messaging.outgoing.dummy-outgoing-channel.connector=dummy
mp.messaging.outgoing.dummy-outgoing-channel.attribute=value
</code></pre></div></td></tr></table></div>
<p>You configure each channel (both incoming and outgoing) individually.</p>
<p>The <code>[incoming|outgoing]</code> segment indicates the direction.</p>
<ul>
<li>
<p>an <code>incoming</code> channel consumes data from a message broker or
    something producing data. Itâ€™s an inbound interaction. It relates to
    methods annotated with an <code>@Incoming</code> using the same channel name.</p>
</li>
<li>
<p>an <code>outgoing</code> consumes data from the application and forwards it to
    a message broker or something consuming data. Itâ€™s an outbound
    interaction. It relates to methods annotated with an <code>@Outgoing</code>
    using the same channel name.</p>
</li>
</ul>
<p>The <code>[channel-name]</code> is the name of the channel. If the channel name
contains a <code>.</code> (dot), you would need to use <code>"</code> (double-quote) around
it. For example, to configure the <code>dummy.incoming.channel</code> channel, you
would need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.&quot;dummy.incoming.channel&quot;.connector=dummy
mp.messaging.incoming.&quot;dummy.incoming.channel&quot;.attribute=value
</code></pre></div></td></tr></table></div>
<p>The <code>[attribute]=[value]</code> sets a specific connector attribute to the
given value. Attributes depend on the used connector. So, refer to the
connector documentation to check the supported attributes.</p>
<p>The <code>connector</code> attribute must be set for each mapped channel and
indicates the name of the connector responsible for the channel.</p>
<p>Here is an example of a channel using an MQTT connector, consuming data
from a MQTT broker, and a channel using a Kafka connector (writing data
to Kafka):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-connectors-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-connectors-__codelineno-1-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Configure the incoming health channel</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.health.topic</span><span class="o">=</span><span class="s">neo</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">mp.messaging.incoming.health.connector</span><span class="o">=</span><span class="s">smallrye-mqtt</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">mp.messaging.incoming.health.host</span><span class="o">=</span><span class="s">localhost</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.incoming.health.broadcast</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1"># Configure outgoing data channel</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="na">mp.messaging.outgoing.data.connector</span><span class="o">=</span><span class="s">smallrye-kafka</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="na">mp.messaging.outgoing.data.bootstrap.servers</span><span class="o">=</span><span class="s">localhost:9092</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="na">mp.messaging.outgoing.data.key.serializer</span><span class="o">=</span><span class="s">org.apache.kafka.common.serialization.StringSerializer</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="na">mp.messaging.outgoing.data.value.serializer</span><span class="o">=</span><span class="s">io.vertx.kafka.client.serialization.JsonObjectSerializer</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="na">mp.messaging.outgoing.data.acks</span><span class="o">=</span><span class="s">1</span>
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>To use a connector, you need to add it to your <em>CLASSPATH</em>. Generally,
adding the dependency to your project is enough. Then, you need to know
the connectorâ€™s name and set the <code>connector</code> attribute for each channel
managed by this connector.</p>
</div>
<h2 id="concepts-connectors-connector-attribute-table">Connector attribute table</h2>
<p>In the connector documentation, you will find a table listing the
attribute supported by the connector. Be aware that attributes for
inbound and outbound interactions may be different.</p>
<p>These tables contain the following entries:</p>
<ol>
<li>
<p>The name of the attribute, and potentially an <em>alias</em>. The name of
    the attribute is used with the
    <code>mp.messaging.[incoming|outgoing].[channel-name].[attribute]=[value]</code>
    syntax (the <code>attribute</code> segment). The <em>alias</em> (if set) is the name
    of a global MicroProfile Config property that avoids having to
    configure the attribute for each managed channel. For example, to
    set the location of your Kafka broker globally, you can use the
    <code>kafka.bootstrap.servers</code> alias.</p>
</li>
<li>
<p>The description of the attribute, including the type.</p>
</li>
<li>
<p>Whether that attribute is mandatory. If so, it fails the
    deployment if not set</p>
</li>
<li>
<p>The default value, if any.</p>
</li>
</ol></section><section class="print-page" id="concepts-contributing-connectors"><h1 id="concepts-contributing-connectors-connector-contribution-guide">Connector Contribution Guide</h1>
<p>A connector implementation is a CDI-managed bean, typically an <code>@ApplicationScoped</code> bean,
which is identified by the <code>@Connector</code> identifier.
In order to provide inbound and outbound channels, the connector implements two interfaces <code>InboundConnector</code> and <code>OutboundConnector</code> respectively.
In addition to that, the connector bean is annotated with <code>@ConnectorAttribute</code>, which describes attributes to configure channels.</p>
<div class="admonition abstract">
<p class="admonition-title">Maven Archetype</p>
<p>Smallrye Reactive Messaging provides a Maven archetype to bootstrap a new connector.
You can generate a new connector project with the code described in this guide using:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-8">8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>mvn<span class="w"> </span>-N<span class="w"> </span>archetype:generate<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>-DarchetypeGroupId<span class="o">=</span>io.smallrye.reactive<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>-DarchetypeArtifactId<span class="o">=</span>smallrye-reactive-messaging-connector-archetype<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>-DarchetypeVersion<span class="o">=</span><span class="m">4</span>.16.0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>-DgroupId<span class="o">=</span>io.smallrye.reactive<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>-Dpackage<span class="o">=</span>io.smallrye.reactive.messaging.my<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>-Dversion<span class="o">=</span><span class="m">4</span>.16.0<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>-DartifactId<span class="o">=</span>smallrye-reactive-messaging-my<span class="w"> </span><span class="se">\</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>-DconnectorName<span class="o">=</span>my
</code></pre></div></td></tr></table></div></p>
</div>
<p>The following is an example of a connector skeleton :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-51">51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-52">52</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-53">53</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-54">54</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-55">55</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-56">56</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-57">57</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-58">58</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-59">59</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-60">60</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-61">61</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-62">62</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-63">63</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-64">64</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-65">65</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-66">66</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-67">67</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-68">68</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-69">69</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-70">70</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-71">71</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-72">72</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-73">73</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-74">74</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-1-75">75</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute.Direction.INCOMING</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute.Direction.INCOMING_AND_OUTGOING</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute.Direction.OUTGOING</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CopyOnWriteArrayList</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Flow</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.annotation.PostConstruct</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.config.Config</span><span class="p">;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.spi.Connector</span><span class="p">;</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.BrokerClient</span><span class="p">;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute</span><span class="p">;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.connector.InboundConnector</span><span class="p">;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.connector.OutboundConnector</span><span class="p">;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.connectors.ExecutionHolder</span><span class="p">;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="nd">@Connector</span><span class="p">(</span><span class="n">MyConnector</span><span class="p">.</span><span class="na">CONNECTOR_NAME</span><span class="p">)</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;client-id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;string&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCOMING_AND_OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The client id &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mandatory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;buffer-size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">INCOMING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The size buffer of incoming messages waiting to be processed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;128&quot;</span><span class="p">)</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;string&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The default topic to send the messages, defaults to channel name if not set&quot;</span><span class="p">)</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;maxPendingMessages&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;int&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;The maximum size of a queue holding pending messages&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1000&quot;</span><span class="p">)</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;waitForWriteCompletion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;boolean&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Whether the outgoing channel waits for the write completion&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">)</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConnector</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">InboundConnector</span><span class="p">,</span><span class="w"> </span><span class="n">OutboundConnector</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">CONNECTOR_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;smallrye-my-connector&quot;</span><span class="p">;</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">    </span><span class="n">ExecutionHolder</span><span class="w"> </span><span class="n">executionHolder</span><span class="p">;</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">    </span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">;</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MyIncomingChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">incomingChannels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MyOutgoingChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outgoingChannels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">    </span><span class="nd">@PostConstruct</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">vertx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">executionHolder</span><span class="p">.</span><span class="na">vertx</span><span class="p">();</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Publisher</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getPublisher</span><span class="p">(</span><span class="n">Config</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">        </span><span class="n">MyConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">ic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyConnectorIncomingConfiguration</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">channelName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ic</span><span class="p">.</span><span class="na">getChannel</span><span class="p">();</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">clientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ic</span><span class="p">.</span><span class="na">getClientId</span><span class="p">();</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ic</span><span class="p">.</span><span class="na">getBufferSize</span><span class="p">();</span>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">        </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BrokerClient</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
<a id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="w">        </span><span class="n">MyIncomingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyIncomingChannel</span><span class="p">(</span><span class="n">vertx</span><span class="p">,</span><span class="w"> </span><span class="n">ic</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">        </span><span class="n">incomingChannels</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">getStream</span><span class="p">();</span>
<a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-62" name="__codelineno-1-62"></a>
<a id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Subscriber</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getSubscriber</span><span class="p">(</span><span class="n">Config</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">        </span><span class="n">MyConnectorOutgoingConfiguration</span><span class="w"> </span><span class="n">oc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyConnectorOutgoingConfiguration</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">channelName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getChannel</span><span class="p">();</span>
<a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">clientId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getClientId</span><span class="p">();</span>
<a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">pendingMessages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getMaxPendingMessages</span><span class="p">();</span>
<a id="__codelineno-1-69" name="__codelineno-1-69"></a><span class="w">        </span><span class="c1">// ...</span>
<a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="w">        </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BrokerClient</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">clientId</span><span class="p">);</span>
<a id="__codelineno-1-71" name="__codelineno-1-71"></a><span class="w">        </span><span class="n">MyOutgoingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingChannel</span><span class="p">(</span><span class="n">vertx</span><span class="p">,</span><span class="w"> </span><span class="n">oc</span><span class="p">,</span><span class="w"> </span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="w">        </span><span class="n">outgoingChannels</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">channel</span><span class="p">.</span><span class="na">getSubscriber</span><span class="p">();</span>
<a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Note that the <code>getPublisher</code> and <code>getSubscriber</code> methods receive MicroProfile Config <code>Config</code> instance and wrap it with
<code>MyConnectorIncomingConfiguration</code> and <code>MyConnectorOutgoingConfiguration</code> objects.</p>
<p>These custom channel configuration types ease getting channel configuration, including the optional or default values.
They are generated by the <code>smallrye-connector-attribute-processor</code> annotation processor, and can be configured in project pom like the following:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-2-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="w">    </span><span class="nt">&lt;dependencies&gt;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">      </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>${project.groupId}<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-provider<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">        </span><span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">      </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">      </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">        </span><span class="nt">&lt;artifactId&gt;</span>smallrye-connector-attribute-processor<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">        </span><span class="nt">&lt;version&gt;</span>${project.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">      </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nt">&lt;/dependencies&gt;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nt">&lt;build&gt;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">      </span><span class="nt">&lt;plugins&gt;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="nt">&lt;plugin&gt;</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">          </span><span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">          </span><span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">          </span><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">            </span><span class="nt">&lt;generatedSourcesDirectory&gt;</span>${project.build.directory}/generated-sources/<span class="nt">&lt;/generatedSourcesDirectory&gt;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">            </span><span class="nt">&lt;annotationProcessors&gt;</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">              </span><span class="nt">&lt;annotationProcessor&gt;</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">                </span>io.smallrye.reactive.messaging.connector.ConnectorAttributeProcessor
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">              </span><span class="nt">&lt;/annotationProcessor&gt;</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">              </span><span class="nt">&lt;annotationProcessor&gt;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">                </span>org.jboss.logging.processor.apt.LoggingToolsProcessor
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">              </span><span class="nt">&lt;/annotationProcessor&gt;</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">            </span><span class="nt">&lt;/annotationProcessors&gt;</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">          </span><span class="nt">&lt;/configuration&gt;</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">        </span><span class="nt">&lt;/plugin&gt;</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">      </span><span class="nt">&lt;/plugins&gt;</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">    </span><span class="nt">&lt;/build&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The <code>smallrye-reactive-messaging-provider</code> is the minimum required dependency for a connector implementation.
You'll also note that the <code>LoggingToolsProcessor</code> annotation processor is also configured.
This enables generating internationalized log statements and exceptions.
Typically, you would create following interfaces in <code>i18n</code> sub-package: <code>[Connector]Exceptions</code>, <code>[Connector]Logging</code> and <code>[Connector]Messages</code>.
More information can be found in <a href="https://jboss-logging.github.io/jboss-logging-tools/">JBoss Logging Tools documentation</a>.</p>
<h2 id="concepts-contributing-connectors-implementing-inbound-channels">Implementing Inbound Channels</h2>
<p>The <code>InboundConnector</code> implementation returns, for a given channel configuration, a reactive stream of <code>Message</code>s.
The returned reactive stream is an instance of <code>Flow.Publisher</code> and typically can be implemented using Mutiny <code>Multi</code> type.</p>
<div class="admonition note">
<p class="admonition-title"><code>IncomingConnectorFactory</code></p>
<p>The inbound channels can also implement the <code>IncomingConnectorFactory</code> from the MicroProfile Reactive Messaging specification.
However, the <code>PublisherBuilder</code> type can be more challenging to work with and
Smallrye Reactive Messaging converts the provided stream to Mutiny types to do the wiring anyway.</p>
</div>
<p>The returned <code>Flow.Publisher</code> would allow controlling the flow of ingestion using backpressure.
It would be preferable to use pull-based APIs of the underlying messaging library to receive messages from the message broker.
You can refer to the <a href="https://smallrye.io/smallrye-mutiny/latest/guides/polling/"><code>Mutiny</code> "How to use polling?" guide</a>
to construct a <code>Multi</code> using Mutiny APIs, or implement the <code>Flow.Subscription</code> from scratch and wrap it in an <code>AbstractMulti</code>.</p>
<p>Here is an example channel implementation which constructs the reactive stream using the polling API:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-51">51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-52">52</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-53">53</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-54">54</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-55">55</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-56">56</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-3-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Flow</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.atomic.AtomicBoolean</span><span class="p">;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.BrokerClient</span><span class="p">;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.health.HealthReport</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.core.impl.VertxInternal</span><span class="p">;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Context</span><span class="p">;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyIncomingChannel</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Context</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">;</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="w"> </span><span class="n">failureHandler</span><span class="p">;</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="w"> </span><span class="n">closed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicBoolean</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Publisher</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyIncomingChannel</span><span class="p">(</span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span><span class="w"> </span><span class="n">MyConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">cfg</span><span class="p">,</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="c1">// create and configure the client with MyConnectorIncomingConfiguration</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cfg</span><span class="p">.</span><span class="na">getChannel</span><span class="p">();</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Context</span><span class="p">.</span><span class="na">newInstance</span><span class="p">(((</span><span class="n">VertxInternal</span><span class="p">)</span><span class="w"> </span><span class="n">vertx</span><span class="p">.</span><span class="na">getDelegate</span><span class="p">()).</span><span class="na">createEventLoopContext</span><span class="p">());</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ackHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="p">);</span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">failureHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="p">);</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createBy</span><span class="p">().</span><span class="na">repeating</span><span class="p">()</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">                </span><span class="p">.</span><span class="na">uni</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">poll</span><span class="p">()))</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">                </span><span class="p">.</span><span class="na">until</span><span class="p">(</span><span class="n">__</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">closed</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">                </span><span class="p">.</span><span class="na">emitOn</span><span class="p">(</span><span class="n">context</span><span class="p">::</span><span class="n">runOnContext</span><span class="p">)</span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">consumed</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyMessage</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">consumed</span><span class="p">,</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">,</span><span class="w"> </span><span class="n">failureHandler</span><span class="p">));</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a>
<a id="__codelineno-3-40" name="__codelineno-3-40"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getChannel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-41" name="__codelineno-3-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span>
<a id="__codelineno-3-42" name="__codelineno-3-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-43" name="__codelineno-3-43"></a>
<a id="__codelineno-3-44" name="__codelineno-3-44"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Publisher</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getStream</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-45" name="__codelineno-3-45"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">stream</span><span class="p">;</span>
<a id="__codelineno-3-46" name="__codelineno-3-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-47" name="__codelineno-3-47"></a>
<a id="__codelineno-3-48" name="__codelineno-3-48"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-49" name="__codelineno-3-49"></a><span class="w">        </span><span class="n">closed</span><span class="p">.</span><span class="na">compareAndSet</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-3-50" name="__codelineno-3-50"></a><span class="w">        </span><span class="n">client</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<a id="__codelineno-3-51" name="__codelineno-3-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-52" name="__codelineno-3-52"></a>
<a id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">isReady</span><span class="p">(</span><span class="n">HealthReport</span><span class="p">.</span><span class="na">HealthReportBuilder</span><span class="w"> </span><span class="n">healthReportBuilder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-54" name="__codelineno-3-54"></a>
<a id="__codelineno-3-55" name="__codelineno-3-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-56" name="__codelineno-3-56"></a>
<a id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="concepts-contributing-connectors-connector-threading-and-vertx">Connector Threading and Vert.x</h3>
<p>Whether the external API call is blocking or non-blocking, managing the thread on which the message processing will be dispatched can be challenging.
Smallrye Reactive Messaging depends on <a href="https://vertx.io/">Eclipse Vert.x</a> to consistently dispatch messages in event-loop or worker threads,
propagating the message context along different processing stages.
You can read more on <a href="#concepts-message-context">Message Context</a> and <a href="https://vertx.io/blog/an-introduction-to-the-vert-x-context-object/">Vert.x Context</a>.</p>
<p>Some connectors already use Vert.x clients, such as RabbitMQ, AMQP 1.0 or MQTT.
Other connectors such as Kafka or Pulsar directly use the client library of the messaging technology,
therefore they create a Vert.x Context per channel to dispatch messages on that context.
Connectors can access the <code>Vertx</code> instance by injecting the <code>ExecutionHolder</code> bean.
<a href="https://smallrye.io/smallrye-mutiny/latest/guides/emit-on-vs-run-subscription-on/">Mutiny operators <code>runSubscribtionOn</code> and <code>emitOn</code></a> can be used to switch threads the events are dispatched on.</p>
<h3 id="concepts-contributing-connectors-custom-message-and-metadata-implementations">Custom Message and Metadata implementations</h3>
<p>Reactive messaging <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Message.html'>Message</a>
type is a thin wrapper around a payload and some metadata, which lets implementing acknowledgment and negative acknowledgment of that message.</p>
<p>Messages received from the underlying library very often return with a custom type,
wrapping the payload and some properties such as key, timestamp, schema information, or any other metadata.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The client may propose different strategies for consuming messages individually or in batches.
If a batch consuming is available the incoming channel may receive wrap and dispatch message as a batch or individually.</p>
</div>
<p>While it is possible to use <code>Message.of</code> builder methods to wrap the incoming message type,
a custom type implementing <code>Message</code> interface helps to deal with different aspects we'll cover later,
such as deserialization, message acknowledgment or tracing.</p>
<p>An example message implementation would be like the following:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-4-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Metadata</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.ConsumedMessage</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.locals.ContextAwareMessage</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">ContextAwareMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">;</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="w"> </span><span class="n">nackHandler</span><span class="p">;</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ConsumedMessage</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">consumed</span><span class="p">;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyMessage</span><span class="p">(</span><span class="n">ConsumedMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">,</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="w"> </span><span class="n">nackHandler</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">consumed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">body</span><span class="p">();</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ackHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">;</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nackHandler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nackHandler</span><span class="p">;</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextAwareMessage</span><span class="p">.</span><span class="na">captureContextMetadata</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyIncomingMetadata</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ConsumedMessage</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">getConsumedMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">consumed</span><span class="p">;</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a>
<a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getPayload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-36" name="__codelineno-4-36"></a>
<a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="nf">getMetadata</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-39" name="__codelineno-4-39"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span>
<a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-41" name="__codelineno-4-41"></a>
<a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">ack</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<a id="__codelineno-4-45" name="__codelineno-4-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-46" name="__codelineno-4-46"></a>
<a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-4-48" name="__codelineno-4-48"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">nack</span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">nackMetadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">nackHandler</span><span class="p">.</span><span class="na">handle</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">nackMetadata</span><span class="p">);</span>
<a id="__codelineno-4-50" name="__codelineno-4-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>Note that <code>MyMessage</code> implements the <code>ContextAwareMessage</code>.
In the constructor <code>captureContextMetadata</code> helper method is used to capture the Vert.x context which created the object and capturing it into the <code>LocalContextMetadata</code>.
This metadata allows running <a href="#concepts-message-context">each message in its own Vert.x context, supporting context propagation</a>.</p>
<p>The <code>MyMessage</code> type implements the accessors for the <code>metadata</code> and <code>payload</code> from the <code>Message</code> interface.
If the messaging technology doesn't have a built-in unmarshalling mechanism, the message can deserialize the raw payload to a primitive or a complex object.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The custom message implementation is usually not the type consumed by the application injecting channels.
Applications usually inject in the payload, the raw consumed type (in the above example the <code>ConsumedMessage</code>),
or some other type provided by the <a href="#concepts-converters"><code>MessageConverter</code>s</a>.
Handling of <code>Message</code> types by the application is restricted only to advanced use cases, because handling of message acknowledgment is manual
Even then the message may be intercepted before and changed, conserving the <code>metadata</code>, <code>ack</code> and <code>nack</code> handlers but not the original type created by the connector.</p>
</div>
<p>The <code>MyIncomingMetadata</code> gives access to the underlying consumed message attributes, and applications can inject this object for accessing message details:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-5-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.ConsumedMessage</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyIncomingMetadata</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">ConsumedMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyIncomingMetadata</span><span class="p">(</span><span class="n">ConsumedMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ConsumedMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getCustomMessage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getBody</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">body</span><span class="p">();</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">key</span><span class="p">();</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-26" name="__codelineno-5-26"></a>
<a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">getTimestamp</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">timestamp</span><span class="p">();</span>
<a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-30" name="__codelineno-5-30"></a>
<a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getProperties</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-32" name="__codelineno-5-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">properties</span><span class="p">();</span>
<a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-34" name="__codelineno-5-34"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<p>Also note that <code>ack</code> and <code>nack</code> method implementations are delegated to handler objects.
This allows configuring different strategies at channel level.</p>
<h3 id="concepts-contributing-connectors-acknowledgment-strategies">Acknowledgment strategies</h3>
<p>The <a href="#concepts-acknowledgement">acknowledgement</a> is the way for message consumers to inform the broker that the message has been successfully received and processed.
Depending on the messaging technology the broker then can decide to remove the message from the queue, flag as consumed or purge it completely.
In Reactive Messaging there are different policies to trigger the acknowledgement but the canonical one is to acknowledge a message when the processing (potentially asynchronous) has completed (<code>POST_PROCESSING</code>).</p>
<p>The Reactive Messaging defines <code>Message#ack</code> method as non-blocking asynchronous, returning a <code>CompletionStage&lt;Void&gt;</code>,
because potentially the acknowledgement action sends a network call to the broker.</p>
<p>The following example simply calls the client <code>ack</code> method using the Mutiny <code>Uni</code> and switch the emitter to the Message context.
Returning back to the message context is essential for chaining asynchronous actions without losing the context and for keeping the consistency on message consumption flow.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-6-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.BrokerClient</span><span class="p">;</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyAckHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyAckHandler</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyAckHandler</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">MyMessage</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="na">ack</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getConsumedMessage</span><span class="p">()))</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">                </span><span class="p">.</span><span class="na">emitOn</span><span class="p">(</span><span class="n">msg</span><span class="p">::</span><span class="n">runOnMessageContext</span><span class="p">)</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">                </span><span class="p">.</span><span class="na">subscribeAsCompletionStage</span><span class="p">();</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>While this ack handler strategy acknowledges each message to the broker,
the messaging technology can allow employing different strategies for acknowledging messages.
For example an ack strategy can track processed messages and acknowledge them altogether or call a different client side endpoint to acknowledge the message batch.</p>
<h3 id="concepts-contributing-connectors-failure-handling-strategies">Failure handling strategies</h3>
<p>The failure handling, or the <a href="#concepts-acknowledgement-negative-acknowledgement">negative acknowledgment</a> allows indicating that a message was not processed correctly.
Similar to the acknowledgment the Reactive Messaging defines <code>Message#nack(Throwable reason, Metadata metadata)</code> method as non-blocking asynchronous, returning a <code>CompletionStage&lt;Void&gt;</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-7-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Metadata</span><span class="p">;</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.BrokerClient</span><span class="p">;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyFailureHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span><span class="kd">static</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyFailureHandler</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyFailureHandler</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-21" name="__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">MyMessage</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">reason</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">reject</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getConsumedMessage</span><span class="p">(),</span><span class="w"> </span><span class="n">reason</span><span class="p">.</span><span class="na">getMessage</span><span class="p">()))</span>
<a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">                </span><span class="p">.</span><span class="na">emitOn</span><span class="p">(</span><span class="n">msg</span><span class="p">::</span><span class="n">runOnMessageContext</span><span class="p">)</span>
<a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">                </span><span class="p">.</span><span class="na">subscribeAsCompletionStage</span><span class="p">();</span>
<a id="__codelineno-7-26" name="__codelineno-7-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Different failure handling strategies can, for example,
- Ignore the failure, log and call the <code>ack</code> instead
- Send the message to a dead letter queue and call the <code>ack</code>
- Employ a different strategy depending on the <code>Metadata</code> associated with the <code>nack</code> method call.</p>
<h3 id="concepts-contributing-connectors-message-converters">Message Converters</h3>
<p>The connector can propose default <a href="#concepts-converters"><code>MessageConverter</code></a> implementations for converting the payload to a custom type.
As an example the following converter extracts the <code>CustomMessage</code> and puts it in the payload:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-8-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.lang.reflect.Type</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.ConsumedMessage</span><span class="p">;</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.MessageConverter</span><span class="p">;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.helpers.TypeUtils</span><span class="p">;</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyMessageConverter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">MessageConverter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canConvert</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TypeUtils</span><span class="p">.</span><span class="na">isAssignable</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">ConsumedMessage</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyIncomingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">isPresent</span><span class="p">();</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyIncomingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">MyIncomingMetadata</span><span class="p">::</span><span class="n">getCustomMessage</span><span class="p">)</span>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="w">                </span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">));</span>
<a id="__codelineno-8-26" name="__codelineno-8-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-27" name="__codelineno-8-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="concepts-contributing-connectors-implementing-outbound-channels">Implementing Outbound Channels</h2>
<p>The <code>OutboundConnector</code> implementation returns, for a given channel configuration, a <code>Flow.Subscriber</code> of messages.
This is typically implemented by a custom <code>Flow.Processor</code> and using the <code>MultiUtils.via</code> helper methods to apply message transformations.</p>
<div class="admonition note">
<p class="admonition-title"><code>OutgoingConnectorFactory</code></p>
<p>The outbound channels can also implement the <code>OutgoingConnectorFactory</code> from the MicroProfile Reactive Messaging specification.
However, it is usually more friendly to work with the <code>MultiUtils.via</code> methods to construct and transform outgoing messages.</p>
</div>
<p>Here is an example outgoing channel implementation:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-9-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.Flow</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.BrokerClient</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.api.SendMessage</span><span class="p">;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.helpers.MultiUtils</span><span class="p">;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyOutgoingChannel</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Subscriber</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">subscriber</span><span class="p">;</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingChannel</span><span class="p">(</span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span><span class="w"> </span><span class="n">MyConnectorOutgoingConfiguration</span><span class="w"> </span><span class="n">oc</span><span class="p">,</span><span class="w"> </span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getChannel</span><span class="p">();</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">;</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getTopic</span><span class="p">().</span><span class="na">orElse</span><span class="p">(</span><span class="n">oc</span><span class="p">.</span><span class="na">getChannel</span><span class="p">());</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">subscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiUtils</span><span class="p">.</span><span class="na">via</span><span class="p">(</span><span class="n">multi</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">multi</span><span class="p">.</span><span class="na">call</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">publishMessage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">)));</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">publishMessage</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">        </span><span class="c1">// construct the outgoing message</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">        </span><span class="n">SendMessage</span><span class="w"> </span><span class="n">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SendMessage</span><span class="p">();</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setPayload</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getTopic</span><span class="p">());</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setKey</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">            </span><span class="c1">//...</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">sendMessage</span><span class="p">))</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">                </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">receipt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">ack</span><span class="p">()))</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="w">                </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">recoverWithUni</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="n">t</span><span class="p">)));</span>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a>
<a id="__codelineno-9-42" name="__codelineno-9-42"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Flow</span><span class="p">.</span><span class="na">Subscriber</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">getSubscriber</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-43" name="__codelineno-9-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">subscriber</span><span class="p">;</span>
<a id="__codelineno-9-44" name="__codelineno-9-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-45" name="__codelineno-9-45"></a>
<a id="__codelineno-9-46" name="__codelineno-9-46"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getChannel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-47" name="__codelineno-9-47"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">channel</span><span class="p">;</span>
<a id="__codelineno-9-48" name="__codelineno-9-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-49" name="__codelineno-9-49"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
The <code>MultiUtils.via</code> helper method allows using the <code>Multi</code> chaining methods and in the same time provides a <code>Flow.Subscriber</code>.
However, this implementation allows sending messages one at a time:
one only after the previous outgoing message send is completed.</p>
<p>Some messaging technologies provide publish receipt,
a message back from the broker to the sender that asynchronously acknowledges the sent operation.
In this case the connector can only be sure of the send operation when it receives the publish receipt of that message.
Some technologies may provide blocking sending calls,
in that case the connector needs to delegate the sending call to a worker thread.</p>
<p>Depending on whether the client supports multiple in-flight outgoing messages, you can also use a <code>SenderProcessor</code>,
which allows receiving configuration for the maximum number of in-flight messages and whether it waits for completion (publish receipt from the broker):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-5">5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-6">6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-7">7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-8">8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-10-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kt">long</span><span class="w"> </span><span class="n">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getMaxPendingMessages</span><span class="p">();</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kt">boolean</span><span class="w"> </span><span class="n">waitForWriteCompletion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oc</span><span class="p">.</span><span class="na">getWaitForWriteCompletion</span><span class="p">();</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">requests</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="n">requests</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Long</span><span class="p">.</span><span class="na">MAX_VALUE</span><span class="p">;</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="p">}</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="k">this</span><span class="p">.</span><span class="na">processor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SenderProcessor</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span><span class="w"> </span><span class="n">waitForWriteCompletion</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">publishMessage</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">));</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="k">this</span><span class="p">.</span><span class="na">subscriber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiUtils</span><span class="p">.</span><span class="na">via</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="c1">// log the failure</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="p">}));</span>
</code></pre></div></td></tr></table></div>
<p>Other more advanced scenarios can be implemented to retry the transmission in case of a retryable failure,
or batch multiple outgoing messages to a single send operation.</p>
<h3 id="concepts-contributing-connectors-outgoing-message-builder">Outgoing <code>Message</code> Builder</h3>
<p>In order to convey all attributes of the outgoing message to the client library
connectors provide outgoing <code>Message</code> implementation and a corresponding outgoing message metadata.
These allow the application developer to build the message attributes that will be sent to the broker.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-51">51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-52">52</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-53">53</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-54">54</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-55">55</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-56">56</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-57">57</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-58">58</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-59">59</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-60">60</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-61">61</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-62">62</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-63">63</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-64">64</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-65">65</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-66">66</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-67">67</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-68">68</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-69">69</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-11-70">70</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.Function</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.Supplier</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Metadata</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.locals.ContextAwareMessage</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyOutgoingMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">ContextAwareMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ack</span><span class="p">;</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">nack</span><span class="p">;</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">MyOutgoingMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">from</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingMessage</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getAck</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getNack</span><span class="p">());</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingMessage</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">            </span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">            </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">nack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">ack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ack</span><span class="p">;</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">nack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nack</span><span class="p">;</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingMessage</span><span class="p">(</span><span class="n">T</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">            </span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">            </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">nack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">        </span><span class="k">this</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingMetadata</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">)),</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">nack</span><span class="p">);</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getPayload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Metadata</span><span class="w"> </span><span class="nf">getMetadata</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">metadata</span><span class="p">;</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-50" name="__codelineno-11-50"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getAck</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-51" name="__codelineno-11-51"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">ack</span><span class="p">;</span>
<a id="__codelineno-11-52" name="__codelineno-11-52"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-53" name="__codelineno-11-53"></a>
<a id="__codelineno-11-54" name="__codelineno-11-54"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-55" name="__codelineno-11-55"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">getNack</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-56" name="__codelineno-11-56"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">nack</span><span class="p">;</span>
<a id="__codelineno-11-57" name="__codelineno-11-57"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-58" name="__codelineno-11-58"></a>
<a id="__codelineno-11-59" name="__codelineno-11-59"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MyOutgoingMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">withKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-60" name="__codelineno-11-60"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-11-61" name="__codelineno-11-61"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">m</span><span class="p">).</span><span class="na">withKey</span><span class="p">(</span><span class="n">key</span><span class="p">).</span><span class="na">build</span><span class="p">()));</span>
<a id="__codelineno-11-62" name="__codelineno-11-62"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<a id="__codelineno-11-63" name="__codelineno-11-63"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-64" name="__codelineno-11-64"></a>
<a id="__codelineno-11-65" name="__codelineno-11-65"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MyOutgoingMessage</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">withTopic</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-66" name="__codelineno-11-66"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-11-67" name="__codelineno-11-67"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">m</span><span class="p">).</span><span class="na">withTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">).</span><span class="na">build</span><span class="p">()));</span>
<a id="__codelineno-11-68" name="__codelineno-11-68"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<a id="__codelineno-11-69" name="__codelineno-11-69"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-70" name="__codelineno-11-70"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-51">51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-52">52</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-53">53</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-54">54</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-55">55</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-12-56">56</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors</span><span class="p">;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyOutgoingMetadata</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="w"> </span><span class="nf">builder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="p">();</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="w"> </span><span class="nf">builder</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingMetadata</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getTopic</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a>
<a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">getKey</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-25" name="__codelineno-12-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-27" name="__codelineno-12-27"></a>
<a id="__codelineno-12-28" name="__codelineno-12-28"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyOutgoingMetadataBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-12-31" name="__codelineno-12-31"></a>
<a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingMetadataBuilder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-33" name="__codelineno-12-33"></a>
<a id="__codelineno-12-34" name="__codelineno-12-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-35" name="__codelineno-12-35"></a>
<a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyOutgoingMetadataBuilder</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span>
<a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTopic</span><span class="p">();</span>
<a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-40" name="__codelineno-12-40"></a>
<a id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="w"> </span><span class="nf">withTopic</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-42" name="__codelineno-12-42"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">topic</span><span class="p">;</span>
<a id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<a id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-45" name="__codelineno-12-45"></a>
<a id="__codelineno-12-46" name="__codelineno-12-46"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">MyOutgoingMetadataBuilder</span><span class="w"> </span><span class="nf">withKey</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<a id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">;</span>
<a id="__codelineno-12-49" name="__codelineno-12-49"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-50" name="__codelineno-12-50"></a>
<a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">MyOutgoingMetadata</span><span class="w"> </span><span class="nf">build</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyOutgoingMetadata</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span>
<a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-55" name="__codelineno-12-55"></a>
<a id="__codelineno-12-56" name="__codelineno-12-56"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The outgoing channel implementation then will construct the client library object that represents the outbound message, <code>SendMessage</code> in this example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-13-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">private</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">publishMessage</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="c1">// construct the outgoing message</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="n">SendMessage</span><span class="w"> </span><span class="n">sendMessage</span><span class="p">;</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SendMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">        </span><span class="n">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SendMessage</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">        </span><span class="n">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SendMessage</span><span class="p">();</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setPayload</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">        </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getTopic</span><span class="p">());</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setKey</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">            </span><span class="c1">//...</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">sendMessage</span><span class="p">))</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">receipt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">ack</span><span class="p">()))</span>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="w">            </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">recoverWithUni</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="n">t</span><span class="p">)));</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It is a best practice to also allow the application to return a payload of the client outbound library object (<code>SendMessage</code>).</p>
<h3 id="concepts-contributing-connectors-outgoing-message-acknowledgement">Outgoing message acknowledgement</h3>
<p>Because the Reactive Messaging <a href="#concepts-acknowledgement-chain-of-acknowledgment">chains acknowledgements</a> from incoming message until the outgoing message,
it is crucial for the outgoing channel to correctly ack and nack the message.</p>
<h2 id="concepts-contributing-connectors-smallrye-health-integration">Smallrye Health Integration</h2>
<p>Smallrye Reactive Messaging allows connectors to integrate with Smallrye Health to contribute channel state to the health reports.
Connectors need to implement the <code>HealthReporter</code> interface and implement some or all of the <code>getReadiness</code>, <code>getLiveness</code> and <code>getStartup</code> methods:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-14-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nd">@Connector</span><span class="p">(</span><span class="n">MyConnectorWithPartials</span><span class="p">.</span><span class="na">CONNECTOR_NAME</span><span class="p">)</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConnectorWithPartials</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">InboundConnector</span><span class="p">,</span><span class="w"> </span><span class="n">OutboundConnector</span><span class="p">,</span><span class="w"> </span><span class="n">HealthReporter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">CONNECTOR_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;smallrye-my-connector&quot;</span><span class="p">;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MyIncomingChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">incomingChannels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">MyOutgoingChannel</span><span class="o">&gt;</span><span class="w"> </span><span class="n">outgoingChannels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HealthReport</span><span class="w"> </span><span class="nf">getReadiness</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">        </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">HealthReportBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyIncomingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">incomingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyOutgoingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">outgoingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HealthReport</span><span class="w"> </span><span class="nf">getLiveness</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="w">        </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">HealthReportBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span>
<a id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyIncomingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">incomingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyOutgoingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">outgoingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-33" name="__codelineno-14-33"></a>
<a id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HealthReport</span><span class="w"> </span><span class="nf">getStartup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="w">        </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">HealthReportBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HealthReport</span><span class="p">.</span><span class="na">builder</span><span class="p">();</span>
<a id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyIncomingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">incomingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-39" name="__codelineno-14-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">MyOutgoingChannel</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">outgoingChannels</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="w">            </span><span class="n">builder</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">channel</span><span class="p">.</span><span class="na">getChannel</span><span class="p">(),</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Implementing health reports per channel depends on what information is available to the connector.
For more information on different health check probes you can check out <a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Configure Liveness, Readiness and Startup Probes
</a></p>
<p>You may want to add a connector attribute to enable/disable the health reporting per channel:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-15-1">1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-15-2">2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-15-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute</span><span class="p">;</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;health-enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;boolean&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConnectorAttribute</span><span class="p">.</span><span class="na">Direction</span><span class="p">.</span><span class="na">INCOMING_AND_OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Whether health reporting is enabled (default) or disabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="concepts-contributing-connectors-opentelemetry-tracing-integration">OpenTelemetry Tracing Integration</h2>
<p>Smallrye Reactive Messaging allows connectors to easily integrate with OpenTelemetry tracing.
It propagates the tracing context from inbound messages and to outbound messages.
The <code>smallrye-reactive-messaging-otel</code> module provides necessary dependencies to the OpenTelemetry artifacts and also provides <code>TracingUtils</code> helper class for setting up the tracing.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-16-1">1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-16-2">2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-16-3">3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-16-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive.messaging<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-otel<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>For integrating tracing you'd need to create a couple of classes:</p>
<ul>
<li>Holder class for tracing information</li>
<li>Implementation of <code>io.opentelemetry.context.propagation.TextMapGetter</code>, which retrieves for a given key the value of a tracing attributed from the holder object</li>
<li>Implementation of <code>io.opentelemetry.context.propagation.TextMapSetter</code>, which sets on the holder object the key and value of tracing attributes</li>
<li>Implementations of <code>io.opentelemetry.instrumentation.api.instrumenter.AttributesExtractor</code> and <code>io.opentelemetry.instrumentation.api.instrumenter.messaging.MessagingAttributesGetter</code></li>
</ul>
<p>Then you'd need to configure instrumenters per incoming and outgoing channel:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-17-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">Instrumenter</span><span class="o">&lt;</span><span class="n">MyTrace</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createInstrumenter</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">incoming</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">        </span><span class="n">MessageOperation</span><span class="w"> </span><span class="n">messageOperation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">MessageOperation</span><span class="p">.</span><span class="na">RECEIVE</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">MessageOperation</span><span class="p">.</span><span class="na">PUBLISH</span><span class="p">;</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">        </span><span class="n">MyAttributesExtractor</span><span class="w"> </span><span class="n">myExtractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyAttributesExtractor</span><span class="p">();</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">        </span><span class="n">MessagingAttributesGetter</span><span class="o">&lt;</span><span class="n">MyTrace</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">attributesGetter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">myExtractor</span><span class="p">.</span><span class="na">getMessagingAttributesGetter</span><span class="p">();</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">spanNameExtractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessagingSpanNameExtractor</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">attributesGetter</span><span class="p">,</span><span class="w"> </span><span class="n">messageOperation</span><span class="p">);</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">        </span><span class="n">InstrumenterBuilder</span><span class="o">&lt;</span><span class="n">MyTrace</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Instrumenter</span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="n">GlobalOpenTelemetry</span><span class="p">.</span><span class="na">get</span><span class="p">(),</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">                </span><span class="s">&quot;io.smallrye.reactive.messaging&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">spanNameExtractor</span><span class="p">);</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">attributesExtractor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MessagingAttributesExtractor</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">attributesGetter</span><span class="p">,</span><span class="w"> </span><span class="n">messageOperation</span><span class="p">);</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">        </span><span class="n">builder</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">                </span><span class="p">.</span><span class="na">addAttributesExtractor</span><span class="p">(</span><span class="n">attributesExtractor</span><span class="p">)</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">                </span><span class="p">.</span><span class="na">addAttributesExtractor</span><span class="p">(</span><span class="n">myExtractor</span><span class="p">);</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">incoming</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">buildConsumerInstrumenter</span><span class="p">(</span><span class="n">MyTraceTextMapGetter</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">);</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">buildProducerInstrumenter</span><span class="p">(</span><span class="n">MyTraceTextMapSetter</span><span class="p">.</span><span class="na">INSTANCE</span><span class="p">);</span>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="c1">// &lt;/create-instrumener&gt;</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">traceIncoming</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">MyTrace</span><span class="w"> </span><span class="n">myTrace</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">makeCurrent</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TracingUtils</span><span class="p">.</span><span class="na">traceIncoming</span><span class="p">(</span><span class="n">instrumenter</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">myTrace</span><span class="p">,</span><span class="w"> </span><span class="n">makeCurrent</span><span class="p">);</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">traceOutgoing</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">MyTrace</span><span class="w"> </span><span class="n">myTrace</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a><span class="w">        </span><span class="n">TracingUtils</span><span class="p">.</span><span class="na">traceOutgoing</span><span class="p">(</span><span class="n">instrumenter</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">myTrace</span><span class="p">);</span>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Finally, you'd need to configure instrumenters per incoming and outgoing channels and wire the call to instrumenter using <code>TracingUtils</code>.</p>
<p>For an incoming channel, you'd need to call the instrumenter on an inbound message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-18-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">Multi</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">receiveMulti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createBy</span><span class="p">().</span><span class="na">repeating</span><span class="p">()</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">        </span><span class="p">.</span><span class="na">uni</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">poll</span><span class="p">()))</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">        </span><span class="p">.</span><span class="na">until</span><span class="p">(</span><span class="n">__</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">closed</span><span class="p">.</span><span class="na">get</span><span class="p">())</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">        </span><span class="p">.</span><span class="na">emitOn</span><span class="p">(</span><span class="n">context</span><span class="p">::</span><span class="n">runOnContext</span><span class="p">)</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">consumed</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyMessage</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">consumed</span><span class="p">,</span><span class="w"> </span><span class="n">ackHandler</span><span class="p">,</span><span class="w"> </span><span class="n">failureHandler</span><span class="p">));</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="n">Instrumenter</span><span class="o">&lt;</span><span class="n">MyTrace</span><span class="p">,</span><span class="w"> </span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">instrumenter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MyOpenTelemetryInstrumenter</span><span class="p">.</span><span class="na">createInstrumenter</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tracingEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="n">receiveMulti</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiveMulti</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">        </span><span class="n">ConsumedMessage</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">consumedMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyIncomingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">get</span><span class="p">().</span><span class="na">getCustomMessage</span><span class="p">();</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">TracingUtils</span><span class="p">.</span><span class="na">traceIncoming</span><span class="p">(</span><span class="n">instrumenter</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyTrace</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">                </span><span class="p">.</span><span class="na">withClientId</span><span class="p">(</span><span class="n">consumedMessage</span><span class="p">.</span><span class="na">clientId</span><span class="p">())</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">                </span><span class="p">.</span><span class="na">withTopic</span><span class="p">(</span><span class="n">consumedMessage</span><span class="p">.</span><span class="na">topic</span><span class="p">())</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">                </span><span class="p">.</span><span class="na">withProperties</span><span class="p">(</span><span class="n">consumedMessage</span><span class="p">.</span><span class="na">properties</span><span class="p">())</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>For an outgoing channel, you'd need to call the instrumenter on constructing the outbound message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-19-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="kd">private</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">publishMessageWithTracing</span><span class="p">(</span><span class="n">BrokerClient</span><span class="w"> </span><span class="n">client</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="c1">// construct the outgoing message</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="n">SendMessage</span><span class="w"> </span><span class="n">sendMessage</span><span class="p">;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">payload</span><span class="w"> </span><span class="k">instanceof</span><span class="w"> </span><span class="n">SendMessage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">        </span><span class="n">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">SendMessage</span><span class="p">)</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">        </span><span class="n">sendMessage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SendMessage</span><span class="p">();</span>
<a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setPayload</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>
<a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">topic</span><span class="p">);</span>
<a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">        </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">MyOutgoingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">out</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getTopic</span><span class="p">());</span>
<a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="w">            </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setKey</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-19-14" name="__codelineno-19-14"></a><span class="w">            </span><span class="c1">//...</span>
<a id="__codelineno-19-15" name="__codelineno-19-15"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-19-16" name="__codelineno-19-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-17" name="__codelineno-19-17"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tracingEnabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-18" name="__codelineno-19-18"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-19-19" name="__codelineno-19-19"></a><span class="w">        </span><span class="n">TracingUtils</span><span class="p">.</span><span class="na">traceOutgoing</span><span class="p">(</span><span class="n">instrumenter</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyTrace</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-19-20" name="__codelineno-19-20"></a><span class="w">                </span><span class="p">.</span><span class="na">withProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
<a id="__codelineno-19-21" name="__codelineno-19-21"></a><span class="w">                </span><span class="p">.</span><span class="na">withTopic</span><span class="p">(</span><span class="n">sendMessage</span><span class="p">.</span><span class="na">getTopic</span><span class="p">())</span>
<a id="__codelineno-19-22" name="__codelineno-19-22"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-19-23" name="__codelineno-19-23"></a><span class="w">        </span><span class="n">sendMessage</span><span class="p">.</span><span class="na">setProperties</span><span class="p">(</span><span class="n">properties</span><span class="p">);</span>
<a id="__codelineno-19-24" name="__codelineno-19-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-19-25" name="__codelineno-19-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">sendMessage</span><span class="p">))</span>
<a id="__codelineno-19-26" name="__codelineno-19-26"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transformToUni</span><span class="p">(</span><span class="n">receipt</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">ack</span><span class="p">()))</span>
<a id="__codelineno-19-27" name="__codelineno-19-27"></a><span class="w">            </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">recoverWithUni</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="n">t</span><span class="p">)));</span>
<a id="__codelineno-19-28" name="__codelineno-19-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You may want to add a connector attribute to enable/disable the tracing per channel:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-20-1">1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-20-2">2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-20-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.annotations.ConnectorAttribute</span><span class="p">;</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="nd">@ConnectorAttribute</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tracing-enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;boolean&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">direction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ConnectorAttribute</span><span class="p">.</span><span class="na">Direction</span><span class="p">.</span><span class="na">INCOMING_AND_OUTGOING</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Whether tracing is enabled (default) or disabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">defaultValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="concepts-contributing-connectors-testing-the-connector">Testing the connector</h2>
<p>While unit tests are highly encouraged for validating ad-hoc logic in connector code,
by nature connector tests are mostly integration tests validating the correct configuration and functioning of channels.
Most of the time tests need to run against a broker instance.
This instance can be mocked or embedded in the test JVM,
or provisioned in a container runtime using <a href="https://testcontainers.org">Testcontainers</a>.
The testcontainers approach is encouraged as it'll provide a testing environment closest to reality.</p>
<p>It may take too much time and resources to start a broker per test method or per test class,
so may want to share the same broker instance between all test classes.
In that case you can checkout how to write a <a href="https://junit.org/junit5/docs/current/user-guide/#extensions">JUnit 5 Extension</a>
and start only one container instance in the beginning of tests and stop it at the end of all the tests.</p>
<p>There are essentially two ways of creating the connector behavior to test against:</p>
<ol>
<li>Instantiating channels directly by passing the custom configuration.
With this you can get the Reactive stream directly from the channel implementation and send/receive messages.
You can use <a href="https://smallrye.io/smallrye-mutiny/2.5.1/guides/testing/">AssertSubscriber from Mutiny</a> to regulate demand and write assertions.</li>
<li>CDI-based tests which write configuration and instantiate application beans.
You can use <a href="https://weld.cdi-spec.org/">Weld, the reference implementation of CDI specification</a> with configured set of beans and extensions:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-1">  1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-2">  2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-3">  3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-4">  4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-5">  5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-6">  6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-7">  7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-8">  8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-9">  9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-10"> 10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-11"> 11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-12"> 12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-13"> 13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-14"> 14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-15"> 15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-16"> 16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-17"> 17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-18"> 18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-19"> 19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-20"> 20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-21"> 21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-22"> 22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-23"> 23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-24"> 24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-25"> 25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-26"> 26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-27"> 27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-28"> 28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-29"> 29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-30"> 30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-31"> 31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-32"> 32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-33"> 33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-34"> 34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-35"> 35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-36"> 36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-37"> 37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-38"> 38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-39"> 39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-40"> 40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-41"> 41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-42"> 42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-43"> 43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-44"> 44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-45"> 45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-46"> 46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-47"> 47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-48"> 48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-49"> 49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-50"> 50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-51"> 51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-52"> 52</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-53"> 53</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-54"> 54</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-55"> 55</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-56"> 56</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-57"> 57</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-58"> 58</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-59"> 59</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-60"> 60</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-61"> 61</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-62"> 62</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-63"> 63</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-64"> 64</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-65"> 65</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-66"> 66</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-67"> 67</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-68"> 68</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-69"> 69</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-70"> 70</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-71"> 71</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-72"> 72</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-73"> 73</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-74"> 74</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-75"> 75</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-76"> 76</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-77"> 77</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-78"> 78</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-79"> 79</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-80"> 80</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-81"> 81</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-82"> 82</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-83"> 83</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-84"> 84</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-85"> 85</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-86"> 86</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-87"> 87</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-88"> 88</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-89"> 89</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-90"> 90</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-91"> 91</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-92"> 92</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-93"> 93</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-94"> 94</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-95"> 95</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-96"> 96</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-97"> 97</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-98"> 98</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-99"> 99</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-100">100</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-101">101</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-102">102</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-103">103</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-104">104</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-105">105</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-106">106</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-107">107</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-108">108</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-109">109</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-110">110</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-111">111</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-112">112</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-113">113</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-114">114</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-115">115</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-116">116</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-117">117</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-118">118</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-119">119</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-120">120</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-121">121</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-122">122</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-123">123</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-124">124</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-125">125</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-126">126</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-127">127</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-128">128</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-129">129</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-130">130</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-131">131</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-132">132</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-133">133</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-134">134</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-135">135</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-136">136</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-137">137</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-138">138</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-139">139</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-21-140">140</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors.test</span><span class="p">;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>
<a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.spi.BeanManager</span><span class="p">;</span>
<a id="__codelineno-21-4" name="__codelineno-21-4"></a>
<a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.config.ConfigProvider</span><span class="p">;</span>
<a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.spi.ConnectorLiteral</span><span class="p">;</span>
<a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.jboss.weld.environment.se.Weld</span><span class="p">;</span>
<a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.jboss.weld.environment.se.WeldContainer</span><span class="p">;</span>
<a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.AfterEach</span><span class="p">;</span>
<a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeEach</span><span class="p">;</span>
<a id="__codelineno-21-11" name="__codelineno-21-11"></a>
<a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.MyConnector</span><span class="p">;</span>
<a id="__codelineno-21-13" name="__codelineno-21-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.MyMessageConverter</span><span class="p">;</span>
<a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.config.SmallRyeConfigProviderResolver</span><span class="p">;</span>
<a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.config.inject.ConfigExtension</span><span class="p">;</span>
<a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.MediatorFactory</span><span class="p">;</span>
<a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.connectors.ExecutionHolder</span><span class="p">;</span>
<a id="__codelineno-21-18" name="__codelineno-21-18"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.connectors.WorkerPoolRegistry</span><span class="p">;</span>
<a id="__codelineno-21-19" name="__codelineno-21-19"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.ChannelProducer</span><span class="p">;</span>
<a id="__codelineno-21-20" name="__codelineno-21-20"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.EmitterFactoryImpl</span><span class="p">;</span>
<a id="__codelineno-21-21" name="__codelineno-21-21"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.HealthCenter</span><span class="p">;</span>
<a id="__codelineno-21-22" name="__codelineno-21-22"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.LegacyEmitterFactoryImpl</span><span class="p">;</span>
<a id="__codelineno-21-23" name="__codelineno-21-23"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.MediatorManager</span><span class="p">;</span>
<a id="__codelineno-21-24" name="__codelineno-21-24"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.MutinyEmitterFactoryImpl</span><span class="p">;</span>
<a id="__codelineno-21-25" name="__codelineno-21-25"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.extension.ReactiveMessagingExtension</span><span class="p">;</span>
<a id="__codelineno-21-26" name="__codelineno-21-26"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.impl.ConfiguredChannelFactory</span><span class="p">;</span>
<a id="__codelineno-21-27" name="__codelineno-21-27"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.impl.ConnectorFactories</span><span class="p">;</span>
<a id="__codelineno-21-28" name="__codelineno-21-28"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.impl.InternalChannelRegistry</span><span class="p">;</span>
<a id="__codelineno-21-29" name="__codelineno-21-29"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.metrics.MetricDecorator</span><span class="p">;</span>
<a id="__codelineno-21-30" name="__codelineno-21-30"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.metrics.MicrometerDecorator</span><span class="p">;</span>
<a id="__codelineno-21-31" name="__codelineno-21-31"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.providers.wiring.Wiring</span><span class="p">;</span>
<a id="__codelineno-21-32" name="__codelineno-21-32"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.test.common.config.MapBasedConfig</span><span class="p">;</span>
<a id="__codelineno-21-33" name="__codelineno-21-33"></a>
<a id="__codelineno-21-34" name="__codelineno-21-34"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">WeldTestBase</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-35" name="__codelineno-21-35"></a>
<a id="__codelineno-21-36" name="__codelineno-21-36"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Weld</span><span class="w"> </span><span class="n">weld</span><span class="p">;</span>
<a id="__codelineno-21-37" name="__codelineno-21-37"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">WeldContainer</span><span class="w"> </span><span class="n">container</span><span class="p">;</span>
<a id="__codelineno-21-38" name="__codelineno-21-38"></a>
<a id="__codelineno-21-39" name="__codelineno-21-39"></a><span class="w">    </span><span class="nd">@BeforeEach</span>
<a id="__codelineno-21-40" name="__codelineno-21-40"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">initWeld</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-41" name="__codelineno-21-41"></a><span class="w">        </span><span class="n">weld</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Weld</span><span class="p">();</span>
<a id="__codelineno-21-42" name="__codelineno-21-42"></a>
<a id="__codelineno-21-43" name="__codelineno-21-43"></a><span class="w">        </span><span class="c1">// SmallRye config</span>
<a id="__codelineno-21-44" name="__codelineno-21-44"></a><span class="w">        </span><span class="n">ConfigExtension</span><span class="w"> </span><span class="n">extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConfigExtension</span><span class="p">();</span>
<a id="__codelineno-21-45" name="__codelineno-21-45"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addExtension</span><span class="p">(</span><span class="n">extension</span><span class="p">);</span>
<a id="__codelineno-21-46" name="__codelineno-21-46"></a>
<a id="__codelineno-21-47" name="__codelineno-21-47"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MediatorFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-48" name="__codelineno-21-48"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MediatorManager</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-49" name="__codelineno-21-49"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">InternalChannelRegistry</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-50" name="__codelineno-21-50"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">ConnectorFactories</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-51" name="__codelineno-21-51"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">ConfiguredChannelFactory</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-52" name="__codelineno-21-52"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">ChannelProducer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-53" name="__codelineno-21-53"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">ExecutionHolder</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-54" name="__codelineno-21-54"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">WorkerPoolRegistry</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-55" name="__codelineno-21-55"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">HealthCenter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-56" name="__codelineno-21-56"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">Wiring</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-57" name="__codelineno-21-57"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addExtension</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">ReactiveMessagingExtension</span><span class="p">());</span>
<a id="__codelineno-21-58" name="__codelineno-21-58"></a>
<a id="__codelineno-21-59" name="__codelineno-21-59"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">EmitterFactoryImpl</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-60" name="__codelineno-21-60"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MutinyEmitterFactoryImpl</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-61" name="__codelineno-21-61"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">LegacyEmitterFactoryImpl</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-62" name="__codelineno-21-62"></a>
<a id="__codelineno-21-63" name="__codelineno-21-63"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MyConnector</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-64" name="__codelineno-21-64"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MyMessageConverter</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-65" name="__codelineno-21-65"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MetricDecorator</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-66" name="__codelineno-21-66"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">MicrometerDecorator</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-21-67" name="__codelineno-21-67"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">disableDiscovery</span><span class="p">();</span>
<a id="__codelineno-21-68" name="__codelineno-21-68"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-69" name="__codelineno-21-69"></a>
<a id="__codelineno-21-70" name="__codelineno-21-70"></a><span class="w">    </span><span class="nd">@AfterEach</span>
<a id="__codelineno-21-71" name="__codelineno-21-71"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stopContainer</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-72" name="__codelineno-21-72"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">container</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-73" name="__codelineno-21-73"></a><span class="w">            </span><span class="c1">// TODO Explicitly close the connector</span>
<a id="__codelineno-21-74" name="__codelineno-21-74"></a><span class="w">            </span><span class="n">getBeanManager</span><span class="p">().</span><span class="na">createInstance</span><span class="p">()</span>
<a id="__codelineno-21-75" name="__codelineno-21-75"></a><span class="w">                    </span><span class="p">.</span><span class="na">select</span><span class="p">(</span><span class="n">MyConnector</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">ConnectorLiteral</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">MyConnector</span><span class="p">.</span><span class="na">CONNECTOR_NAME</span><span class="p">)).</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-21-76" name="__codelineno-21-76"></a><span class="w">            </span><span class="n">container</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
<a id="__codelineno-21-77" name="__codelineno-21-77"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-78" name="__codelineno-21-78"></a><span class="w">        </span><span class="c1">// Release the config objects</span>
<a id="__codelineno-21-79" name="__codelineno-21-79"></a><span class="w">        </span><span class="n">SmallRyeConfigProviderResolver</span><span class="p">.</span><span class="na">instance</span><span class="p">().</span><span class="na">releaseConfig</span><span class="p">(</span><span class="n">ConfigProvider</span><span class="p">.</span><span class="na">getConfig</span><span class="p">());</span>
<a id="__codelineno-21-80" name="__codelineno-21-80"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-81" name="__codelineno-21-81"></a>
<a id="__codelineno-21-82" name="__codelineno-21-82"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BeanManager</span><span class="w"> </span><span class="nf">getBeanManager</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-83" name="__codelineno-21-83"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">container</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-84" name="__codelineno-21-84"></a><span class="w">            </span><span class="n">runApplication</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">MapBasedConfig</span><span class="p">());</span>
<a id="__codelineno-21-85" name="__codelineno-21-85"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-86" name="__codelineno-21-86"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="na">getBeanManager</span><span class="p">();</span>
<a id="__codelineno-21-87" name="__codelineno-21-87"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-88" name="__codelineno-21-88"></a>
<a id="__codelineno-21-89" name="__codelineno-21-89"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addBeans</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="p">...</span><span class="w"> </span><span class="n">clazzes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-90" name="__codelineno-21-90"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClasses</span><span class="p">(</span><span class="n">clazzes</span><span class="p">);</span>
<a id="__codelineno-21-91" name="__codelineno-21-91"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-92" name="__codelineno-21-92"></a>
<a id="__codelineno-21-93" name="__codelineno-21-93"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-94" name="__codelineno-21-94"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getBeanManager</span><span class="p">().</span><span class="na">createInstance</span><span class="p">().</span><span class="na">select</span><span class="p">(</span><span class="n">clazz</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-21-95" name="__codelineno-21-95"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-96" name="__codelineno-21-96"></a>
<a id="__codelineno-21-97" name="__codelineno-21-97"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">runApplication</span><span class="p">(</span><span class="n">MapBasedConfig</span><span class="w"> </span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">clazz</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-98" name="__codelineno-21-98"></a><span class="w">        </span><span class="n">weld</span><span class="p">.</span><span class="na">addBeanClass</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
<a id="__codelineno-21-99" name="__codelineno-21-99"></a><span class="w">        </span><span class="n">runApplication</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<a id="__codelineno-21-100" name="__codelineno-21-100"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">get</span><span class="p">(</span><span class="n">clazz</span><span class="p">);</span>
<a id="__codelineno-21-101" name="__codelineno-21-101"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-102" name="__codelineno-21-102"></a>
<a id="__codelineno-21-103" name="__codelineno-21-103"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">runApplication</span><span class="p">(</span><span class="n">MapBasedConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-104" name="__codelineno-21-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-105" name="__codelineno-21-105"></a><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">write</span><span class="p">();</span>
<a id="__codelineno-21-106" name="__codelineno-21-106"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-107" name="__codelineno-21-107"></a><span class="w">            </span><span class="n">MapBasedConfig</span><span class="p">.</span><span class="na">cleanup</span><span class="p">();</span>
<a id="__codelineno-21-108" name="__codelineno-21-108"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-109" name="__codelineno-21-109"></a>
<a id="__codelineno-21-110" name="__codelineno-21-110"></a><span class="w">        </span><span class="n">container</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weld</span><span class="p">.</span><span class="na">initialize</span><span class="p">();</span>
<a id="__codelineno-21-111" name="__codelineno-21-111"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-112" name="__codelineno-21-112"></a>
<a id="__codelineno-21-113" name="__codelineno-21-113"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addConfig</span><span class="p">(</span><span class="n">MapBasedConfig</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-114" name="__codelineno-21-114"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">config</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-115" name="__codelineno-21-115"></a><span class="w">            </span><span class="n">config</span><span class="p">.</span><span class="na">write</span><span class="p">();</span>
<a id="__codelineno-21-116" name="__codelineno-21-116"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-117" name="__codelineno-21-117"></a><span class="w">            </span><span class="n">MapBasedConfig</span><span class="p">.</span><span class="na">cleanup</span><span class="p">();</span>
<a id="__codelineno-21-118" name="__codelineno-21-118"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-119" name="__codelineno-21-119"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-120" name="__codelineno-21-120"></a>
<a id="__codelineno-21-121" name="__codelineno-21-121"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">HealthCenter</span><span class="w"> </span><span class="nf">getHealth</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-122" name="__codelineno-21-122"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">container</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-123" name="__codelineno-21-123"></a><span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Application not started&quot;</span><span class="p">);</span>
<a id="__codelineno-21-124" name="__codelineno-21-124"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-21-125" name="__codelineno-21-125"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">container</span><span class="p">.</span><span class="na">getBeanManager</span><span class="p">().</span><span class="na">createInstance</span><span class="p">().</span><span class="na">select</span><span class="p">(</span><span class="n">HealthCenter</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-21-126" name="__codelineno-21-126"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-127" name="__codelineno-21-127"></a>
<a id="__codelineno-21-128" name="__codelineno-21-128"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isStarted</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-129" name="__codelineno-21-129"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getHealth</span><span class="p">().</span><span class="na">getStartup</span><span class="p">().</span><span class="na">isOk</span><span class="p">();</span>
<a id="__codelineno-21-130" name="__codelineno-21-130"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-131" name="__codelineno-21-131"></a>
<a id="__codelineno-21-132" name="__codelineno-21-132"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isReady</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-133" name="__codelineno-21-133"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getHealth</span><span class="p">().</span><span class="na">getReadiness</span><span class="p">().</span><span class="na">isOk</span><span class="p">();</span>
<a id="__codelineno-21-134" name="__codelineno-21-134"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-135" name="__codelineno-21-135"></a>
<a id="__codelineno-21-136" name="__codelineno-21-136"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isAlive</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-21-137" name="__codelineno-21-137"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">getHealth</span><span class="p">().</span><span class="na">getLiveness</span><span class="p">().</span><span class="na">isOk</span><span class="p">();</span>
<a id="__codelineno-21-138" name="__codelineno-21-138"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-21-139" name="__codelineno-21-139"></a>
<a id="__codelineno-21-140" name="__codelineno-21-140"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></li>
</ol>
<p>You would need following test dependencies for enabling Weld in tests:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-22-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">      </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>test-common<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">      </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">      </span><span class="nt">&lt;groupId&gt;</span>org.jboss.weld.se<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>weld-se-shaded<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">      </span><span class="nt">&lt;version&gt;</span>${weld.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="w">      </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">      </span><span class="nt">&lt;groupId&gt;</span>org.jboss.weld<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>weld-core-impl<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">      </span><span class="nt">&lt;version&gt;</span>${weld.version}<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">      </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
<a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="w">    </span><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">      </span><span class="nt">&lt;groupId&gt;</span>org.awaitility<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">      </span><span class="nt">&lt;artifactId&gt;</span>awaitility<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-22-21" name="__codelineno-22-21"></a><span class="w">      </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div></p>
<p>Your test classes can therefore extend the <code>WeldTestBase</code> and provide configuration and application beans:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-10">10</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-11">11</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-12">12</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-13">13</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-14">14</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-15">15</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-16">16</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-17">17</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-18">18</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-19">19</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-20">20</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-21">21</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-22">22</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-23">23</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-24">24</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-25">25</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-26">26</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-27">27</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-28">28</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-29">29</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-30">30</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-31">31</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-32">32</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-33">33</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-34">34</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-35">35</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-36">36</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-37">37</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-38">38</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-39">39</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-40">40</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-41">41</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-42">42</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-43">43</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-44">44</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-45">45</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-46">46</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-47">47</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-48">48</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-49">49</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-50">50</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-51">51</a></span>
<span class="normal"><a href="#concepts-contributing-connectors-__codelineno-23-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">connectors.test</span><span class="p">;</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="kn">import static</span><span class="w"> </span><span class="nn">org.awaitility.Awaitility.await</span><span class="p">;</span>
<a id="__codelineno-23-4" name="__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.List</span><span class="p">;</span>
<a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span>
<a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CopyOnWriteArrayList</span><span class="p">;</span>
<a id="__codelineno-23-8" name="__codelineno-23-8"></a>
<a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-23-10" name="__codelineno-23-10"></a>
<a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<a id="__codelineno-23-13" name="__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">connectors.MyConnector</span><span class="p">;</span>
<a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.test.common.config.MapBasedConfig</span><span class="p">;</span>
<a id="__codelineno-23-16" name="__codelineno-23-16"></a>
<a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConnectorTest</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">WeldTestBase</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-18" name="__codelineno-23-18"></a>
<a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">incomingChannel</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-21" name="__codelineno-23-21"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">;</span>
<a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">myTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">        </span><span class="n">MapBasedConfig</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MapBasedConfig</span><span class="p">()</span>
<a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">                </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;mp.messaging.incoming.data.topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">myTopic</span><span class="p">)</span>
<a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">                </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;mp.messaging.incoming.data.host&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">)</span>
<a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="w">                </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;mp.messaging.incoming.data.port&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)</span>
<a id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="w">                </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;mp.messaging.incoming.data.connector&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">MyConnector</span><span class="p">.</span><span class="na">CONNECTOR_NAME</span><span class="p">);</span>
<a id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="w">        </span><span class="n">MyApp</span><span class="w"> </span><span class="n">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">runApplication</span><span class="p">(</span><span class="n">config</span><span class="p">,</span><span class="w"> </span><span class="n">MyApp</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-23-30" name="__codelineno-23-30"></a>
<a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="w">        </span><span class="c1">// produce expected number of messages to myTopic</span>
<a id="__codelineno-23-33" name="__codelineno-23-33"></a>
<a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="w">        </span><span class="c1">// wait until app received</span>
<a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="w">        </span><span class="n">await</span><span class="p">().</span><span class="na">until</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">app</span><span class="p">.</span><span class="na">received</span><span class="p">().</span><span class="na">size</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="p">);</span>
<a id="__codelineno-23-36" name="__codelineno-23-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-37" name="__codelineno-23-37"></a>
<a id="__codelineno-23-38" name="__codelineno-23-38"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-23-39" name="__codelineno-23-39"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyApp</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-40" name="__codelineno-23-40"></a>
<a id="__codelineno-23-41" name="__codelineno-23-41"></a><span class="w">        </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-23-42" name="__codelineno-23-42"></a>
<a id="__codelineno-23-43" name="__codelineno-23-43"></a><span class="w">        </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-23-44" name="__codelineno-23-44"></a><span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-45" name="__codelineno-23-45"></a><span class="w">            </span><span class="n">received</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<a id="__codelineno-23-46" name="__codelineno-23-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-47" name="__codelineno-23-47"></a>
<a id="__codelineno-23-48" name="__codelineno-23-48"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">received</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-49" name="__codelineno-23-49"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">received</span><span class="p">;</span>
<a id="__codelineno-23-50" name="__codelineno-23-50"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-23-51" name="__codelineno-23-51"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-52" name="__codelineno-23-52"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition tip">
<p class="admonition-title">Awaitility</p>
<p>Because connector tests are usually asynchronous, <a href="https://github.com/awaitility/awaitility">awaitility</a>
provides a DSL to await on expressed assertions.</p>
</div>
<h3 id="concepts-contributing-connectors-common-tests-for-validating-the-connector">Common tests for validating the connector</h3>
<ul>
<li>Message consumption through incoming channels</li>
<li>Message producing through outgoing channels</li>
<li>Ack and failure handler strategies test</li>
<li>Message Context propagation test <code>LocalPropagationTest</code></li>
<li><code>HealthCheckTest</code></li>
<li><code>MessageConverterTest</code></li>
<li><code>TracingPropagationTest</code></li>
<li>Configuration test</li>
<li>Authentication test</li>
<li>Tests for</li>
</ul></section><section class="print-page" id="concepts-acknowledgement"><h1 id="concepts-acknowledgement-acknowledgement">Acknowledgement</h1>
<p>Acknowledgment is an essential concept in messaging. A message is
acknowledged when its processing or reception has been successful. It
allows the broker to move to the next message.</p>
<p>How acknowledgment is used, and the exact behavior in terms of retry and
resilience depends on the broker. For example, for Kafka, it would
commit the offset. For AMQP, it would inform the broker that the message
has been <em>accepted</em>.</p>
<p>Reactive Messaging supports acknowledgement. The default acknowledgement
depends on the method signature. Also, the acknowledgement policy can be
configured using the <code>@Acknowledgement</code> annotation.</p>
<h2 id="concepts-acknowledgement-chain-of-acknowledgment">Chain of acknowledgment</h2>
<p>If we reuse this example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-0-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">items</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;from&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reactive&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;messaging&quot;</span><span class="p">);</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="p">}</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">processed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">processed</span><span class="p">);</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The framework automatically acknowledges the message received from the
<code>sink</code> channel when the <code>consume</code> method returns. As a consequence, the
message received by the <code>process</code> method is acknowledged, and so on. In
other words, it creates a chain of acknowledgement - from the outbound
channel to the inbound channel.</p>
<p>When using connectors to receive and consume messages, the outbound
connector acknowledges the messages when they are dispatched
successfully to the broker. The acknowledgment chain would, as a result,
acknowledges the inbound connector, which would be able to send an
acknowledgment to the broker.</p>
<p>This chain of acknowledgment is automatically implemented when
processing payloads.</p>
<h2 id="concepts-acknowledgement-acknowledgment-when-using-messages">Acknowledgment when using Messages</h2>
<p>When using <code>Messages</code>, the user controls the acknowledgment, and so the
chain is not formed automatically. It gives you more flexibility about
when and how the incoming messages are acknowledged.</p>
<p>If you create a <code>Message</code> using the <code>with</code> method, is copy the
acknowledgment function from the incoming message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="c1">// The acknowledgement is forwarded, when the consumer</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="c1">// acknowledges the message, `in` will be acknowledged</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To have more control over the acknowledgment, you can create a brand new
<code>Message</code> and pass the acknowledgment function:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-2-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="c1">// called when the consumer acknowledges the message</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="c1">// return a CompletionStage completed when the</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="c1">// acknowledgment of the created message is</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="c1">// completed.</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="c1">// For immediate ack use:</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>However, you may need to create the acknowledgment chain, to acknowledge
the incoming message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-3-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processAndProduceNewMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="c1">// The acknowledgement is forwarded, when the consumer</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="c1">// acknowledges the message, `in` will be acknowledged</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">            </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">                </span><span class="c1">// Called when the consumer acknowledges the message</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">                </span><span class="c1">// ...</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">                </span><span class="c1">// Don&#39;t forget to acknowledge the incoming message:</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">            </span><span class="p">});</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To trigger the acknowledgment of the incoming message, use the <code>ack()</code>
method. It returns a <code>CompletionStage</code>, receiving <code>null</code> as value when
the acknowledgment has completed.</p>
<h2 id="concepts-acknowledgement-acknowledgment-when-using-streams">Acknowledgment when using streams</h2>
<p>When transforming streams of <code>Message</code>, the acknowledgment is delegated
to the user. It means that itâ€™s up to the user to acknowledge the
incoming messages:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-4-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">message</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toUpperCase</span><span class="p">()));</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In the previous example, we only generate a single message per incoming
message so that we can use the <code>with</code> method. It becomes more
sophisticated when grouping incoming messages or when each incoming
message produces multiple messages.</p>
<p>In the case of a stream of payloads, the default strategy acknowledges
the incoming messages before being processed by the method (regardless
of the outcome).</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-5-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">transformPayload</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">            </span><span class="c1">// The incoming messages are already acknowledged</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">String</span><span class="p">::</span><span class="n">toUpperCase</span><span class="p">);</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>For method receiving a single payload and producing a stream of payloads, it defaults to pre-processing acknowledgement.
However, in this case, post-processing is supported.
It waits for all the produced messages to be acknowledged before acknowledging the received one.
If one of the produced message is nacked, the received one is nacked immediately.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-6-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="c1">// Defaults to pre-processing, but post-processing is also supported</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="nd">@Acknowledgment</span><span class="p">(</span><span class="n">Acknowledgment</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">POST_PROCESSING</span><span class="p">)</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">transformPayload</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">one</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">items</span><span class="p">(</span><span class="n">one</span><span class="p">,</span><span class="w"> </span><span class="n">one</span><span class="p">);</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="concepts-acknowledgement-controlling-acknowledgement">Controlling acknowledgement</h2>
<p>The  <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/org/eclipse/microprofile/reactive/messaging/Acknowledgment.html'>Acknowledgment</a>
annotation lets you customize the default strategy presented in the
previous sections. The <code>@Acknowledgement</code> annotation takes a <em>strategy</em>
as parameter. Reactive Messaging proposed 4 strategies:</p>
<ul>
<li>
<p><code>POST_PROCESSING</code> - the acknowledgement of the incoming message is
    executed once the produced message is acknowledged.</p>
</li>
<li>
<p><code>PRE_PROCESSING</code> - the acknowledgement of the incoming message is
    executed before the message is processed by the method.</p>
</li>
<li>
<p><code>MANUAL</code> - the acknowledgement is done by the user.</p>
</li>
<li>
<p><code>NONE</code> - No acknowledgment is performed, neither manually or
    automatically.</p>
</li>
</ul>
<p>It is recommended to use <code>POST_PROCESSING</code> as it guarantees that the
full processing has completed before acknowledging the incoming message.
However, sometimes itâ€™s not possible, and this strategy is not available
if you manipulate streams of <code>Messages</code> or payloads.</p>
<p>The <code>PRE_PROCESSING</code> strategy can be useful to acknowledge a message
early in the process:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-5">5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-6">6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-7">7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-8">8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-7-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nd">@Acknowledgment</span><span class="p">(</span><span class="n">Acknowledgment</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">PRE_PROCESSING</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="c1">// The message wrapping the payload is already acknowledged</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="c1">// The default would have waited the produced message to be</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="c1">// acknowledged</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It cuts the acknowledgment chain, meaning that the rest of the
processing is not linked to the incoming message anymore. This strategy
is the default strategy when manipulating streams of payloads.</p>
<p>Refer to the <a href="#concepts-signatures">signature list</a> to determine
which strategies are available for a specific method signature and
whatâ€™s the default strategy.</p>
<h2 id="concepts-acknowledgement-negative-acknowledgement">Negative acknowledgement</h2>
<p>Messages can also be <em>nacked</em>, which indicates that the message was not
processed correctly. The <code>Message.nack</code> method indicates failing
processing (and supply the reason), and, as for successful
acknowledgment, the <em>nack</em> is propagated through the chain of messages.</p>
<p>If the message has been produced by a connector, this connector
implements specific behavior when receiving a <em>nack</em>. It can fail
(default), or ignore the failing, or implement a dead-letter queue
mechanism. Refer to the connector documentation for further details
about the available strategies.</p>
<p>If the message is sent by an emitter using the <code>send(P)</code> method, the
returned <code>CompletionStage</code> is completed <em>exceptionally</em> with the <em>nack</em>
reason.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-8-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">Emitter</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">emitPayload</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">completionStage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="s">&quot;hello&quot;</span><span class="p">);</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="n">completionStage</span><span class="p">.</span><span class="na">whenComplete</span><span class="p">((</span><span class="n">acked</span><span class="p">,</span><span class="w"> </span><span class="n">nacked</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">nacked</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">            </span><span class="c1">// the processing has failed</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Negative acknowledgment can be manual or automatic. If your method
handles instances of <code>Message</code> and the acknowledgment strategy is
<code>MANUAL</code>, you can nack a message explicitly. You must indicate the
reason (an exception) when calling the <code>nack</code> method. As for successful
acknowledgment, the <code>nack</code> returns a <code>CompletionStage</code> completed when
the <code>nack</code> has been processed.</p>
<p>If your method uses the <code>POST_PROCESSING</code> acknowledgment strategy, and
the method fails (either by throwing an exception or by producing a
failure), the message is automatically nacked with the caught exception:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-32">32</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-33">33</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-34">34</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-35">35</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-36">36</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-37">37</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-38">38</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-39">39</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-40">40</a></span>
<span class="normal"><a href="#concepts-acknowledgement-__codelineno-9-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">        </span><span class="c1">// Throwing an exception triggers a nack</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">);</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">        </span><span class="c1">// Returning null would skip the message (it will be acked)</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="p">}</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processAsync</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">        </span><span class="c1">// Returning a failing Uni triggers a nack</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">failure</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">));</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">        </span><span class="c1">// Throwing an exception triggers a nack</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">);</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;e&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">        </span><span class="c1">// Returning null would skip the message (it will be acked not nacked)</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">nullItem</span><span class="p">();</span>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">        </span><span class="c1">// returning `null` is invalid for method returning Unis, the message is nacked</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a>
<a id="__codelineno-9-40" name="__codelineno-9-40"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-9-41" name="__codelineno-9-41"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-blocking"><h1 id="concepts-blocking-blocking">@Blocking</h1>
<p>The <code>io.smallrye.reactive.messaging.annotations.Blocking</code> annotation can
be used on a method annotated with <code>@Incoming</code>, or <code>@Outgoing</code> to
indicate that the method should be executed on a worker pool:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-blocking-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nd">@Blocking</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If method execution does not need to be ordered, it can be indicated on
the <code>@Blocking</code> annotation:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-blocking-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-1-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nd">@Blocking</span><span class="p">(</span><span class="n">ordered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When unordered, the invocation can happen concurrently.</p>
<p>By default, use of <code>@Blocking</code> results in the method being executed in
the Vert.x worker pool. If itâ€™s desired to execute methods on a custom
worker pool, with specific concurrency needs, it can be defined on
<code>@Blocking</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-blocking-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#concepts-blocking-__codelineno-2-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;Y&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nd">@Blocking</span><span class="p">(</span><span class="s">&quot;my-custom-pool&quot;</span><span class="p">)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Specifying the concurrency for the above worker pool requires the
following configuration property to be defined:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>smallrye.messaging.worker.my-custom-pool.max-concurrency=3
</code></pre></div></td></tr></table></div>
<h2 id="concepts-blocking-supported-signatures">Supported signatures</h2>
<p><code>@Blocking</code> does not support every signature. The following table lists
the supported ones.</p>
<table>
<thead>
<tr>
<th>Shape</th>
<th>Signature</th>
<th>Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td>Publisher</td>
<td><code>@Outgoing("in") @Blocking O generator()</code></td>
<td>Invokes the generator from a worker thread. If <code>ordered</code> is set to <code>false</code>, the generator can be called concurrently.</td>
</tr>
<tr>
<td>Publisher</td>
<td><code>@Outgoing("in")  @Blocking  Message&lt;O&gt; generator()</code></td>
<td>Invokes the generator from a worker thread. If <code>ordered</code> is set to <code>false</code>, the generator can be called concurrently.</td>
</tr>
<tr>
<td>Processor</td>
<td><code>@Incoming("in") @Outgoing("bar") @Blocking O process(I in)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Processor</td>
<td><code>@Incoming("in") @Outgoing("bar") @Blocking Message&lt;O&gt; process(I in)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Subscriber</td>
<td><code>@Incoming("in") @Blocking void consume(I in)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Subscriber</td>
<td><code>@Incoming("in") @Blocking Uni&lt;Void&gt; consume(I in)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Subscriber</td>
<td><code>@Incoming("in") @Blocking Uni&lt;Void&gt; consume(Message&lt;I&gt; msg)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Subscriber</td>
<td><code>@Incoming("in") @Blocking CompletionStage&lt;Void&gt; consume(I in)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
<tr>
<td>Subscriber</td>
<td><code>@Incoming("in") @Blocking CompletionStage&lt;Void&gt; consume(Message&lt;I&gt; msg)</code></td>
<td>Invokes the method on a worker thread. If <code>ordered</code> is set to <code>false</code>, the method can be called concurrently.</td>
</tr>
</tbody>
</table>
<p>When a method can be called concurrently, the max concurrency depends on
the number of threads from the worker thread pool.</p>
<h2 id="concepts-blocking-using-iosmallryecommonannotationblocking">Using io.smallrye.common.annotation.Blocking</h2>
<p><code>io.smallrye.common.annotation.Blocking</code> is another annotation with the
same semantic. <code>io.smallrye.common.annotation.Blocking</code> is used by
multiple SmallRye projects and Quarkus.</p>
<p>SmallRye Reactive Messaging also supports
<code>io.smallrye.common.annotation.Blocking</code>. However,
<code>io.smallrye.common.annotation.Blocking</code> does not allow configuring the
ordering (it defaults to <code>ordered=true</code>).</p>
<p>When both annotations are used,
<code>io.smallrye.reactive.messaging.annotations.Blocking</code> is preferred.</p></section><section class="print-page" id="concepts-signatures"><h1 id="concepts-signatures-supported-signatures">Supported signatures</h1>
<p>The following tables list the supported method signatures and indicate
the various supported features. For instance, they indicate the default
and available acknowledgement strategies (when applicable).</p>
<h2 id="concepts-signatures-method-signatures-to-generate-data">Method signatures to generate data</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Invocation time</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Outgoing Publisher&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Publisher&lt;O&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Multi&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Multi&lt;O&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Flow.Publisher&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Flow.Publisher&lt;O&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing PublisherBuilder&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing PublisherBuilder&lt;O&gt; method()</code> `</td>
<td>Called once at <em>assembly</em> time</td>
</tr>
<tr>
<td><code>@Outgoing Message&lt;O&gt; method()</code> `</td>
<td>Called for every downstream request, sequentially</td>
</tr>
<tr>
<td><code>@Outgoing O method()</code> `</td>
<td>Called for every downstream request, sequentially</td>
</tr>
<tr>
<td><code>@Outgoing CompletionStage&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called for every downstream request, sequentially (After the completion of the last returned CompletionStage)</td>
</tr>
<tr>
<td><code>@Outgoing CompletionStage&lt;O&gt; method()</code> `</td>
<td>Called for every downstream request, , sequentially (After the completion of the last returned CompletionStage)</td>
</tr>
<tr>
<td><code>@Outgoing Uni&lt;Message&lt;O&gt;&gt; method()</code> `</td>
<td>Called for every downstream request, sequentially (After the completion of the last returned Uni)</td>
</tr>
<tr>
<td><code>@Outgoing Uni&lt;O&gt; method()</code> `</td>
<td>Called for every downstream request, , sequentially (After the completion of the last returned Uni)</td>
</tr>
</tbody>
</table>
<h2 id="concepts-signatures-method-signatures-to-consume-data">Method signatures to consume data</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Invocation time</th>
<th>Supported Acknowledgement Strategies</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Incoming void method(I p)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming CompletionStage&lt;?&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called for every incoming message (sequentially)</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming CompletionStage&lt;?&gt; method(I p)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, PRE_PROCESSING, NONE</td>
</tr>
<tr>
<td><code>@Incoming Uni&lt;?&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called for every incoming message (sequentially)</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming Uni&lt;?&gt; method(I p)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, PRE_PROCESSING, NONE</td>
</tr>
<tr>
<td><code>@Incoming Subscriber&lt;Message&lt;I&gt;&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, POST_PROCESSING, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming Subscriber&lt;I&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming Flow.Subscriber&lt;Message&lt;I&gt;&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, POST_PROCESSING, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming Flow.Subscriber&lt;I&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming SubscriberBuilder&lt;Message&lt;I&gt;, ?&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, POST_PROCESSING, NONE, PRE_PROCESSING</td>
</tr>
<tr>
<td><code>@Incoming SubscriberBuilder&lt;I, ?&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, POST_PROCESSING, NONE, PRE_PROCESSING</td>
</tr>
</tbody>
</table>
<h2 id="concepts-signatures-method-signatures-to-process-data">Method signatures to process data</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Invocation time</th>
<th>Supported Acknowledgement Strategies</th>
<th>Metadata Propagation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Outgoing @Incoming Message&lt;O&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called for every incoming message (sequentially)</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming O method(I payload)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming CompletionStage&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called for every incoming message (sequentially)</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming CompletionStage&lt;O&gt; method(I payload)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Uni&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called for every incoming message (sequentially)</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Uni&lt;O&gt; method(I payload)</code></td>
<td>Called for every incoming payload (sequentially)</td>
<td><em>POST_PROCESSING</em>, NONE, PRE_PROCESSING</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Processor&lt;Message&lt;I&gt;, Message&lt;O&gt;&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Processor&lt;I, O&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Processor&lt;Message&lt;I&gt;, Message&lt;O&gt;&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Processor&lt;I, O&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming ProcessorBuilder&lt;Message&lt;I&gt;, Message&lt;O&gt;&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming ProcessorBuilder&lt;I, O&gt; method()</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Publisher&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Publisher&lt;O&gt; method(I payload)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Multi&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Multi&lt;O&gt; method(I payload)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Publisher&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Publisher&lt;O&gt; method(I payload)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>automatic</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming PublisherBuilder&lt;Message&lt;O&gt;&gt; method(Message&lt;I&gt; msg)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, PRE_PROCESSING, NONE</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming PublisherBuilder&lt;O&gt; method(I payload)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>automatic</td>
</tr>
</tbody>
</table>
<h2 id="concepts-signatures-method-signatures-to-manipulate-streams">Method signatures to manipulate streams</h2>
<table>
<thead>
<tr>
<th>Signature</th>
<th>Invocation time</th>
<th>Supported Acknowledgement Strategies</th>
<th>Metadata Propagation</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Outgoing @Incoming Publisher&lt;Message&lt;O&gt;&gt; method(Publisher&lt;Message&lt;I&gt;&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Publisher&lt;O&gt; method(Publisher&lt;I&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Multi&lt;Message&lt;O&gt;&gt; method(Multi&lt;Message&lt;I&gt;&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Multi&lt;O&gt; method(Multi&lt;I&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Publisher&lt;Message&lt;O&gt;&gt; method(Flow.Publisher&lt;Message&lt;I&gt;&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming Flow.Publisher&lt;O&gt; method(Flow.Publisher&lt;I&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>PRE_PROCESSING</em>, NONE</td>
<td>not supported</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming PublisherBuilder&lt;Message&lt;O&gt;&gt; method(PublisherBuilder&lt;Message&lt;I&gt;&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td><em>MANUAL</em>, NONE, PRE_PROCESSING</td>
<td>manual</td>
</tr>
<tr>
<td><code>@Outgoing @Incoming PublisherBuilder&lt;O&gt; method(PublisherBuilder&lt;I&gt; pub)</code></td>
<td>Called once at <em>assembly</em> time</td>
<td>NONE, PRE_PROCESSING</td>
<td>not supported</td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When processing <code>Message</code>, it is often required to <em>chain</em> the incoming
<code>Message</code> to enable post-processing acknowledgement and metadata
propagation. Use the <code>with</code> (like <code>withPayload</code>) methods from the
incoming message, so it copies the metadata and ack/nack methods. It
returns a new <code>Message</code> with the right content.</p>
</div></section><section class="print-page" id="concepts-skipping"><h1 id="concepts-skipping-skipping-messages">Skipping messages</h1>
<p>Sometimes you receive a message and donâ€™t want to produce an output
message. To handle this, you have several choices:</p>
<ol>
<li>for method processing single message or payload, producing <code>null</code>
    would produce an ignored message (not forwarded)</li>
<li>for method processing streams, you can generate an <em>empty</em> stream.</li>
</ol>
<h2 id="concepts-skipping-skipping-a-single-item">Skipping a single item</h2>
<p>To skip a single message or payload, return <code>null</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-skipping-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-0-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1">// Skip when processing payload synchronously - returning `null`</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">processPayload</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="c1">// Skip when processing message synchronously - returning `null`</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="p">}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="c1">// Skip when processing payload asynchronously - returning a `Uni` with a `null` value</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayloadAsync</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">        </span><span class="c1">// Important, you must not return `null`, but a `null` content</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">nullItem</span><span class="p">();</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="p">}</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="c1">// Skip when processing message asynchronously - returning a `Uni` with a `null` value</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessageAsync</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">nullItem</span><span class="p">();</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">()));</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="concepts-skipping-skipping-in-a-stream">Skipping in a stream</h2>
<p>To skip a message or payload when manipulating a stream, emit an <em>empty</em> <code>Multi</code> (or <code>Publisher</code>):</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-skipping-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#concepts-skipping-__codelineno-1-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out-1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayload</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">empty</span><span class="p">();</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="p">}</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out-2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">();</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">empty</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">()));</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="p">}</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out-3&quot;</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">processPayloadStream</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">            </span><span class="p">.</span><span class="na">select</span><span class="p">().</span><span class="na">where</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transform</span><span class="p">(</span><span class="n">String</span><span class="p">::</span><span class="n">toUpperCase</span><span class="p">);</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="p">}</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out-4&quot;</span><span class="p">)</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">processMessageStream</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stream</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">            </span><span class="p">.</span><span class="na">select</span><span class="p">().</span><span class="na">where</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">equalsIgnoreCase</span><span class="p">(</span><span class="s">&quot;skip&quot;</span><span class="p">))</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">            </span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">transform</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toUpperCase</span><span class="p">()));</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-converters"><h1 id="concepts-converters-message-converters">Message Converters</h1>
<p>SmallRye Reactive Messaging supports <em>message converters</em>, allowing to
transform an incoming message into a version accepted by the method. If
the incoming messages or payload does not match the invoked methodâ€™s
expectation, SmallRye Reactive Messaging looks for a suitable converter.
If found, it converts the incoming message with this converter.</p>
<p>Converters can have multiple purposes, but the main use case is about
transforming the messageâ€™s payload:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-converters-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConverter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">MessageConverter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canConvert</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span><span class="c1">// Checks whether this converter can be used to convert</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">        </span><span class="c1">// the incoming message into a message containing a payload</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">        </span><span class="c1">// of the type `target`.</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">getClass</span><span class="p">().</span><span class="na">equals</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">Person</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">convert</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="c1">// Convert the incoming message into the new message.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="c1">// It&#39;s important to build the new message **from**</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="c1">// the received one.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Person</span><span class="p">((</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()));</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To provide a converter, implement a bean exposing the <code>MessageConverter</code>
interface. The <code>canConvert</code> method is called during the lookup and
verifies if it can handle the conversion. The <code>target</code> type is the
expected payload type. If the converter returns <code>true</code> to <code>canConvert</code>,
SmallRye Reactive Messaging calls the <code>convert</code> method to proceed to the
conversion.</p>
<p>The previous converter can be used in application like the following, to
convert <code>Message&lt;String&gt;</code> to <code>Message&lt;Person&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-converters-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-converters-__codelineno-1-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;persons&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">source</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">items</span><span class="p">(</span><span class="s">&quot;Neo&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Morpheus&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Trinity&quot;</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="p">}</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="c1">// The messages need to be converted as they are emitted as Message&lt;String&gt;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// and consumed as Message&lt;Person&gt;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;persons&quot;</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Person</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Converters work for all supported method signatures. However, the
signature must be well-formed to allow the extraction of the expected
payload type. Wildcards and raw types do not support conversion. If the
expected payload type cannot be extracted, or no converter fits, the
message is passed as received.</p>
<p>If multiple suitable converters are present, implementations should
override the <code>getPriority</code> method returning the priority. The default
priority is <code>100</code>. The converter lookup invokes converters with higher
priority (from the least value to the greatest) first.</p></section><section class="print-page" id="concepts-keyed-multi"><h1 id="concepts-keyed-multi-using-keyedmulti">Using <code>KeyedMulti</code></h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p><code>KeyedMulti</code> is an experimental feature.</p>
</div>
<p>When implementing a data streaming application, it's common to handle messages partitioned using a <em>key</em>.
In this case, your stream manipulation often has to 1) group by key and 2) do the manipulation.
Reactive Messaging can do the first step for you and reduce the code complexity.
To do this, it injects <code>io.smallrye.reactive.messaging.keyed.KeyedMulti</code> in your method instead of a <em>bare</em> <code>Multi</code>.</p>
<p>For example, imagine the following stream, represented as <code>key:value</code>: <code>"a:1", "b:1", "a:2", "b:2", "b:3"...</code>
Then, let's consider the following method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-0-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">reshape</span><span class="p">(</span><span class="n">KeyedMulti</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">multi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// Called once per key and receive the stream of value for that specific key</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">multi</span><span class="p">.</span><span class="na">key</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">multi</span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">scan</span><span class="p">(</span><span class="n">AtomicInteger</span><span class="p">::</span><span class="k">new</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">        </span><span class="n">i</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">    </span><span class="p">})</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">            </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">()));</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Reactive Messaging automatically extracts the key and value from the incoming stream and invokes the method for each key.
The received <code>KeyedMulti</code> represent the stream for each key.
The <code>key()</code> method returns the extracted key.</p>
<p>The key and value can be extracted from the payload but also (and often) from the message's metadata.</p>
<p>When using Kafka, it automatically extracts the key/value from the Kafka records.
In the other cases, or if you need custom extraction, you can implement your own <code>io.smallrye.reactive.messaging.keyed.KeyValueExtractor</code>.
Implementations are exposed <code>ApplicationScoped</code> beans, and are used to extract the key and value.
The following implementation extracts the key and value from payloads structured as "key:value":</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.keyed.KeyValueExtractor</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KeyValueExtractorFromPayload</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KeyValueExtractor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">canExtract</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">keyType</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">valueType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="c1">// Called for the first message of the stream to select the extractor.</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">        </span><span class="c1">// Here we only check for the type, but the logic can be more complex</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">keyType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">valueType</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">extractKey</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">keyType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">));</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">extractValue</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Type</span><span class="w"> </span><span class="n">valueType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toString</span><span class="p">();</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">string</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="n">string</span><span class="p">.</span><span class="na">indexOf</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The extractor selection uses the <code>canExtract</code> method.
When multiple extractors are available, you can implement the <code>getPriority()</code> method to give a lower priority.
Default extractors have the priority 100.
So, if you have a custom extractor with the priority 99, it will be used (if it replies <code>true</code> to the <code>canExtract</code> call).
In addition, you can use the <code>io.smallrye.reactive.messaging.keyed.Keyed</code> annotation to indicate the class of the extractor to use.
The extractor must still be a CDI bean, but the <code>canExtract</code> method is not called, and priority does not matter:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-6">6</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-7">7</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-8">8</a></span>
<span class="normal"><a href="#concepts-keyed-multi-__codelineno-2-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">reshape</span><span class="p">(</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">        </span><span class="nd">@Keyed</span><span class="p">(</span><span class="n">KeyValueExtractorFromPayload</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span><span class="n">KeyedMulti</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">multi</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">multi</span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">scan</span><span class="p">(</span><span class="n">AtomicInteger</span><span class="p">::</span><span class="k">new</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">        </span><span class="n">i</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">();</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">    </span><span class="p">}).</span><span class="na">map</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Integer</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="na">get</span><span class="p">()));</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-decorators"><h1 id="concepts-decorators-channel-decorators">Channel Decorators</h1>
<p>SmallRye Reactive Messaging supports decorating reactive streams
of incoming and outgoing channels for implementing cross-cutting
concerns such as monitoring, tracing or message interception.</p>
<p>Two symmetrical APIs are proposed for decorating publisher and subscriber channels,
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/PublisherDecorator.html'>PublisherDecorator</a>
and <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/SubscriberDecorator.html'>SubscriberDecorator</a> respectively.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><code>@Incoming</code> channels and channels bound to an outbound connector are both <code>Subscriber</code>s.
Conversely <code>@Outgoing</code> channels and channels bound to an inbound connector are <code>Publisher</code>s.</p>
</div>
<p>For example, to provide a decorator which counts consumed messages from incoming connector,
implement a bean exposing the interface <code>PublisherDecorator</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-decorators-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-0-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConsumedMessageDecorator</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">PublisherDecorator</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">AtomicLong</span><span class="o">&gt;</span><span class="w"> </span><span class="n">counters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">decorate</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">publisher</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channelName</span><span class="p">,</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isConnector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isConnector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">            </span><span class="n">AtomicLong</span><span class="w"> </span><span class="n">counter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicLong</span><span class="p">();</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">            </span><span class="n">counters</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">channelName</span><span class="p">,</span><span class="w"> </span><span class="n">counter</span><span class="p">);</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">publisher</span><span class="p">.</span><span class="na">onItem</span><span class="p">().</span><span class="na">invoke</span><span class="p">(</span><span class="n">counter</span><span class="p">::</span><span class="n">incrementAndGet</span><span class="p">);</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">publisher</span><span class="p">;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getPriority</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">getMessageCount</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">counters</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">channel</span><span class="p">).</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Decorators' <code>decorate</code> method is called only once per channel at application deployment when graph wiring is taking place.
Decorators are very powerful because they receive the stream of messages (Mutiny <code>Multi&lt;Message&lt;?&gt;&gt;</code>)
and potentially return a new stream of messages.</p>
<p>Note that if a decorator is available it will be called on every channel.
The <code>decorate</code> method receives the channel name and whether the channel is a connector or not as parameters.
Decorators are called ordered from highest to lowest priority (from the least value to the greatest),
obtained using the <code>jakarta.enterprise.inject.spi.Prioritized#getPriority</code> method.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>SubscriberDecorator</code> receive a list of channel names because <code>@Incoming</code> annotation is repeatable
and consuming methods can be linked to multiple channels.</p>
</div>
<h2 id="concepts-decorators-intercepting-incoming-and-outgoing-messages">Intercepting Incoming and Outgoing Messages</h2>
<p>Decorators (<code>PublisherDecorator</code> and <code>SubscriberDecorator</code>) can be used to intercept and alter messages, both on incoming and outgoing channels.</p>
<p>Smallrye Reactive Messaging allows defining intercepting incoming and outgoing messages for a specific channel, using
<code>IncomingInterceptor</code> and <code>OutgoingInterceptor</code> respectively.</p>
<p>Only one interceptor is allowed to be bound for interception per outgoing channel.
If no interceptors are found with a <code>@Identifier</code> but a <code>@Default</code> one is available, it is used.
When multiple interceptors are available, the bean with the highest priority is used.</p>
<h3 id="concepts-decorators-incominginterceptor"><code>IncomingInterceptor</code></h3>
<p>To provide an incoming interceptor implement a bean exposing the interface <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/IncomingInterceptor.html'>IncomingInterceptor</a>, qualified with a <code>@Identifier</code> with the channel name to intercept.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-decorators-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-1-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">interceptors</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.IncomingInterceptor</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;channel-a&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyIncomingInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">IncomingInterceptor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">afterMessageReceive</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="s">&quot;changed &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">());</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessageAck</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="c1">// Called after message ack</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessageNack</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">failure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">        </span><span class="c1">// Called after message nack</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>An <code>IncomingInterceptor</code> can implement these three methods:</p>
<ul>
<li><code>Message&lt;?&gt; afterMessageReceive(Message&lt;?&gt; message)</code> : Called after receiving the message from an incoming connector.
  The message can be altered by returning a new message from this method. The modified message will be consumed in incoming channels.</li>
<li><code>void onMessageAck(Message&lt;?&gt; message)</code> : Called after message acknowledgment.</li>
<li><code>void onMessageNack(Message&lt;?&gt; message, Throwable failure)</code> : Called after message negative-acknowledgment.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are willing to adapt an incoming message payload to fit a consuming method receiving type,
you can use <a href="#concepts-converters"><code>MessageConverter</code></a>s.</p>
</div>
<h3 id="concepts-decorators-outgoinginterceptor"><code>OutgoingInterceptor</code></h3>
<p>To provide an outgoing interceptor implement a bean exposing the interface <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/OutgoingInterceptor.html'>OutgoingInterceptor</a>, qualified with a <code>@Identifier</code> with the channel name to intercept.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-decorators-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#concepts-decorators-__codelineno-2-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">interceptors</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.OutgoingInterceptor</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.OutgoingMessageMetadata</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;channel-a&quot;</span><span class="p">)</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyOutgoingInterceptor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">OutgoingInterceptor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">onMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="s">&quot;changed &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getPayload</span><span class="p">());</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessageAck</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="n">message</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">OutgoingMessageMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="na">getResult</span><span class="p">());</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onMessageNack</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">failure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>An <code>OutgoingInterceptor</code> can implement these three methods:</p>
<ul>
<li><code>Message&lt;?&gt; beforeMessageSend(Message&lt;?&gt; message)</code> : Called before passing the message to the outgoing connector for transmission.
The message can be altered by returning a new message from this method.</li>
<li><code>void onMessageAck(Message&lt;?&gt; message)</code> : Called after message acknowledgment.
This callback can access <code>OutgoingMessageMetadata</code> which will hold the result of the message transmission to the broker, if supported by the connector. This is only supported by MQTT and Kafka connectors.</li>
<li><code>void onMessageNack(Message&lt;?&gt; message, Throwable failure)</code> : Called after message negative-acknowledgment.</li>
</ul></section><section class="print-page" id="concepts-broadcast"><h1 id="concepts-broadcast-broadcast">Broadcast</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p><code>@Broadcast</code> is an experimental feature.</p>
</div>
<p>By default, messages transiting in a channel are only dispatched to a
single consumer. Having multiple consumers is considered as an error,
and is reported at deployment time.</p>
<p>The <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/annotations/Broadcast.html'>Broadcast</a>
annotation changes this behavior and indicates that messages transiting
in the channel are dispatched to all the consumers. <code>@Broadcast</code> must be
used with the <code>@Outgoing</code> annotation:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-broadcast-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-0-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nd">@Broadcast</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume1</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In the previous example, both consumers get the messages.</p>
<p>You can also control the number of consumers to wait before starting to
dispatch the messages. This allows waiting for the complete graph to be
woven:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-broadcast-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-broadcast-__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nd">@Broadcast</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="p">}</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume1</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume2</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Inbound connectors also support a <code>broadcast</code> attribute that allows
broadcasting the messages to multiple downstream subscribers.</p>
</div>
<h1 id="concepts-broadcast-use-with-emitter">Use with Emitter</h1>
<p>For details on how to use <code>@Broadcast</code> with <code>Emitter</code> see the
<a href="#concepts-emitter-emitter-and-broadcast">documentation</a>.</p></section><section class="print-page" id="concepts-merge"><h1 id="concepts-merge-merge-channels">Merge channels</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p><code>@Merge</code> is an experimental feature.</p>
</div>
<p>By default, messages transiting in a channel can arise from a single
producer. Having multiple producers is considered erroneous and is
reported at deployment time.</p>
<p>The <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/annotations/Merge.html'>Merge</a>
annotation changes this behavior and indicates that a channel can have
multiple producers. <code>@Merge</code> must be used with the <code>@Incoming</code>
annotation:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-merge-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-merge-__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">increment</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="p">}</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">multiply</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="p">}</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="nd">@Merge</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">getAll</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="c1">//...</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In the previous example, the consumer gets all the messages (from both
producers).</p>
<p>The <code>@Merge</code> annotation allows configuring how the incoming messages
(from the different producers) are merged into the channel. The <code>mode</code>
attribute allows configuring this behavior:</p>
<ul>
<li>
<p><code>ONE</code> picks a single producer, discarding the other producer;</p>
</li>
<li>
<p><code>MERGE</code> (default) gets all the messages as they come, without any
    defined order. Messages from different producers may be interleaved.</p>
</li>
<li>
<p><code>CONCAT</code> concatenates the producers. The messages from one producer
    are received until the messages from other producers are received.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Outbound connectors also support a <code>merge</code> attribute that allows
consuming the messages to multiple upstreams. It will dispatch all the
received messages.</p>
</div></section><section class="print-page" id="concepts-incoming-concurrency"><h1 id="concepts-incoming-concurrency-incoming-channel-concurrency">Incoming Channel Concurrency</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Incoming channel <code>concurrency</code> config is an experimental feature.</p>
</div>
<p>The <code>concurrency</code> attribute for incoming channels provides a mechanism to enable concurrent non-blocking processing of incoming messages.
When applied to a channel, this attribute specifies the number of copies of that channel to be created and wired to the processing method,
allowing multiple messages to be processed concurrently.</p>
<p>For example, concurrency configuration for a Kafka incoming channel the configuration will look like:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.my-channel.connector</span><span class="o">=</span><span class="s">smallrye-kafka</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.my-channel.topic</span><span class="o">=</span><span class="s">orders</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.my-channel.value.deserializer</span><span class="o">=</span><span class="s">org.apache.kafka.common.serialization.DoubleDeserializer</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.my-channel.concurrency</span><span class="o">=</span><span class="s">4</span>
</code></pre></div></td></tr></table></div>
<p>In this example, there will be 4 copies of the <code>my-channel</code> running concurrently, with distinctive internal channel names,
<code>my-channel$1</code>, <code>my-channel$2</code>, etc. but all registered with the name <code>my-channel</code> to the <code>ChannelRegistry</code>.</p>
<div class="admonition info">
<p class="admonition-title">Kafka connector <code>partitions</code></p>
<p>This is essentially very similar to the Kafka connector <code>partitions</code> configuration, but addresses some its limitations.
Using <code>partitions</code> config in Kafka connector, channels are merged into the downstream message processor
(method annotated with <code>@Incoming</code> or an injected channel) which is therefore called sequentially.
This prevents concurrently processing messages from multiple partitions.</p>
<p>The <code>concurrency</code> mechanism effectively allows polling Kafka partitions from separate clients
and concurrently processing records while preserving the in-partition order.</p>
</div>
<p>Copy channels inherit all configuration attributes of the main channel config.
Per-copy channel attributes can be configured separately using the <code>$</code> separated channel names: <code>mp.messaging.incoming.my-channel$1.attribute</code>.</p>
<p>For example, the following AMQP 1.0 channel defines 3 channels each with a different selector:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-5">5</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-6">6</a></span>
<span class="normal"><a href="#concepts-incoming-concurrency-__codelineno-1-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.incoming.data.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.data.address</span><span class="o">=</span><span class="s">address</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">mp.messaging.incoming.data.durable</span><span class="o">=</span><span class="s">false</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">mp.messaging.incoming.data.concurrency</span><span class="o">=</span><span class="s">3</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.incoming.data$1.selector</span><span class="o">=</span><span class="s">x=&#39;foo&#39;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="na">mp.messaging.incoming.data$2.selector</span><span class="o">=</span><span class="s">x=&#39;bar&#39;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="na">mp.messaging.incoming.data$3.selector</span><span class="o">=</span><span class="s">x=&#39;baz&#39;</span>
</code></pre></div></td></tr></table></div>
<p>While the <code>concurrency</code> attribute is applicable to channels of any connector type,
the channel implementation may need to take this configuration into account and adjust the threading accordingly.
Connectors based on Vert.x event loop create a new event loop context per copy-channel to dispatch messages on distinct contexts.</p>
<div class="admonition important">
<p class="admonition-title">Non-blocking processing</p>
<p>Note that while this allows concurrent processing, messages are still dispatched on Vert.x event loop threads, and should not be blocked.</p>
</div>
<p>Otherwise, connectors treat copy channels as independent channels.
For example, health check reports are registered separately for each copy-channel.</p></section><section class="print-page" id="concepts-incomings"><h1 id="concepts-incomings-multiple-incoming-channels">Multiple Incoming Channels</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Multiple <code>@Incomings</code> is an experimental feature.</p>
</div>
<p>The <code>@Incoming</code> annotation is repeatable. It means that the method
receives the messages transiting on every listed channels, in no
specific order:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-incomings-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-incomings-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-incomings-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-incomings-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-incomings-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-incomings-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;channel-1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;channel-2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// get messages from channel-1 and channel-2</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-outgoings"><h1 id="concepts-outgoings-multiple-outgoing-channels">Multiple Outgoing Channels</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Multiple <code>@Outgoings</code> is an experimental feature.</p>
</div>
<p>The <code>@Outgoing</code> annotation is repeatable. It means that the method
dispatches outgoing messages to multiple listed channels:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-outgoings-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out2&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="c1">// send messages from channel-in to both channel-out1 and channel-out2</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The default behaviour is same as the <a href="#concepts-broadcast">@Broadcast annotation</a>,
meaning that outbound messages are dispatched to all listed outgoing channels.</p>
<p>However, different dispatching mechanism can be employed:</p>
<h2 id="concepts-outgoings-selectively-dispatching-messages-using-targeted-messages">Selectively dispatching messages using <code>Targeted</code> messages</h2>
<p>You can selectively dispatch messages to multiple outgoings by returning
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/Targeted.html'>Targeted</a> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-outgoings-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-1-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out1&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out2&quot;</span><span class="p">)</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out3&quot;</span><span class="p">)</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">Targeted</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="c1">// send messages from channel-in to both channel-out1 and channel-out2</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">    </span><span class="n">Targeted</span><span class="w"> </span><span class="n">targeted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Targeted</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;out1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Price: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">price</span><span class="p">,</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">            </span><span class="s">&quot;out2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Quote: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">price</span><span class="p">);</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">price</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">90.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">targeted</span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;out3&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">price</span><span class="p">);</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">targeted</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this example, three outgoing channels are declared on the <code>process</code> method
but in some condition channel <code>out3</code> does not receive any messages.</p>
<div class="admonition important">
<p class="admonition-title">Coordinated acknowledgements</p>
<p><code>Targeted</code> return types coordinate acknowledgements between outgoing messages
and the incoming message, therefore the incoming message will be ack'ed only
when all outgoing messages are ack'ed.</p>
</div>
<p>In cases where you need to consume <code>Message</code> and handle metadata propagation
more finely you can use <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/TargetedMessages.html'>TargetedMessages</a>
which is a <code>Message</code> type:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-outgoings-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-2-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;channel-in&quot;</span><span class="p">)</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;channel-out1&quot;</span><span class="p">)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;channel-out2&quot;</span><span class="p">)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;channel-out3&quot;</span><span class="p">)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">TargetedMessages</span><span class="w"> </span><span class="nf">processMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="c1">// send messages from channel-in to both channel-out1 and channel-out2</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Messages</span><span class="p">.</span><span class="na">chain</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">            </span><span class="p">.</span><span class="na">with</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;channel-out1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toUpperCase</span><span class="p">()),</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">                    </span><span class="s">&quot;channel-out2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">toLowerCase</span><span class="p">())));</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Note that in this case coordinated acknowledgements is handled explicitly
using <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/Messages.html'>Messages</a> utility.</p>
<h2 id="concepts-outgoings-branching-outgoing-channels-with-multisplitter">Branching outgoing channels with <code>MultiSplitter</code></h2>
<p>In stream transformer processors it can be useful to branch out an incoming
stream into different sub-streams, based on some conditions.</p>
<p>When consuming a <code>Multi</code>, you can use the <code>Multi.split</code>
(see <a href="https://smallrye.io/smallrye-mutiny/latest/guides/multi-split/">Mutiny documentation</a>)
operation to define multiple branches.
The stream transformer method with multiple outgoings must return a
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/mutiny/4.16.0/io/smallrye/mutiny/operators/multi/split/MultiSplitter.html'>MultiSplitter</a>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-outgoings-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#concepts-outgoings-__codelineno-3-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kd">enum</span><span class="w"> </span><span class="n">Caps</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="n">ALL_CAPS</span><span class="p">,</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">ALL_LOW</span><span class="p">,</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">MIXED</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink1&quot;</span><span class="p">)</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink2&quot;</span><span class="p">)</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink3&quot;</span><span class="p">)</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kd">public</span><span class="w"> </span><span class="n">MultiSplitter</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Caps</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">reshape</span><span class="p">(</span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">split</span><span class="p">(</span><span class="n">Caps</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toLowerCase</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Caps</span><span class="p">.</span><span class="na">ALL_LOW</span><span class="p">;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Objects</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Caps</span><span class="p">.</span><span class="na">ALL_CAPS</span><span class="p">;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Caps</span><span class="p">.</span><span class="na">MIXED</span><span class="p">;</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="p">});</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>In this case the number of outgoing channels must match the number of branches given to <code>split</code> operation.
Outgoing channels will be tried to be matched to branch identifier enum <code>toString</code> ignoring case.
If not all branches are matched, it will fall back to one-by-one matching depending on the order of outgoing channel declarations and enum ordinals.</p></section><section class="print-page" id="concepts-testing"><h1 id="concepts-testing-testing-your-application">Testing your application</h1>
<p>Itâ€™s not rare to have to test your application but deploying the
infrastructure can be cumbersome. While Docker or Test Containers have
improved the testing experience, you may want to <em>mock</em> this
infrastructure.</p>
<p>SmallRye Reactive Messaging proposes an <em>in-memory</em> connector for this
exact purpose. It allows switching the connector used for a channel with
an <em>in-memory</em> connector. This in-memory connector provides a way to
send messages to incoming channels, or check the received messages for
outgoing channels.</p>
<p>To use the <em>in-memory</em> connector, you need to add the following
dependency to your project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-testing-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-in-memory<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">  </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>Then, in a test, you can do something like:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-testing-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-1-51">51</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">testing</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Any</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.AfterAll</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Assertions</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.BeforeAll</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.junit.jupiter.api.Test</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.memory.InMemoryConnector</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.memory.InMemorySink</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.memory.InMemorySource</span><span class="p">;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyTest</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="c1">// 1. Switch the channels to the in-memory connector:</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nd">@BeforeAll</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">switchMyChannels</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">switchIncomingChannelsToInMemory</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">);</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">switchOutgoingChannelsToInMemory</span><span class="p">(</span><span class="s">&quot;processed-prices&quot;</span><span class="p">);</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="c1">// 2. Don&#39;t forget to reset the channel after the tests:</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="nd">@AfterAll</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">revertMyChannels</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="w">    </span><span class="c1">// 3. Inject the in-memory connector in your test,</span>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="c1">// or use the bean manager to retrieve the instance</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">    </span><span class="nd">@Any</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">    </span><span class="n">InMemoryConnector</span><span class="w"> </span><span class="n">connector</span><span class="p">;</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">test</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">        </span><span class="c1">// 4. Retrieves the in-memory source to send message</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">        </span><span class="n">InMemorySource</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="na">source</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">);</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">        </span><span class="c1">// 5. Retrieves the in-memory sink to check what is received</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">        </span><span class="n">InMemorySink</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">connector</span><span class="p">.</span><span class="na">sink</span><span class="p">(</span><span class="s">&quot;processed-prices&quot;</span><span class="p">);</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">        </span><span class="c1">// 6. Send fake messages:</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">        </span><span class="n">prices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">        </span><span class="n">prices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">        </span><span class="n">prices</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">        </span><span class="c1">// 7. Check you have received the expected messages</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">        </span><span class="n">Assertions</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">results</span><span class="p">.</span><span class="na">received</span><span class="p">().</span><span class="na">size</span><span class="p">());</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When switching a channel to the in-memory connector, all the
configuration properties are ignored.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This connector has been designed for testing purpose only.
Switching the channel to in-memory connector means that the
original connector is not invoked at all during tests.
Therefore, if your code depends on a specific connector behaviour
or a custom metadata you need to simulate those in your tests.</p>
</div>
<p>The <em>switch</em> methods return <code>Map&lt;String, String&gt;</code> instances containing
the set properties. While these system properties are already set, you
can retrieve them and pass them around, for example if you need to start
an external process with these properties:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-testing-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#concepts-testing-__codelineno-2-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">env</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="n">env</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">switchIncomingChannelsToInMemory</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">));</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">env</span><span class="p">.</span><span class="na">putAll</span><span class="p">(</span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">switchOutgoingChannelsToInMemory</span><span class="p">(</span><span class="s">&quot;my-data-stream&quot;</span><span class="p">));</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">env</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="p">}</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="n">InMemoryConnector</span><span class="p">.</span><span class="na">clear</span><span class="p">();</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The in-memory connector support the <code>broadcast</code> and <code>merge</code> attributes.
So, if your connector is configured with <code>broadcast: true</code>, the
connector broadcasts the messages to all the channel consumers. If your
connector is configured with <code>merge:true</code>, the connector receives all
the messages sent to the mapped channel even when coming from multiple
producers.</p>
</div>
<h2 id="concepts-testing-vertx-context-with-in-memory-connector">Vert.x Context with In-memory Connector</h2>
<p>For the sake of simplicity, In-memory connector channels dispatch messages on the caller thread of <code>InMemorySource#send</code> method.
However, most of the other connectors handle context propagation dispatching messages on separate <a href="#concepts-message-context">duplicated Vert.x contexts</a>.</p>
<p>If this causes a change of behaviour in your tests,
you can configure the in-memory connector channels with <code>run-on-vertx-context</code> attribute to dispatch events,
including messages and acknowledgements, on a Vert.x context.
Alternatively you can switch this behaviour using the <code>InMemorySource#runOnVertxContext</code> method.</p></section><section class="print-page" id="concepts-logging"><h1 id="concepts-logging-logging">Logging</h1>
<p>SmallRye Reactive Messaging uses <a href="https://github.com/jboss-logging">JBoss
Logging</a> as logging API. This section
explains how to configure the loggers for various logging backends.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are developing SmallRye Reactive Messaging and wonder about how
the logs are managed, it uses <a href="https://jboss-logging.github.io/jboss-logging-tools/#introduction">JBoss Logging
Tools</a>.</p>
</div>
<h2 id="concepts-logging-logging-backends">Logging Backends</h2>
<p>SmallRye Reactive Messaging uses the JBoss Logging library to write
messages to a log file. This library is a logging <em>bridge</em> that
integrates different log frameworks. You can decide which of the
following frameworks you want to use for your application:</p>
<ul>
<li>JBoss LogManager (<code>jboss</code>)</li>
<li>Log4j 2 (<code>log4j2</code>)</li>
<li>Log4j 1 (<code>log4j</code>)</li>
<li>Slf4j (<code>slf4j</code>)</li>
<li>JDK logging (<code>jul</code>)</li>
</ul>
<p>You only need to add the chosen framework to the classpath, and the
JBoss Logging library will pick it up. If there are multiple frameworks
available on the classpath, it picks the first found (in the order from
the list). Alternatively, you can set the <code>org.jboss.logging.provider</code>
system property is one of the values given above.</p>
<p>The concepts and log categories are the same for all frameworks.
However, the format of the configuration file and the names of the log
levels differ. Check the documentation of your logging library to find
out which <em>dependencies</em> are required, the exact name of the log levels,
and where the configuration should be written.</p>
<h2 id="concepts-logging-log-categories">Log Categories</h2>
<p>As all applications and frameworks, SmallRye Reactive Messaging writes
log messages in different categories and log levels. The categories
group messages from specific connectors, classes or components. The
following table shows the essential log categories used by SmallRye
Reactive Messaging:</p>
<table>
<thead>
<tr>
<th>Category</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>io.smallrye.reactive.messaging</code></td>
<td>This category contains all the messages written by SmallRye Reactive Messaging.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.provider</code></td>
<td>This category contains all the messages generated by the <em>core</em> (provider).</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.kafka</code></td>
<td>This category contains all the messages generated by the Kafka Connector.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.amqp</code></td>
<td>This category contains all the messages generated by the AMQP Connector.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.jms</code></td>
<td>This category contains all the messages generated by the JMS Connector.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.camel</code></td>
<td>This category contains all the messages generated by the Camel Connector.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.mqtt</code></td>
<td>This category contains all the messages generated by the MQTT (Client) Connector.</td>
</tr>
<tr>
<td><code>io.smallrye.reactive.messaging.mqtt-server</code></td>
<td>This category contains all the messages generated by the MQTT (Server) Connector.</td>
</tr>
</tbody>
</table>
<p>The names of the log levels are defined by your logging framework and
determine the amount and granularity of the log messages. You can assign
a log level to each category. If you do not specify a specific
categoryâ€™s log level, it will inherit the level from its parent
category. Thus, setting the log level of
<code>io.smallrye.reactive.messaging</code> influences every loggers from SmallRye
Reactive Messaging.</p>
<h2 id="concepts-logging-message-code">Message Code</h2>
<p>Each message has an identifier code. They are all prefixed with <code>SRMSG</code>,
followed with the numeric code.</p>
<p>In the following output, the code is <code>SRMSG00229</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>[2020-06-15 13:35:07] [INFO   ] SRMSG00229: Channel manager initializing...
</code></pre></div></td></tr></table></div>
<h2 id="concepts-logging-recommended-logging-configurations">Recommended logging configurations</h2>
<h3 id="concepts-logging-development">Development</h3>
<h4 id="concepts-logging-log4j-1">Log4J 1</h4>
<p><em>log4j.properties</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">log4j.appender.stdout</span><span class="o">=</span><span class="s">org.apache.log4j.ConsoleAppender</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">log4j.appender.stdout.Target</span><span class="o">=</span><span class="s">System.out</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">log4j.appender.stdout.layout</span><span class="o">=</span><span class="s">org.apache.log4j.PatternLayout</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">log4j.appender.stdout.layout.ConversionPattern</span><span class="o">=</span><span class="s">%d{HH:mm:ss,SSS} %-5p [%c] - %m%n</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">log4j.rootLogger</span><span class="o">=</span><span class="s">info, stdout</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="na">log4j.logger.io.smallrye.reactive.messaging</span><span class="o">=</span><span class="s">info</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="na">log4j.logger.org.jboss.weld</span><span class="o">=</span><span class="s">warn</span>
</code></pre></div></td></tr></table></div>
<h4 id="concepts-logging-log4j-2">Log4J 2</h4>
<p><em>log4j2.xml</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">&lt;Configuration</span><span class="w"> </span><span class="na">monitorInterval=</span><span class="s">&quot;60&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">&lt;Properties&gt;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="nt">&lt;Property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;log-path&quot;</span><span class="nt">&gt;</span>PropertiesConfiguration<span class="nt">&lt;/Property&gt;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">&lt;/Properties&gt;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">  </span><span class="nt">&lt;Appenders&gt;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="nt">&lt;Console</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Console-Appender&quot;</span><span class="w"> </span><span class="na">target=</span><span class="s">&quot;SYSTEM*OUT&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">      </span><span class="nt">&lt;PatternLayout&gt;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">        </span><span class="nt">&lt;pattern&gt;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">          </span>[%-5level]<span class="w"> </span>%d{yyyy-MM-dd<span class="w"> </span>HH:mm:ss.SSS}<span class="w"> </span>[%t]<span class="w"> </span>%c{1}<span class="w"> </span>-<span class="w"> </span>%msg%n
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">        </span><span class="nt">&lt;/pattern&gt;</span>&gt;
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">      </span><span class="nt">&lt;/PatternLayout&gt;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nt">&lt;/Console&gt;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">  </span><span class="nt">&lt;/Appenders&gt;</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">  </span><span class="nt">&lt;Loggers&gt;</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nt">&lt;Logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;io.smallrye.reactive.messaging&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nt">&lt;/Logger&gt;</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nt">&lt;Logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.jboss.weld&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="nt">&lt;/Logger&gt;</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="nt">&lt;Root</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="nt">&lt;/Root&gt;</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">  </span><span class="nt">&lt;/Loggers&gt;</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="nt">&lt;/Configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<h4 id="concepts-logging-jdk-jul">JDK (JUL)</h4>
<p><em>logging.properties</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-5">5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-6">6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-7">7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-8">8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-2-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">handlers</span><span class="o">=</span><span class="s">java.util.logging.ConsoleHandler</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="na">java.util.logging.ConsoleHandler.level</span><span class="o">=</span><span class="s">FINEST</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="na">java.util.logging.ConsoleHandler.formatter</span><span class="o">=</span><span class="s">java.util.logging.SimpleFormatter</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="na">java.util.logging.SimpleFormatter.format</span><span class="o">=</span><span class="s">[%1$tF %1$tT] [%4$-7s] %5$s %n</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="na">.level</span><span class="o">=</span><span class="s">INFO</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="na">io.smallrye.reactive.messaging.level</span><span class="o">=</span><span class="s">INFO</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="na">org.jboss.weld.level</span><span class="o">=</span><span class="s">WARNING</span>
</code></pre></div></td></tr></table></div>
<h4 id="concepts-logging-logback-via-slf4j">LogBack via SLF4J*</h4>
<p><em>logback.xml</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-3-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">  </span><span class="nt">&lt;appender</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;STDOUT&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="nt">&lt;encoder</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">      </span><span class="nt">&lt;Pattern&gt;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">        </span>%d{yyyy-MM-dd<span class="w"> </span>HH:mm:ss}<span class="w"> </span>[%thread]<span class="w"> </span>%-5level<span class="w"> </span>%logger{36}<span class="w"> </span>-<span class="w"> </span>%msg%n
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">      </span><span class="nt">&lt;/Pattern&gt;</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="nt">&lt;/encoder&gt;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">  </span><span class="nt">&lt;/appender&gt;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">  </span><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;io.smallrye.reactive.messaging&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">  </span><span class="nt">&lt;/logger&gt;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">  </span><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.jboss.weld&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">  </span><span class="nt">&lt;/logger&gt;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">  </span><span class="nt">&lt;root</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">  </span><span class="nt">&lt;/root&gt;</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<h3 id="concepts-logging-production">Production</h3>
<h4 id="concepts-logging-log4j-1_1">Log4J 1</h4>
<p><em>log4j.properties</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-4-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="na">log4j.appender.stdout</span><span class="o">=</span><span class="s">org.apache.log4j.ConsoleAppender</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">log4j.appender.stdout.Target</span><span class="o">=</span><span class="s">System.out</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="na">log4j.appender.stdout.layout</span><span class="o">=</span><span class="s">org.apache.log4j.PatternLayout</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="na">log4j.appender.stdout.layout.ConversionPattern</span><span class="o">=</span><span class="s">%d{HH:mm:ss,SSS} %-5p [%c] - %m%n</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="na">log4j.rootLogger</span><span class="o">=</span><span class="s">info, stdout</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="na">log4j.logger.io.smallrye.reactive.messaging</span><span class="o">=</span><span class="s">warn</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="na">log4j.logger.org.jboss.weld</span><span class="o">=</span><span class="s">error</span>
</code></pre></div></td></tr></table></div>
<h4 id="concepts-logging-log4j-2_1">Log4J 2</h4>
<p><em>log4j2.xml</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-23">23</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-24">24</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-5-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">&lt;Configuration</span><span class="w"> </span><span class="na">monitorInterval=</span><span class="s">&quot;60&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">  </span><span class="nt">&lt;Properties&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nt">&lt;Property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;log-path&quot;</span><span class="nt">&gt;</span>PropertiesConfiguration<span class="nt">&lt;/Property&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">  </span><span class="nt">&lt;/Properties&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">  </span><span class="nt">&lt;Appenders&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="nt">&lt;Console</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;Console-Appender&quot;</span><span class="w"> </span><span class="na">target=</span><span class="s">&quot;SYSTEM*OUT&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">      </span><span class="nt">&lt;PatternLayout&gt;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">        </span><span class="nt">&lt;pattern&gt;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">          </span>[%-5level]<span class="w"> </span>%d{yyyy-MM-dd<span class="w"> </span>HH:mm:ss.SSS}<span class="w"> </span>[%t]<span class="w"> </span>%c{1}<span class="w"> </span>-<span class="w"> </span>%msg%n
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="nt">&lt;/pattern&gt;</span>&gt;
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">      </span><span class="nt">&lt;/PatternLayout&gt;</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="nt">&lt;/Console&gt;</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">  </span><span class="nt">&lt;/Appenders&gt;</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="nt">&lt;Loggers&gt;</span>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="nt">&lt;Logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;io.smallrye.reactive.messaging&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="nt">&lt;/Logger&gt;</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="nt">&lt;Logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.jboss.weld&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="nt">&lt;/Logger&gt;</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">    </span><span class="nt">&lt;Root</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">      </span><span class="nt">&lt;AppenderRef</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;Console-Appender&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="nt">&lt;/Root&gt;</span>
<a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">  </span><span class="nt">&lt;/Loggers&gt;</span>
<a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="nt">&lt;/Configuration&gt;</span>
</code></pre></div></td></tr></table></div>
<h4 id="concepts-logging-jdk-jul_1">JDK (JUL)</h4>
<p><em>logging.properties</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-7">7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-8">8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-6-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">handlers</span><span class="o">=</span><span class="s">java.util.logging.ConsoleHandler</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">java.util.logging.ConsoleHandler.level</span><span class="o">=</span><span class="s">INFO</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">java.util.logging.ConsoleHandler.formatter</span><span class="o">=</span><span class="s">java.util.logging.SimpleFormatter</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="na">java.util.logging.SimpleFormatter.format</span><span class="o">=</span><span class="s">[%1$tF %1$tT] [%4$-7s] %5$s %n</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="na">.level</span><span class="o">=</span><span class="s">INFO</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="na">io.smallrye.reactive.messaging.level</span><span class="o">=</span><span class="s">WARNING</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="na">org.jboss.weld.level</span><span class="o">=</span><span class="s">SEVERE</span>
</code></pre></div></td></tr></table></div>
<p><em>logback.xml</em></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-logging-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#concepts-logging-__codelineno-7-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nt">&lt;configuration&gt;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">  </span><span class="nt">&lt;appender</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;STDOUT&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="nt">&lt;encoder</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;ch.qos.logback.classic.encoder.PatternLayoutEncoder&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">      </span><span class="nt">&lt;Pattern&gt;</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">        </span>%d{yyyy-MM-dd<span class="w"> </span>HH:mm:ss}<span class="w"> </span>[%thread]<span class="w"> </span>%-5level<span class="w"> </span>%logger{36}<span class="w"> </span>-<span class="w"> </span>%msg%n
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">      </span><span class="nt">&lt;/Pattern&gt;</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="nt">&lt;/encoder&gt;</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span><span class="nt">&lt;/appender&gt;</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;io.smallrye.reactive.messaging&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;warn&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">  </span><span class="nt">&lt;/logger&gt;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">  </span><span class="nt">&lt;logger</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;org.jboss.weld&quot;</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;error&quot;</span><span class="w"> </span><span class="na">additivity=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">  </span><span class="nt">&lt;/logger&gt;</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">  </span><span class="nt">&lt;root</span><span class="w"> </span><span class="na">level=</span><span class="s">&quot;info&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="nt">&lt;appender-ref</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;STDOUT&quot;</span><span class="nt">/&gt;</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">  </span><span class="nt">&lt;/root&gt;</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-observability"><h1 id="concepts-observability-observability-api">Observability API</h1>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Observability API is experimental and SmallRye only feature.</p>
</div>
<p>Smallrye Reactive Messaging proposes an observability API that allows to observe messages received and send through inbound and outbound channels.</p>
<p>For any observation to happen, you need to provide an implementation of the <code>MessageObservationCollector</code>, discovered as a CDI-managed bean.</p>
<p>At wiring time the discovered <code>MessageObservationCollector</code> implementation <code>initObservation</code> method is called once per channel to initialize the <code>ObservationContext</code>.
The default <code>initObservation</code> implementation returns a default <code>ObservationContext</code> object,
but the collector implementation can provide a custom per-channel <code>ObservationContext</code> object that'll hold information necessary for the observation.
The <code>ObservationContext#complete</code> method is called each time a message observation is completed â€“ message being acked or nacked.
The collector implementation can decide at initialization time to disable the observation per channel by returning a <code>null</code> observation context.</p>
<p>For each new message, the collector is on <code>onNewMessage</code> method with the channel name, the <code>Message</code> and the <code>ObservationContext</code> object initialized beforehand.
This method can react to the creation of a new message but also is responsible for instantiating and returning a <code>MessageObservation</code>.
While custom implementations can augment the observability capability, SmallRye Reactive Messaging provides a default implementation <code>DefaultMessageObservation</code>.</p>
<p>So a simple observability collector can be implemented as such:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-observability-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">observability</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.DefaultMessageObservation</span><span class="p">;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.MessageObservation</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.MessageObservationCollector</span><span class="p">;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.ObservationContext</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SimpleMessageObservationCollector</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">MessageObservationCollector</span><span class="o">&lt;</span><span class="n">ObservationContext</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MessageObservation</span><span class="w"> </span><span class="nf">onNewMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">ObservationContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="c1">// Called after message has been created</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultMessageObservation</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>A collector with a custom <code>ObservationContext</code> can be implemented as such :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-observability-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-31">31</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-32">32</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-33">33</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-34">34</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-35">35</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-36">36</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-37">37</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-38">38</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-39">39</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-40">40</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-41">41</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-42">42</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-43">43</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-44">44</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-45">45</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-46">46</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-47">47</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-48">48</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-49">49</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-50">50</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-51">51</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-52">52</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-53">53</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-54">54</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-55">55</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-56">56</a></span>
<span class="normal"><a href="#concepts-observability-__codelineno-1-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">observability</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.DefaultMessageObservation</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.MessageObservation</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.MessageObservationCollector</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.observation.ObservationContext</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ContextMessageObservationCollector</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="kd">implements</span><span class="w"> </span><span class="n">MessageObservationCollector</span><span class="o">&lt;</span><span class="n">ContextMessageObservationCollector</span><span class="p">.</span><span class="na">MyContext</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MyContext</span><span class="w"> </span><span class="nf">initObservation</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">incoming</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">emitter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// Called on observation setup, per channel</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="c1">// if returned null the observation for that channel is disabled</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyContext</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">incoming</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="p">);</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">MessageObservation</span><span class="w"> </span><span class="nf">onNewMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">MyContext</span><span class="w"> </span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="c1">// Called after message has been created</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultMessageObservation</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyContext</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ObservationContext</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-32" name="__codelineno-1-32"></a>
<a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span>
<a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">incoming</span><span class="p">;</span>
<a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">        </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyContext</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">channel</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">incoming</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">emitter</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">channel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">channel</span><span class="p">;</span>
<a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">incoming</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">;</span>
<a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">emitter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emitter</span><span class="p">;</span>
<a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-42" name="__codelineno-1-42"></a>
<a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">complete</span><span class="p">(</span><span class="n">MessageObservation</span><span class="w"> </span><span class="n">observation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">            </span><span class="c1">// called after message processing has completed and observation is done</span>
<a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">            </span><span class="c1">// register duration</span>
<a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">            </span><span class="n">Duration</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">observation</span><span class="p">.</span><span class="na">getCompletionDuration</span><span class="p">();</span>
<a id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="w">            </span><span class="n">Throwable</span><span class="w"> </span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">observation</span><span class="p">.</span><span class="na">getReason</span><span class="p">();</span>
<a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reason</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">                </span><span class="c1">// message was nacked</span>
<a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">                </span><span class="c1">// message was acked successfully</span>
<a id="__codelineno-1-53" name="__codelineno-1-53"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-55" name="__codelineno-1-55"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-56" name="__codelineno-1-56"></a>
<a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="concepts-advanced-config"><h1 id="concepts-advanced-config-advanced-configuration">Advanced configuration</h1>
<h2 id="concepts-advanced-config-strict-binding-mode">Strict Binding Mode</h2>
<p>By default, SmallRye Reactive Messaging does not enforce whether all
<em>mediators</em> are connected. It just prints a warning message. The strict
mode fails the deployment if some "incomings" are not bound to
"outgoings". To enable this mode, you can pass the
<code>-Dsmallrye-messaging-strict-binding=true</code> via the command line, or you
can set the <code>smallrye-messaging-strict-binding</code> attribute to <code>true</code> in
the configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-advanced-config-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>smallrye-messaging-strict-binding=true
</code></pre></div></td></tr></table></div>
<h2 id="concepts-advanced-config-disabling-channels">Disabling channels</h2>
<p>You can disable a channel in the configuration by setting the <code>enabled</code>
attribute to <code>false</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-advanced-config-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#concepts-advanced-config-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>mp.messaging.outgoing.dummy-sink.connector=dummy
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>mp.messaging.outgoing.dummy-sink.enabled=false # Disable this channel
</code></pre></div></td></tr></table></div>
<p>SmallRye Reactive Messaging does not register disabled channels, so make
sure the rest of the application does not rely on them.</p>
<h2 id="concepts-advanced-config-publisher-metrics">Publisher metrics</h2>
<p>SmallRye Reactive Messaging integrates MicroProfile Metrics and
Micrometer for registering counter metrics (named
<code>mp.messaging.message.count</code>) of published messages per channel.</p>
<p>Both MicroProfile and Micrometer publisher metrics are enabled by
default if found on the classpath. They can be disabled with
<code>smallrye.messaging.metrics.mp.enabled</code> and
<code>smallrye.messaging.metrics.micrometer.enabled</code> properties respectively.</p></section><section class="print-page" id="concepts-message-context"><h1 id="concepts-message-context-message-contexts">Message Contexts</h1>
<p>Message context provides a way to propagate data along the processing of a message.
It can be used to propagate message specific objects in an implicit manner and be able to retrieve them later, such as the user, session or transaction.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Message contexts are only support by Kafka, AMQP, RabbitMQ and MQTT connectors.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Message context support is an experimental and SmallRye only feature.</p>
</div>
<h2 id="concepts-message-context-whats-a-message-context">What's a message context</h2>
<p>A message context is execution context on which a message is processed.
Each stage of the processing is going to use the same execution context.
Thus, it allows storing <em>data</em> which can later be restored.
For example, you can imagine storing some authentication (<code>User</code> in the following example) data in one part of your processing and restore it in a later stage.</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-message-context-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-message-context-__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// Extract some data from the message and store it in the context</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">    </span><span class="c1">// Store the extracted data into the message context.</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">ContextLocals</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="kd">record</span> <span class="nc">input</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="p">}</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;after-process&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">   </span><span class="c1">// You can retrieve the store data using</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">   </span><span class="n">User</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ContextLocals</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">   </span><span class="c1">// ...</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span><span class="p">;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
The Message context is also available when using blocking or asynchronous stages (stage returning <code>Uni</code> or <code>CompletionStage</code>)</p>
<h2 id="concepts-message-context-the-difference-with-metadata">The difference with metadata</h2>
<p>Message metadata can be used to provide a similar feature.
However, it requires using <code>Messages</code> which can be inconvenient (need to handle the acknowledgement manually).
Message Contexts provide a simpler API, closer to a <em>Message CDI scope</em>: you can save data, and restore it later.
The implicit propagation avoid having to deal with <code>Messages</code>.</p>
<h2 id="concepts-message-context-supported-signatures">Supported signatures</h2>
<p>Message context works with:</p>
<ul>
<li>methods consuming or producing <code>Messages</code>, <code>Uni&lt;Message&lt;T&gt;&gt;</code> and <code>CompletionStage&lt;Message&lt;T&gt;&gt;</code></li>
<li>methods consuming or producing payloads, <code>Uni&lt;Payload&gt;</code> and <code>CompletionStage&lt;Payload&gt;</code>.</li>
<li>blocking and non-blocking methods</li>
</ul>
<p>However, message context are <strong>NOT</strong> enforced when using methods consuming or producing:</p>
<ul>
<li><code>Multi</code>, <code>Flow.Publisher</code>, <code>Publisher</code> and <code>PublisherBuilder</code></li>
<li><code>Subscriber</code>, <code>Flow.Subscriber</code>, and <code>SubscriberBuilder</code></li>
<li><code>Processor</code>, <code>Flow.Processor</code>, and <code>ProcessorBuilder</code></li>
</ul>
<h2 id="concepts-message-context-under-the-hood">Under the hood</h2>
<p>Under the hood, the message context feature uses Vert.x <em>duplicated contexts</em>.
A duplicated context is a view of the "root" (event loop) context, which is restored at each stage of the message processing.</p>
<p>Each time that a compatible connector receives a message from a broker, it creates a new <em>duplicated context</em> and attaches it to the message.
So the context is stored in the metadata of the message.</p>
<p>When the message is processed, SmallRye Reactive Messaging makes sure that this processing is executed on the stored duplicated context.</p></section><section class="print-page" id="concepts-incoming-metadata-injection"><h1 id="concepts-incoming-metadata-injection-incoming-metadata-injection">Incoming Metadata Injection</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Metadata injection is an experimental feature.</p>
</div>
<p>When using reactive messaging, <code>Message</code> flow in your system.
Each message has a payload but can also contain <em>metadata</em>, as explained in <a href="#concepts-concepts-messages-payload-metadata">Messages, Payload, Metadata</a>.</p>
<p>You can inject the incoming message metadata as a parameter depending on the method signature.
<strong>Only methods receiving the payload as a parameter can also receive the metadata.</strong>
For example, <code>@Incoming("in") void consume(String s)</code> can also receive the metadata using the following signature:
<code>@Incoming("in") void consume(String s, MyMetadata m)</code>.
Note that the payload must be the first parameter.</p>
<p>The metadata can be injected using the class of the metadata to inject.
In this case, the method is invoked with <code>null</code> if the metadata is missing.
You can also inject the metadata using <code>Optional&lt;MetadataClass&gt;,</code> which would be empty if the incoming message does not contain metadata of type <code>MetadataClass.</code></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#concepts-incoming-metadata-injection-__codelineno-0-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">MyMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">payload</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="p">}</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process2</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">MyMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">payload</span><span class="p">.</span><span class="na">toUpperCase</span><span class="p">());</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="p">}</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="c1">// ...</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Period</span><span class="w"> </span><span class="n">metadata2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume2</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">payload</span><span class="p">,</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">MyMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Period</span><span class="w"> </span><span class="n">metadata2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: Concepts</h1><h1 class='nav-section-title-end'>Ended: Core</h1>
                        <h1 class='nav-section-title' id='section-kafka'>
                            Kafka <a class='headerlink' href='#section-kafka' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="kafka-kafka"><h1 id="kafka-kafka-apache-kafka-connector">Apache Kafka Connector</h1>
<p>The Kafka connector adds support for Kafka to Reactive Messaging. With
it you can receive Kafka Records as well as write <code>message</code> into Kafka.</p>
<p><a href="https://kafka.apache.org/">Apache Kafka</a> is a popular distributed
streaming platform. It lets you:</p>
<ul>
<li>
<p>Publish and subscribe to streams of records, similar to a message
    queue or enterprise messaging system.</p>
</li>
<li>
<p>Store streams of records in a fault-tolerant durable way.</p>
</li>
<li>
<p>Process streams of records as they occur.</p>
</li>
</ul>
<p>The Kafka cluster stores streams of <em>records</em> in categories called
<em>topics</em>. Each record consists of a <em>key</em>, a <em>value</em>, and a <em>timestamp</em>.</p>
<p>For more details about Kafka, check the
<a href="https://kafka.apache.org/intro">documentation</a>.</p>
<h2 id="kafka-kafka-using-the-kafka-connector">Using the Kafka Connector</h2>
<p>To use the Kafka Connector, add the following dependency to your
project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-kafka-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-kafka<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-kafka</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-kafka-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#kafka-kafka-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-kafka</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-kafka</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="kafka-receiving-kafka-records"><h1 id="kafka-receiving-kafka-records-receiving-kafka-records">Receiving Kafka Records</h1>
<p>The Kafka Connector retrieves Kafka Records from Kafka Brokers and maps
each of them to Reactive Messaging <code>Messages</code>.</p>
<h2 id="kafka-receiving-kafka-records-example">Example</h2>
<p>Letâ€™s imagine you have a Kafka broker running, and accessible using the
<code>kafka:9092</code> address (by default it would use <code>localhost:9092</code>).
Configure your application to receive Kafka records from a Kafka <em>topic</em>
on the <code>prices</code> channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">kafka.bootstrap.servers</span><span class="o">=</span><span class="s">kafka:9092 # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-kafka # &lt;2&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.prices.value.deserializer</span><span class="o">=</span><span class="s">org.apache.kafka.common.serialization.DoubleDeserializer # &lt;3&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">mp.messaging.incoming.prices.broadcast</span><span class="o">=</span><span class="s">true # &lt;4&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>Configure the broker location. You can configure it globally or per
    channel</p>
</li>
<li>
<p>Configure the connector to manage the <code>prices</code> channel</p>
</li>
<li>
<p>Sets the (Kafka) deserializer to read the recordâ€™s value</p>
</li>
<li>
<p>Make sure that we can receive from more than one consumer (see
    <code>KafkaPriceConsumer</code> and <code>KafkaPriceMessageConsumer</code> below)</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the Kafka topic. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>topic</code> attribute to override it.</p>
</div>
<p>Then, your application receives <code>Message&lt;Double&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message (commit the offset)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-receiving-kafka-records-deserialization">Deserialization</h2>
<p>The deserialization is handled by the underlying Kafka Client. You need
to configure the:</p>
<ul>
<li>
<p><code>mp.messaging.incoming.[channel-name].value.deserializer</code> to
    configure the value deserializer (mandatory)</p>
</li>
<li>
<p><code>mp.messaging.incoming.[channel-name].key.deserializer</code> to configure
    the key deserializer (optional, default to <code>String</code>)</p>
</li>
</ul>
<p>If you want to use a custom deserializer, add it to your <code>CLASSPATH</code> and
configure the associate attribute.</p>
<p>In addition, the Kafka Connector also provides a set of <em>message
converters</em>. So you can receive <em>payloads</em> representing records from
Kafka using:</p>
<ul>
<li><a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/Record.html'>Record</a> - a pair key/value</li>
<li><a href="https://kafka.apache.org/26/javadoc/index.html?org/apache/kafka/clients/consumer/ConsumerRecord.html">ConsumerRecord<K,V></a> -
    a structure representing the record with all its metadata</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-3-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;topic-a&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Record</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">key</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no key</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no value</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;topic-b&quot;</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">key</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no key</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no value</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">();</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">();</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-receiving-kafka-records-inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from Kafka contains an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/api/IncomingKafkaRecordMetadata.html'>IncomingKafkaRecordMetadata</a>
in the metadata. It provides the key, topic, partitions,
headers and so on:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-4-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">IncomingKafkaRecordMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingKafkaRecordMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">        </span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metadata</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="c1">// The topic</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTopic</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="c1">// The key</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="c1">// The timestamp</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">Instant</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">();</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="c1">// The underlying record</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getRecord</span><span class="p">();</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-receiving-kafka-records-acknowledgement">Acknowledgement</h2>
<p>When a message produced from a Kafka record is acknowledged, the
connector invokes a <em>commit strategy</em>. These strategies decide when the
consumer offset for a specific topic/partition is committed. Committing
an offset indicates that all previous records have been processed. It is
also the position where the application would restart the processing
after a crash recovery or a restart.</p>
<p>Committing every offset has performance penalties as Kafka offset
management can be slow. However, not committing the offset often enough
may lead to message duplication if the application crashes between two
commits.</p>
<p>The Kafka connector supports three strategies:</p>
<ul>
<li>
<p><code>throttled</code> keeps track of received messages and commit to the next
    offset after the latest <em>acked</em> message in sequence. This strategy
    guarantees <em>at-least-once delivery</em> even if the channel performs
    asynchronous processing. The connector tracks the received records
    and periodically (period specified by <code>auto.commit.interval.ms</code>
    (default: 5000)) commits the highest consecutive offset. The
    connector will be marked as unhealthy if a message associated with a
    record is not acknowledged in
    <code>throttled.unprocessed-record-max-age.ms</code> (default: 60000). Indeed,
    this strategy cannot commit the offset as soon as a single record
    processing fails (see failure-strategy to configure what happens on
    failing processing). If <code>throttled.unprocessed-record-max-age.ms</code> is
    set to less than or equal to 0, it does not perform any health check
    verification. Such a setting might lead to running out of memory if
    there are poison pill messages. This strategy is the default if
    <code>enable.auto.commit</code> is not explicitly set to <code>true</code>.</p>
</li>
<li>
<p><code>checkpoint</code> allows persisting consumer offsets on a "state store",
    instead of committing them back to the Kafka broker. Using the
    <code>CheckpointMetadata</code> API, consumer code can persist a processing
    state with the offset to mark the progress of a consumer.
    When the processing continues from a previously persisted offset,
    it seeks the Kafka consumer to that offset and also restores the
    persisted state, continuing the stateful processing from where it
    left off. The <code>checkpoint</code> strategy holds locally the processing
    state associated with the latest offset, and persists it
    periodically to the state store (period specified by
    <code>auto.commit.interval.ms</code> (default: 5000)). The connector will be
    marked as unhealthy if no processing state is persisted to the state
    store in <code>checkpoint.unsynced-state-max-age.ms</code> (default: 10000).
    Using the <code>CheckpointMetadata</code> API the user code can force to persist
    the state on message ack. If <code>checkpoint.unsynced-state-max-age.ms</code>
    is set to less than or equal to 0, it does not perform any health
    check verification. For more information, see
    <a href="#kafka-receiving-kafka-records-stateful-processing-with-checkpointing">Stateful processing with Checkpointing</a></p>
</li>
<li>
<p><code>latest</code> commits the record offset received by the Kafka consumer as
    soon as the associated message is acknowledged (if the offset is
    higher than the previously committed offset). This strategy provides
    <em>at-least-once</em> delivery if the channel processes the message
    without performing any asynchronous processing. This strategy should
    not be used on high-load as offset commit is expensive. However, it
    reduces the risk of duplicates.</p>
</li>
<li>
<p><code>ignore</code> performs no commit. This strategy is the default strategy
    when the consumer is explicitly configured with <code>enable.auto.commit</code>
    to <code>true</code>. It delegates the offset commit to the Kafka client. When
    <code>enable.auto.commit</code> is <code>true</code> this strategy <strong>DOES NOT</strong> guarantee
    at-least-once delivery. However, if the processing failed between
    two commits, messages received after the commit and before the
    failure will be re-processed.</p>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Kafka connector disables the Kafka <em>auto commit</em> if not explicitly
enabled. This behavior differs from the traditional Kafka consumer.</p>
</div>
<p>If high-throughout is important for you, and not limited by the
downstream, we recommend to either:</p>
<ul>
<li>Use the <code>throttled</code> policy</li>
<li>or set <code>enable.auto.commit</code> to <code>true</code> and annotate the consuming
    method with <code>@Acknowledgment(Acknowledgment.Strategy.NONE)</code></li>
</ul>
<h2 id="kafka-receiving-kafka-records-failure-management">Failure Management</h2>
<p>If a message produced from a Kafka record is <em>nacked</em>, a failure
strategy is applied. The Kafka connector supports 3 strategies:</p>
<ul>
<li>
<p><code>fail</code> - fail the application, no more records will be processed.
    (default) The offset of the record that has not been processed
    correctly is not committed.</p>
</li>
<li>
<p><code>ignore</code> - the failure is logged, but the processing continue. The
    offset of the record that has not been processed correctly is
    committed.</p>
</li>
<li>
<p><code>dead-letter-queue</code> - the offset of the record that has not been
    processed correctly is committed, but the record is written to a
    (Kafka) <em>dead letter queue</em> topic.</p>
</li>
<li>
<p><code>delayed-retry-topic</code> - the offset of the record that has not been
    processed correctly is still committed, but the record is written to
    a series of Kafka topics for retrying the processing with some delay.
    This allows retrying failed records by reconsuming them later without
    blocking the processing of the latest records.</p>
</li>
</ul>
<p>The strategy is selected using the <code>failure-strategy</code> attribute.</p>
<h3 id="kafka-receiving-kafka-records-dead-letter-queue">Dead Letter Queue</h3>
<p>In the case of <code>dead-letter-queue</code>, you can configure the following
attributes:</p>
<ul>
<li><code>dead-letter-queue.topic</code>: the topic to use to write the records not
    processed correctly, default is <code>dead-letter-topic-$channel</code>, with
    <code>$channel</code> being the name of the channel.</li>
<li>
<p><code>dead-letter-queue.producer-client-id</code>: the client id used by the kafka
producer when sending records to dead letter queue topic. If not specified
it will default to <code>kafka-dead-letter-topic-producer-$client-id</code>, with $client-id
being the value obtained from consumer client id.</p>
</li>
<li>
<p><code>dead-letter-queue.key.serializer</code>: the serializer used to write the
    record key on the dead letter queue. By default, it deduces the
    serializer from the key deserializer.</p>
</li>
<li>
<p><code>dead-letter-queue.value.serializer</code>: the serializer used to write
    the record value on the dead letter queue. By default, it deduces
    the serializer from the value deserializer.</p>
</li>
</ul>
<p>The record written on the dead letter topic contains the original
recordâ€™s headers, as well as a set of additional headers about the
original record:</p>
<ul>
<li>
<p><code>dead-letter-reason</code> - the reason of the failure (the <code>Throwable</code>
    passed to <code>nack()</code>)</p>
</li>
<li>
<p><code>dead-letter-cause</code> - the cause of the failure (the <code>getCause()</code> of
    the <code>Throwable</code> passed to <code>nack()</code>), if any</p>
</li>
<li>
<p><code>dead-letter-topic</code> - the original topic of the record</p>
</li>
<li>
<p><code>dead-letter-partition</code> - the original partition of the record
    (integer mapped to String)</p>
</li>
<li>
<p><code>dead-letter-offset</code> - the original offset of the record (long
    mapped to String)</p>
</li>
</ul>
<p>When using <code>dead-letter-queue</code>, it is also possible to change some
metadata of the record that is sent to the dead letter topic. To do
that, use the <code>Message.nack(Throwable, Metadata)</code> method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-7">7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-8">8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-5-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Failed!&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="n">OutgoingKafkaRecordMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">                    </span><span class="p">.</span><span class="na">withKey</span><span class="p">(</span><span class="s">&quot;failed-record&quot;</span><span class="p">)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">                    </span><span class="p">.</span><span class="na">withHeaders</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RecordHeaders</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">                            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;my-header&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my-header-value&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">)))</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">()));</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>Metadata</code> may contain an instance of <code>OutgoingKafkaRecordMetadata</code>.
If the instance is present, the following properties will be used:</p>
<ul>
<li>
<p>key; if not present, the original recordâ€™s key will be used</p>
</li>
<li>
<p>topic; if not present, the configured dead letter topic will be used</p>
</li>
<li>
<p>partition; if not present, partition will be assigned automatically</p>
</li>
<li>
<p>headers; combined with the original recordâ€™s headers, as well as the
    <code>dead-letter-*</code> headers described above</p>
</li>
</ul>
<h3 id="kafka-receiving-kafka-records-delayed-retry-topic">Delayed Retry Topic</h3>
<div class="admonition experimental">
<p class="admonition-title">Experimental</p>
<p>Delayed retry topic feature is experimental.</p>
</div>
<p>The delayed retry topic strategy allows failed records to be automatically retried by forwarding them to a series of retry topics.
Each retry topic is associated with a specific delay time, which is expressed in milliseconds.
When a record processing fails, it is forwarded to the first retry topic.
The failure strategy then consumes these records and dispatches them to be retried again once the delay time of the topic has elapsed.</p>
<p>If the processing of a record fails again, the message is forwarded to the next topic in the list, with possibly a longer delay time.
If the processing of a record keeps failing, it will eventually be abandoned.
Alternatively, if the <code>dead-letter-queue.topic</code> property is configured, the record will be sent to the dead letter queue.</p>
<p>The Kafka producer client used when forwarding records to retry topics can be configured using the <em>dead-letter-queue</em> properties
namely, <code>dead-letter-queue.producer-client-id</code>, <code>dead-letter-queue.key.serializer</code> and <code>dead-letter-queue.value.serializer</code>.</p>
<p>Delayed retry topics and delays can be configured with following attributes:</p>
<ul>
<li>
<p><code>delayed-retry-topic.topics</code> :
The comma-separated list of retry topics, each one suffixed with <code>_[DELAY_IN_MILLISECONDS]</code> for indicating the delay time.
For example, <code>my_retry_topic_2000,my_retry_topic_4000,my_retry_topic_10000</code> will use three topics
<em>my_retry_topic_2000</em>, <em>my_retry_topic_4000</em> and <em>my_retry_topic_10000</em>, with 2000ms 4000ms and 10000ms respectively.</p>
<p>If not configured the source channel name is used, with 10, 20 and 50 seconds of delay,
ex. for a channel named <code>source</code>, retry topics will be <code>source_retry_10000</code>, <code>source_retry_20000</code>, <code>source_retry_50000</code>.</p>
</li>
<li>
<p><code>delayed-retry-topic.max-retries</code> :
The maximum number of retries before abandoning the retries.
If configured higher than the number of retry topics the last topic is used until maximum number of retries is reached.
This can be configured to use a single retry topic with a fixed delay and multiple retries.</p>
<p>For example, <code>delayed-retry-topic.topics=source_retry_10000</code> and <code>delayed-retry-topic.max-retries=4</code> will forward failed records
to the topic <em>source_retry_10000</em> with maximum of 4 retries.</p>
</li>
<li>
<p><code>delayed-retry-topic.timeout</code> :
The global timeout in milliseconds for a retried record.
The timeout is calculated from the first failure for a record.
If the next retry will reach the timeout, instead of forwarding to the retry topic the retry is abandoned and,
if configured, the record is forwarded to the dead letter queue.</p>
<p>The default is 120 seconds.</p>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>While you can use <a href="#kafka-receiving-kafka-records-retrying-processing">Smallrye Fault Tolerance to retry processing</a>,
it will block the processing of further messages until the retried record is processed successfully, or abandoned.</p>
<p>Delayed retry topic failure strategy allows effectively implementing non-blocking retries.
But it will not preserve the order of messages inside a topic-partition.</p>
</div>
<p>The record written on the delayed retry topics will preserve the key and partition of the original record.
It also contains the original recordâ€™s headers, as well as a set of additional headers about the original record:</p>
<ul>
<li><code>delayed-retry-count</code> the current number of retries</li>
<li><code>delayed-retry-original-timestamp</code> the original timestamp of the record</li>
<li><code>delayed-retry-first-processing-timestamp</code> the first processing timestamp of the record</li>
<li><code>delayed-retry-reason</code> the reason of the failure (the <code>Throwable</code> passed to <code>nack()</code>)</li>
<li><code>delayed-retry-cause</code> the cause of the failure (the <code>getCause()</code> of the <code>Throwable</code> passed to <code>nack()</code>), if any</li>
<li><code>delayed-retry-topic</code> the original topic of the record</li>
<li><code>delayed-retry-partition</code> the original partition of the record</li>
<li><code>delayed-retry-offset</code> the original offset of the record</li>
<li><code>delayed-retry-exception-class-name</code> the class name of the throwable passed to <code>nack()</code></li>
<li><code>delayed-retry-cause-class-name</code> the class name of the the <code>getCause()</code> of the <code>Throwable</code> passed to <code>nack()</code>, if any</li>
</ul>
<p>As for the dead letter queue it is possible to change forwarded values by providing a <code>OutgoingKafkaRecordMetadata</code>
when the message is nacked using <code>Message.nack(Throwable, Metadata)</code>.</p>
<div class="admonition note">
<p class="admonition-title">Multiple partitions</p>
<p>The delayed retry topic strategy does not create retry topics automatically.
If the source topic has multiple partitions, delayed retry and dead letter queue topics would need to be setup with the same number of partitions.</p>
<p>It is possible to scale consumer application instances according to the number of partitions.
But it is not guaranteed that the retry topics consumer will be assigned the same partition(s) as the main topic consumer.
Therefore, retry processing of a record can happen in an other instance.</p>
</div>
<h2 id="kafka-receiving-kafka-records-custom-commit-and-failure-strategies">Custom commit and failure strategies</h2>
<p>In addition to provided strategies, it is possible to implement custom
commit and failure strategies and configure Kafka channels with them.</p>
<p>For example, for a custom commit strategy, implement the
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/commit/KafkaCommitHandler.html'>KafkaCommitHandler</a> interface,
and provide a managed bean implementing the <code>KafkaCommitHandler.Factory</code> interface,
identified using <code>@Identifier</code> qualifier.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-21">21</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-22">22</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-23">23</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-24">24</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-25">25</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-26">26</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-27">27</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-28">28</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-29">29</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-30">30</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-31">31</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-32">32</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-33">33</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-34">34</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-35">35</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-36">36</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-37">37</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-38">38</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-39">39</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-40">40</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-41">41</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-42">42</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-43">43</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-44">44</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-45">45</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-46">46</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-47">47</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-48">48</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-49">49</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-50">50</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-51">51</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-52">52</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-53">53</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-54">54</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-55">55</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-56">56</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-57">57</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-58">58</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-59">59</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-6-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.BiConsumer</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.TopicPartition</span><span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.IncomingKafkaRecord</span><span class="p">;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConnectorIncomingConfiguration</span><span class="p">;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumer</span><span class="p">;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.KafkaCommitHandler</span><span class="p">;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaCustomCommit</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">        </span><span class="c1">// called on message ack</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">received</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="c1">// called before message processing</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">graceful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="c1">// called on channel shutdown</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">partitionsAssigned</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="c1">// called on partitions assignment</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">partitionsRevoked</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="c1">// called on partitions revoked</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;custom&quot;</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Factory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">KafkaConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">                </span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">                </span><span class="n">KafkaConsumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">                </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reportFailure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KafkaCustomCommit</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Finally, to use the custom commit strategy,
set the <code>commit-strategy</code> attribute to the identifier of the commit handler factory:
<code>mp.messaging.incoming.$channel.commit-strategy=custom</code>.
Similarly, custom failure strategies can be configured using <code>failure-strategy</code> attribute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the custom strategy implementation inherits
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/commit/ContextHolder.html'>ContextHolder</a> class it can access the
Vert.x event-loop context created for the Kafka consumer</p>
</div>
<h2 id="kafka-receiving-kafka-records-retrying-processing">Retrying processing</h2>
<p>You can combine Reactive Messaging with <a href="https://github.com/smallrye/smallrye-fault-tolerance">SmallRye Fault
Tolerance</a>, and
retry processing when it fails:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-5">5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-7-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can configure the delay, the number of retries, the jitter...</p>
<p>If your method returns a <code>Uni</code>, you need to add the <code>@NonBlocking</code>
annotation:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-6">6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="nd">@NonBlocking</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception or the returned Uni produce a failure</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The incoming messages are acknowledged only once the processing
completes successfully. So, it commits the offset after the successful
processing. If after the retries the processing still failed, the
message is <em>nacked</em> and the failure strategy is applied.</p>
<p>You can also use <code>@Retry</code> on methods only consuming incoming messages:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-9-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-9-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-9-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-9-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-9-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-receiving-kafka-records-handling-deserialization-failures">Handling deserialization failures</h2>
<p>Because deserialization happens before creating a <code>Message</code>, the failure
strategy presented above cannot be applied. However, when a
deserialization failure occurs, you can intercept it and provide a
fallback value. To achieve this, create a CDI bean implementing the
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/api/DeserializationFailureHandler.html'>DeserializationFailureHandler</a>
interface:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-10-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;failure-retry&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Set the name of the failure handler</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyDeserializationFailureHandler</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">DeserializationFailureHandler</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Specify the expected type</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JsonObject</span><span class="w"> </span><span class="nf">decorateDeserialization</span><span class="p">(</span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deserialization</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deserializer</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">            </span><span class="n">Headers</span><span class="w"> </span><span class="n">headers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">deserialization</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">                    </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">retry</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">                    </span><span class="p">.</span><span class="na">await</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The bean must be exposed with the <code>@Identifier</code> qualifier specifying the
name of the bean. Then, in the connector configuration, specify the
following attribute:</p>
<ul>
<li>
<p><code>mp.messaging.incoming.$channel.key-deserialization-failure-handler</code>:
    name of the bean handling deserialization failures happening for the
    recordâ€™s key</p>
</li>
<li>
<p><code>mp.messaging.incoming.$channel.value-deserialization-failure-handler</code>:
    name of the bean handling deserialization failures happening for the
    recordâ€™s value,</p>
</li>
</ul>
<p>The handler is called with the deserialization action as a <code>Uni&lt;T&gt;</code>, the
recordâ€™s topic, a boolean indicating whether the failure happened on a
key, the class name of the deserializer that throws the exception, the
corrupted data, the exception, and the records headers augmented with
headers describing the failure (which ease the write to a dead letter).
On the deserialization <code>Uni</code> failure strategies like retry, providing a
fallback value or applying timeout can be implemented. Note that the
method must await on the result and return the deserialized object.
Alternatively, the handler can only implement
<code>handleDeserializationFailure</code> method and provide a fallback value,
which may be <code>null</code>.</p>
<p>If you donâ€™t configure a deserialization failure handlers and a
deserialization failure happens, the application is marked unhealthy.
You can also ignore the failure, which will log the exception and
produce a <code>null</code> value. To enable this behavior, set the
<code>mp.messaging.incoming.$channel.fail-on-deserialization-failure</code>
attribute to <code>false</code>.</p>
<p>If the <code>fail-on-deserialization-failure</code> attribute is set to <code>false</code> and
the <code>failure-strategy</code> attribute is <code>dead-letter-queue</code> the failed record
will be sent to the corresponding <em>dead letter queue</em> topic.
The forwarded record will have the original key and value,
and the following headers set:</p>
<ul>
<li><code>deserialization-failure-reason</code>: The deserialization failure message</li>
<li><code>deserialization-failure-cause</code>: The deserialization failure cause if any</li>
<li><code>deserialization-failure-key</code>: Whether the deserialization failure happened on a key</li>
<li><code>deserialization-failure-topic</code>: The topic of the incoming message when a deserialization failure happen</li>
<li><code>deserialization-failure-deserializer</code>: The class name of the underlying deserializer</li>
<li><code>deserialization-failure-key-data</code>: If applicable the key data that was not able to be deserialized</li>
<li><code>deserialization-failure-value-data</code>: If applicable the value data that was not able to be deserialized</li>
</ul>
<h2 id="kafka-receiving-kafka-records-receiving-cloud-events">Receiving Cloud Events</h2>
<p>The Kafka connector supports <a href="https://cloudevents.io/">Cloud Events</a>.
When the connector detects a <em>structured</em> or <em>binary</em> Cloud Events, it
adds a <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/IncomingKafkaCloudEventMetadata.html'>IncomingKafkaCloudEventMetadata</a> in the metadata of the
Message. <code>IncomingKafkaCloudEventMetadata</code> contains the various (mandatory and optional) Cloud Event attributes.</p>
<p>If the connector cannot extract the Cloud Event metadata, it sends the
Message without the metadata.</p>
<h3 id="kafka-receiving-kafka-records-binary-cloud-events">Binary Cloud Events</h3>
<p>For <code>binary</code> Cloud Events, <strong>all</strong> mandatory Cloud Event attributes must
be set in the record header, prefixed by <code>ce_</code> (as mandated by the
<a href="https://github.com/cloudevents/spec/blob/v1.0/kafka-protocol-binding.md">protocol
binding</a>).
The connector considers headers starting with the <code>ce_</code> prefix but not
listed in the specification as extensions. You can access them using the
<code>getExtension</code> method from <code>IncomingKafkaCloudEventMetadata</code>. You can
retrieve them as <code>String</code>.</p>
<p>The <code>datacontenttype</code> attribute is mapped to the <code>content-type</code> header
of the record. The <code>partitionkey</code> attribute is mapped to the recordâ€™s
key, if any.</p>
<p>Note that all headers are read as UTF-8.</p>
<p>With binary Cloud Events, the recordâ€™s key and value can use any
deserializer.</p>
<h3 id="kafka-receiving-kafka-records-structured-cloud-events">Structured Cloud Events</h3>
<p>For <code>structured</code> Cloud Events, the event is encoded in the recordâ€™s
value. Only JSON is supported, so your event must be encoded as JSON in
the recordâ€™s value.</p>
<p>Structured Cloud Event must set the <code>content-type</code> header of the record
to <code>application/cloudevents</code> or prefix the value with
<code>application/cloudevents</code> such as:
<code>application/cloudevents+json; charset=UTF-8</code>.</p>
<p>To receive structured Cloud Events, your value deserializer must be:</p>
<ul>
<li>
<p><code>org.apache.kafka.common.serialization.StringDeserializer</code></p>
</li>
<li>
<p><code>org.apache.kafka.common.serialization.ByteArrayDeserializer</code></p>
</li>
<li>
<p><code>io.vertx.kafka.client.serialization.JsonObjectDeserializer</code></p>
</li>
</ul>
<p>As mentioned previously, the value must be a valid JSON object
containing at least all the mandatory Cloud Events attributes.</p>
<p>If the record is a structured Cloud Event, the created Messageâ€™s payload
is the Cloud Event <code>data</code>.</p>
<p>The <code>partitionkey</code> attribute is mapped to the recordâ€™s key if any.</p>
<h2 id="kafka-receiving-kafka-records-consumer-rebalance-listener">Consumer Rebalance Listener</h2>
<p>To handle offset commit and assigned partitions yourself, you can
provide a consumer rebalance listener. To achieve this, implement the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface, make the implementing class a bean, and add the <code>@Identifier</code>
qualifier. A usual use case is to store offset in a separate data store
to implement exactly-once semantic, or starting the processing at a
specific offset.</p>
<p>The listener is invoked every time the consumer topic/partition
assignment changes. For example, when the application starts, it invokes
the <code>partitionsAssigned</code> callback with the initial set of
topics/partitions associated with the consumer. If, later, this set
changes, it calls the <code>partitionsRevoked</code> and <code>partitionsAssigned</code>
callbacks again, so you can implement custom logic.</p>
<p>Note that the rebalance listener methods are called from the Kafka
<em>polling</em> thread and must block the caller thread until completion.
Thatâ€™s because the rebalance protocol has synchronization barriers, and
using asynchronous code in a rebalance listener may be executed after
the synchronization barrier.</p>
<p>When topics/partitions are assigned or revoked from a consumer, it
pauses the message delivery and restarts once the rebalance completes.</p>
<p>If the rebalance listener handles offset commit on behalf of the user
(using the <code>ignore</code> commit strategy), the rebalance listener <strong>must</strong>
commit the offset synchronously in the <code>partitionsRevoked</code> callback. We
also recommend applying the same logic when the application stops.</p>
<p>Unlike the <code>ConsumerRebalanceListener</code> from Apache Kafka, the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
methods pass the Kafka <code>Consumer</code> and the set of topics/partitions.</p>
<h3 id="kafka-receiving-kafka-records-example_1">Example</h3>
<p>In this example we set-up a consumer that always starts on messages from
at most 10 minutes ago (or offset 0). First we need to provide a bean
that implements the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface and is annotated with <code>@Identifier</code>. We then must configure
our inbound connector to use this named bean.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-21">21</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-22">22</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-23">23</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-24">24</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-25">25</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-26">26</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-27">27</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-28">28</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-29">29</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-30">30</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-31">31</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-32">32</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-33">33</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-34">34</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-35">35</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-36">36</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-37">37</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-38">38</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-39">39</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-40">40</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-41">41</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-42">42</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-43">43</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-44">44</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-45">45</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-46">46</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-47">47</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-48">48</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-11-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.Consumer</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.OffsetAndTimestamp</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;rebalanced-example.rebalancer&quot;</span><span class="p">)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumerRebalanceListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaConsumerRebalanceListener</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">KafkaRebalancedConsumerRebalanceListener</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="cm">     * When receiving a list of partitions will search for the earliest offset within 10 minutes</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="cm">     * and seek the consumer to it.</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="cm">     *</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="cm">     * @param consumer underlying consumer</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="cm">     * @param partitions set of assigned topic partitions</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="cm">     */</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPartitionsAssigned</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">            </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">600_000L</span><span class="p">;</span><span class="w"> </span><span class="c1">//10 minute ago</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Assigned &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">partition</span><span class="p">);</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="p">);</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="w">                </span><span class="p">.</span><span class="na">offsetsForTimes</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">offsets</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">offset</span><span class="p">();</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Seeking position &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a><span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="na">seek</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-21">21</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-22">22</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-12-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Acknowledgment</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.IncomingKafkaRecord</span><span class="p">;</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;rebalanced-example&quot;</span><span class="p">)</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="nd">@Acknowledgment</span><span class="p">(</span><span class="n">Acknowledgment</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">NONE</span><span class="p">)</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">        </span><span class="c1">// We don&#39;t need to ACK messages because in this example we set offset during consumer re-balance</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a>
<a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To configure the inbound connector to use the provided listener we
either set the consumer rebalance listenerâ€™s name:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.consumer-rebalance-listener.name=rebalanced-example.rebalancer</code></li>
</ul>
<p>Or have the listenerâ€™s name be the same as the group id:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.group.id=rebalanced-example.rebalancer</code></li>
</ul>
<p>Setting the consumer rebalance listenerâ€™s name takes precedence over
using the group id.</p>
<h2 id="kafka-receiving-kafka-records-receiving-kafka-records-in-batches">Receiving Kafka Records in Batches</h2>
<p>By default, incoming methods receive each Kafka record individually.
Under the hood, Kafka consumer clients poll the broker constantly and
receive records in batches, presented inside the <code>ConsumerRecords</code>
container.</p>
<p>In <strong>batch</strong> mode, your application can receive all the records returned
by the consumer <strong>poll</strong> in one go.</p>
<p>To achieve this you need to set
<code>mp.messaging.incoming.$channel.batch=true</code> <strong>and</strong> specify a compatible
container type to receive all the data:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-1">1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-2">2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-3">3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-4">4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-5">5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">        </span><span class="c1">// process price</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The incoming method can also receive <code>Message&lt;List&lt;Payload&gt;</code>,
<code>KafkaBatchRecords&lt;Payload&gt;</code> <code>ConsumerRecords&lt;Key, Payload&gt;</code> types, They
give access to record details such as offset or timestamp :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-21">21</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-14-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumeMessage</span><span class="p">(</span><span class="n">KafkaRecordBatch</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">KafkaRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="kd">record</span><span class="err">.</span><span class="nc">getMetadata</span><span class="p">(</span><span class="n">IncomingKafkaRecordMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">metadata</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getPartition</span><span class="p">();</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getOffset</span><span class="p">();</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">            </span><span class="n">Instant</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">();</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">            </span><span class="c1">//... process messages</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="c1">// ack will commit the latest offsets (per partition) of the batch.</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="p">}</span>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumeRecords</span><span class="p">(</span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">partitions</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">records</span><span class="p">(</span><span class="n">partition</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">            </span><span class="c1">//... process messages</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Note that the successful processing of the incoming record batch will
commit the latest offsets for each partition received inside the batch.
The configured commit strategy will be applied for these records only.</p>
<p>Conversely, if the processing throws an exception, all messages are
<em>nacked</em>, applying the failure strategy for all the records inside the
batch.</p>
<h2 id="kafka-receiving-kafka-records-manual-topic-partition-assignment">Manual topic-partition assignment</h2>
<p>The default behavior of Kafka incoming channels is to subscribe to one or more topics in order to receive records from the Kafka broker.
Channel attributes <code>topic</code> and <code>topics</code> allow specifying topics to subscribe to,
or <code>pattern</code> attribute allows to subscribe to all topics matching a regular expression.
Subscribing to topics allows partitioning consumption of topics by dynamically assigning (rebalancing) partitions between members of a consumer group.</p>
<p>The <code>assign-seek</code> configuration attribute allows manually assigning topic-partitions to a Kafka incoming channel,
and optionally seek to a specified offset in the partition to start consuming records.
If <code>assign-seek</code> is used, the consumer will not be dynamically subscribed to topics,
but instead will statically assign the described partitions.
In manual topic-partition rebalancing doesn't happen and therefore rebalance listeners are never called.</p>
<p>The attribute takes a list of triplets separated by commas: <code>&lt;topic&gt;:&lt;partition&gt;:&lt;offset&gt;</code>.</p>
<p>For example, the following configuration</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-15-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="na">mp.messaging.incoming.data.assign-seek</span><span class="o">=</span><span class="s">topic1:0:10, topic2:1:20</span>
</code></pre></div></td></tr></table></div>
<p>assigns the consumer to:
- Partition 0 of topic 'topic1', setting the initial position at offset 10.
- Partition 1 of topic 'topic2', setting the initial position at offset 20.</p>
<p>The topic, partition, and offset in each triplet can have the following variations:
- If the topic is omitted, the configured <code>topic</code> will be used.
- If the offset is omitted, partitions are assigned to the consumer but won't be seeked to offset.
- If offset is 0, it seeks to the beginning of the topic-partition.
- If offset is -1, it seeks to the end of the topic-partition.</p>
<h2 id="kafka-receiving-kafka-records-stateful-processing-with-checkpointing">Stateful processing with Checkpointing</h2>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Checkpointing is experimental, and APIs and features are subject
to change in the future.</p>
</div>
<p>The <code>checkpoint</code> commit strategy allows for a Kafka incoming channel to
manage topic-partition offsets, not by committing on the Kafka broker,
but by persisting consumers' advancement on a
<a href="#kafka-receiving-kafka-records-implementing-state-stores"><em>state store</em></a>.</p>
<p>In addition to that, if the consumer builds an internal state as
a result of consumed records, the topic-partition offset persisted
to the state store can be associated with a <em>processing state</em>,
saving the local state to the persistent store. When a consumer
restarts or consumer group instances scale, i.e. when new partitions
get assigned to the consumer, the checkpointing works by resuming the
processing from the latest offset and its saved state.</p>
<p>The <code>@Incoming</code> channel consumer code can manipulate the processing
state through the <code>CheckpointMetadata</code> API:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-16-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="c1">// Get the `CheckpointMetadata` from the incoming message</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="n">CheckpointMetadata</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckpointMetadata</span><span class="p">.</span><span class="na">fromMessage</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="c1">// `CheckpointMetadata` allows transforming the processing state</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="c1">// Applies the given function, starting from the value `0.0` when no previous state exists</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="n">checkpoint</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">getPayload</span><span class="p">(),</span><span class="w"> </span><span class="cm">/* persistOnAck */</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="c1">// `persistOnAck` flag set to true, ack will persist the processing state</span>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="c1">// associated with the latest offset (per partition).</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>transform</code> method allows applying a transformation function to
the current state, producing a changed state and registering it
locally for checkpointing. By default, the local state is synced
(persisted) to the state store periodically, period specified by
<code>auto.commit.interval.ms</code>, (default: 5000). If <code>persistOnAck</code> flag
is given, the latest state is persisted to the state store eagerly
on message acknowledgment. The <code>setNext</code> method works similarly
directly setting the latest state.</p>
<p>The <code>checkpoint</code> commit strategy tracks when a processing state
is last persisted for each topic-partition. If an outstanding state
change can not be persisted for <code>checkpoint.unsynced-state-max-age.ms</code>
(default: 10000), the channel is marked unhealthy.</p>
<p>Where and how processing states are persisted is decided by the
state store implementation. This can be configured on the incoming
channel using <code>checkpoint.state-store</code> configuration property,
using the state store factory identifier name.
The serialization of state objects depends on the state store
implementation. In order to instruct state stores for serialization
can require configuring the type name of state objects
using <code>checkpoint.state-type</code> property.</p>
<p>In order to keep Smallrye Reactive Messaging free of persistence-related
dependencies, this library includes only a default state store named <code>file</code>.
It is based on Vert.x Filesystem API and stores the processing state
in Json formatted files, in a local directory configured by the
<code>checkpoint.file.state-dir</code> property. State files follow the naming
scheme <code>[consumer-group-id]:[topic]:[partition]</code>.</p>
<h3 id="kafka-receiving-kafka-records-implementing-state-stores">Implementing State Stores</h3>
<p>State store implementations are required to implement <code>CheckpointStateStore</code>
interface, and provide a managed bean implementing
<code>CheckpointStateStore.Factory</code>, identified with <code>@Identifier</code> bean
qualifier indicating the name of the state-store.
The factory bean identifier indicates the name to configure on
<code>checkpoint.state-store</code> config property.
The factory is discovered as a CDI managed bean and state store is
created once per channel:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-10">10</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-11">11</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-12">12</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-13">13</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-14">14</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-15">15</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-16">16</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-17">17</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-18">18</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-19">19</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-20">20</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-21">21</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-22">22</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-23">23</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-24">24</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-25">25</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-26">26</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-27">27</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-28">28</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-29">29</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-30">30</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-31">31</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-32">32</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-33">33</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-34">34</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-35">35</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-36">36</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-37">37</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-38">38</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-39">39</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-40">40</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-41">41</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-42">42</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-43">43</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-44">44</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-45">45</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-46">46</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-47">47</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-48">48</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-49">49</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-50">50</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-51">51</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-52">52</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-53">53</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-54">54</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-55">55</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-56">56</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-57">57</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-58">58</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-59">59</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-60">60</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-61">61</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-62">62</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-63">63</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-64">64</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-65">65</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-66">66</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-67">67</a></span>
<span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-17-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.ConsumerConfig</span><span class="p">;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.TopicPartition</span><span class="p">;</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConnectorIncomingConfiguration</span><span class="p">;</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumer</span><span class="p">;</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.CheckpointStateStore</span><span class="p">;</span>
<a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.ProcessingState</span><span class="p">;</span>
<a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-17-18" name="__codelineno-17-18"></a>
<a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyCheckpointStateStore</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-20" name="__codelineno-17-20"></a>
<a id="__codelineno-17-21" name="__codelineno-17-21"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">;</span>
<a id="__codelineno-17-22" name="__codelineno-17-22"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="p">;</span>
<a id="__codelineno-17-23" name="__codelineno-17-23"></a>
<a id="__codelineno-17-24" name="__codelineno-17-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyCheckpointStateStore</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-25" name="__codelineno-17-25"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">consumerGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">;</span>
<a id="__codelineno-17-26" name="__codelineno-17-26"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stateType</span><span class="p">;</span>
<a id="__codelineno-17-27" name="__codelineno-17-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-28" name="__codelineno-17-28"></a>
<a id="__codelineno-17-29" name="__codelineno-17-29"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-17-30" name="__codelineno-17-30"></a><span class="cm">     * Can be used with</span>
<a id="__codelineno-17-31" name="__codelineno-17-31"></a><span class="cm">     * {@code mp.reactive.messaging.incoming.my-channel.commit-strategy=checkpoint}</span>
<a id="__codelineno-17-32" name="__codelineno-17-32"></a><span class="cm">     * {@code mp.reactive.messaging.incoming.my-channel.checkpoint.state-store=my-store}</span>
<a id="__codelineno-17-33" name="__codelineno-17-33"></a><span class="cm">     */</span>
<a id="__codelineno-17-34" name="__codelineno-17-34"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-17-35" name="__codelineno-17-35"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-store&quot;</span><span class="p">)</span>
<a id="__codelineno-17-36" name="__codelineno-17-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Factory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-37" name="__codelineno-17-37"></a>
<a id="__codelineno-17-38" name="__codelineno-17-38"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-17-39" name="__codelineno-17-39"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">KafkaConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-17-40" name="__codelineno-17-40"></a><span class="w">                </span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span>
<a id="__codelineno-17-41" name="__codelineno-17-41"></a><span class="w">                </span><span class="n">KafkaConsumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-17-42" name="__codelineno-17-42"></a><span class="w">                </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="w"> </span><span class="cm">/* if configured, otherwise null */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-43" name="__codelineno-17-43"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">configuration</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ConsumerConfig</span><span class="p">.</span><span class="na">GROUP_ID_CONFIG</span><span class="p">);</span>
<a id="__codelineno-17-44" name="__codelineno-17-44"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyCheckpointStateStore</span><span class="p">(</span><span class="n">consumerGroupId</span><span class="p">,</span><span class="w"> </span><span class="n">stateType</span><span class="p">);</span>
<a id="__codelineno-17-45" name="__codelineno-17-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-17-46" name="__codelineno-17-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-47" name="__codelineno-17-47"></a>
<a id="__codelineno-17-48" name="__codelineno-17-48"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-17-49" name="__codelineno-17-49"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessingState</span><span class="o">&lt;?&gt;&gt;&gt;</span><span class="w"> </span><span class="n">fetchProcessingState</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-50" name="__codelineno-17-50"></a><span class="w">        </span><span class="c1">// Called on Vert.x event loop</span>
<a id="__codelineno-17-51" name="__codelineno-17-51"></a><span class="w">        </span><span class="c1">// Return a Uni completing with the map of topic-partition to processing state</span>
<a id="__codelineno-17-52" name="__codelineno-17-52"></a><span class="w">        </span><span class="c1">// The Uni will be subscribed also on Vert.x event loop</span>
<a id="__codelineno-17-53" name="__codelineno-17-53"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">nullItem</span><span class="p">();</span>
<a id="__codelineno-17-54" name="__codelineno-17-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-55" name="__codelineno-17-55"></a>
<a id="__codelineno-17-56" name="__codelineno-17-56"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-17-57" name="__codelineno-17-57"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">persistProcessingState</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessingState</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-58" name="__codelineno-17-58"></a><span class="w">        </span><span class="c1">// Called on Vert.x event loop</span>
<a id="__codelineno-17-59" name="__codelineno-17-59"></a><span class="w">        </span><span class="c1">// Return a Uni completing with void when the given states are persisted</span>
<a id="__codelineno-17-60" name="__codelineno-17-60"></a><span class="w">        </span><span class="c1">// The Uni will be subscribed also on Vert.x event loop</span>
<a id="__codelineno-17-61" name="__codelineno-17-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-17-62" name="__codelineno-17-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-63" name="__codelineno-17-63"></a>
<a id="__codelineno-17-64" name="__codelineno-17-64"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-17-65" name="__codelineno-17-65"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-66" name="__codelineno-17-66"></a><span class="w">        </span><span class="cm">/* Called when channel is closing, no-op by default */</span>
<a id="__codelineno-17-67" name="__codelineno-17-67"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-68" name="__codelineno-17-68"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The checkpoint commit strategy calls the state store in following events:</p>
<ul>
<li><code>fetchProcessingState</code> : on partitions assigned, to seek the consumer to the latest offset.</li>
<li><code>persistProcessingState</code> on partitions revoked, to persist the state of last processed record.</li>
<li><code>persistProcessingState</code> on message acknowledgement, if a new state is set during the processing and <code>persistOnAck</code> flag is set.</li>
<li><code>persistProcessingState</code> on <code>auto.commit.interval.ms</code> intervals, if a new state is set during processing.</li>
<li><code>persistProcessingState</code> on channel shutdown.</li>
<li><code>close</code> on channel shutdown.</li>
</ul>
<h2 id="kafka-receiving-kafka-records-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>assign-seek</em></td>
<td style="text-align: left;">Assign partitions and optionally seek to offsets, instead of subscribing to topics. A comma-separating list of triplets in form of <code>&lt;topic&gt;:|&lt;partition&gt;|:&lt;offset&gt;</code> to assign statically to the consumer and seek to the given offsets. Offset <code>0</code> seeks to beginning and offset <code>-1</code> seeks to the end of the topic-partition. If the topic is omitted the configured topic will be used. If the offset is omitted partitions are assigned to the consumer but won't be seeked to offset.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto.offset.reset</em></td>
<td style="text-align: left;">What to do when there is no initial offset in Kafka.Accepted values are earliest, latest and none</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>latest</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>batch</em></td>
<td style="text-align: left;">Whether the Kafka records are consumed in batch. The channel injection point must consume a compatible type, such as <code>List&lt;Payload&gt;</code> or <code>KafkaRecordBatch&lt;Payload&gt;</code>.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>bootstrap.servers</em> <em>(kafka.bootstrap.servers)</em></td>
<td style="text-align: left;">A comma-separated list of host:port to use for establishing the initial connection to the Kafka cluster.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost:9092</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether the Kafka records should be dispatched to multiple consumer</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.state-store</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, the name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.StateStore.Factory</code> to specify the state store implementation.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.state-type</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, the fully qualified type name of the state object to persist in the state store. When provided, it can be used by the state store implementation to help persisting the processing state object.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.unsynced-state-max-age.ms</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, specify the max age in milliseconds that the processing state must be persisted before the connector is marked as unhealthy. Setting this attribute to 0 disables this monitoring.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id-prefix</em></td>
<td style="text-align: left;">Prefix for Kafka client <code>client.id</code> attribute. If defined configured or generated <code>client.id</code> will be prefixed with the given value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events</em></td>
<td style="text-align: left;">Enables (default) or disables the Cloud Event support. If enabled on an <em>incoming</em> channel, the connector analyzes the incoming records and try to create Cloud Event metadata. If enabled on an <em>outgoing</em>, the connector sends the outgoing messages as Cloud Event if the message includes Cloud Event Metadata.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>commit-strategy</em></td>
<td style="text-align: left;">Specify the commit strategy to apply when a message produced from a record is acknowledged. Values can be <code>latest</code>, <code>ignore</code> or <code>throttled</code>. If <code>enable.auto.commit</code> is true then the default is <code>ignore</code> otherwise it is <code>throttled</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>consumer-rebalance-listener.name</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>. If set, this rebalance listener is applied to the consumer.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.key.serializer</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the key serializer to use. If not set the serializer associated to the key deserializer is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.producer-client-id</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates what client id the generated producer should use. Defaults is <code>kafka-dead-letter-topic-producer-$client-id</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.topic</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates on which topic the record is sent. Defaults is <code>dead-letter-topic-$channel</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.value.serializer</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the value serializer to use. If not set the serializer associated to the value deserializer is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.max-retries</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates the maximum number of retries. If higher than the number of delayed retry topics, last topic is used.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.timeout</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates the global timeout per record.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>120000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.topics</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates topics to use. If not set the source channel name is used, with 10, 20 and 50 seconds delayed topics.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>enable.auto.commit</em></td>
<td style="text-align: left;">If enabled, consumer's offset will be periodically committed in the background by the underlying Kafka client, ignoring the actual processing outcome of the records. It is recommended to NOT enable this setting and let Reactive Messaging handles the commit.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>fail-on-deserialization-failure</em></td>
<td style="text-align: left;">When no deserialization failure handler is set and a deserialization failure happens, report the failure and mark the application as unhealthy. If set to <code>false</code> and a deserialization failure happens, a <code>null</code> value is forwarded.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from a record is acknowledged negatively (nack). Values can be <code>fail</code> (default), <code>ignore</code>, or <code>dead-letter-queue</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>fail</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>fetch.min.bytes</em></td>
<td style="text-align: left;">The minimum amount of data the server should return for a fetch request. The default setting of 1 byte means that fetch requests are answered as soon as a single byte of data is available or the fetch request times out waiting for data to arrive.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>graceful-shutdown</em></td>
<td style="text-align: left;">Whether or not a graceful shutdown should be attempted when the application terminates.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>group.id</em></td>
<td style="text-align: left;">A unique string that identifies the consumer group the application belongs to. If not set, a unique, generated id is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-enabled</em></td>
<td style="text-align: left;">Whether readiness health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-timeout</em></td>
<td style="text-align: left;"><em>deprecated</em> - During the readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready. Deprecated: Use 'health-topic-verification-timeout' instead.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-topic-verification</em></td>
<td style="text-align: left;"><em>deprecated</em> - Whether the readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin connection. Deprecated: Use 'health-topic-verification-enabled' instead.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-enabled</em></td>
<td style="text-align: left;">Whether the startup and readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin client connection.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-readiness-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the readiness health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-startup-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the startup health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-timeout</em></td>
<td style="text-align: left;">During the startup and readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>kafka-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Kafka consumer/producer configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key-deserialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.DeserializationFailureHandler</code>. If set, deserialization failure happening when deserializing keys are delegated to this handler which may retry or provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key.deserializer</em></td>
<td style="text-align: left;">The deserializer classname used to deserialize the record's key</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>org.apache.kafka.common.serialization.StringDeserializer</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>lazy-client</em></td>
<td style="text-align: left;">Whether Kafka client is created lazily or eagerly.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-queue-size-factor</em></td>
<td style="text-align: left;">Multiplier factor to determine maximum number of records queued for processing, using <code>max.poll.records</code> * <code>max-queue-size-factor</code>. Defaults to 2. In <code>batch</code> mode <code>max.poll.records</code> is considered <code>1</code>.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>partitions</em></td>
<td style="text-align: left;">The number of partitions to be consumed concurrently. The connector creates the specified amount of Kafka consumers. It should match the number of partition of the targeted topic</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>pattern</em></td>
<td style="text-align: left;">Indicate that the <code>topic</code> property is a regular expression. Must be used with the <code>topic</code> property. Cannot be used with the <code>topics</code> property</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>pause-if-no-requests</em></td>
<td style="text-align: left;">Whether the polling must be paused when the application does not request items and resume when it does. This allows implementing back-pressure based on the application capacity. Note that polling is not stopped, but will not retrieve any records when paused.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>poll-timeout</em></td>
<td style="text-align: left;">The polling timeout in milliseconds. When polling records, the poll will wait at most that duration before returning records. Default is 1000ms</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requests</em></td>
<td style="text-align: left;">When <code>partitions</code> is greater than 1, this attribute allows configuring how many records are requested by each consumers every time.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>128</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry</em></td>
<td style="text-align: left;">Whether or not the connection to the broker is re-attempted in case of failure</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry-attempts</em></td>
<td style="text-align: left;">The maximum number of reconnection before failing. -1 means infinite retry</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>-1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry-max-wait</em></td>
<td style="text-align: left;">The max delay (in seconds) between 2 reconnects</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>30</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>throttled.unprocessed-record-max-age.ms</em></td>
<td style="text-align: left;">While using the <code>throttled</code> commit-strategy, specify the max age in milliseconds that an unprocessed message can be before the connector is marked as unhealthy. Setting this attribute to 0 disables this monitoring.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">The consumed / populated Kafka topic. If neither this property nor the <code>topics</code> properties are set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>topics</em></td>
<td style="text-align: left;">A comma-separating list of topics to be consumed. Cannot be used with the <code>topic</code> or <code>pattern</code> properties</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>value-deserialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.DeserializationFailureHandler</code>. If set, deserialization failure happening when deserializing values are delegated to this handler which may retry or provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>value.deserializer</em></td>
<td style="text-align: left;">The deserializer classname used to deserialize the record's value</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>You can also pass any property supported by the underlying <a href="https://kafka.apache.org/documentation/#consumerconfigs">Kafka
consumer</a>.</p>
<p>For example, to configure the <code>max.poll.records</code> property, use:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-receiving-kafka-records-__codelineno-18-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="na">mp.messaging.incoming.[channel].max.poll.records</span><span class="o">=</span><span class="s">1000</span>
</code></pre></div></td></tr></table></div>
<p>Some consumer client properties are configured to sensible default
values:</p>
<p>If not set, <code>reconnect.backoff.max.ms</code> is set to <code>10000</code> to avoid high
load on disconnection.</p>
<p>If not set, <code>key.deserializer</code> is set to
<code>org.apache.kafka.common.serialization.StringDeserializer</code>.</p>
<p>The consumer <code>client.id</code> is configured according to the number of
clients to create using <code>mp.messaging.incoming.[channel].partitions</code>
property.</p>
<ul>
<li>
<p>If a <code>client.id</code> is provided, it is used as-is or suffixed with
    client index if <code>partitions</code> property is set.</p>
</li>
<li>
<p>If a <code>client.id</code> is not provided, it is generated as
    <code>kafka-consumer-[channel][-index]</code>.</p>
</li>
</ul></section><section class="print-page" id="kafka-writing-kafka-records"><h1 id="kafka-writing-kafka-records-writing-kafka-records">Writing Kafka Records</h1>
<p>The Kafka Connector can write Reactive Messaging <code>Messages</code> as Kafka
Records.</p>
<h2 id="kafka-writing-kafka-records-example">Example</h2>
<p>Letâ€™s imagine you have a Kafka broker running, and accessible using the
<code>kafka:9092</code> address (by default it would use <code>localhost:9092</code>).
Configure your application to write the messages from the <code>prices</code>
channel into a Kafka <em>topic</em> as follows:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">kafka.bootstrap.servers</span><span class="o">=</span><span class="s">kafka:9092 # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.outgoing.prices-out.connector</span><span class="o">=</span><span class="s">smallrye-kafka # &lt;2&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.outgoing.prices-out.value.serializer</span><span class="o">=</span><span class="s">org.apache.kafka.common.serialization.DoubleSerializer # &lt;3&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">mp.messaging.outgoing.prices-out.topic</span><span class="o">=</span><span class="s">prices # &lt;4&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Configure the broker location. You can configure it globally or per
    channel
2.  Configure the connector to manage the <code>prices</code> channel
3.  Sets the (Kafka) serializer to encode the message payload into the
    recordâ€™s value
4.  Make sure the topic name is <code>prices</code> (and not the default
    <code>prices-out</code>)</p>
<p>Then, your application must send <code>Message&lt;Double&gt;</code> to the <code>prices</code>
channel. It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices-out&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices-out&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()));</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-writing-kafka-records-serialization">Serialization</h2>
<p>The serialization is handled by the underlying Kafka Client. You need to
configure the:</p>
<ul>
<li>
<p><code>mp.messaging.outgoing.[channel-name].value.serializer</code> to configure
    the value serializer (mandatory)</p>
</li>
<li>
<p><code>mp.messaging.outgoing.[channel-name].key.serializer</code> to configure
    the key serializer (optional, default to <code>String</code>)</p>
</li>
</ul>
<p>If you want to use a custom serializer, add it to your <code>CLASSPATH</code> and
configure the associate attribute.</p>
<p>By default, the written record contains:</p>
<ul>
<li>
<p>the <code>Message</code> payload as <em>value</em></p>
</li>
<li>
<p>no key, or the key configured using the <code>key</code> attribute or the key
    passed in the metadata attached to the <code>Message</code></p>
</li>
<li>
<p>the timestamp computed for the system clock (<code>now</code>) or the timestamp
    passed in the metadata attached to the <code>Message</code></p>
</li>
</ul>
<h2 id="kafka-writing-kafka-records-sending-keyvalue-pairs">Sending key/value pairs</h2>
<p>In the Kafka world, itâ€™s often necessary to send <em>records</em>, i.e. a
key/value pair. The connector provides the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/Record.html'>io.smallrye.reactive.messaging.kafka.Record</a>
class that you can use to send a pair:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-3-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Record</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Record</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>When the connector receives a message with a <code>Record</code> payload, it
extracts the key and value from it. The configured serializers for the
key and the value must be compatible with the recordâ€™s key and value.
Note that the <code>key</code> and the <code>value</code> can be <code>null</code>. It is also possible
to create a record with a <code>null</code> key AND a <code>null</code> value.</p>
<p>If you need more control on the written records, use
<code>OutgoingKafkaRecordMetadata</code>.</p>
<h2 id="kafka-writing-kafka-records-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Messages</code>, you can add an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/api/OutgoingKafkaRecordMetadata.html'>OutgoingKafkaRecordMetadata</a>
to influence how the message is going to be written to Kafka. For example,
you can add Kafka headers, configure the record keyâ€¦</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-4-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Creates an OutgoingKafkaRecordMetadata</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">// The type parameter is the type of the record&#39;s key</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">OutgoingKafkaRecordMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingKafkaRecordMetadata</span><span class="p">.</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">builder</span><span class="p">()</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="p">.</span><span class="na">withKey</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">        </span><span class="p">.</span><span class="na">withHeaders</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RecordHeaders</span><span class="p">().</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;my-header&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()))</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-writing-kafka-records-propagating-record-key">Propagating Record Key</h2>
<p>When processing messages, you can propagate incoming record key to the
outgoing record.</p>
<p>Consider the following example method, which consumes messages from the
channel <code>in</code>, transforms the payload, and writes the result to the
channel <code>out</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.88</span><span class="p">;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Enabled with
<code>mp.messaging.outgoing.[channel-name].propagate-record-key=true</code>
configuration, record key propagation produces the outgoing record with
the same <em>key</em> as the incoming record.</p>
<p>If the outgoing record already contains a <em>key</em>, it <strong>wonâ€™t be
overridden</strong> by the incoming record key. If the incoming record does
have a <em>null</em> key, the <code>mp.messaging.outgoing.[channel-name].key</code>
property is used.</p>
<h2 id="kafka-writing-kafka-records-propagating-record-headers">Propagating Record headers</h2>
<p>You can also propagate incoming record headers to the outgoing record, by specifying the list of headers to be considered.</p>
<p><code>mp.messaging.outgoing.[channel-name].propagate-headers=Authorization,Proxy-Authorization</code></p>
<p>If the ougoing record already defines a header with the same key, it won't be overriden by the incoming header.</p>
<h2 id="kafka-writing-kafka-records-dynamic-topic-names">Dynamic topic names</h2>
<p>Sometimes it is desirable to select the destination of a message
dynamically. In this case, you should not configure the topic inside
your application configuration file, but instead, use the outbound
metadata to set the name of the topic.</p>
<p>For example, you can route to a dynamic topic based on the incoming
message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-6">6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-7">7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-6-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">String</span><span class="w"> </span><span class="n">topicName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectTopicFromIncommingMessage</span><span class="p">(</span><span class="n">incoming</span><span class="p">);</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">OutgoingKafkaRecordMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingKafkaRecordMetadata</span><span class="p">.</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">builder</span><span class="p">()</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">        </span><span class="p">.</span><span class="na">withTopic</span><span class="p">(</span><span class="n">topicName</span><span class="p">)</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-writing-kafka-records-acknowledgement">Acknowledgement</h2>
<p>Kafka acknowledgement can take times depending on the configuration.
Also, it stores in-memory the records that cannot be written.</p>
<p>By default, the connector does wait for Kafka to acknowledge the record
to continue the processing (acknowledging the received <code>Message</code>). You
can disable this by setting the <code>waitForWriteCompletion</code> attribute to
<code>false</code>.</p>
<p>Note that the <code>acks</code> attribute has a huge impact on the record
acknowledgement.</p>
<p>If a record cannot be written, the message is <code>nacked</code>.</p>
<h2 id="kafka-writing-kafka-records-back-pressure-and-inflight-records">Back-pressure and inflight records</h2>
<p>The Kafka outbound connector handles back-pressure monitoring the number
of in-flight messages waiting to be written to the Kafka broker. The
number of in-flight messages is configured using the
<code>max-inflight-messages</code> attribute and defaults to 1024.</p>
<p>The connector only sends that amount of messages concurrently. No other
messages will be sent until at least one in-flight message gets
acknowledged by the broker. Then, the connector writes a new message to
Kafka when one of the brokerâ€™s in-flight messages get acknowledged. Be
sure to configure Kafkaâ€™s <code>batch.size</code> and <code>linger.ms</code> accordingly.</p>
<p>You can also remove the limit of inflight messages by setting
<code>max-inflight-messages</code> to <code>0</code>. However, note that the Kafka Producer
may block if the number of requests reaches
<code>max.in.flight.requests.per.connection</code>.</p>
<h2 id="kafka-writing-kafka-records-handling-serialization-failures">Handling serialization failures</h2>
<p>For Kafka producer client serialization failures are not recoverable,
thus the message dispatch is not retried. However, using schema
registries, serialization may intermittently fail to contact the
registry. In these cases you may need to apply a failure strategy for
the serializer. To achieve this, create a CDI bean implementing the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.16.0/io/smallrye/reactive/messaging/kafka/SerializationFailureHandler.html'>SerializationFailureHandler</a>
interface:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-7-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;failure-fallback&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Set the name of the failure handler</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MySerializationFailureHandler</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">SerializationFailureHandler</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Specify the expected type</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">decorateSerialization</span><span class="p">(</span><span class="n">Uni</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">serialization</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">                </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">serializer</span><span class="p">,</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">                </span><span class="n">Object</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">Headers</span><span class="w"> </span><span class="n">headers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">serialization</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">                    </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">retry</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">                    </span><span class="p">.</span><span class="na">await</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The bean must be exposed with the <code>@Identifier</code> qualifier specifying the
name of the bean. Then, in the connector configuration, specify the
following attribute:</p>
<ul>
<li>
<p><code>mp.messaging.incoming.$channel.key-serialization-failure-handler</code>:
    name of the bean handling serialization failures happening for the
    recordâ€™s key</p>
</li>
<li>
<p><code>mp.messaging.incoming.$channel.value-serialization-failure-handler</code>:
    name of the bean handling serialization failures happening for the
    recordâ€™s value,</p>
</li>
</ul>
<p>The handler is called with the serialization action as a <code>Uni</code>, the
recordâ€™s topic, a boolean indicating whether the failure happened on a
key, the class name of the deserializer that throws the exception, the
corrupted data, the exception, and the records headers. Failure
strategies like retry, providing a fallback value or applying timeout
can be implemented. Note that the method must await on the result and
return the serialized byte array. Alternatively, the handler can
implement <code>decorateSerialization</code> method which can return a fallback
value.</p>
<h2 id="kafka-writing-kafka-records-sending-cloud-events">Sending Cloud Events</h2>
<p>The Kafka connector supports <a href="https://cloudevents.io/">Cloud Events</a>.
The connector sends the outbound record as Cloud Events if:</p>
<ul>
<li>
<p>the message metadata contains an
    <code>io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</code>
    instance,</p>
</li>
<li>
<p>the channel configuration defines the <code>cloud-events-type</code> and
    <code>cloud-events-source</code> attributes.</p>
</li>
</ul>
<p>You can create
<code>io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</code> instances
using:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-17">17</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-18">18</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-19">19</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-20">20</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-21">21</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-22">22</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-23">23</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-24">24</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-8-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</span><span class="p">;</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaCloudEventProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;cloud-events&quot;</span><span class="p">)</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">toCloudEvents</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">                </span><span class="p">.</span><span class="na">withId</span><span class="p">(</span><span class="s">&quot;id-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-8-19" name="__codelineno-8-19"></a><span class="w">                </span><span class="p">.</span><span class="na">withType</span><span class="p">(</span><span class="s">&quot;greetings&quot;</span><span class="p">)</span>
<a id="__codelineno-8-20" name="__codelineno-8-20"></a><span class="w">                </span><span class="p">.</span><span class="na">withSource</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">))</span>
<a id="__codelineno-8-21" name="__codelineno-8-21"></a><span class="w">                </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;greeting-message&quot;</span><span class="p">)</span>
<a id="__codelineno-8-22" name="__codelineno-8-22"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-8-23" name="__codelineno-8-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-24" name="__codelineno-8-24"></a>
<a id="__codelineno-8-25" name="__codelineno-8-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If the metadata does not contain an id, the connector generates one
(random UUID). The <code>type</code> and <code>source</code> can be configured per message or
at the channel level using the <code>cloud-events-type</code> and
<code>cloud-events-source</code> attributes. Other attributes are also
configurable.</p>
<p>The metadata can be contributed by multiple methods, however, you must
always retrieve the already existing metadata to avoid overriding the
values:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-25">25</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-26">26</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-27">27</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-28">28</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-29">29</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-30">30</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-31">31</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-32">32</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-33">33</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-34">34</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-35">35</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-36">36</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-37">37</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-38">38</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-9-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</span><span class="p">;</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaCloudEventMultipleProcessors</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">                </span><span class="p">.</span><span class="na">withId</span><span class="p">(</span><span class="s">&quot;id-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">                </span><span class="p">.</span><span class="na">withType</span><span class="p">(</span><span class="s">&quot;greeting&quot;</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<a id="__codelineno-9-26" name="__codelineno-9-26"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-9-27" name="__codelineno-9-27"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;cloud-events&quot;</span><span class="p">)</span>
<a id="__codelineno-9-28" name="__codelineno-9-28"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process2</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-29" name="__codelineno-9-29"></a><span class="w">        </span><span class="n">OutgoingCloudEventMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span>
<a id="__codelineno-9-30" name="__codelineno-9-30"></a><span class="w">                </span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-9-31" name="__codelineno-9-31"></a><span class="w">                </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-9-32" name="__codelineno-9-32"></a>
<a id="__codelineno-9-33" name="__codelineno-9-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<a id="__codelineno-9-34" name="__codelineno-9-34"></a><span class="w">                </span><span class="p">.</span><span class="na">withSource</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;source://me&quot;</span><span class="p">))</span>
<a id="__codelineno-9-35" name="__codelineno-9-35"></a><span class="w">                </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-9-36" name="__codelineno-9-36"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-9-37" name="__codelineno-9-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-38" name="__codelineno-9-38"></a>
<a id="__codelineno-9-39" name="__codelineno-9-39"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>By default, the connector sends the Cloud Events using the <em>binary</em>
format. You can write <em>structured</em> Cloud Events by setting the
<code>cloud-events-mode</code> to <code>structured</code>. Only JSON is supported, so the
created records had its <code>content-type</code> header set to
<code>application/cloudevents+json; charset=UTF-8</code> When using the
<em>structured</em> mode, the value serializer must be set to
<code>org.apache.kafka.common.serialization.StringSerializer</code>, otherwise the
connector reports the error. In addition, in <em>structured</em>, the connector
maps the messageâ€™s payload to JSON, except for <code>String</code> passed directly.</p>
<p>The recordâ€™s key can be set in the channel configuration (<code>key</code>
attribute), in the <code>OutgoingKafkaRecordMetadata</code> or using the
<code>partitionkey</code> Cloud Event attribute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>you can disable the Cloud Event support by setting the <code>cloud-events</code>
attribute to <code>false</code></p>
</div>
<h2 id="kafka-writing-kafka-records-using-producerrecord">Using <code>ProducerRecord</code></h2>
<p>Kafka built-in type
<a href="https://kafka.apache.org/26/javadoc/index.html?org/apache/kafka/clients/producer/ProducerRecord.html">ProducerRecord\<K,V></a>
can also be used for producing messages:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;my-topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This is an advanced feature. The <code>ProducerRecord</code> is sent to Kafka as
is. Any possible metadata attached through <code>Message&lt;ProducerRecord&lt;K, V&gt;&gt;</code> are ignored and lost.</p>
</div>
<h2 id="kafka-writing-kafka-records-producer-interceptors">Producer Interceptors</h2>
<p>Producer interceptors can be configured for Kafka producer clients using the standard <code>interceptor.classes</code> property.
Configured classes will be instantiated by the Kafka producer on client creation.</p>
<p>Alternatively, producer clients can be configured with a CDI managed-bean implementing <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/org.apache.kafka/kafka-clients/4.16.0/org/apache/kafka/clients/producer/ProducerInterceptor.html'>org.apache.kafka.clients.producer.ProducerInterceptor</a> interface:</p>
<p>To achieve this, the bean must be exposed with the <code>@Identifier</code> qualifier specifying the name of the bean:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-10">10</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-11">11</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-12">12</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-13">13</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-14">14</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-15">15</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-16">16</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-17">17</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-18">18</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-19">19</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-20">20</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-21">21</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-22">22</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-23">23</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-24">24</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-25">25</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-26">26</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-27">27</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-28">28</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-29">29</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-30">30</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-31">31</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-32">32</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-33">33</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-34">34</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-35">35</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-36">36</a></span>
<span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-11-37">37</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.producer.ProducerInterceptor</span><span class="p">;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.producer.ProducerRecord</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.producer.RecordMetadata</span><span class="p">;</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-producer-interceptor&quot;</span><span class="p">)</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ProducerInterceptorBeanExample</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ProducerInterceptor</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">onSend</span><span class="p">(</span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producerRecord</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">        </span><span class="c1">// called before send</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">producerRecord</span><span class="p">;</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onAcknowledgement</span><span class="p">(</span><span class="n">RecordMetadata</span><span class="w"> </span><span class="n">recordMetadata</span><span class="p">,</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="w">        </span><span class="c1">// called on send acknowledgement callback</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">        </span><span class="c1">// called on client close</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">        </span><span class="c1">// called on client configuration</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Then, in the channel configuration, specify the following attribute:
<code>mp.messaging.incoming.$channel.interceptor-bean=my-producer-interceptor</code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code>onSend</code> method will be called on the producer <em>sending thread</em> and <code>onAcknowledgement</code> will be called on the <em>Kafka producer I/O thread</em>.
In both cases if implementations are not fast, sending of messages could be delayed.</p>
</div>
<h2 id="kafka-writing-kafka-records-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>acks</em></td>
<td style="text-align: left;">The number of acknowledgments the producer requires the leader to have received before considering a request complete. This controls the durability of records that are sent. Accepted values are: 0, 1, all</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>bootstrap.servers</em> <em>(kafka.bootstrap.servers)</em></td>
<td style="text-align: left;">A comma-separated list of host:port to use for establishing the initial connection to the Kafka cluster.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost:9092</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>buffer.memory</em></td>
<td style="text-align: left;">The total bytes of memory the producer can use to buffer records waiting to be sent to the server.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>33554432</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id-prefix</em></td>
<td style="text-align: left;">Prefix for Kafka client <code>client.id</code> attribute. If defined configured or generated <code>client.id</code> will be prefixed with the given value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>close-timeout</em></td>
<td style="text-align: left;">The amount of milliseconds waiting for a graceful shutdown of the Kafka producer</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events</em></td>
<td style="text-align: left;">Enables (default) or disables the Cloud Event support. If enabled on an <em>incoming</em> channel, the connector analyzes the incoming records and try to create Cloud Event metadata. If enabled on an <em>outgoing</em>, the connector sends the outgoing messages as Cloud Event if the message includes Cloud Event Metadata.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-data-content-type</em> <em>(cloud-events-default-data-content-type)</em></td>
<td style="text-align: left;">Configure the default <code>datacontenttype</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>datacontenttype</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-data-schema</em> <em>(cloud-events-default-data-schema)</em></td>
<td style="text-align: left;">Configure the default <code>dataschema</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>dataschema</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-insert-timestamp</em> <em>(cloud-events-default-timestamp)</em></td>
<td style="text-align: left;">Whether or not the connector should insert automatically the <code>time</code> attribute into the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>time</code> attribute itself</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-mode</em></td>
<td style="text-align: left;">The Cloud Event mode (<code>structured</code> or <code>binary</code> (default)). Indicates how are written the cloud events in the outgoing record</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>binary</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-source</em> <em>(cloud-events-default-source)</em></td>
<td style="text-align: left;">Configure the default <code>source</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>source</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-subject</em> <em>(cloud-events-default-subject)</em></td>
<td style="text-align: left;">Configure the default <code>subject</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>subject</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-type</em> <em>(cloud-events-default-type)</em></td>
<td style="text-align: left;">Configure the default <code>type</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>type</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-enabled</em></td>
<td style="text-align: left;">Whether readiness health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-timeout</em></td>
<td style="text-align: left;"><em>deprecated</em> - During the readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready. Deprecated: Use 'health-topic-verification-timeout' instead.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-topic-verification</em></td>
<td style="text-align: left;"><em>deprecated</em> - Whether the readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin connection. Deprecated: Use 'health-topic-verification-enabled' instead.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-enabled</em></td>
<td style="text-align: left;">Whether the startup and readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin client connection.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-readiness-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the readiness health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-startup-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the startup health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-timeout</em></td>
<td style="text-align: left;">During the startup and readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>interceptor-bean</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>org.apache.kafka.clients.producer.ProducerInterceptor</code>. If set, the identified bean will be used as the producer interceptor.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>kafka-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Kafka consumer/producer configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key</em></td>
<td style="text-align: left;">A key to used when writing the record</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key-serialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.SerializationFailureHandler</code>. If set, serialization failure happening when serializing keys are delegated to this handler which may provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key.serializer</em></td>
<td style="text-align: left;">The serializer classname used to serialize the record's key</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>org.apache.kafka.common.serialization.StringSerializer</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>lazy-client</em></td>
<td style="text-align: left;">Whether Kafka client is created lazily or eagerly.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-inflight-messages</em></td>
<td style="text-align: left;">The maximum number of messages to be written to Kafka concurrently. It limits the number of messages waiting to be written and acknowledged by the broker. You can set this attribute to <code>0</code> remove the limit</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1024</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>merge</em></td>
<td style="text-align: left;">Whether the connector should allow multiple upstreams</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>partition</em></td>
<td style="text-align: left;">The target partition id. -1 to let the client determine the partition</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>-1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>propagate-headers</em></td>
<td style="text-align: left;">A comma-separating list of incoming record headers to be propagated to the outgoing record</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;">``</td>
</tr>
<tr>
<td style="text-align: left;"><em>propagate-record-key</em></td>
<td style="text-align: left;">Propagate incoming record key to the outgoing record</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retries</em></td>
<td style="text-align: left;">If set to a positive number, the connector will try to resend any record that was not delivered successfully (with a potentially transient error) until the number of retries is reached. If set to 0, retries are disabled. If not set, the connector tries to resend any record that failed to be delivered (because of a potentially transient error) during an amount of time configured by <code>delivery.timeout.ms</code>.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2147483647</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">The consumed / populated Kafka topic. If neither this property nor the <code>topics</code> properties are set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>value-serialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.SerializationFailureHandler</code>. If set, serialization failure happening when serializing values are delegated to this handler which may provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>value.serializer</em></td>
<td style="text-align: left;">The serializer classname used to serialize the payload</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>waitForWriteCompletion</em></td>
<td style="text-align: left;">Whether the client waits for Kafka to acknowledge the written record before acknowledging the message</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
</tbody>
</table>
<p>You can also pass any property supported by the underlying <a href="https://kafka.apache.org/documentation/#producerconfigs">Kafka
producer</a>.</p>
<p>For example, to configure the <code>batch.size</code> property, use:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-writing-kafka-records-__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="na">mp.messaging.outgoing.[channel].batch.size</span><span class="o">=</span><span class="s">32768</span>
</code></pre></div></td></tr></table></div>
<p>Some producer client properties are configured to sensible default
values:</p>
<p>If not set, <code>reconnect.backoff.max.ms</code> is set to <code>10000</code> to avoid high
load on disconnection.</p>
<p>If not set, <code>key.serializer</code> is set to
<code>org.apache.kafka.common.serialization.StringSerializer</code>.</p>
<p>If not set, producer <code>client.id</code> is generated as
<code>kafka-producer-[channel]</code>.</p></section><section class="print-page" id="kafka-health"><h1 id="kafka-health-health-reporting">Health reporting</h1>
<p>The Kafka connector reports the startup, readiness and liveness of each channel managed by the connector.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To disable health reporting, set the <code>health-enabled</code> attribute for the
channel to <code>false</code>.</p>
</div>
<h2 id="kafka-health-startup-readiness">Startup &amp; Readiness</h2>
<h3 id="kafka-health-metrics-based-strategy">Metrics-based strategy</h3>
<p>By default, both inbound and outbound channels use underlying Kafka client metrics to check if at least one active connection exists with a broker.
This strategy is lightweight and does not require additional remote interactions with the broker.</p>
<h3 id="kafka-health-client-based-strategy">Client-based strategy</h3>
<p>You can also enable another strategy by setting the <code>health-topic-verification-enabled</code> attribute to <code>true</code>.
With this second strategy, the health checks use a Kafka Admin Client to access the broker and retrieve the list of existing topics.
Retrieving this list can be a lengthy and expensive operation.
You can configure a timeout using the <code>health-topic-verification-timeout</code> attribute.
The default timeout is set to 2 seconds.
Note that if the timeout is reached, the health check fails.</p>
<div class="admonition warning">
<p class="admonition-title">Deprecated</p>
<p><code>health-readiness-topic-verification</code> and <code>health-readiness-timeout</code> attributes are deprecated and replaced by <code>health-topic-verification-enabled</code> and <code>health-topic-verification-timeout</code>.</p>
</div>
<p>For <strong>startup</strong> checks both <em>inbound</em> and <em>outbound</em> side verify that the Kafka topic is created and its partitions are available in the broker.
If multiple topics are consumed using the <code>topics</code> attribute, the readiness check verifies that all the consumed topics are available.
If you use a pattern (using the <code>pattern</code> attribute), the readiness check verifies that at least one existing topic matches the pattern.</p>
<p>For <strong>readiness</strong> checks inbound channels verify that the underlying consumer is assigned at least a partition to consume.
On the outbound side (writing records to Kafka) verify that the broker is still accessible.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code>health-topic-verification-enabled</code> is enabled, both for startup and readiness checks use this strategy. They can be disabled explicitly using <code>health-topic-verification-startup-disabled</code> and <code>health-topic-verification-readiness-disabled</code> flags.</p>
</div>
<p>To summarize for startup and readiness health checks:</p>
<p><strong>Startup</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>Inbound</th>
<th>Outbound</th>
</tr>
</thead>
<tbody>
<tr>
<td>Metrics-based</td>
<td><code>connection-count</code> metric &gt; 0 or<br/> no subscribers to the stream</td>
<td><code>connection-count</code> metric &gt; 0</td>
</tr>
<tr>
<td>Client-based</td>
<td>Subscribed topic(s) exist in the broker and are available</td>
<td>Produced topic exist in the broker and is available</td>
</tr>
</tbody>
</table>
<p><strong>Readiness</strong></p>
<table>
<thead>
<tr>
<th></th>
<th>Inbound</th>
<th>Outbound</th>
</tr>
</thead>
<tbody>
<tr>
<td>Metrics-based</td>
<td><code>connection-count</code> metric &gt; 0 or<br/> no subscribers to the stream</td>
<td><code>connection-count</code> metric &gt; 0</td>
</tr>
<tr>
<td>Client-based</td>
<td>Consumer has at least one partition assignment<br/> no subscribers to the stream</td>
<td>Cluster is acessible using the Kafka admin API</td>
</tr>
</tbody>
</table>
<h2 id="kafka-health-liveness">Liveness</h2>
<p>On the inbound side (receiving records from Kafka), the liveness check
verifies that:</p>
<ul>
<li>
<p>no failures have been caught</p>
</li>
<li>
<p>the client is connected to the broker</p>
</li>
</ul>
<p>On the outbound side (writing records to Kafka), the liveness check
verifies that:</p>
<ul>
<li>no failures have been caught</li>
</ul>
<p>Note that a message processing failures <em>nacks</em> the message which is
then handled by the failure-strategy. It the responsibility of the
failure-strategy to report the failure and influence the outcome of the
liveness checks. The <code>fail</code> failure strategy reports the failure and so
the liveness check will report the failure.</p></section><section class="print-page" id="kafka-avro-configuration"><h1 id="kafka-avro-configuration-using-apache-avro-serializerdeserializer">Using Apache Avro serializer/deserializer</h1>
<p>If you are using <a href="https://avro.apache.org/">Apache Avro</a>
serializer/deserializer, please note the following configuration
properties.</p>
<h2 id="kafka-avro-configuration-for-confluent-schema-registry">For <a href="https://docs.confluent.io/current/schema-registry/serdes-develop/serdes-avro.html">Confluent</a> Schema Registry</h2>
<p>Confluent Avro library is <code>io.confluent:kafka-avro-serializer</code>. Note
that this library is not available in Maven Central, you need to use the
<a href="https://docs.confluent.io/clients-kafka-java/current/overview.html">Confluent Maven
repository</a>.</p>
<h3 id="kafka-avro-configuration-consumer">Consumer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.deserializer</td>
<td>io.confluent.kafka.serializers.KafkaAvroDeserializer</td>
</tr>
<tr>
<td>schema.registry.url</td>
<td><a href="http://{your_host}:{your_port}/">http://{your_host}:{your_port}/</a></td>
</tr>
<tr>
<td>specific.avro.reader</td>
<td>true</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.[channel].value.deserializer=io.confluent.kafka.serializers.KafkaAvroDeserializer
mp.messaging.incoming.[channel].schema.registry.url=http://{your_host}:{your_port}/
mp.messaging.incoming.[channel].specific.avro.reader=true
</code></pre></div></td></tr></table></div>
<h3 id="kafka-avro-configuration-producer">Producer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.serializer</td>
<td>io.confluent.kafka.serializers.KafkaAvroSerializer</td>
</tr>
<tr>
<td>schema.registry.url</td>
<td><a href="http://{your_host}:{your_port}/">http://{your_host}:{your_port}/</a></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.[channel].value.serializer=io.confluent.kafka.serializers.KafkaAvroSerializer
mp.messaging.outgoing.[channel].schema.registry.url=http://{your_host}:{your_port}/
</code></pre></div></td></tr></table></div>
<h2 id="kafka-avro-configuration-for-apicurio-registry-1x">For <a href="https://www.apicur.io/registry/">Apicurio</a> Registry 1.x</h2>
<p>Apicurio Registry 1.x Avro library is
<code>io.apicurio:apicurio-registry-utils-serde</code>.</p>
<p>The configuration properties listed here are meant to be used with the
Apicurio Registry 1.x client library and Apicurio Registry 1.x server.</p>
<h3 id="kafka-avro-configuration-consumer_1">Consumer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.deserializer</td>
<td>io.apicurio.registry.utils.serde.AvroKafkaDeserializer</td>
</tr>
<tr>
<td>apicurio.registry.url</td>
<td><a href="http://{your_host}:{your_port}/api">http://{your_host}:{your_port}/api</a></td>
</tr>
<tr>
<td>apicurio.registry.avro-datum-provider</td>
<td>io.apicurio.registry.utils.serde.avro.DefaultAvroDatumProvider</td>
</tr>
<tr>
<td>apicurio.registry.use-specific-avro-reader</td>
<td>true</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.[channel].value.deserializer=io.apicurio.registry.utils.serde.AvroKafkaDeserializer
mp.messaging.incoming.[channel].apicurio.registry.url=http://{your_host}:{your_port}/api
mp.messaging.incoming.[channel].apicurio.registry.avro-datum-provider=io.apicurio.registry.utils.serde.avro.DefaultAvroDatumProvider
mp.messaging.incoming.[channel].apicurio.registry.use-specific-avro-reader=true
</code></pre></div></td></tr></table></div>
<h3 id="kafka-avro-configuration-producer_1">Producer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.serializer</td>
<td>io.apicurio.registry.utils.serde.AvroKafkaSerializer</td>
</tr>
<tr>
<td>apicurio.registry.url</td>
<td><a href="http://{your_host}:{your_port}/api">http://{your_host}:{your_port}/api</a></td>
</tr>
</tbody>
</table>
<p>To automatically register schemas with the registry, add:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>apicurio.registry.global-id</td>
<td>io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.[channel].value.serializer=io.apicurio.registry.utils.serde.AvroKafkaSerializer
mp.messaging.outgoing.[channel].apicurio.registry.url=http://{your_host}:{your_port}/api
mp.messaging.outgoing.[channel].apicurio.registry.global-id=io.apicurio.registry.utils.serde.strategy.GetOrCreateIdStrategy
</code></pre></div></td></tr></table></div>
<h2 id="kafka-avro-configuration-for-apicurio-registry-2x">For <a href="https://www.apicur.io/registry/">Apicurio</a> Registry 2.x</h2>
<p>Apicurio Registry 2.x Avro library is
<code>io.apicurio:apicurio-registry-serdes-avro-serde</code>.</p>
<p>The configuration properties listed here are meant to be used with the
Apicurio Registry 2.x client library and Apicurio Registry 2.x server.</p>
<h3 id="kafka-avro-configuration-consumer_2">Consumer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.deserializer</td>
<td>io.apicurio.registry.serde.avro.AvroKafkaDeserializer</td>
</tr>
<tr>
<td>apicurio.registry.url</td>
<td><a href="http://{your_host}:{your_port}/apis/registry/v2">http://{your_host}:{your_port}/apis/registry/v2</a></td>
</tr>
<tr>
<td>apicurio.registry.use-specific-avro-reader</td>
<td>true</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.[channel].value.deserializer=io.apicurio.registry.serde.avro.AvroKafkaDeserializer
mp.messaging.incoming.[channel].apicurio.registry.url=http://{your_host}:{your_port}/apis/registry/v2
mp.messaging.incoming.[channel].apicurio.registry.use-specific-avro-reader=true
</code></pre></div></td></tr></table></div>
<h3 id="kafka-avro-configuration-producer_2">Producer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.serializer</td>
<td>io.apicurio.registry.serde.avro.AvroKafkaSerializer</td>
</tr>
<tr>
<td>apicurio.registry.url</td>
<td><a href="http://{your_host}:{your_port}/apis/registry/v2">http://{your_host}:{your_port}/apis/registry/v2</a></td>
</tr>
</tbody>
</table>
<p>To automatically register schemas with the registry, add:</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>apicurio.registry.auto-register</td>
<td>true</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.[channel].value.serializer=io.apicurio.registry.serde.avro.AvroKafkaSerializer
mp.messaging.outgoing.[channel].apicurio.registry.url=http://{your_host}:{your_port}/apis/registry/v2
mp.messaging.outgoing.[channel].apicurio.registry.auto-register=true
</code></pre></div></td></tr></table></div></section><section class="print-page" id="kafka-protobuf-configuration"><h1 id="kafka-protobuf-configuration-using-google-protobuf-serializerdeserializer">Using Google Protobuf serializer/deserializer</h1>
<p>If you are using <a href="https://developers.google.com/protocol-buffers/">Protocol
Buffers</a>
serializer/deserializer, please note the following configuration
properties.</p>
<h2 id="kafka-protobuf-configuration-for-confluent-schema-registry">For <a href="https://docs.confluent.io/platform/current/schema-registry/serdes-develop/serdes-protobuf.html#serdes-and-formatter-protobuf">Confluent</a> Schema Registry</h2>
<p>Confluent protobuf library is <code>io.confluent:kafka-protobuf-serializer</code>.
Note that this library is not available in Maven Central, you need to
use the <a href="https://docs.confluent.io/clients-kafka-java/current/overview.html">Confluent Maven
repository</a>.</p>
<h3 id="kafka-protobuf-configuration-consumer">Consumer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.deserializer</td>
<td>io.confluent.kafka.serializers.protobuf.KafkaProtobufDeserializer</td>
</tr>
<tr>
<td>schema.registry.url</td>
<td><a href="http://{your_host}:{your_port}/">http://{your_host}:{your_port}/</a></td>
</tr>
<tr>
<td>mp.messaging.incoming.[channel].specific.protobuf.value.type</td>
<td>your.package.DomainObjectKey$Key</td>
</tr>
<tr>
<td>mp.messaging.incoming.[channel].specific.protobuf.key.type</td>
<td>your.package.DomainObjectValue$Value</td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.[channel].value.deserializer=io.confluent.kafka.serializers.protobuf.KafkaProtobufDeserializer
mp.messaging.incoming.[channel].schema.registry.url=http://{your_host}:{your_port}/
mp.messaging.incoming.[channel].specific.protobuf.value.type=your.package.DomainObjectKey$Key
mp.messaging.incoming.[channel].specific.protobuf.key.type=your.package.DomainObjectValue$Value
</code></pre></div></td></tr></table></div>
<h3 id="kafka-protobuf-configuration-producer">Producer</h3>
<table>
<thead>
<tr>
<th>Property</th>
<th>Recommended value</th>
</tr>
</thead>
<tbody>
<tr>
<td>value.serializer</td>
<td>io.confluent.kafka.serializers.protobuf.KafkaProtobufSerializer</td>
</tr>
<tr>
<td>schema.registry.url</td>
<td><a href="http://{your_host}:{your_port}/">http://{your_host}:{your_port}/</a></td>
</tr>
</tbody>
</table>
<p>Example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.[channel].value.serializer=io.confluent.kafka.serializers.protobuf.KafkaProtobufSerializer
mp.messaging.outgoing.[channel].schema.registry.url=http://{your_host}:{your_port}/
</code></pre></div></td></tr></table></div></section><section class="print-page" id="kafka-consumer-rebalance-listener"><h1 id="kafka-consumer-rebalance-listener-consumer-rebalance-listener">Consumer Rebalance Listener</h1>
<p>To handle offset commit and assigned partitions yourself, you can
provide a consumer rebalance listener. To achieve this, implement the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface, make the implementing class a bean, and add the <code>@Identifier</code>
qualifier. A usual use case is to store offset in a separate data store
to implement exactly-once semantic, or starting the processing at a
specific offset.</p>
<p>The listener is invoked every time the consumer topic/partition
assignment changes. For example, when the application starts, it invokes
the <code>partitionsAssigned</code> callback with the initial set of
topics/partitions associated with the consumer. If, later, this set
changes, it calls the <code>partitionsRevoked</code> and <code>partitionsAssigned</code>
callbacks again, so you can implement custom logic.</p>
<p>Note that the rebalance listener methods are called from the Kafka
<em>polling</em> thread and must block the caller thread until completion.
Thatâ€™s because the rebalance protocol has synchronization barriers, and
using asynchronous code in a rebalance listener may be executed after
the synchronization barrier.</p>
<p>When topics/partitions are assigned or revoked from a consumer, it
pauses the message delivery and restarts once the rebalance completes.</p>
<p>If the rebalance listener handles offset commit on behalf of the user
(using the <code>ignore</code> commit strategy), the rebalance listener <strong>must</strong>
commit the offset synchronously in the <code>partitionsRevoked</code> callback. We
also recommend applying the same logic when the application stops.</p>
<p>Unlike the <code>ConsumerRebalanceListener</code> from Apache Kafka, the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
methods pass the Kafka <code>Consumer</code> and the set of topics/partitions.</p>
<h2 id="kafka-consumer-rebalance-listener-example">Example</h2>
<p>In this example we set-up a consumer that always starts on messages from
at most 10 minutes ago (or offset 0). First we need to provide a bean
that implements the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface and is annotated with <code>@Identifier</code>. We then must configure
our inbound connector to use this named bean.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-28">28</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-29">29</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-30">30</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-31">31</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-32">32</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-33">33</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-34">34</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-35">35</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-36">36</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-37">37</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-38">38</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-39">39</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-40">40</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-41">41</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-42">42</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-43">43</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-44">44</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-45">45</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-46">46</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-47">47</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-48">48</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.Consumer</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.OffsetAndTimestamp</span><span class="p">;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</span><span class="p">;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;rebalanced-example.rebalancer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumerRebalanceListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaConsumerRebalanceListener</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">KafkaRebalancedConsumerRebalanceListener</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="cm">     * When receiving a list of partitions will search for the earliest offset within 10 minutes</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="cm">     * and seek the consumer to it.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="cm">     *</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="cm">     * @param consumer underlying consumer</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="cm">     * @param partitions set of assigned topic partitions</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="cm">     */</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPartitionsAssigned</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">            </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">600_000L</span><span class="p">;</span><span class="w"> </span><span class="c1">//10 minute ago</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Assigned &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">partition</span><span class="p">);</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="p">);</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="w">                </span><span class="p">.</span><span class="na">offsetsForTimes</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">offsets</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">offset</span><span class="p">();</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Seeking position &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="na">seek</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#kafka-consumer-rebalance-listener-__codelineno-1-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Acknowledgment</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.IncomingKafkaRecord</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;rebalanced-example&quot;</span><span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Acknowledgment</span><span class="p">(</span><span class="n">Acknowledgment</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">NONE</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// We don&#39;t need to ACK messages because in this example we set offset during consumer re-balance</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To configure the inbound connector to use the provided listener we
either set the consumer rebalance listenerâ€™s name:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.consumer-rebalance-listener.name=rebalanced-example.rebalancer</code></li>
</ul>
<p>Or have the listenerâ€™s name be the same as the group id:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.group.id=rebalanced-example.rebalancer</code></li>
</ul>
<p>Setting the consumer rebalance listenerâ€™s name takes precedence over
using the group id.</p></section><section class="print-page" id="kafka-kerberos"><h1 id="kafka-kerberos-kerberos-authentication">Kerberos authentication</h1>
<p>When using <a href="https://en.wikipedia.org/wiki/Kerberos_(protocol)">Kerberos</a>
authentication, you need to configure the connector with:</p>
<ul>
<li>
<p>the security protocol set to <code>SASL_PLAINTEXT</code></p>
</li>
<li>
<p>the SASL mechanism set to <code>GSSAPI</code></p>
</li>
<li>
<p>the Jaas config configured with <code>Krb5LoginModule</code></p>
</li>
<li>
<p>the Kerberos service name</p>
</li>
</ul>
<p>The following snippet provides an example:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-kerberos-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#kafka-kerberos-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#kafka-kerberos-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#kafka-kerberos-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#kafka-kerberos-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">kafka.bootstrap.servers</span><span class="o">=</span><span class="s">ip-192-168-0-207.us-east-2.compute.internal:9094</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">kafka.sasl.mechanism</span><span class="o">=</span><span class="s">GSSAPI</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">kafka.security.protocol</span><span class="o">=</span><span class="s">SASL_PLAINTEXT</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">kafka.sasl.jaas.config</span><span class="o">=</span><span class="s">com.sun.security.auth.module.Krb5LoginModule required doNotPrompt=true refreshKrb5Config=true useKeyTab=true storeKey=true keyTab=&quot;file:/opt/kafka/krb5/kafka-producer.keytab&quot; principal=&quot;kafka-producer/ip-192-168-0-207.us-east-2.compute.internal@INTERNAL&quot;;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">kafka.sasl.kerberos.service.name</span><span class="o">=</span><span class="s">kafka</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="kafka-client-service"><h1 id="kafka-client-service-kafkaclientservice">KafkaClientService</h1>
<p>For advanced use cases, SmallRye Reactive Messaging provides a bean of
type <code>KafkaClientService</code> that you can inject:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-client-service-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#kafka-client-service-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">KafkaClientService</span><span class="w"> </span><span class="n">kafka</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>From there, you can obtain an
<code>io.smallrye.reactive.messaging.kafka.KafkaProducer</code> and an
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumer</code>.</p>
<p><code>KafkaProducer</code> and <code>KafkaConsumer</code> expose a non-blocking API on top of
the Kafka client API. They also mediate access to the threads that
SmallRye Reactive Messaging uses to run all Kafka operations: the
<em>polling thread</em>, used for consuming records from Kafka topics, and the
<em>sending thread</em>, used for producing records to Kafka topics. (Just to
be clear: each <em>channel</em> has its own polling thread and sending thread.)</p>
<p>The reason why SmallRye Reactive Messaging uses a special thread to run
the poll loop should be obvious: the <code>Consumer</code> API is blocking. The
<code>Producer</code> API, on the other hand, is documented to be non-blocking.
However, in present versions, Kafka doesnâ€™t guarantee that in all cases;
see <a href="https://issues.apache.org/jira/browse/KAFKA-3539">KAFKA-3539</a> for
more details. That is why SmallRye Reactive Messaging uses a dedicated
thread to run the send operations as well.</p>
<p>Sometimes, SmallRye Reactive Messaging provides direct access to the
Kafka <code>Producer</code> or <code>Consumer</code>. For example, a
<a href="#kafka-consumer-rebalance-listener"><code>KafkaConsumerRebalanceListener</code></a>
methods are always invoked on the polling thread, so they give you
direct access to <code>Consumer</code>. In such case, you should use the
<code>Producer</code>/<code>Consumer</code> API directly, instead of the
<code>KafkaProducer</code>/<code>KafkaConsumer</code> API.</p></section><section class="print-page" id="kafka-default-configuration"><h1 id="kafka-default-configuration-retrieving-kafka-default-configuration">Retrieving Kafka default configuration</h1>
<p>If your application/runtime exposes as a CDI <em>bean</em> of type
<code>Map&lt;String, Object</code> with the identifier <code>default-kafka-broker</code>, this
configuration is used to establish the connection with the Kafka broker.</p>
<p>For example, you can imagine exposing this map as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-default-configuration-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-0-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;default-kafka-broker&quot;</span><span class="p">)</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">createKafkaRuntimeConfig</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">    </span><span class="n">StreamSupport</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="na">getPropertyNames</span><span class="p">().</span><span class="na">spliterator</span><span class="p">(),</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">String</span><span class="p">::</span><span class="n">toLowerCase</span><span class="p">)</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">startsWith</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">))</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="p">.</span><span class="na">distinct</span><span class="p">()</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">        </span><span class="p">.</span><span class="na">sorted</span><span class="p">()</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="p">.</span><span class="na">forEach</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="na">substring</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">).</span><span class="na">toLowerCase</span><span class="p">().</span><span class="na">replaceAll</span><span class="p">(</span><span class="s">&quot;[^a-z0-9.]&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.&quot;</span><span class="p">);</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="na">getOptionalValue</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">            </span><span class="n">properties</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">);</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">properties</span><span class="p">;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This previous example would extract all the configuration keys from
MicroProfile Config starting with <code>kafka</code>.</p>
<div class="admonition note">
<p class="admonition-title">Quarkus</p>
<p>Starting with Quarkus 1.5, a map corresponding to the previous example
is automatically provided.</p>
</div>
<p>In addition to this default configuration, you can configure the name of
the <code>Map</code> producer using the <code>kafka-configuration</code> attribute:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-default-configuration-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#kafka-default-configuration-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.incoming.my-channel.connector</span><span class="o">=</span><span class="s">smallrye-kafka</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.my-channel.kafka-configuration</span><span class="o">=</span><span class="s">my-configuration</span>
</code></pre></div></td></tr></table></div>
<p>In this case, the connector looks for the <code>Map</code> associated with the
<code>my-configuration</code> name. If <code>kafka-configuration</code> is not set, an
optional lookup for a <code>Map</code> exposed with the channel name (<code>my-channel</code>
in the previous example) is done.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If <code>kafka-configuration</code> is set and no <code>Map</code> can be found, the
deployment fails.</p>
</div>
<p>Attribute values are resolved as follows:</p>
<ol>
<li>
<p>if the attribute is set directly on the channel configuration
    (<code>mp.messaging.incoming.my-channel.attribute=value</code>), this value is
    used</p>
</li>
<li>
<p>if the attribute is not set on the channel, the connector looks for
    a <code>Map</code> with the channel name or the configured
    <code>kafka-configuration</code> (if set) and the value is retrieved from that
    <code>Map</code></p>
</li>
<li>
<p>If the resolved <code>Map</code> does not contain the value the default <code>Map</code>
    is used (exposed with the <code>default-kafka-broker</code> name)</p>
</li>
</ol></section><section class="print-page" id="kafka-test-companion"><h1 id="kafka-test-companion-kafka-companion">Kafka Companion</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Kafka Companion is experimental and APIs are subject to change in the future.</p>
</div>
<p>The <strong>Kafka Companion</strong> is a separate Java library for helping to test Kafka applications.
It is not intended to mock Kafka, but to the contrary, connect to a Kafka broker and provide high-level features.</p>
<p>It is not limited to the SmallRye Reactive Messaging testing, but intends to improve the testability of applications using Kafka. Some of its features:</p>
<ul>
<li>Running In-container Kafka broker for tests via <a href="https://github.com/strimzi/test-container">strimzi-test-container</a>.</li>
<li>Running the Kafka broker behind a <a href="https://github.com/Shopify/toxiproxy">toxiproxy</a> for simulating network issues.</li>
<li>Running embedded Kafka Kraft broker for tests.</li>
<li>Base classes for tests to bootstrap tests.</li>
<li>Companion classes for easily creating tasks to produce and consume Kafka records.</li>
<li>Writing assertions for produce and consume tasks, state of consumers, topics, offsets etc.</li>
</ul>
<h2 id="kafka-test-companion-getting-started-writing-tests">Getting started writing tests</h2>
<p>Easiest way of starting to write Kafka tests is to extend <code>KafkaCompanionTestBase</code>.
It starts a single-node Kafka broker for the test suite using testcontainers and creates the <code>KafkaCompanion</code> to connect to this broker:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaWithBaseTest</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">KafkaCompanionTestBase</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">    </span><span class="nd">@Test</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testWithBase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">        </span><span class="c1">// companion is created by the base class</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">        </span><span class="c1">// produce 100 records to messages topic</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">        </span><span class="n">ProducerTask</span><span class="w"> </span><span class="n">producerTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">produceIntegers</span><span class="p">()</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">                </span><span class="p">.</span><span class="na">usingGenerator</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">msgCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">producerTask</span><span class="p">.</span><span class="na">awaitCompletion</span><span class="p">().</span><span class="na">count</span><span class="p">();</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">        </span><span class="n">Assertions</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">msgCount</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">        </span><span class="c1">// consume 100 records from messages topic</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">        </span><span class="n">ConsumerTask</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">consumerTask</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">consumeIntegers</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">                </span><span class="p">.</span><span class="na">fromTopics</span><span class="p">(</span><span class="s">&quot;messages&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">        </span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lastRecord</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumerTask</span><span class="p">.</span><span class="na">awaitCompletion</span><span class="p">().</span><span class="na">getLastRecord</span><span class="p">();</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">        </span><span class="n">Assertions</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">lastRecord</span><span class="p">.</span><span class="na">value</span><span class="p">(),</span><span class="w"> </span><span class="mi">99</span><span class="p">);</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><code>KafkaCompanion</code> can be used on its own to connect to a broker:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">// Create companion with bootstrap servers and API timeout (default is 10 seconds)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">KafkaCompanion</span><span class="w"> </span><span class="n">companion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KafkaCompanion</span><span class="p">(</span><span class="s">&quot;localhost:9092&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1">// Create producer and start producer task</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="n">ProducerBuilder</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">produceIntegers</span><span class="p">()</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">        </span><span class="p">.</span><span class="na">withClientId</span><span class="p">(</span><span class="s">&quot;my-producer&quot;</span><span class="p">)</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">        </span><span class="p">.</span><span class="na">withProp</span><span class="p">(</span><span class="s">&quot;max.block.ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;5000&quot;</span><span class="p">);</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="n">producer</span><span class="p">.</span><span class="na">usingGenerator</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// Create consumer and start consumer task</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="n">ConsumerBuilder</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">consumeIntegers</span><span class="p">()</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="p">.</span><span class="na">withGroupId</span><span class="p">(</span><span class="s">&quot;my-group&quot;</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">        </span><span class="p">.</span><span class="na">withCommitAsyncWhen</span><span class="p">(</span><span class="n">record</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="n">ConsumerTask</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">fromTopics</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="c1">// Await completion and assert consumed record count</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="n">Assertions</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">records</span><span class="p">.</span><span class="na">awaitCompletion</span><span class="p">().</span><span class="na">count</span><span class="p">(),</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>There are a couple of things to note on how Kafka companion handles <strong>producers</strong>, <strong>consumers</strong> and <strong>tasks</strong>:</p>
<p><code>ProducerBuilder</code> and <code>ConsumerBuilder</code> lazy descriptions of with which configuration to create a producer or a consumer.</p>
<p><code>ProducerTask</code> and <code>ConsumerTask</code> run asynchronously on dedicated threads and are started as soon as they are created.
A task terminates when it is explicitly stopped, when it's predefined duration or number of records has been produced/consumed, or when it encounters an error.
An exterior thread can await on records processed, or simply on termination of the task.
At a given time produced or consumed records are accessible through the task.</p>
<p>The actual creation of the producer or consumer happens when a task is started. When the task terminates the producer or the consumer is automatically closed.</p>
<p>For example, in the previous example:</p>
<ol>
<li>We described a producer with a client id <code>my-producer</code> and <code>max.block.ms</code> of 5 seconds.</li>
<li>Then we created a task to produce 100 records using the generator function, without waiting for its completion.</li>
<li>We then described a consumer with group id <code>my-group</code> and which commits offset synchronously on every received record.</li>
<li>Finally, we created a task to consume records for 10 seconds and await its completion.</li>
</ol>
<h2 id="kafka-test-companion-producing-records">Producing records</h2>
<h3 id="kafka-test-companion-produce-from-records">Produce from records</h3>
<p>Produce given records:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-2-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="n">companion</span><span class="p">.</span><span class="na">produce</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">fromRecords</span><span class="p">(</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;k1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;1&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()),</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;k2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;2&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()),</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">        </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;k3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;3&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()));</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="kafka-test-companion-produce-from-generator-function">Produce from generator function</h3>
<p>Produce 10 records using the generator function:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">companion</span><span class="p">.</span><span class="na">produceIntegers</span><span class="p">().</span><span class="na">usingGenerator</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">),</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></p>
<h3 id="kafka-test-companion-produce-from-csv-file">Produce from CSV file</h3>
<p>Given a comma-separated file <code>records.csv</code> with the following content
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-4-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a>messages,0,a,asdf
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>messages,1,b,asdf
<a id="__codelineno-4-3" name="__codelineno-4-3"></a>messages,3,c,asdf
</code></pre></div></td></tr></table></div></p>
<p>Produce records from the file:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">companion</span><span class="p">.</span><span class="na">produceStrings</span><span class="p">().</span><span class="na">fromCsv</span><span class="p">(</span><span class="s">&quot;records.csv&quot;</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="kafka-test-companion-consuming-records">Consuming records</h2>
<h3 id="kafka-test-companion-consume-from-topics">Consume from topics</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-6-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="n">companion</span><span class="p">.</span><span class="na">consumeIntegers</span><span class="p">().</span><span class="na">fromTopics</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;topic2&quot;</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h3 id="kafka-test-companion-consume-from-offsets">Consume from offsets</h3>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-7-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">offsets</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TopicPartition</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">100L</span><span class="p">);</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="n">offsets</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TopicPartition</span><span class="p">(</span><span class="s">&quot;topic2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w"> </span><span class="mi">100L</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="n">companion</span><span class="p">.</span><span class="na">consumeIntegers</span><span class="p">().</span><span class="na">fromOffsets</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</code></pre></div></td></tr></table></div>
<h3 id="kafka-test-companion-consumer-assignment-and-offsets">Consumer assignment and offsets</h3>
<p>During execution of the consumer task, information about the underlying consumer's topic partition assignment, position or committed offsets can be accessed.
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-8-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="n">ConsumerBuilder</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">consumeIntegers</span><span class="p">()</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">        </span><span class="p">.</span><span class="na">withAutoCommit</span><span class="p">();</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="n">consumer</span><span class="p">.</span><span class="na">fromTopics</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="c1">// ...</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="n">await</span><span class="p">().</span><span class="na">untilAsserted</span><span class="p">(</span><span class="n">consumer</span><span class="p">::</span><span class="n">waitForAssignment</span><span class="p">);</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="n">consumer</span><span class="p">.</span><span class="na">committed</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">TopicPartition</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="kafka-test-companion-registering-custom-serdes">Registering Custom Serdes</h2>
<p>KafkaCompanion handles Serializers and Deserializers for default types such as primitives, String, ByteBuffer, UUID.</p>
<p>Serdes for custom types can be registered to the companion object, and will be used for producer and consumer tasks:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-9-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">KafkaCompanion</span><span class="w"> </span><span class="n">companion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KafkaCompanion</span><span class="p">(</span><span class="s">&quot;localhost:9092&quot;</span><span class="p">);</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="c1">// Register serde to the companion</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="n">companion</span><span class="p">.</span><span class="na">registerSerde</span><span class="p">(</span><span class="n">Orders</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrdersSerializer</span><span class="p">(),</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OrdersDeserializer</span><span class="p">());</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="c1">// Companion will configure consumer accordingly</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="n">ConsumerTask</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">Orders</span><span class="o">&gt;</span><span class="w"> </span><span class="n">orders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">consume</span><span class="p">(</span><span class="n">Integer</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">Orders</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">        </span><span class="p">.</span><span class="na">fromTopics</span><span class="p">(</span><span class="s">&quot;orders&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1000</span><span class="p">).</span><span class="na">awaitCompletion</span><span class="p">();</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">Orders</span><span class="o">&gt;</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">orders</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="c1">// ... check consumed records</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-test-companion-topics">Topics</h2>
<p>Create, list, describe and delete topics:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-10-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-10-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-10-3">3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-10-4">4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-10-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="n">companion</span><span class="p">.</span><span class="na">topics</span><span class="p">().</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="n">companion</span><span class="p">.</span><span class="na">topics</span><span class="p">().</span><span class="na">createAndWait</span><span class="p">(</span><span class="s">&quot;topic2&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="n">Assertions</span><span class="p">.</span><span class="na">assertEquals</span><span class="p">(</span><span class="n">companion</span><span class="p">.</span><span class="na">topics</span><span class="p">().</span><span class="na">list</span><span class="p">().</span><span class="na">size</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="n">companion</span><span class="p">.</span><span class="na">topics</span><span class="p">().</span><span class="na">delete</span><span class="p">(</span><span class="s">&quot;topic1&quot;</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></p>
<h2 id="kafka-test-companion-consumer-groups-and-offsets">Consumer Groups and Offsets</h2>
<p>List topic partition offsets:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-11-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-11-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="n">TopicPartition</span><span class="w"> </span><span class="n">topicPartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KafkaCompanion</span><span class="p">.</span><span class="na">tp</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kt">long</span><span class="w"> </span><span class="n">latestOffset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">offsets</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">topicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetSpec</span><span class="p">.</span><span class="na">latest</span><span class="p">()).</span><span class="na">offset</span><span class="p">();</span>
</code></pre></div></td></tr></table></div></p>
<p>List, describe, alter consumer groups and their offsets:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-test-companion-__codelineno-12-1">1</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-2">2</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-3">3</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-4">4</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-5">5</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-6">6</a></span>
<span class="normal"><a href="#kafka-test-companion-__codelineno-12-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="n">Collection</span><span class="o">&lt;</span><span class="n">ConsumerGroupListing</span><span class="o">&gt;</span><span class="w"> </span><span class="n">consumerGroups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">companion</span><span class="p">.</span><span class="na">consumerGroups</span><span class="p">().</span><span class="na">list</span><span class="p">();</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerGroupListing</span><span class="w"> </span><span class="n">consumerGroup</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">consumerGroups</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="c1">// check consumer groups</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="p">}</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="n">TopicPartition</span><span class="w"> </span><span class="n">topicPartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KafkaCompanion</span><span class="p">.</span><span class="na">tp</span><span class="p">(</span><span class="s">&quot;topic&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="n">companion</span><span class="p">.</span><span class="na">consumerGroups</span><span class="p">().</span><span class="na">resetOffsets</span><span class="p">(</span><span class="s">&quot;consumer-group&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">topicPartition</span><span class="p">);</span>
</code></pre></div></td></tr></table></div></p></section><section class="print-page" id="kafka-transactions"><h1 id="kafka-transactions-kafka-transactions-and-exactly-once-processing">Kafka Transactions and Exactly-Once Processing</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Kafka Transactions is an experimental feature.</p>
</div>
<p><a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging">Kafka transactions</a> enable atomic writes to multiple Kafka topics and partitions.
Inside a transaction, a producer writes records to the Kafka topic partitions as it would normally do.
If the transaction completes successfully, all the records previously written to the broker inside that transaction will be <em>committed</em>, and will be readable for consumers.
If an error during the transaction causes it to be <em>aborted</em>, none will be readable for consumers.</p>
<p>There are a couple of fundamental things to consider before using transactions:</p>
<ul>
<li>
<p>Each transactional producer is configured with a unique identifier called the <code>transactional.id</code>.
This is used to identify the same producer instance across application restarts.
By default, it is not configured, and transactions cannot be used.
When it is configured, the producer is limited to idempotent delivery, therefore <code>enable.idempotence=true</code> is implied.</p>
</li>
<li>
<p>For <strong>only</strong> reading transactional messages, a consumer needs to explicitly configure its <code>isolation.level</code> property to <code>read_committed</code>.
This will make sure that the consumer will deliver only records committed inside a transaction, and filter out messages from aborted transactions.</p>
</li>
<li>
<p>It should also be noted that this does not mean all records atomically written inside a transaction will be read atomically by the consumer.
Transactional producers can write to multiple topics and partitions inside a transaction, but consumers do not know where the transaction starts or ends.
Not only multiple consumers inside a consumer group can share those partitions,
all records which were part of a single transaction can be consumed in different batch of records by a consumer.</p>
</li>
</ul>
<p>Kafka connector provides <code>KafkaTransactions</code> custom emitter for writing records inside a transaction.
Before using a transaction we need to make sure that <code>transactional.id</code> is configured on the channel properties.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.tx-out-example.transactional.id=example-tx-producer
</code></pre></div></td></tr></table></div>
<p>It can be used as a regular emitter <code>@Channel</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-transactions-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-21">21</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-22">22</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-23">23</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-24">24</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-25">25</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-26">26</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-27">27</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-0-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaRecord</span><span class="p">;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.transactions.KafkaTransactions</span><span class="p">;</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaTransactionalProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;tx-out-example&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="n">KafkaTransactions</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">txProducer</span><span class="p">;</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">emitInTransaction</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">txProducer</span><span class="p">.</span><span class="na">withTransaction</span><span class="p">(</span><span class="n">emitter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;a&quot;</span><span class="p">));</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;b&quot;</span><span class="p">));</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;c&quot;</span><span class="p">));</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When <code>transactional.id</code> is provided <code>KafkaProducer#initTransactions</code> is called when the underlying Kafka producer is created.</p>
</div>
<p>The function given to the <code>withTransaction</code> method receives a <code>TransactionalEmitter</code> for producing records, and returns a <code>Uni</code> that provides the result of the transaction.
If the processing completes successfully, the producer is flushed and the transaction is committed.
If the processing throws an exception, returns a failing <code>Uni</code>, or marks the <code>TransactionalEmitter</code> for abort, the transaction is aborted.</p>
<p>If this method is called on a Vert.x context, the processing function is also called on that context.
Otherwise, it is called on the sending thread of the producer.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A transaction is considered <em>in progress</em> from the call to the <code>withTransaction</code> until the returned <code>Uni</code> results in success or failure.
While a transaction is in progress, subsequent calls to the <code>withTransaction</code>, including nested ones inside the given function, will throw <code>IllegalStateException</code>.
Note that in Reactive Messaging, the execution of processing methods is already serialized, unless <code>@Blocking(ordered = false)</code> is used.
If <code>withTransaction</code> can be called concurrently, for example from a REST endpoint, it is recommended to limit the concurrency of the execution.
This can be done using the <code>@Bulkhead</code> annotation from Microprofile Fault Tolerance.</p>
</div>
<h2 id="kafka-transactions-exactly-once-processing">Exactly-Once Processing</h2>
<p>Kafka Transactions API also allows managing consumer offsets inside a transaction, together with produced messages.
This in turn enables coupling a consumer with a transactional producer in a consume-transform-produce pattern,
also known as exactly-once processing.
It means that an application consumes messages from a topic-partition, processes them, publishes the results to a topic-partition,
and commits offsets of the consumed messages in a transaction.</p>
<p>The <code>KafkaTransactions</code> emitter also provides a way to apply exactly-once processing to an incoming Kafka message inside a transaction.</p>
<p>The following example includes a batch of Kafka records inside a transaction.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.outgoing.tx-out-example.transactional.id=example-tx-producer
mp.messaging.outgoing.in-channel.batch=true
mp.messaging.outgoing.in-channel.commit-strategy=ignore
mp.messaging.outgoing.in-channel.failure-strategy=ignore
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-transactions-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-30">30</a></span>
<span class="normal"><a href="#kafka-transactions-__codelineno-1-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaRecord</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaRecordBatch</span><span class="p">;</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.transactions.KafkaTransactions</span><span class="p">;</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaExactlyOnceProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;tx-out-example&quot;</span><span class="p">)</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="n">KafkaTransactions</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">txProducer</span><span class="p">;</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">emitInTransaction</span><span class="p">(</span><span class="n">KafkaRecordBatch</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">txProducer</span><span class="p">.</span><span class="na">withTransaction</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">KafkaRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">                </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a>
<a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If the processing completes successfully, before committing the transaction, the topic partition offsets of the given batch message will be committed to the transaction.</p>
<p>If the processing needs to abort, after aborting the transaction, the consumer's position is reset to the last committed offset, effectively resuming the consumption from that offset.
If no consumer offset has been committed, the consumer's position is reset to the beginning of the topic, even if the offset reset policy is <code>latest</code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When using exactly-once processing, consumed message offset commits are handled by the transaction and therefore <code>commit-strategy</code> needs to be <code>ignore</code>.</p>
</div>
<p>Any strategy can be employed for the <code>failure-strategy</code>.
Note that the <code>Uni</code> returned from the <code>#withTransaction</code> will yield a failure if the transaction fails and is aborted.</p>
<p>The application can choose to handle the error case, but for the message consumption to continue, <code>Uni</code> returned from the <code>@Incoming</code> method must not result in failure.
<code>KafkaTransactions#withTransactionAndAck</code> method will ack and nack the message but will not stop the reactive stream.
Ignoring the failure simply resets the consumer to the last committed offsets and resumes the processing from there.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to use exactly-once processing along with the batch consumption mode.
While it is possible to use it with a single Kafka message, it'll have a significant performance impact.</p>
</div></section><section class="print-page" id="kafka-request-reply"><h1 id="kafka-request-reply-kafka-requestreply">Kafka Request/Reply</h1>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Kafka Request Reply Emitter is an experimental feature.</p>
</div>
<p>The Kafka <a href="https://www.enterpriseintegrationpatterns.com/patterns/messaging/RequestReply.html">Request-Reply</a> pattern allows you to publish a message to a Kafka topic and then await for a reply message that responds to the initial request.</p>
<p>The <code>KafkaRequestReply</code> emitter implements the requestor (or the client) of the request-reply pattern for Kafka outbound channels:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-19">19</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-20">20</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-0-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.reply.KafkaRequestReply</span><span class="p">;</span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRequestReplyEmitter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-request&quot;</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">    </span><span class="n">KafkaRequestReply</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quoteRequest</span><span class="p">;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">requestQuote</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">quoteRequest</span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>request</code> method publishes the request record to the configured target topic of the outgoing channel,
and polls a reply topic (by default, the target topic with <code>-replies</code> suffix) for a reply record.
When the reply is received the returned <code>Uni</code> is completed with the record value.</p>
<p>The request send operation generates a correlation id and sets a header (by default <code>REPLY_CORRELATION_ID</code>),
which it expects to be sent back in the reply record. Two additional headers are set on the request record:</p>
<ul>
<li>The topic from which the reply is expected, by default <code>REPLY_TOPIC</code> header,
which can be configured using the <code>reply.topic</code> channel attribute.</li>
<li>Optionally, the partition from which the reply is expected, by default <code>REPLY_PARTITION</code> header.
The reply partition header is added only when the Kafka request reply is configured specifically to receive records from a topic-partition
, using the <code>reply.partition</code> channel attribute.
The reply partition header integer value is encoded in 4 bytes,
and helper methods <code>KafkaRequestReply#replyPartitionFromBytes</code> and <code>KafkaRequestReply#replyPartitionToBytes</code> can be used for custom operations.</li>
</ul>
<p>The replier (or the server) can be implemented using a Reactive Messaging processor:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaReplier</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="n">Random</span><span class="w"> </span><span class="n">rand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">)</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;reply&quot;</span><span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="nf">handleRequest</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rand</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Kafka outgoing channels detect default <code>REPLY_CORRELATION_ID</code>, <code>REPLY_TOPIC</code> and <code>REPLY_PARTITION</code> headers
and send the reply record to the expected topic-partition by propagating back the correlation id header.</p>
<p>Default headers can be configured, using <code>reply.correlation-id.header</code>, <code>reply.topic.header</code> and <code>reply.partition.header</code> channel attributes.
If custom headers are used the reply server needs some more manual work.
Given the following request/reply outgoing configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">mp.messaging.outgoing.reqrep.topic</span><span class="o">=</span><span class="s">requests</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">mp.messaging.outgoing.reqrep.reply.correlation-id.header</span><span class="o">=</span><span class="s">MY_CORRELATION</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="na">mp.messaging.outgoing.reqrep.reply.topic.header</span><span class="o">=</span><span class="s">MY_TOPIC</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="na">mp.messaging.outgoing.reqrep.reply.partition.header</span><span class="o">=</span><span class="s">MY_PARTITION</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="na">mp.messaging.incoming.request.topic</span><span class="o">=</span><span class="s">requests</span>
</code></pre></div></td></tr></table></div>
<p>The reply server can be implemented as the following:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-29">29</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-30">30</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-31">31</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-32">32</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-33">33</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-34">34</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-35">35</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-36">36</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-37">37</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-38">38</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-3-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.ConsumerRecord</span><span class="p">;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.producer.ProducerRecord</span><span class="p">;</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.header.Header</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.reply.KafkaRequestReply</span><span class="p">;</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaCustomHeaderReplier</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="n">Random</span><span class="w"> </span><span class="n">rand</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;request&quot;</span><span class="p">)</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;reply&quot;</span><span class="p">)</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">    </span><span class="n">ProducerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">        </span><span class="n">Header</span><span class="w"> </span><span class="n">topicHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;MY_TOPIC&quot;</span><span class="p">);</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">topicHeader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">            </span><span class="c1">// Skip</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">myTopic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">topicHeader</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">generateValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">.</span><span class="na">nextInt</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<a id="__codelineno-3-30" name="__codelineno-3-30"></a><span class="w">        </span><span class="n">Header</span><span class="w"> </span><span class="n">partitionHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">headers</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;MY_PARTITION&quot;</span><span class="p">);</span>
<a id="__codelineno-3-31" name="__codelineno-3-31"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">partitionHeader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-32" name="__codelineno-3-32"></a><span class="w">            </span><span class="c1">// Propagate incoming headers, including the correlation id header</span>
<a id="__codelineno-3-33" name="__codelineno-3-33"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">myTopic</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">key</span><span class="p">(),</span><span class="w"> </span><span class="n">generateValue</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">headers</span><span class="p">());</span>
<a id="__codelineno-3-34" name="__codelineno-3-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-35" name="__codelineno-3-35"></a><span class="w">        </span><span class="c1">// Send the replies to extracted myTopic-myPartition</span>
<a id="__codelineno-3-36" name="__codelineno-3-36"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">myPartition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">KafkaRequestReply</span><span class="p">.</span><span class="na">replyPartitionFromBytes</span><span class="p">(</span><span class="n">partitionHeader</span><span class="p">.</span><span class="na">value</span><span class="p">());</span>
<a id="__codelineno-3-37" name="__codelineno-3-37"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ProducerRecord</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="n">myTopic</span><span class="p">,</span><span class="w"> </span><span class="n">myPartition</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">key</span><span class="p">(),</span><span class="w"> </span><span class="n">generateValue</span><span class="p">,</span><span class="w"> </span><span class="n">request</span><span class="p">.</span><span class="na">headers</span><span class="p">());</span>
<a id="__codelineno-3-38" name="__codelineno-3-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-39" name="__codelineno-3-39"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="kafka-request-reply-requesting-with-message-types">Requesting with <code>Message</code> types</h2>
<p>Like the core Emitter's <code>send</code> methods, <code>request</code> method also can receive a <code>Message</code> type and return a message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-4-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.api.OutgoingKafkaRecordMetadata</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.reply.KafkaRequestReply</span><span class="p">;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRequestReplyMessageEmitter</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;my-request&quot;</span><span class="p">)</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="n">KafkaRequestReply</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quoteRequest</span><span class="p">;</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">requestMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">quoteRequest</span><span class="p">.</span><span class="na">request</span><span class="p">(</span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">                </span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingKafkaRecordMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">                        </span><span class="p">.</span><span class="na">withKey</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()));</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The ingested reply type of the <code>KafkaRequestReply</code> is discovered at runtime,
in order to configure a <code>MessageConveter</code> to be applied on the incoming message before returning the <code>Uni</code> result.</p>
</div>
<h2 id="kafka-request-reply-scaling-requestreply">Scaling Request/Reply</h2>
<p>If multiple requestor instances are configured on the same outgoing topic, and the same reply topic,
each requestor consumer will generate a unique consumer group.id and
therefore all requestor instances will receive replies of all instances. If an observed correlation id doesn't match
the id of any pending replies, the reply is simply discarded.
With the additional network traffic this allows scaling requestors, (and repliers) dynamically.</p>
<p>Alternatively, requestor instances can be configured to consume replies from dedicated topics using <code>reply.topic</code> attribute,
or distinct partitions of a single topic, using <code>reply.partition</code> attribute.
The later will configure the Kafka consumer to assign statically to the given partition.</p>
<h2 id="kafka-request-reply-pending-replies-and-reply-timeout">Pending replies and reply timeout</h2>
<p>By default, the <code>Uni</code> returned from the <code>request</code> method is configured to fail with timeout exception if no replies is received after 5 seconds.
This timeout is configurable with the channel attribute <code>reply.timeout</code>.</p>
<p>A snapshot of the list of pending replies is available through the <code>KafkaRequestReply#getPendingReplies</code> method.</p>
<h2 id="kafka-request-reply-waiting-for-topic-partition-assignment">Waiting for topic-partition assignment</h2>
<p>The requestor can be found in a position where a request is sent, and it's reply is already published to the reply topic,
before the requestor starts and polls the consumer.
In case the reply consumer is configured with <code>auto.offset.reset=latest</code>, which is the default value, this can lead to the requestor missing replies.
If <code>auto.offset.reset</code> is <code>latest</code>, at wiring time, before any request can take place, the <code>KafkaRequestReply</code>
finds partitions that the consumer needs to subscribe and waits for their assignment to the consumer.
On other occasons the <code>KafkaRequestReply#waitForAssignments</code> method can be used.</p>
<h2 id="kafka-request-reply-correlation-ids">Correlation Ids</h2>
<p>The Kafka Request/Reply allows configuring the correlation id mechanism completely through a <code>CorrelationIdHandler</code> implementation.
The default handler is based on randomly generated UUID strings, written to byte array in Kafka record headers.
The correlation id handler implementation can be configured using the <code>reply.correlation-id.handler</code> attribute.
As mentioned the default configuration is <code>uuid</code>,
and an alternative <code>bytes</code> implementation can be used to generate 12 bytes random correlation ids.</p>
<p>Custom handlers can be implemented by proposing a CDI-managed bean with <code>@Identifier</code> qualifier.</p>
<h2 id="kafka-request-reply-reply-error-handling">Reply Error Handling</h2>
<p>If the reply server produces an error and can or would like to propagate the error back to the requestor, failing the returned <code>Uni</code>.</p>
<p>If configured using the <code>reply.failure.handler</code> channel attribute,
the <code>ReplyFailureHandler</code> implementations are discovered through CDI, matching the <code>@Identifier</code> qualifier.</p>
<p>A sample reply error handler can lookup header values and return the error to be thrown by the reply:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-10">10</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-11">11</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-12">12</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-13">13</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-14">14</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-15">15</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-16">16</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-17">17</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-18">18</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-19">19</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-20">20</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-21">21</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-22">22</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-5-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.outbound</span><span class="p">;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.header.Header</span><span class="p">;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaRecord</span><span class="p">;</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.reply.ReplyFailureHandler</span><span class="p">;</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-reply-error&quot;</span><span class="p">)</span>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyReplyFailureHandler</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ReplyFailureHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="nf">handleReply</span><span class="p">(</span><span class="n">KafkaRecord</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">replyRecord</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">        </span><span class="n">Header</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">replyRecord</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">().</span><span class="na">lastHeader</span><span class="p">(</span><span class="s">&quot;REPLY_ERROR&quot;</span><span class="p">);</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalArgumentException</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="na">value</span><span class="p">()));</span>
<a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p><code>null</code> return value indicates that no error has been found in the reply record, and it can be delivered to the application.</p>
<h2 id="kafka-request-reply-advanced-configuration-for-the-kafka-consumer">Advanced configuration for the Kafka consumer</h2>
<p>The underlying Kafka consumer can be configured with the <code>reply</code> property prefix.
For example the underlying Kafka consuemer can be configured to batch mode using:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#kafka-request-reply-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#kafka-request-reply-__codelineno-6-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.outgoing.reqrep.topic</span><span class="o">=</span><span class="s">requests</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.outgoing.reqrep.reply.topic</span><span class="o">=</span><span class="s">quote-results</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">mp.messaging.outgoing.reqrep.reply.batch</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">mp.messaging.outgoing.reqrep.reply.commit-strategy</span><span class="o">=</span><span class="s">latest</span>
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: Kafka</h1>
                        <h1 class='nav-section-title' id='section-amqp-1-0'>
                            AMQP 1.0 <a class='headerlink' href='#section-amqp-1-0' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="amqp-amqp"><h1 id="amqp-amqp-amqp-10-connector">AMQP 1.0 Connector</h1>
<p>The AMQP Connector adds support for AMQP 1.0 to Reactive Messaging.</p>
<p>Advanced Message Queuing Protocol 1.0 (AMQP 1.0) is an open standard for
passing business messages between applications or organizations.</p>
<p>With this connector, your application can:</p>
<ul>
<li>receive messages from an AMQP Broker or Router.</li>
<li>send <code>Message</code> to an AMQP <em>address</em></li>
</ul>
<p>The AMQP connector is based on the <a href="https://vertx.io/docs/vertx-amqp-client/java/">Vert.x AMQP Client</a>.</p>
<h1 id="amqp-amqp-using-the-amqp-connector">Using the AMQP connector</h1>
<p>To use the AMQP Connector, add the following dependency to your project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-amqp-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-amqp<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-amqp</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-amqp-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#amqp-amqp-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">RabbitMQ</p>
<p>To use RabbitMQ, refer to <a href="#amqp-amqp-amqp-rabbitmq">Using RabbitMQ</a>.</p>
</div></section><section class="print-page" id="amqp-receiving-amqp-messages"><h1 id="amqp-receiving-amqp-messages-receiving-messages-from-amqp">Receiving messages from AMQP</h1>
<p>The AMQP connector lets you retrieve messages from an <a href="https://www.amqp.org/product/architecture">AMQP broker or
router</a>. The AMQP connector
retrieves <em>AMQP Messages</em> and maps each of them into Reactive Messaging
<code>Messages</code>.</p>
<h2 id="amqp-receiving-amqp-messages-example">Example</h2>
<p>Letâ€™s imagine you have an AMQP broker (such as <a href="https://activemq.apache.org/components/artemis/">Apache ActiveMQ
Artemis</a>) running, and
accessible using the <code>amqp:5672</code> address (by default it would use
<code>localhost:5672</code>). Configure your application to receive AMQP Messages
on the <code>prices</code> channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">amqp-host</span><span class="o">=</span><span class="s">amqp # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">amqp-port</span><span class="o">=</span><span class="s">5672 # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">amqp-username</span><span class="o">=</span><span class="s">my-username # &lt;3&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">amqp-password</span><span class="o">=</span><span class="s">my-password # &lt;4&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-amqp # &lt;5&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>Configures the broker/router host name. You can do it per channel
    (using the <code>host</code> attribute) or globally using <code>amqp-host</code></p>
</li>
<li>
<p>Configures the broker/router port. You can do it per channel (using
    the <code>port</code> attribute) or globally using <code>amqp-port</code>. The default is
    <code>5672</code>.</p>
</li>
<li>
<p>Configures the broker/router username if required. You can do it per
    channel (using the <code>username</code> attribute) or globally using
    <code>amqp-username</code>.</p>
</li>
<li>
<p>Configures the broker/router password if required. You can do it per
    channel (using the <code>password</code> attribute) or globally using
    <code>amqp-password</code>.</p>
</li>
<li>
<p>Instructs the <code>prices</code> channel to be managed by the AMQP connector</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the AMQP <em>address</em>. By default, it uses the
channel name (<code>prices</code>). You can configure the <code>address</code> attribute to
override it.</p>
</div>
<p>Then, your application receives <code>Message&lt;Double&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message, marking the AMQP message as `accepted`.</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-receiving-amqp-messages-deserialization">Deserialization</h2>
<p>The connector converts incoming AMQP Messages into Reactive Messaging
<code>Message&lt;T&gt;</code> instances. <code>T</code> depends on the <em>body</em> of the received AMQP
Message.</p>
<p>The <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html">AMQP Type
System</a>
defines the supported types.</p>
<table>
<thead>
<tr>
<th>AMQP Body Type</th>
<th><code>&lt;T&gt;</code></th>
</tr>
</thead>
<tbody>
<tr>
<td>AMQP Value containing a <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-types-v1.0-os.html#section-primitive-type-definitions">AMQP Primitive Type</a></td>
<td>the corresponding Java type</td>
</tr>
<tr>
<td>AMQP Value using the <code>Binary</code> type</td>
<td><code>byte[]</code></td>
</tr>
<tr>
<td>AMQP Sequence</td>
<td><code>List</code></td>
</tr>
<tr>
<td>AMQP Data (with binary content) and the <code>content-type</code> is set to <code>application/json</code></td>
<td><a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html"><code>JsonObject</code></a></td>
</tr>
<tr>
<td>AMQP Data with a different <code>content-type</code></td>
<td><code>byte[]</code></td>
</tr>
</tbody>
</table>
<p>If you send objects with this AMQP connector (outbound connector), it
gets encoded as JSON and sent as binary. The <code>content-type</code> is set to
<code>application/json</code>. You can receive this payload using (Vert.x) JSON
Objects, and then map it to the object class you want:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-3-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Generator</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;to-amqp&quot;</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">prices</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">                      </span><span class="c1">// &lt;1&gt;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">        </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">();</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Price</span><span class="p">().</span><span class="na">setPrice</span><span class="p">(</span><span class="n">count</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()))</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">                </span><span class="p">.</span><span class="na">onOverflow</span><span class="p">().</span><span class="na">drop</span><span class="p">();</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="p">}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Consumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;from-amqp&quot;</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">JsonObject</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">             </span><span class="c1">// &lt;2&gt;</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">        </span><span class="n">Price</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">mapTo</span><span class="p">(</span><span class="n">Price</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">         </span><span class="c1">// &lt;3&gt;</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">        </span><span class="n">prices</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">price</span><span class="p">);</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">prices</span><span class="p">;</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>The <code>Price</code> instances are automatically encoded to JSON by the
    connector</p>
</li>
<li>
<p>You can receive it using a <code>JsonObject</code></p>
</li>
<li>
<p>Then, you can reconstruct the instance using the <code>mapTo</code> method</p>
</li>
</ol>
<h2 id="amqp-receiving-amqp-messages-inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from AMQP contains an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-amqp/4.16.0/io/smallrye/reactive/messaging/amqp/IncomingAmqpMetadata.html'>IncomingAmqpMetadata</a></p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">Optional</span><span class="o">&lt;</span><span class="n">IncomingAmqpMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingAmqpMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">metadata</span><span class="p">.</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">meta</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getAddress</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">subject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getSubject</span><span class="p">();</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">durable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">isDurable</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="c1">// Use io.vertx.core.json.JsonObject</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="n">JsonObject</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getProperties</span><span class="p">();</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-receiving-amqp-messages-acknowledgement">Acknowledgement</h2>
<p>When a Reactive Messaging <code>Message</code> associated with an AMQP Message is
acknowledged, it informs the broker that the message has been
<em>accepted</em>.</p>
<h2 id="amqp-receiving-amqp-messages-failure-management">Failure Management</h2>
<p>If a message produced from an AMQP message is <em>nacked</em>, a failure
strategy is applied. The AMQP connector supports six strategies:</p>
<ul>
<li>
<p><code>fail</code> - fail the application; no more AMQP messages will be
    processed (default). The AMQP message is marked as rejected.</p>
</li>
<li>
<p><code>accept</code> - this strategy marks the AMQP message as <em>accepted</em>. The
    processing continues ignoring the failure. Refer to the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-accepted">accepted
    delivery state
    documentation</a>.</p>
</li>
<li>
<p><code>release</code> - this strategy marks the AMQP message as <em>released</em>. The
    processing continues with the next message. The broker can redeliver
    the message. Refer to the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-released">released delivery state
    documentation</a>.</p>
</li>
<li>
<p><code>reject</code> - this strategy marks the AMQP message as rejected. The
    processing continues with the next message. Refer to the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-rejected">rejected
    delivery state
    documentation</a>.</p>
</li>
<li>
<p><code>modified-failed</code> - this strategy marks the AMQP message as
    <em>modified</em> and indicates that it failed (with the <code>delivery-failed</code>
    attribute). The processing continues with the next message, but the
    broker may attempt to redeliver the message. Refer to the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-modified">modified
    delivery state
    documentation</a></p>
</li>
<li>
<p><code>modified-failed-undeliverable-here</code> - this strategy marks the AMQP
    message as <em>modified</em> and indicates that it failed (with the
    <code>delivery-failed</code> attribute). It also indicates that the application
    cannot process the message, meaning that the broker will not attempt
    to redeliver the message to this node. The processing continues with
    the next message. Refer to the <a href="http://docs.oasis-open.org/amqp/core/v1.0/os/amqp-core-messaging-v1.0-os.html#type-modified">modified delivery state
    documentation</a></p>
</li>
</ul>
<h2 id="amqp-receiving-amqp-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>address</em></td>
<td style="text-align: left;">The AMQP address. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-acknowledgement</em></td>
<td style="text-align: left;">Whether the received AMQP messages must be acknowledged when received</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether the received AMQP messages must be dispatched to multiple <em>subscribers</em></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>capabilities</em></td>
<td style="text-align: left;">A comma-separated list of capabilities proposed by the sender or receiver client.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(amqp-client-options-name)</em></td>
<td style="text-align: left;">The name of the AMQP Client Option bean used to customize the AMQP client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events</em></td>
<td style="text-align: left;">Enables (default) or disables the Cloud Event support. If enabled on an <em>incoming</em> channel, the connector analyzes the incoming records and try to create Cloud Event metadata. If enabled on an <em>outgoing</em>, the connector sends the outgoing messages as Cloud Event if the message includes Cloud Event Metadata.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>connect-timeout</em> <em>(amqp-connect-timeout)</em></td>
<td style="text-align: left;">The connection timeout in milliseconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>container-id</em></td>
<td style="text-align: left;">The AMQP container id</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>durable</em></td>
<td style="text-align: left;">Whether AMQP subscription is durable</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from an AMQP message is nacked. Accepted values are <code>fail</code> (default), <code>accept</code>, <code>release</code>, <code>reject</code>, <code>modified-failed</code>, <code>modified-failed-undeliverable-here</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>fail</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-timeout</em></td>
<td style="text-align: left;">The max number of seconds to wait to determine if the connection with the broker is still established for the readiness check. After that threshold, the check is considered as failed.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>3</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em> <em>(amqp-host)</em></td>
<td style="text-align: left;">The broker hostname</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>link-name</em></td>
<td style="text-align: left;">The name of the link. If not set, the channel name is used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em> <em>(amqp-password)</em></td>
<td style="text-align: left;">The password used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em> <em>(amqp-port)</em></td>
<td style="text-align: left;">The broker port</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5672</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-attempts</em> <em>(amqp-reconnect-attempts)</em></td>
<td style="text-align: left;">The number of reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>100</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval</em> <em>(amqp-reconnect-interval)</em></td>
<td style="text-align: left;">The interval in second between two reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>selector</em></td>
<td style="text-align: left;">Sets a message selector. This attribute is used to define an <code>apache.org:selector-filter:string</code> filter on the source terminus, using SQL-based syntax to request the server filters which messages are delivered to the receiver (if supported by the server in question). Precise functionality supported and syntax needed can vary depending on the server.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>sni-server-name</em> <em>(amqp-sni-server-name)</em></td>
<td style="text-align: left;">If set, explicitly override the hostname to use for the TLS SNI server name</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>use-ssl</em> <em>(amqp-use-ssl)</em></td>
<td style="text-align: left;">Whether the AMQP connection uses SSL/TLS</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em> <em>(amqp-username)</em></td>
<td style="text-align: left;">The username used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>virtual-host</em> <em>(amqp-virtual-host)</em></td>
<td style="text-align: left;">If set, configure the hostname value used for the connection AMQP Open frame and TLS SNI server name (if TLS is in use)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>You can also pass any property supported by the <a href="https://vertx.io/docs/vertx-amqp-client/java/">Vert.x AMQP
client</a> as attribute.</p>
<p>To use an existing <em>address</em> or <em>queue</em>, you need to configure the
<code>address</code>, <code>container-id</code> and, optionally, the <code>link-name</code> attributes.
For example, if you have an Apache Artemis broker configured with:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-5-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">&lt;queues&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nt">&lt;queue</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;people&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">        </span><span class="nt">&lt;address&gt;</span>people<span class="nt">&lt;/address&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">        </span><span class="nt">&lt;durable&gt;</span>true<span class="nt">&lt;/durable&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">        </span><span class="nt">&lt;user&gt;</span>artemis<span class="nt">&lt;/user&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="nt">&lt;/queue&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nt">&lt;/queues&gt;</span>
</code></pre></div></td></tr></table></div>
<p>You need the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-6-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.incoming.people.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.incoming.people.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">mp.messaging.incoming.people.address</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">mp.messaging.incoming.people.container-id</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<p>You may need to configure the <code>link-name</code> attribute, if the queue name
is not the channel name:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#amqp-receiving-amqp-messages-__codelineno-7-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">mp.messaging.incoming.people-in.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">mp.messaging.incoming.people-in.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="na">mp.messaging.incoming.people-in.address</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="na">mp.messaging.incoming.people-in.container-id</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="na">mp.messaging.incoming.people-in.link-name</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-receiving-amqp-messages-receiving-cloud-events">Receiving Cloud Events</h2>
<p>The AMQP connector supports <a href="https://cloudevents.io/">Cloud Events</a>.
When the connector detects a <em>structured</em> or <em>binary</em> Cloud Events, it
adds a <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/ce/IncomingCloudEventMetadata.html'>IncomingCloudEventMetadata</a>
into the metadata of the <code>Message</code>. <code>IncomingCloudEventMetadata</code>
contains accessors to the mandatory and optional Cloud Event attributes.</p>
<p>If the connector cannot extract the Cloud Event metadata, it sends the
Message without the metadata.</p>
<h3 id="amqp-receiving-amqp-messages-binary-cloud-events">Binary Cloud Events</h3>
<p>For <code>binary</code> Cloud Events, <strong>all</strong> mandatory Cloud Event attributes must
be set in the AMQP application properties, prefixed by <code>cloudEvents:</code>
(as mandated by the <a href="https://github.com/cloudevents/spec/blob/v1.0.1/amqp-protocol-binding.md">protocol
binding</a>).
The connector considers headers starting with the <code>cloudEvents:</code> prefix
but not listed in the specification as extensions. You can access them
using the <code>getExtension</code> method from <code>IncomingCloudEventMetadata</code>.</p>
<p>The <code>datacontenttype</code> attribute is mapped to the <code>content-type</code> header
of the record.</p>
<h3 id="amqp-receiving-amqp-messages-structured-cloud-events">Structured Cloud Events</h3>
<p>For <code>structured</code> Cloud Events, the event is encoded in the recordâ€™s
value. Only JSON is supported, so your event must be encoded as JSON in
the recordâ€™s value.</p>
<p>Structured Cloud Event must set the <code>content-type</code> header of the record
to <code>application/cloudevents+json; charset=UTF-8</code>. The message body must
be a valid JSON object containing at least all the mandatory Cloud
Events attributes.</p>
<p>If the record is a structured Cloud Event, the created Messageâ€™s payload
is the Cloud Event <code>data</code>.</p></section><section class="print-page" id="amqp-sending-amqp-messages"><h1 id="amqp-sending-amqp-messages-sending-messages-to-amqp">Sending messages to AMQP</h1>
<p>The AMQP connector can write Reactive Messaging <code>Messages</code> as AMQP
Messages.</p>
<h2 id="amqp-sending-amqp-messages-example">Example</h2>
<p>Letâ€™s imagine you have an AMQP broker (such as <a href="https://activemq.apache.org/components/artemis/">Apache ActiveMQ
Artemis</a>) running, and
accessible using the <code>amqp:5672</code> address (by default it would use
<code>localhost:5672</code>). Configure your application to send the messages from
the <code>prices</code> channel as AMQP Message as follows:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">amqp-host</span><span class="o">=</span><span class="s">amqp  # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">amqp-port</span><span class="o">=</span><span class="s">5672  # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">amqp-username</span><span class="o">=</span><span class="s">my-username # &lt;3&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">amqp-password</span><span class="o">=</span><span class="s">my-password # &lt;4&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">mp.messaging.outgoing.prices.connector</span><span class="o">=</span><span class="s">smallrye-amqp # &lt;5&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Configures the broker/router host name. You can do it per channel
    (using the <code>host</code> attribute) or globally using <code>amqp-host</code></p>
<ol>
<li>
<p>Configures the broker/router port. You can do it per channel (using
    the <code>port</code> attribute) or globally using <code>amqp-port</code>. The default is
    <code>5672</code>.</p>
</li>
<li>
<p>Configures the broker/router username if required. You can do it per
    channel (using the <code>username</code> attribute) or globally using
    <code>amqp-username</code>.</p>
</li>
<li>
<p>Configures the broker/router password if required. You can do it per
    channel (using the <code>password</code> attribute) or globally using
    <code>amqp-password</code>.</p>
</li>
<li>
<p>Instructs the <code>prices</code> channel to be managed by the AMQP connector</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the <em>address</em>. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>address</code> attribute to override
it.</p>
</div>
<p>Then, your application must send <code>Message&lt;Double&gt;</code> to the <code>prices</code>
channel. It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()));</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-sending-amqp-messages-serialization">Serialization</h2>
<p>When receiving a <code>Message&lt;T&gt;</code>, the connector convert the message into an
AMQP Message. The payload is converted to the AMQP Message <em>body</em>.</p>
<table>
<thead>
<tr>
<th><code>T</code></th>
<th>AMQP Message Body</th>
</tr>
</thead>
<tbody>
<tr>
<td>primitive types or <code>String</code></td>
<td>AMQP Value with the payload</td>
</tr>
<tr>
<td><code>Instant</code> or <code>UUID</code></td>
<td>AMQP Value using the corresponding AMQP Type</td>
</tr>
<tr>
<td><a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html"><code>JsonObject</code></a> or <a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonArray.html"><code>JsonArray</code></a></td>
<td>AMQP Data using a binary content. The <code>content-type</code> is set to <code>application/json</code></td>
</tr>
<tr>
<td><code>io.vertx.mutiny.core.buffer.Buffer</code></td>
<td>AMQP Data using a binary content. No <code>content-type</code> set</td>
</tr>
<tr>
<td>Any other class</td>
<td>The payload is converted to JSON (using a Json Mapper). The result is wrapped into AMQP Data using a <strong>binary</strong> content. The <code>content-type</code> is set to <code>application/json</code></td>
</tr>
</tbody>
</table>
<p>If the message payload cannot be serialized to JSON, the message is
<em>nacked</em>.</p>
<h2 id="amqp-sending-amqp-messages-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Messages</code>, you can add an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-amqp/4.16.0/io/smallrye/reactive/messaging/amqp/OutgoingAmqpMetadata.html'>OutgoingAmqpMetadata</a>
to influence how the message is going to be sent to AMQP. For example, you
can configure the subjects, properties:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-3-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">OutgoingAmqpMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingAmqpMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">        </span><span class="p">.</span><span class="na">withDurable</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">        </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;my-subject&quot;</span><span class="p">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-sending-amqp-messages-dynamic-address-names">Dynamic address names</h2>
<p>Sometimes it is desirable to select the destination of a message
dynamically. In this case, you should not configure the address inside
your application configuration file, but instead, use the outbound
metadata to set the address.</p>
<p>For example, you can send to a dynamic address based on the incoming
message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">String</span><span class="w"> </span><span class="n">addressName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">selectAddressFromIncommingMessage</span><span class="p">(</span><span class="n">incoming</span><span class="p">);</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">OutgoingAmqpMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingAmqpMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span><span class="p">.</span><span class="na">withAddress</span><span class="p">(</span><span class="n">addressName</span><span class="p">)</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="p">.</span><span class="na">withDurable</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To be able to set the address per message, the connector is using an
<em>anonymous sender</em>.</p>
</div>
<h2 id="amqp-sending-amqp-messages-acknowledgement">Acknowledgement</h2>
<p>By default, the Reactive Messaging <code>Message</code> is acknowledged when the
broker acknowledged the message. When using routers, this
acknowledgement may not be enabled. In this case, configure the
<code>auto-acknowledgement</code> attribute to acknowledge the message as soon as
it has been sent to the router.</p>
<p>If an AMQP message is rejected/released/modified by the broker (or
cannot be sent successfully), the message is nacked.</p>
<h2 id="amqp-sending-amqp-messages-back-pressure-and-credits">Back Pressure and Credits</h2>
<p>The back-pressure is handled by AMQP <em>credits</em>. The outbound connector
only requests the amount of allowed credits. When the amount of credits
reaches 0, it waits (in a non-blocking fashion) until the broker grants
more credits to the AMQP sender.</p>
<h2 id="amqp-sending-amqp-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>address</em></td>
<td style="text-align: left;">The AMQP address. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>capabilities</em></td>
<td style="text-align: left;">A comma-separated list of capabilities proposed by the sender or receiver client.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(amqp-client-options-name)</em></td>
<td style="text-align: left;">The name of the AMQP Client Option bean used to customize the AMQP client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events</em></td>
<td style="text-align: left;">Enables (default) or disables the Cloud Event support. If enabled on an <em>incoming</em> channel, the connector analyzes the incoming records and try to create Cloud Event metadata. If enabled on an <em>outgoing</em>, the connector sends the outgoing messages as Cloud Event if the message includes Cloud Event Metadata.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-data-content-type</em> <em>(cloud-events-default-data-content-type)</em></td>
<td style="text-align: left;">Configure the default <code>datacontenttype</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>datacontenttype</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-data-schema</em> <em>(cloud-events-default-data-schema)</em></td>
<td style="text-align: left;">Configure the default <code>dataschema</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>dataschema</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-insert-timestamp</em> <em>(cloud-events-default-timestamp)</em></td>
<td style="text-align: left;">Whether or not the connector should insert automatically the <code>time</code> attribute into the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>time</code> attribute itself</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-mode</em></td>
<td style="text-align: left;">The Cloud Event mode (<code>structured</code> or <code>binary</code> (default)). Indicates how are written the cloud events in the outgoing record</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>binary</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-source</em> <em>(cloud-events-default-source)</em></td>
<td style="text-align: left;">Configure the default <code>source</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>source</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-subject</em> <em>(cloud-events-default-subject)</em></td>
<td style="text-align: left;">Configure the default <code>subject</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>subject</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events-type</em> <em>(cloud-events-default-type)</em></td>
<td style="text-align: left;">Configure the default <code>type</code> attribute of the outgoing Cloud Event. Requires <code>cloud-events</code> to be set to <code>true</code>. This value is used if the message does not configure the <code>type</code> attribute itself</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connect-timeout</em> <em>(amqp-connect-timeout)</em></td>
<td style="text-align: left;">The connection timeout in milliseconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>container-id</em></td>
<td style="text-align: left;">The AMQP container id</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>credit-retrieval-period</em></td>
<td style="text-align: left;">The period (in milliseconds) between two attempts to retrieve the credits granted by the broker. This time is used when the sender run out of credits.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>durable</em></td>
<td style="text-align: left;">Whether sent AMQP messages are marked durable</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-timeout</em></td>
<td style="text-align: left;">The max number of seconds to wait to determine if the connection with the broker is still established for the readiness check. After that threshold, the check is considered as failed.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>3</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em> <em>(amqp-host)</em></td>
<td style="text-align: left;">The broker hostname</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>link-name</em></td>
<td style="text-align: left;">The name of the link. If not set, the channel name is used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>merge</em></td>
<td style="text-align: left;">Whether the connector should allow multiple upstreams</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em> <em>(amqp-password)</em></td>
<td style="text-align: left;">The password used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em> <em>(amqp-port)</em></td>
<td style="text-align: left;">The broker port</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5672</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-attempts</em> <em>(amqp-reconnect-attempts)</em></td>
<td style="text-align: left;">The number of reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>100</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval</em> <em>(amqp-reconnect-interval)</em></td>
<td style="text-align: left;">The interval in second between two reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>sni-server-name</em> <em>(amqp-sni-server-name)</em></td>
<td style="text-align: left;">If set, explicitly override the hostname to use for the TLS SNI server name</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ttl</em></td>
<td style="text-align: left;">The time-to-live of the send AMQP messages. 0 to disable the TTL</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>use-anonymous-sender</em></td>
<td style="text-align: left;">Whether or not the connector should use an anonymous sender. Default value is <code>true</code> if the broker supports it, <code>false</code> otherwise. If not supported, it is not possible to dynamically change the destination address.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>use-ssl</em> <em>(amqp-use-ssl)</em></td>
<td style="text-align: left;">Whether the AMQP connection uses SSL/TLS</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em> <em>(amqp-username)</em></td>
<td style="text-align: left;">The username used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>virtual-host</em> <em>(amqp-virtual-host)</em></td>
<td style="text-align: left;">If set, configure the hostname value used for the connection AMQP Open frame and TLS SNI server name (if TLS is in use)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>You can also pass any property supported by the <a href="https://vertx.io/docs/vertx-amqp-client/java/">Vert.x AMQP
client</a> as attribute.</p>
<h2 id="amqp-sending-amqp-messages-using-existing-destinations">Using existing destinations</h2>
<p>To use an existing <em>address</em> or <em>queue</em>, you need to configure the
<code>address</code>, <code>container-id</code> and, optionally, the <code>link-name</code> attributes.
For example, if you have an Apache Artemis broker configured with:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-5-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nt">&lt;queues&gt;</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nt">&lt;queue</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;people&quot;</span><span class="nt">&gt;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">        </span><span class="nt">&lt;address&gt;</span>people<span class="nt">&lt;/address&gt;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">        </span><span class="nt">&lt;durable&gt;</span>true<span class="nt">&lt;/durable&gt;</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">        </span><span class="nt">&lt;user&gt;</span>artemis<span class="nt">&lt;/user&gt;</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="nt">&lt;/queue&gt;</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="nt">&lt;/queues&gt;</span>
</code></pre></div></td></tr></table></div>
<p>You need the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-6-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.outgoing.people.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.outgoing.people.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">mp.messaging.outgoing.people.address</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">mp.messaging.outgoing.people.container-id</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<p>You may need to configure the <code>link-name</code> attribute, if the queue name
is not the channel name:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-7-3">3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-7-4">4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-7-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">mp.messaging.outgoing.people-out.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">mp.messaging.outgoing.people-out.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="na">mp.messaging.outgoing.people-out.address</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="na">mp.messaging.outgoing.people-out.container-id</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="na">mp.messaging.outgoing.people-out.link-name</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<p>To use a <code>MULTICAST</code> queue, you need to provide the <em>FQQN</em>
(Fully-qualified queue name) instead of just the name of the queue:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="na">mp.messaging.outgoing.people-out.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="na">mp.messaging.outgoing.people-out.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="na">mp.messaging.outgoing.people-out.address</span><span class="o">=</span><span class="s">foo</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="na">mp.messaging.outgoing.people-out.container-id</span><span class="o">=</span><span class="s">foo</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="na">mp.messaging.incoming.people-out.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="na">mp.messaging.incoming.people-out.durable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="na">mp.messaging.incoming.people-out.address</span><span class="o">=</span><span class="s">foo::bar # Note the syntax: address-name::queue-name</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="na">mp.messaging.incoming.people-out.container-id</span><span class="o">=</span><span class="s">bar</span>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="na">mp.messaging.incoming.people-out.link-name</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<p>More details about the AMQP Address model can be found on <a href="https://activemq.apache.org/components/artemis/documentation/2.0.0/address-model.html">the Artemis
documentation</a>.</p>
<h2 id="amqp-sending-amqp-messages-sending-cloud-events">Sending Cloud Events</h2>
<p>The AMQP connector supports <a href="https://cloudevents.io/">Cloud Events</a>. The
connector sends the outbound record as Cloud Events if:</p>
<ul>
<li>
<p>the message metadata contains an
    <code>io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</code>
    instance,</p>
</li>
<li>
<p>the channel configuration defines the <code>cloud-events-type</code> and
    <code>cloud-events-source</code> attributes.</p>
</li>
</ul>
<p>You can create
<code>io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</code> instances
using:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-17">17</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-18">18</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-19">19</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-20">20</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-21">21</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-22">22</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-23">23</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-24">24</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-9-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.outbound</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</span><span class="p">;</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpCloudEventProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;cloud-events&quot;</span><span class="p">)</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">toCloudEvents</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">                </span><span class="p">.</span><span class="na">withId</span><span class="p">(</span><span class="s">&quot;id-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">                </span><span class="p">.</span><span class="na">withType</span><span class="p">(</span><span class="s">&quot;greetings&quot;</span><span class="p">)</span>
<a id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">                </span><span class="p">.</span><span class="na">withSource</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;http://example.com&quot;</span><span class="p">))</span>
<a id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">                </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;greeting-message&quot;</span><span class="p">)</span>
<a id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-9-23" name="__codelineno-9-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-24" name="__codelineno-9-24"></a>
<a id="__codelineno-9-25" name="__codelineno-9-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If the metadata does not contain an id, the connector generates one
(random UUID). The <code>type</code> and <code>source</code> can be configured per message or
at the channel level using the <code>cloud-events-type</code> and
<code>cloud-events-source</code> attributes. Other attributes are also
configurable.</p>
<p>The metadata can be contributed by multiple methods, however, you must
always retrieve the already existing metadata to avoid overriding the
values:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-10">10</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-11">11</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-12">12</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-13">13</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-14">14</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-15">15</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-16">16</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-17">17</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-18">18</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-19">19</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-20">20</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-21">21</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-22">22</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-23">23</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-24">24</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-25">25</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-26">26</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-27">27</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-28">28</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-29">29</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-30">30</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-31">31</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-32">32</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-33">33</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-34">34</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-35">35</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-36">36</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-37">37</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-38">38</a></span>
<span class="normal"><a href="#amqp-sending-amqp-messages-__codelineno-10-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">amqp.outbound</span><span class="p">;</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.net.URI</span><span class="p">;</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.ce.OutgoingCloudEventMetadata</span><span class="p">;</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AmqpCloudEventMultipleProcessors</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-15" name="__codelineno-10-15"></a>
<a id="__codelineno-10-16" name="__codelineno-10-16"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;source&quot;</span><span class="p">)</span>
<a id="__codelineno-10-17" name="__codelineno-10-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-10-18" name="__codelineno-10-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-19" name="__codelineno-10-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-10-20" name="__codelineno-10-20"></a><span class="w">                </span><span class="p">.</span><span class="na">withId</span><span class="p">(</span><span class="s">&quot;id-&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">getPayload</span><span class="p">())</span>
<a id="__codelineno-10-21" name="__codelineno-10-21"></a><span class="w">                </span><span class="p">.</span><span class="na">withType</span><span class="p">(</span><span class="s">&quot;greeting&quot;</span><span class="p">)</span>
<a id="__codelineno-10-22" name="__codelineno-10-22"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-10-23" name="__codelineno-10-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-24" name="__codelineno-10-24"></a>
<a id="__codelineno-10-25" name="__codelineno-10-25"></a><span class="w">    </span><span class="nd">@SuppressWarnings</span><span class="p">(</span><span class="s">&quot;unchecked&quot;</span><span class="p">)</span>
<a id="__codelineno-10-26" name="__codelineno-10-26"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-10-27" name="__codelineno-10-27"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;cloud-events&quot;</span><span class="p">)</span>
<a id="__codelineno-10-28" name="__codelineno-10-28"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process2</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-29" name="__codelineno-10-29"></a><span class="w">        </span><span class="n">OutgoingCloudEventMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">in</span>
<a id="__codelineno-10-30" name="__codelineno-10-30"></a><span class="w">                </span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-10-31" name="__codelineno-10-31"></a><span class="w">                </span><span class="p">.</span><span class="na">orElseGet</span><span class="p">(()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-10-32" name="__codelineno-10-32"></a>
<a id="__codelineno-10-33" name="__codelineno-10-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">in</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">OutgoingCloudEventMetadata</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>
<a id="__codelineno-10-34" name="__codelineno-10-34"></a><span class="w">                </span><span class="p">.</span><span class="na">withSource</span><span class="p">(</span><span class="n">URI</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;source://me&quot;</span><span class="p">))</span>
<a id="__codelineno-10-35" name="__codelineno-10-35"></a><span class="w">                </span><span class="p">.</span><span class="na">withSubject</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-10-36" name="__codelineno-10-36"></a><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-10-37" name="__codelineno-10-37"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-38" name="__codelineno-10-38"></a>
<a id="__codelineno-10-39" name="__codelineno-10-39"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>By default, the connector sends the Cloud Events using the <em>binary</em>
format. You can write <em>structured</em> Cloud Events by setting the
<code>cloud-events-mode</code> to <code>structured</code>. Only JSON is supported, so the
created records had its <code>content-type</code> header set to
<code>application/cloudevents+json; charset=UTF-8</code></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>you can disable the Cloud Event support by setting the <code>cloud-events</code>
attribute to <code>false</code></p>
</div></section><section class="print-page" id="amqp-health"><h1 id="amqp-health-health-reporting">Health reporting</h1>
<p>The AMQP connector reports the startup, liveness, and readiness of each
inbound (Receiving messages) and outbound (sending messages) channel
managed by the connector:</p>
<ul>
<li>
<p>Startup :: For both inbound and outbound, the startup probe reports <em>OK</em> when the
connection with the broker is established, and the AMQP senders and
receivers are opened (the links are attached to the broker).</p>
</li>
<li>
<p>Liveness :: For both inbound and outbound, the liveness check verifies that the
connection is established. The check still returns <em>OK</em> if the
connection got cut, but we are attempting a reconnection.</p>
</li>
<li>
<p>Readiness :: For the inbound, it checks that the connection is established and the
receiver is opened. Unlike the liveness check, this probe reports <em>KO</em>
until the connection is re-established. For the outbound, it checks that
the connection is established and the sender is opened. Unlike the
liveness check, this probe reports <em>KO</em> until the connection is
re-established.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To disable health reporting, set the <code>health-enabled</code> attribute for the
channel to <code>false</code>.</p>
</div>
<p>Note that a message processing failures <em>nacks</em> the message, which is
then handled by the failure-strategy. It is the responsibility of the
<code>failure-strategy</code> to report the failure and influence the outcome of
the checks. The <code>fail</code> failure strategy reports the failure, and so the
check will report the fault.</p></section><section class="print-page" id="amqp-client-customization"><h1 id="amqp-client-customization-customizing-the-underlying-amqp-client">Customizing the underlying AMQP client</h1>
<p>You can customize the underlying AMQP Client configuration by
<em>producing</em> an instance of
<a href="https://vertx.io/docs/apidocs/io/vertx/amqp/AmqpClientOptions.html"><code>AmqpClientOptions</code></a>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-client-customization-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-options&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">AmqpClientOptions</span><span class="w"> </span><span class="nf">getNamedOptions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// You can use the produced options to configure the TLS connection</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">PemKeyCertOptions</span><span class="w"> </span><span class="n">keycert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemKeyCertOptions</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">            </span><span class="p">.</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.crt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">            </span><span class="p">.</span><span class="na">addKeyPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.key&quot;</span><span class="p">);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">PemTrustOptions</span><span class="w"> </span><span class="n">trust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemTrustOptions</span><span class="p">().</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tlc/ca.crt&quot;</span><span class="p">);</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AmqpClientOptions</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">            </span><span class="p">.</span><span class="na">setSsl</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemKeyCertOptions</span><span class="p">(</span><span class="n">keycert</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemTrustOptions</span><span class="p">(</span><span class="n">trust</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="p">.</span><span class="na">addEnabledSaslMechanism</span><span class="p">(</span><span class="s">&quot;EXTERNAL&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="p">.</span><span class="na">setHostnameVerificationAlgorithm</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">            </span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="mi">30000</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">            </span><span class="p">.</span><span class="na">setReconnectInterval</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">            </span><span class="p">.</span><span class="na">setContainerId</span><span class="p">(</span><span class="s">&quot;my-container&quot;</span><span class="p">);</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This instance is retrieved and used to configure the client used by the
connector. You need to indicate the name of the client using the
<code>client-options-name</code> attribute:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-client-customization-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.incoming.prices.client-options-name</span><span class="o">=</span><span class="s">my-named-options</span>
</code></pre></div></td></tr></table></div>
<h2 id="amqp-client-customization-client-capabilities">Client capabilities</h2>
<p>Both incoming and outgoing AMQP channels can be configured with a list
of capabilities to declare during sender and receiver connections with
the AMQP broker. Note that supported capability names are broker
specific.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-client-customization-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#amqp-client-customization-__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">mp.messaging.incoming.sink.capabilities</span><span class="o">=</span><span class="s">temporary-topic</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">...</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="na">mp.messaging.outgoing.source.capabilities</span><span class="o">=</span><span class="s">shared</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="amqp-rabbitmq"><h1 id="amqp-rabbitmq-using-rabbitmq">Using RabbitMQ</h1>
<p>This connector is for AMQP 1.0. RabbitMQ implements AMQP 0.9.1. RabbitMQ
does not provide AMQP 1.0 by default, but there is a plugin for it. To
use RabbitMQ with this connector, enable and configure the <a href="https://github.com/rabbitmq/rabbitmq-amqp1.0/blob/v3.8.x/README.md">AMQP 1.0
plugin</a>.</p>
<p>Despite the plugin, a few features wonâ€™t work with RabbitMQ. Thus, we
recommend the following configurations.</p>
<p>To receive messages from RabbitMQ:</p>
<ul>
<li>Set <code>durable</code> to <code>false</code></li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-rabbitmq-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#amqp-rabbitmq-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.prices.durable</span><span class="o">=</span><span class="s">false</span>
</code></pre></div></td></tr></table></div>
<p>To send messages to RabbitMQ:</p>
<ul>
<li>set the destination <code>address</code> (anonymous sender are not supported)</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#amqp-rabbitmq-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#amqp-rabbitmq-__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.outgoing.generated-price.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.outgoing.generated-price.address</span><span class="o">=</span><span class="s">prices</span>
</code></pre></div></td></tr></table></div>
<p>Itâ€™s not possible to change the destination dynamically (using message
metadata) when using RabbitMQ. The connector automatically detects that
the broker does not support anonymous sender (See
<a href="http://docs.oasis-open.org/amqp/anonterm/v1.0/anonterm-v1.0.html">http://docs.oasis-open.org/amqp/anonterm/v1.0/anonterm-v1.0.html</a>).</p>
<p>Alternatively, you can use the <a href="#rabbitmq-rabbitmq">RabbitMQ connector</a>.</p></section><h1 class='nav-section-title-end'>Ended: AMQP 1.0</h1>
                        <h1 class='nav-section-title' id='section-rabbitmq'>
                            RabbitMQ <a class='headerlink' href='#section-rabbitmq' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="rabbitmq-rabbitmq"><h1 id="rabbitmq-rabbitmq-rabbitmq-connector">RabbitMQ Connector</h1>
<p>The RabbitMQ Connector adds support for RabbitMQ to Reactive Messaging,
based on the AMQP 0-9-1 Protocol Specification.</p>
<p>Advanced Message Queuing Protocol 0-9-1 (<a href="https://www.rabbitmq.com/resources/specs/amqp0-9-1.pdf">AMQP
0-9-1</a>) is an
open standard for passing business messages between applications or
organizations.</p>
<p>With this connector, your application can:</p>
<ul>
<li>receive messages from a RabbitMQ queue</li>
<li>send messages to a RabbitMQ exchange</li>
</ul>
<p>The RabbitMQ connector is based on the <a href="https://vertx.io/docs/vertx-rabbitmq-client/java/">Vert.x RabbitMQ
Client</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The <strong>AMQP connector</strong> supports the AMQP 1.0 protocol, which is very
different from AMQP 0-9-1. You <em>can</em> use the AMQP connector with
RabbitMQ provided that the latter has the <a href="https://github.com/rabbitmq/rabbitmq-amqp1.0/blob/v3.7.x/README.md">AMQP 1.0
Plugin</a>
installed, albeit with reduced functionality.</p>
</div>
<h2 id="rabbitmq-rabbitmq-using-the-rabbitmq-connector">Using the RabbitMQ connector</h2>
<p>To use the RabbitMQ Connector, add the following dependency to your
project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-rabbitmq<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-rabbitmq</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
</code></pre></div></td></tr></table></div></p></section><section class="print-page" id="rabbitmq-receiving-messages-from-rabbitmq"><h1 id="rabbitmq-receiving-messages-from-rabbitmq-receiving-messages-from-rabbitmq">Receiving messages from RabbitMQ</h1>
<p>The RabbitMQ connector lets you retrieve messages from a <a href="https://www.rabbitmq.com/">RabbitMQ
broker</a>. The RabbitMQ connector retrieves
<em>RabbitMQ Messages</em> and maps each of them into Reactive Messaging
<code>Messages</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this context, the reactive messaging concept of a <em>Channel</em> is
realised as a <a href="https://www.rabbitmq.com/queues.html">RabbitMQ Queue</a>.</p>
</div>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-example">Example</h2>
<p>Letâ€™s imagine you have a RabbitMQ broker running, and accessible using
the <code>rabbitmq:5672</code> address (by default it would use <code>localhost:5672</code>).
Configure your application to receive RabbitMQ Messages on the <code>prices</code>
channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-7">7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">rabbitmq-host</span><span class="o">=</span><span class="s">rabbitmq  # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">rabbitmq-port</span><span class="o">=</span><span class="s">5672      # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">rabbitmq-username</span><span class="o">=</span><span class="s">my-username   # &lt;3&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">rabbitmq-password</span><span class="o">=</span><span class="s">my-password   # &lt;4&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq # &lt;5&gt;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="na">mp.messaging.incoming.prices.queue.name</span><span class="o">=</span><span class="s">my-queue         # &lt;6&gt;</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="na">mp.messaging.incoming.prices.routing-keys</span><span class="o">=</span><span class="s">urgent         # &lt;7&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>Configures the broker/router host name. You can do it per channel
    (using the <code>host</code> attribute) or globally using <code>rabbitmq-host</code>.</p>
</li>
<li>
<p>Configures the broker/router port. You can do it per channel (using
    the <code>port</code> attribute) or globally using <code>rabbitmq-port</code>. The default
    is 5672.</p>
</li>
<li>
<p>Configures the broker/router username if required. You can do it per
    channel (using the <code>username</code> attribute) or globally using
    <code>rabbitmq-username</code>.</p>
</li>
<li>
<p>Configures the broker/router password if required. You can do it per
    channel (using the <code>password</code> attribute) or globally using
    <code>rabbitmq-password</code>.</p>
</li>
<li>
<p>Instructs the <code>prices</code> channel to be managed by the RabbitMQ
    connector.</p>
</li>
<li>
<p>Configures the RabbitMQ queue to read messages from.</p>
</li>
<li>
<p>Configures the binding between the RabbitMQ exchange and the
    RabbitMQ queue using a routing key. The default is <code>#</code> (all messages
    will be forwarded from the exchange to the queue) but in general
    this can be a comma-separated list of one or more keys.</p>
</li>
</ol>
<p>Then, your application receives <code>Message&lt;String&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RabbitMQPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;String&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RabbitMQPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message, marking the RabbitMQ message as `accepted`.</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Whether you need to explicitly acknowledge the message depends on the
<code>auto-acknowledgement</code> channel setting; if that is set to <code>true</code> then
your message will be automatically acknowledged on receipt.</p>
</div>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-deserialization">Deserialization</h2>
<p>The connector converts incoming RabbitMQ Messages into Reactive
Messaging <code>Message&lt;T&gt;</code> instances. The payload type <code>T</code> depends on the
value of the RabbitMQ received message Envelope <code>content_type</code> and
<code>content_encoding</code> properties.</p>
<table>
<thead>
<tr>
<th>content_encoding</th>
<th>content_type</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Value present</em></td>
<td><em>n/a</em></td>
<td><code>byte[]</code></td>
</tr>
<tr>
<td><em>No value</em></td>
<td><code>text/plain</code></td>
<td><code>String</code></td>
</tr>
<tr>
<td><em>No value</em></td>
<td><code>application/json</code></td>
<td>a JSON element which can be a <a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonArray.html"><code>JsonArray</code></a>, <a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html"><code>JsonObject</code></a>, <code>String</code>, ... if the buffer contains an array, object, string,...</td>
</tr>
<tr>
<td><em>No value</em></td>
<td><em>Anything else</em></td>
<td><code>byte[]</code></td>
</tr>
</tbody>
</table>
<p>If you send objects with this RabbitMQ connector (outbound connector),
they are encoded as JSON and sent with <code>content_type</code> set to
<code>application/json</code>. You can receive this payload using (Vert.x) JSON
Objects, and then map it to the object class you want:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-3-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Generator</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;to-rabbitmq&quot;</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">prices</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">             </span><span class="c1">// &lt;1&gt;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">        </span><span class="n">AtomicInteger</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AtomicInteger</span><span class="p">();</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">l</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Price</span><span class="p">().</span><span class="na">setPrice</span><span class="p">(</span><span class="n">count</span><span class="p">.</span><span class="na">incrementAndGet</span><span class="p">()))</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">                </span><span class="p">.</span><span class="na">onOverflow</span><span class="p">().</span><span class="na">drop</span><span class="p">();</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="p">}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Consumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">CopyOnWriteArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;from-rabbitmq&quot;</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">JsonObject</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">      </span><span class="c1">// &lt;2&gt;</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">        </span><span class="n">Price</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="na">mapTo</span><span class="p">(</span><span class="n">Price</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  </span><span class="c1">// &lt;3&gt;</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">        </span><span class="n">prices</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">price</span><span class="p">);</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Price</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">list</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">prices</span><span class="p">;</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>The <code>Price</code> instances are automatically encoded to JSON by the
    connector</li>
<li>You can receive it using a <code>JsonObject</code></li>
<li>Then, you can reconstruct the instance using the <code>mapTo</code> method</li>
</ol>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from RabbitMQ contain an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-rabbitmq/4.16.0/io/smallrye/reactive/messaging/rabbitmq/IncomingRabbitMQMetadata.html'>IncomingRabbitMQMetadata</a>
in the metadata.</p>
<p>RabbitMQ message headers can be accessed from the metadata either by
calling <code>getHeader(String header, Class&lt;T&gt; type)</code> to retrieve a single
header value. or <code>getHeaders()</code> to get a map of all header values.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-4-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">IncomingRabbitMQMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incomingMessage</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingRabbitMQMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">metadata</span><span class="p">.</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">meta</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contentEncoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getContentEncoding</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">contentType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getContentType</span><span class="p">();</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">correlationId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getCorrelationId</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">ZonedDateTime</span><span class="o">&gt;</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">(</span><span class="n">ZoneId</span><span class="p">.</span><span class="na">systemDefault</span><span class="p">());</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getPriority</span><span class="p">();</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">replyTo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getReplyTo</span><span class="p">();</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getUserId</span><span class="p">();</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="c1">// Access a single String-valued header</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stringHeader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getHeader</span><span class="p">(</span><span class="s">&quot;my-header&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="c1">// Access all headers</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">headers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getHeaders</span><span class="p">();</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<p>The type <code>&lt;T&gt;</code> of the header value depends on the RabbitMQ type used for
the header:</p>
<table>
<thead>
<tr>
<th>RabbitMQ Header Type</th>
<th>T</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td><code>String</code></td>
</tr>
<tr>
<td>Boolean</td>
<td><code>Boolean</code></td>
</tr>
<tr>
<td>Number</td>
<td><code>Number</code></td>
</tr>
<tr>
<td>List</td>
<td><code>java.util.List</code></td>
</tr>
</tbody>
</table>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-acknowledgement">Acknowledgement</h2>
<p>When a Reactive Messaging Message associated with a RabbitMQ Message is
acknowledged, it informs the broker that the message has been
<em>accepted</em>.</p>
<p>Whether you need to explicitly acknowledge the message depends on the
<code>auto-acknowledgement</code> setting for the channel; if that is set to <code>true</code>
then your message will be automatically acknowledged on receipt.</p>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-failure-management">Failure Management</h2>
<p>If a message produced from a RabbitMQ message is <em>nacked</em>, a failure
strategy is applied. The RabbitMQ connector supports three strategies,
controlled by the <code>failure-strategy</code> channel setting:</p>
<ul>
<li>
<p><code>fail</code> - fail the application; no more RabbitMQ messages will be
    processed. The RabbitMQ message is marked as rejected.</p>
</li>
<li>
<p><code>accept</code> - this strategy marks the RabbitMQ message as accepted. The
    processing continues ignoring the failure.</p>
</li>
<li>
<p><code>reject</code> - this strategy marks the RabbitMQ message as rejected
    (default). The processing continues with the next message.</p>
</li>
<li>
<p><code>requeue</code> - this strategy marks the RabbitMQ message as rejected
    with requeue flag to true. The processing continues with the next message,
    but the requeued message will be redelivered to the consumer.</p>
</li>
</ul>
<p>When using <code>dead-letter-queue</code>, it is also possible to change some
metadata of the record that is sent to the dead letter topic. To do
that, use the <code>Message.nack(Throwable, Metadata)</code> method:</p>
<p>The RabbitMQ reject <code>requeue</code> flag can be controlled on different failure strategies
using the <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/rabbitmq/RabbitMQRejectMetadata.html'>RabbitMQRejectMetadata</a>.
To do that, use the <code>Message.nack(Throwable, Metadata)</code> method by including the
<code>RabbitMQRejectMetadata</code> metadata with <code>requeue</code> to <code>true</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-5-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Failed!&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="k">new</span><span class="w"> </span><span class="n">RabbitMQRejectMetadata</span><span class="p">(</span><span class="kc">true</span><span class="p">)));</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p><code>RabbitMQFailureHandler</code> is experimental and APIs are subject to change in the future</p>
</div>
<p>In addition, you can also provide your own failure strategy.
To provide a failure strategy implement a bean exposing the interface
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/rabbitmq/fault/RabbitMQFailureHandler.html'>RabbitMQFailureHandler</a>,
qualified with a <code>@Identifier</code>.
Set the name of the bean as the <code>failure-strategy</code> channel setting.</p>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>addresses</em> <em>(rabbitmq-addresses)</em></td>
<td style="text-align: left;">The multiple addresses for cluster mode, when given overrides the host and port</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>arguments</em></td>
<td style="text-align: left;">A comma-separated list of arguments [key1:value1,key2:value2,...] to bind the queue to the exchange. Relevant only if 'exchange.type' is headers</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-acknowledgement</em></td>
<td style="text-align: left;">Whether the received RabbitMQ messages must be acknowledged when received; if true then delivery constitutes acknowledgement</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-bind-dlq</em></td>
<td style="text-align: left;">Whether to automatically declare the DLQ and bind it to the binder DLX</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>automatic-recovery-enabled</em></td>
<td style="text-align: left;">Whether automatic connection recovery is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>automatic-recovery-on-initial-connection</em></td>
<td style="text-align: left;">Whether automatic recovery on initial connections is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether the received RabbitMQ messages must be dispatched to multiple <em>subscribers</em></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(rabbitmq-client-options-name)</em></td>
<td style="text-align: left;">The name of the RabbitMQ Client Option bean used to customize the RabbitMQ client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connection-timeout</em></td>
<td style="text-align: left;">The TCP connection timeout (ms); 0 is interpreted as no timeout</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>consumer-arguments</em></td>
<td style="text-align: left;">A comma-separated list of arguments [key1:value1,key2:value2,...] for created consumer</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>content-type-override</em></td>
<td style="text-align: left;">Override the content_type attribute of the incoming message, should be a valid MINE type</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>credentials-provider-name</em> <em>(rabbitmq-credentials-provider-name)</em></td>
<td style="text-align: left;">The name of the RabbitMQ Credentials Provider bean used to provide dynamic credentials to the RabbitMQ client</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-dlx</em></td>
<td style="text-align: left;">If specified, a DLX to assign to the DLQ. Relevant only if auto-bind-dlq is true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-dlx-routing-key</em></td>
<td style="text-align: left;">If specified, a dead letter routing key to assign to the DLQ. Relevant only if auto-bind-dlq is true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-exchange</em></td>
<td style="text-align: left;">A DLX to assign to the queue. Relevant only if auto-bind-dlq is true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>DLX</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-exchange-type</em></td>
<td style="text-align: left;">The type of the DLX to assign to the queue. Relevant only if auto-bind-dlq is true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>direct</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-exchange.arguments</em></td>
<td style="text-align: left;">The identifier of the key-value Map exposed as bean used to provide arguments for dead-letter-exchange creation</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue-mode</em></td>
<td style="text-align: left;">If automatically declare DLQ, we can choose different modes of DLQ [lazy, default]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue-name</em></td>
<td style="text-align: left;">The name of the DLQ; if not supplied will default to the queue name with '.dlq' appended</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue-type</em></td>
<td style="text-align: left;">If automatically declare DLQ, we can choose different types of DLQ [quorum, classic, stream]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.arguments</em></td>
<td style="text-align: left;">The identifier of the key-value Map exposed as bean used to provide arguments for dead-letter-queue creation</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-routing-key</em></td>
<td style="text-align: left;">A dead letter routing key to assign to the queue; if not supplied will default to the queue name</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-ttl</em></td>
<td style="text-align: left;">If specified, the time (ms) for which a message can remain in DLQ undelivered before it is dead. Relevant only if auto-bind-dlq is true</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dlx.declare</em></td>
<td style="text-align: left;">Whether to declare the dead letter exchange binding. Relevant only if auto-bind-dlq is true; set to false if these are expected to be set up independently</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.arguments</em></td>
<td style="text-align: left;">The identifier of the key-value Map exposed as bean used to provide arguments for exchange creation</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>rabbitmq-exchange-arguments</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.auto-delete</em></td>
<td style="text-align: left;">Whether the exchange should be deleted after use</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.declare</em></td>
<td style="text-align: left;">Whether to declare the exchange; set to false if the exchange is expected to be set up independently</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.durable</em></td>
<td style="text-align: left;">Whether the exchange is durable</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.name</em></td>
<td style="text-align: left;">The exchange that messages are published to or consumed from. If not set, the channel name is used. If set to "", the default exchange is used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.type</em></td>
<td style="text-align: left;">The exchange type: direct, fanout, headers or topic (default)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>topic</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">The failure strategy to apply when a RabbitMQ message is nacked. Accepted values are <code>fail</code>, <code>accept</code>, <code>reject</code> (default), <code>requeue</code> or name of a bean</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>reject</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>handshake-timeout</em></td>
<td style="text-align: left;">The AMQP 0-9-1 protocol handshake timeout (ms)</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-lazy-subscription</em></td>
<td style="text-align: left;">Whether the liveness and readiness checks should report 'ok' when there is no subscription yet. This is useful when injecting the channel with <code>@Inject @Channel("...") Multi&lt;...&gt; multi;</code></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-enabled</em></td>
<td style="text-align: left;">Whether readiness health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em> <em>(rabbitmq-host)</em></td>
<td style="text-align: left;">The broker hostname</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>include-properties</em></td>
<td style="text-align: left;">Whether to include properties when a broker message is passed on the event bus</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>keep-most-recent</em></td>
<td style="text-align: left;">Whether to discard old messages instead of recent ones</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-incoming-internal-queue-size</em></td>
<td style="text-align: left;">The maximum size of the incoming internal queue</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>500000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-outstanding-messages</em></td>
<td style="text-align: left;">The maximum number of outstanding/unacknowledged messages being processed by the connector at a time; must be a positive number</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>network-recovery-interval</em></td>
<td style="text-align: left;">How long (ms) will automatic recovery wait before attempting to reconnect</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em> <em>(rabbitmq-password)</em></td>
<td style="text-align: left;">The password used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em> <em>(rabbitmq-port)</em></td>
<td style="text-align: left;">The broker port</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5672</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.arguments</em></td>
<td style="text-align: left;">The identifier of the key-value Map exposed as bean used to provide arguments for queue creation</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>rabbitmq-queue-arguments</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.auto-delete</em></td>
<td style="text-align: left;">Whether the queue should be deleted after use</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.declare</em></td>
<td style="text-align: left;">Whether to declare the queue and binding; set to false if these are expected to be set up independently</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.durable</em></td>
<td style="text-align: left;">Whether the queue is durable</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.exclusive</em></td>
<td style="text-align: left;">Whether the queue is for exclusive use</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.name</em></td>
<td style="text-align: left;">The queue from which messages are consumed. If not set, the channel name is used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.single-active-consumer</em></td>
<td style="text-align: left;">If set to true, only one consumer can actively consume messages</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.ttl</em></td>
<td style="text-align: left;">If specified, the time (ms) for which a message can remain in the queue undelivered before it is dead</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.x-delivery-limit</em></td>
<td style="text-align: left;">If queue.x-queue-type is quorum, when a message has been returned more times than the limit the message will be dropped or dead-lettered</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.x-max-priority</em></td>
<td style="text-align: left;">Define priority level queue consumer</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.x-queue-mode</em></td>
<td style="text-align: left;">If automatically declare queue, we can choose different modes of queue [lazy, default]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>queue.x-queue-type</em></td>
<td style="text-align: left;">If automatically declare queue, we can choose different types of queue [quorum, classic, stream]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-attempts</em> <em>(rabbitmq-reconnect-attempts)</em></td>
<td style="text-align: left;">The number of reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>100</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval</em> <em>(rabbitmq-reconnect-interval)</em></td>
<td style="text-align: left;">The interval (in seconds) between two reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requested-channel-max</em></td>
<td style="text-align: left;">The initially requested maximum channel number</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2047</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requested-heartbeat</em></td>
<td style="text-align: left;">The initially requested heartbeat interval (seconds), zero for none</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>routing-keys</em></td>
<td style="text-align: left;">A comma-separated list of routing keys to bind the queue to the exchange. Relevant only if 'exchange.type' is topic or direct</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>#</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl</em> <em>(rabbitmq-ssl)</em></td>
<td style="text-align: left;">Whether or not the connection should use SSL</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing.attribute-headers</em></td>
<td style="text-align: left;">A comma-separated list of headers that should be recorded as span attributes. Relevant only if tracing.enabled=true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;">``</td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing.enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-all</em> <em>(rabbitmq-trust-all)</em></td>
<td style="text-align: left;">Whether to skip trust certificate verification</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-store-password</em> <em>(rabbitmq-trust-store-password)</em></td>
<td style="text-align: left;">The password of the JKS trust store</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-store-path</em> <em>(rabbitmq-trust-store-path)</em></td>
<td style="text-align: left;">The path to a JKS trust store</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>use-nio</em></td>
<td style="text-align: left;">Whether usage of NIO Sockets is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>user</em></td>
<td style="text-align: left;">The user name to use when connecting to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>guest</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em> <em>(rabbitmq-username)</em></td>
<td style="text-align: left;">The username used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>virtual-host</em> <em>(rabbitmq-virtual-host)</em></td>
<td style="text-align: left;">The virtual host to use when connecting to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>/</code></td>
</tr>
</tbody>
</table>
<p>To use an existing <em>queue</em>, you need to configure the <code>queue.name</code>
attribute.</p>
<p>For example, if you have a RabbitMQ broker already configured with a
queue called <code>peopleQueue</code> that you wish to read messages from, you need
the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.incoming.people.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.incoming.people.queue.name</span><span class="o">=</span><span class="s">peopleQueue</span>
</code></pre></div></td></tr></table></div>
<p>If you want RabbitMQ to create the queue for you but bind it to an
existing topic exchange <code>people</code>, you need the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-7-2">2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">mp.messaging.incoming.people.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">mp.messaging.incoming.people.queue.name</span><span class="o">=</span><span class="s">peopleQueue</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="na">mp.messaging.incoming.people.queue.declare</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the above the channel name <code>people</code> is implicitly assumed to be the
name of the exchange; if this is not the case you would need to name the
exchange explicitly using the <code>exchange.name</code> property.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The connector supports RabbitMQ's "Server-named Queues" feature to create
an exclusive, auto-deleting, non-durable and randomly named queue. To
enable this feature you set the queue name to exactly <code>(server.auto)</code>.
Using this name not only enables the server named queue feature but also
automatically makes ths queue exclusive, auto-deleting, and non-durable;
therefore ignoring any values provided for the <code>exclusive</code>, <code>auto-delete</code>
and <code>durable</code> options.</p>
</div>
<p>If you want RabbitMQ to create the <code>people</code> exchange, queue and binding,
you need the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-8-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="na">mp.messaging.incoming.people.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="na">mp.messaging.incoming.people.exchange.declare</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="na">mp.messaging.incoming.people.queue.name</span><span class="o">=</span><span class="s">peopleQueue</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="na">mp.messaging.incoming.people.queue.declare</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="na">mp.messaging.incoming.people.queue.routing-keys</span><span class="o">=</span><span class="s">tall,short</span>
</code></pre></div></td></tr></table></div>
<p>In the above we have used an explicit list of routing keys rather than
the default (<code>#</code>). Each component of the list creates a separate binding
between the queue and the exchange, so in the case above we would have
two bindings; one based on a routing key of <code>tall</code>, the other based on
one of <code>short</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default value of <code>routing-keys</code> is <code>#</code> (indicating a match against
all possible routing keys) which is only appropriate for <em>topic</em>
Exchanges. If you are using other types of exchange and/or need to
declare queue bindings, youâ€™ll need to supply a valid value for the
exchange in question.</p>
</div>
<h2 id="rabbitmq-receiving-messages-from-rabbitmq-custom-arguments-for-queue-declaration">Custom arguments for Queue declaration</h2>
<p>When queue declaration is made by the Reactive Messaging channel, using the <code>queue.declare=true</code> configuration,
custom queue arguments can be specified using the <code>queue.arguments</code> attribute.
<code>queue.arguments</code> accepts the identifier (using the <code>@Identifier</code> qualifier) of a <code>Map&lt;String, Object&gt;</code> exposed as a CDI bean.
If no arguments has been configured, the default <strong>rabbitmq-queue-arguments</strong> identifier is looked for.</p>
<p>The following CDI bean produces such a configuration identified with <strong>my-arguments</strong>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-10">10</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-11">11</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-12">12</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-13">13</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-14">14</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-15">15</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-16">16</a></span>
<span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-9-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.customization</span><span class="p">;</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ArgumentProducers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-arguments&quot;</span><span class="p">)</span>
<a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">customArguments</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;custom-arg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">);</span>
<a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Then the channel can be configured to use those arguments in exchange declaration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-receiving-messages-from-rabbitmq-__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="na">mp.messaging.outgoing.data.queue.arguments</span><span class="o">=</span><span class="s">my-arguments</span>
</code></pre></div></td></tr></table></div>
<p>Similarly, the <code>dead-letter-queue.arguments</code> allows configuring custom arguments for dead letter queue when one is declared (<code>auto-bind-dlq=true</code>).</p></section><section class="print-page" id="rabbitmq-sending-messages-to-rabbitmq"><h1 id="rabbitmq-sending-messages-to-rabbitmq-sending-messages-to-rabbitmq">Sending messages to RabbitMQ</h1>
<p>The RabbitMQ connector can write Reactive Messaging <code>Messages</code> as
RabbitMQ Messages.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this context, the reactive messaging concept of a <em>Channel</em> is
realised as a <a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html#exchanges">RabbitMQ
Exchange</a>.</p>
</div>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-example">Example</h2>
<p>Letâ€™s imagine you have a RabbitMQ broker running, and accessible using
the <code>rabbitmq:5672</code> address (by default it would use <code>localhost:5672</code>).
Configure your application to send the messages from the <code>prices</code>
channel as a RabbitMQ Message as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>rabbitmq-host=rabbitmq   # &lt;1&gt;
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>rabbitmq-port=5672       # &lt;2&gt;
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>rabbitmq-username=my-username # &lt;3&gt;
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>rabbitmq-password=my-password  # &lt;4&gt;
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>mp.messaging.outgoing.prices.connector=smallrye-rabbitmq # &lt;5&gt;
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>mp.messaging.outgoing.prices.default-routing-key=normal    # &lt;6&gt;
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>Configures the broker/router host name. You can do it per channel
    (using the <code>host</code> attribute) or globally using <code>rabbitmq-host</code></p>
</li>
<li>
<p>Configures the broker/router port. You can do it per channel (using
    the <code>port</code> attribute) or globally using <code>rabbitmq-port</code>. The default
    is <code>5672</code>.</p>
</li>
<li>
<p>Configures the broker/router username if required. You can do it per
    channel (using the <code>username</code> attribute) or globally using
    <code>rabbitmq-username</code>.</p>
</li>
<li>
<p>Configures the broker/router password if required. You can do it per
    channel (using the <code>password</code> attribute) or globally using
    <code>rabbitmq-password</code>.</p>
</li>
<li>
<p>Instructs the <code>prices</code> channel to be managed by the RabbitMQ
    connector</p>
</li>
<li>
<p>Supplies the default routing key to be included in outbound
    messages; this will be if the "raw payload" form of message sending
    is used (see below).</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the RabbitMQ exchange name. By default, it uses
the channel name (<code>prices</code>) as the name of the exchange to send messages
to. You can configure the <code>exchange.name</code> attribute to override it.</p>
</div>
<p>Then, your application can send <code>Message&lt;Double&gt;</code> to the prices channel.
It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RabbitMQPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>, which affords the opportunity to
explicitly specify metadata on the outgoing message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-2-33">33</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.ZonedDateTime</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Metadata</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.rabbitmq.OutgoingRabbitMQMetadata</span><span class="p">;</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RabbitMQPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">(),</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">                        </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OutgoingRabbitMQMetadata</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">                                </span><span class="p">.</span><span class="na">withRoutingKey</span><span class="p">(</span><span class="s">&quot;normal&quot;</span><span class="p">)</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">                                </span><span class="p">.</span><span class="na">withTimestamp</span><span class="p">(</span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">                                </span><span class="p">.</span><span class="na">build</span><span class="p">())));</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-serialization">Serialization</h2>
<p>When sending a <code>Message&lt;T&gt;</code>, the connector converts the message into a
RabbitMQ Message. The payload is converted to the RabbitMQ Message body.</p>
<table>
<thead>
<tr>
<th>T</th>
<th>RabbitMQ Message Body</th>
</tr>
</thead>
<tbody>
<tr>
<td>primitive types or <code>UUID</code>/<code>String</code></td>
<td>String value with <code>content_type</code> set to <code>text/plain</code></td>
</tr>
<tr>
<td><a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html"><code>JsonObject</code></a> or <a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonArray.html"><code>JsonArray</code></a></td>
<td>Serialized String payload with <code>content_type</code> set to <code>application/json</code></td>
</tr>
<tr>
<td><code>io.vertx.mutiny.core.buffer.Buffer</code></td>
<td>Binary content, with <code>content_type</code> set to <code>application/octet-stream</code></td>
</tr>
<tr>
<td><code>byte[]</code></td>
<td>Binary content, with content_type set to <code>application/octet-stream</code></td>
</tr>
<tr>
<td>Any other class</td>
<td>The payload is converted to JSON (using a Json Mapper) then serialized with <code>content_type</code> set to <code>application/json</code></td>
</tr>
</tbody>
</table>
<p>If the message payload cannot be serialized to JSON, the message is
<em>nacked</em>.</p>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Messages</code>, you can add an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-rabbitmq/4.16.0/io/smallrye/reactive/messaging/rabbitmq/OutgoingRabbitMQMetadata.html'>OutgoingRabbitMQMetadata</a>
to influence how the message is handled by RabbitMQ. For example, you
can configure the routing key, timestamp and headers:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-3-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kd">final</span><span class="w"> </span><span class="n">OutgoingRabbitMQMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">OutgoingRabbitMQMetadata</span><span class="p">.</span><span class="na">Builder</span><span class="p">()</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">        </span><span class="p">.</span><span class="na">withHeader</span><span class="p">(</span><span class="s">&quot;my-header&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;xyzzy&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">        </span><span class="p">.</span><span class="na">withRoutingKey</span><span class="p">(</span><span class="s">&quot;urgent&quot;</span><span class="p">)</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">        </span><span class="p">.</span><span class="na">withTimestamp</span><span class="p">(</span><span class="n">ZonedDateTime</span><span class="p">.</span><span class="na">now</span><span class="p">())</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// Add `metadata` to the metadata of the outgoing message.</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="k">return</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">metadata</span><span class="p">));</span>
</code></pre></div></td></tr></table></div>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-acknowledgement">Acknowledgement</h2>
<p>By default, the Reactive Messaging <code>Message</code> is acknowledged when the
broker acknowledges the message.</p>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>addresses</em> <em>(rabbitmq-addresses)</em></td>
<td style="text-align: left;">The multiple addresses for cluster mode, when given overrides the host and port</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>automatic-recovery-enabled</em></td>
<td style="text-align: left;">Whether automatic connection recovery is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>automatic-recovery-on-initial-connection</em></td>
<td style="text-align: left;">Whether automatic recovery on initial connections is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(rabbitmq-client-options-name)</em></td>
<td style="text-align: left;">The name of the RabbitMQ Client Option bean used to customize the RabbitMQ client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connection-timeout</em></td>
<td style="text-align: left;">The TCP connection timeout (ms); 0 is interpreted as no timeout</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>credentials-provider-name</em> <em>(rabbitmq-credentials-provider-name)</em></td>
<td style="text-align: left;">The name of the RabbitMQ Credentials Provider bean used to provide dynamic credentials to the RabbitMQ client</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>default-routing-key</em></td>
<td style="text-align: left;">The default routing key to use when sending messages to the exchange</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;">``</td>
</tr>
<tr>
<td style="text-align: left;"><em>default-ttl</em></td>
<td style="text-align: left;">If specified, the time (ms) sent messages can remain in queues undelivered before they are dead</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.arguments</em></td>
<td style="text-align: left;">The identifier of the key-value Map exposed as bean used to provide arguments for exchange creation</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>rabbitmq-exchange-arguments</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.auto-delete</em></td>
<td style="text-align: left;">Whether the exchange should be deleted after use</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.declare</em></td>
<td style="text-align: left;">Whether to declare the exchange; set to false if the exchange is expected to be set up independently</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.durable</em></td>
<td style="text-align: left;">Whether the exchange is durable</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.name</em></td>
<td style="text-align: left;">The exchange that messages are published to or consumed from. If not set, the channel name is used. If set to "", the default exchange is used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>exchange.type</em></td>
<td style="text-align: left;">The exchange type: direct, fanout, headers or topic (default)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>topic</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>handshake-timeout</em></td>
<td style="text-align: left;">The AMQP 0-9-1 protocol handshake timeout (ms)</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-enabled</em></td>
<td style="text-align: left;">Whether readiness health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em> <em>(rabbitmq-host)</em></td>
<td style="text-align: left;">The broker hostname</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>include-properties</em></td>
<td style="text-align: left;">Whether to include properties when a broker message is passed on the event bus</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-inflight-messages</em></td>
<td style="text-align: left;">The maximum number of messages to be written to RabbitMQ concurrently; must be a positive number</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1024</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-outgoing-internal-queue-size</em></td>
<td style="text-align: left;">The maximum size of the outgoing internal queue</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>network-recovery-interval</em></td>
<td style="text-align: left;">How long (ms) will automatic recovery wait before attempting to reconnect</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em> <em>(rabbitmq-password)</em></td>
<td style="text-align: left;">The password used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em> <em>(rabbitmq-port)</em></td>
<td style="text-align: left;">The broker port</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>5672</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>publish-confirms</em></td>
<td style="text-align: left;">If set to true, published messages are acknowledged when the publish confirm is received from the broker</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-attempts</em> <em>(rabbitmq-reconnect-attempts)</em></td>
<td style="text-align: left;">The number of reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>100</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval</em> <em>(rabbitmq-reconnect-interval)</em></td>
<td style="text-align: left;">The interval (in seconds) between two reconnection attempts</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requested-channel-max</em></td>
<td style="text-align: left;">The initially requested maximum channel number</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2047</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requested-heartbeat</em></td>
<td style="text-align: left;">The initially requested heartbeat interval (seconds), zero for none</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl</em> <em>(rabbitmq-ssl)</em></td>
<td style="text-align: left;">Whether or not the connection should use SSL</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing.attribute-headers</em></td>
<td style="text-align: left;">A comma-separated list of headers that should be recorded as span attributes. Relevant only if tracing.enabled=true</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;">``</td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing.enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-all</em> <em>(rabbitmq-trust-all)</em></td>
<td style="text-align: left;">Whether to skip trust certificate verification</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-store-password</em> <em>(rabbitmq-trust-store-password)</em></td>
<td style="text-align: left;">The password of the JKS trust store</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-store-path</em> <em>(rabbitmq-trust-store-path)</em></td>
<td style="text-align: left;">The path to a JKS trust store</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>use-nio</em></td>
<td style="text-align: left;">Whether usage of NIO Sockets is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>user</em></td>
<td style="text-align: left;">The user name to use when connecting to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>guest</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em> <em>(rabbitmq-username)</em></td>
<td style="text-align: left;">The username used to authenticate to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>virtual-host</em> <em>(rabbitmq-virtual-host)</em></td>
<td style="text-align: left;">The virtual host to use when connecting to the broker</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>/</code></td>
</tr>
</tbody>
</table>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-using-existing-destinations">Using existing destinations</h2>
<p>To use an existing <em>exchange</em>, you may need to configure the
<code>exchange.name</code> attribute.</p>
<p>For example, if you have a RabbitMQ broker already configured with an
exchange called <code>people</code> that you wish to send messages to, you need the
following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="na">mp.messaging.outgoing.people.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
</code></pre></div></td></tr></table></div>
<p>You would need to configure the <code>exchange.name</code> attribute, if the
exchange name were not the channel name:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="na">mp.messaging.outgoing.people-out.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">mp.messaging.outgoing.people-out.exchange.name</span><span class="o">=</span><span class="s">people</span>
</code></pre></div></td></tr></table></div>
<p>If you want RabbitMQ to create the <code>people</code> exchange, you need the
following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-6-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.outgoing.people-out.connector</span><span class="o">=</span><span class="s">smallrye-amqp</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.outgoing.people-out.exchange.name</span><span class="o">=</span><span class="s">people</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">mp.messaging.outgoing.people-out.exchange.declare</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The above example will create a <code>topic</code> exchange and use an empty
default <code>routing-key</code> (unless overridden programatically using outgoing
metadata for the message). If you want to create a different type of
exchange or have a different default routing key, then the
<code>exchange.type</code> and <code>default-routing-key</code> properties need to be
explicitly specified.</p>
</div>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-sending-to-specific-queues-via-the-default-exchange">Sending to specific queues via the default exchange</h2>
<p>To send a message to a specific queue (usually a reply queue),
you have to configure the default exchange as an outgoing channel and set the name of the queue as routing key in the message metadata.
The name of the exchange needs to be set to <code>""</code>.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-7-1">1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-7-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="na">mp.messaging.outgoing.channel-name-for-default-exchange.connector</span><span class="o">=</span><span class="s">smallrye-rabbitmq</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="na">mp.messaging.outgoing.channel-name-for-default-exchange.exchange.name</span><span class="o">=</span><span class="s">&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
<h2 id="rabbitmq-sending-messages-to-rabbitmq-custom-arguments-for-exchange-declaration">Custom arguments for Exchange declaration</h2>
<p>When exchange declaration is made by the Reactive Messaging channel, using the <code>exchange.declare=true</code> configuration,
custom exchange arguments can be specified using the <code>exchange.arguments</code> attribute.
<code>exchange.arguments</code> accepts the identifier (using the <code>@Identifier</code> qualifier) of a <code>Map&lt;String, Object&gt;</code> exposed as a CDI bean.
If no arguments has been configured, the default <strong>rabbitmq-exchange-arguments</strong> identifier is looked for.</p>
<p>The following CDI bean produces such a configuration identified with <strong>my-arguments</strong>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-10">10</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-11">11</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-12">12</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-13">13</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-14">14</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-15">15</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-16">16</a></span>
<span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-8-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">rabbitmq.customization</span><span class="p">;</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a>
<a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-8-9" name="__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ArgumentProducers</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-arguments&quot;</span><span class="p">)</span>
<a id="__codelineno-8-14" name="__codelineno-8-14"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">customArguments</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;custom-arg&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">);</span>
<a id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Then the channel can be configured to use those arguments in exchange declaration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-sending-messages-to-rabbitmq-__codelineno-9-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="na">mp.messaging.outgoing.data.exchange.arguments</span><span class="o">=</span><span class="s">my-arguments</span>
</code></pre></div></td></tr></table></div>
<p>Similarly, the <code>dead-letter-exchange.arguments</code> allows configuring custom arguments for dead letter exchange when one is declared (<code>dlx.declare=true</code>).</p></section><section class="print-page" id="rabbitmq-rabbitmq-health"><h1 id="rabbitmq-rabbitmq-health-health-reporting">Health reporting</h1>
<p>The RabbitMQ connector reports the readiness and liveness of each
channel managed by the connector.</p>
<p>On the inbound side (receiving messages from RabbitMQ), the check
verifies that the receiver is connected to the broker.</p>
<p>On the outbound side (sending records to RabbitMQ), the check verifies
that the sender is not disconnected from the broker; the sender <em>may</em>
still be in an initialized state (connection not yet attempted), but
this is regarded as live/ready.</p>
<p>You can disable health reporting by setting the <code>health-enabled</code> attribute of the channel to <code>false</code>.
It disables both liveness and readiness.
You can disable readiness reporting by setting the <code>health-readiness-enabled</code> attribute of the channel to <code>false</code>.</p>
<h2 id="rabbitmq-rabbitmq-health-channel-and-lazy-subscription">@Channel and lazy subscription</h2>
<p>When you inject a channel using <code>@Channel</code> annotation, you are responsible for subscribing to the channel.
Until the subscription happens, the channel is not connected to the broker and thus cannot receive messages.
The default health check will fail in this case.</p>
<p>To handle this use case, you need to configure the <code>health-lazy-subscription</code> attribute of the channel to <code>true</code>.
It configures the health check to not fail if there are no subscription yet.</p></section><section class="print-page" id="rabbitmq-rabbitmq-client-customization"><h1 id="rabbitmq-rabbitmq-client-customization-customizing-the-underlying-rabbitmq-client">Customizing the underlying RabbitMQ client</h1>
<p>You can customize the underlying RabbitMQ Client configuration by
<em>producing</em> an instance of
<a href="https://vertx.io/docs/apidocs/io/vertx/rabbitmq/RabbitMQOptions.html"><code>RabbitMQOptions</code></a>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-17">17</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-18">18</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-client-customization-__codelineno-0-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-named-options&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">RabbitMQOptions</span><span class="w"> </span><span class="nf">getNamedOptions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// You can use the produced options to configure the TLS connection</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">PemKeyCertOptions</span><span class="w"> </span><span class="n">keycert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemKeyCertOptions</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">            </span><span class="p">.</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.crt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">            </span><span class="p">.</span><span class="na">addKeyPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.key&quot;</span><span class="p">);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">PemTrustOptions</span><span class="w"> </span><span class="n">trust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemTrustOptions</span><span class="p">().</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tlc/ca.crt&quot;</span><span class="p">);</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">RabbitMQOptions</span><span class="p">)</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RabbitMQOptions</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">            </span><span class="p">.</span><span class="na">setUser</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">            </span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">            </span><span class="p">.</span><span class="na">setSsl</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemKeyCertOptions</span><span class="p">(</span><span class="n">keycert</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemTrustOptions</span><span class="p">(</span><span class="n">trust</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">            </span><span class="p">.</span><span class="na">setHostnameVerificationAlgorithm</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">            </span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="mi">30000</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">            </span><span class="p">.</span><span class="na">setReconnectInterval</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This instance is retrieved and used to configure the client used by the
connector. You need to indicate the name of the client using the
<code>client-options-name</code> attribute:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>mp.messaging.incoming.prices.client-options-name=my-named-options
</code></pre></div></td></tr></table></div></section><section class="print-page" id="rabbitmq-rabbitmq-cloud"><h1 id="rabbitmq-rabbitmq-cloud-connecting-to-managed-instances">Connecting to managed instances</h1>
<p>This section describes the connector configuration to use managed
RabbitMQ instances (hosted on the Cloud).</p>
<h2 id="rabbitmq-rabbitmq-cloud-cloud-amqp">Cloud AMQP</h2>
<p>To connect to an instance of RabbitMQ hosted on <a href="https://www.cloudamqp.com/">Cloud
AMQP</a>, use the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">rabbitmq-host</span><span class="o">=</span><span class="s">host-name</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">rabbitmq-port</span><span class="o">=</span><span class="s">5671</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">rabbitmq-username</span><span class="o">=</span><span class="s">user-name</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">rabbitmq-password</span><span class="o">=</span><span class="s">password</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">rabbitmq-virtual-host</span><span class="o">=</span><span class="s">user-name</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">rabbitmq-ssl</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<p>You can extract the values from the <code>AMQPS</code> url displayed on the
administration portal:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>amqps://user-name:password@host/user-name
</code></pre></div></td></tr></table></div>
<h2 id="rabbitmq-rabbitmq-cloud-amazon-mq">Amazon MQ</h2>
<p><a href="https://aws.amazon.com/amazon-mq/">Amazon MQ</a> can host RabbitMQ brokers
(as well as AMQP 1.0 brokers). To connect to a RabbitMQ instance hosted
on Amazon MQ, use the following configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#rabbitmq-rabbitmq-cloud-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">rabbitmq-host</span><span class="o">=</span><span class="s">host-name</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">rabbitmq-port</span><span class="o">=</span><span class="s">5671</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="na">rabbitmq-username</span><span class="o">=</span><span class="s">user-name</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="na">rabbitmq-password</span><span class="o">=</span><span class="s">password</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">rabbitmq-ssl</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<p>You can extract the host value from the <code>AMQPS</code> url displayed on the
administration console:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span></pre></div></td><td class="code"><div><pre><span></span><code>amqps://foobarbaz.mq.us-east-2.amazonaws.com:5671
</code></pre></div></td></tr></table></div>
<p>The username and password are configured during the broker creation.</p></section><h1 class='nav-section-title-end'>Ended: RabbitMQ</h1>
                        <h1 class='nav-section-title' id='section-pulsar'>
                            Pulsar <a class='headerlink' href='#section-pulsar' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="pulsar-pulsar"><h1 id="pulsar-pulsar-apache-pulsar-connector">Apache Pulsar Connector</h1>
<p>The Pulsar connector adds support for Apache Pulsar to Reactive Messaging. With
it you can consume Pulsar Messages as well as produce <em>message</em> into Pulsar.</p>
<p><a href="https://pulsar.apache.org/">Apache Pulsar</a> an open-source, distributed messaging
and streaming platform built for the cloud. For more details about Pulsar, check the
<a href="https://pulsar.apache.org/docs/next/concepts-overview/">documentation</a>.</p>
<p>Pulsar implements the publish-subscribe pattern.
Producers publish <em>messages</em> to <em>topic</em>s.
Consumers create <em>subscription</em>s to those topics to receive and process incoming messages,
and send <em>acknowledgments</em> to the broker when processing is finished.</p>
<p>When a <em>subscription</em> is created, Pulsar retains all messages, even if the consumer is disconnected.
The retained messages are discarded only when a consumer acknowledges that all these messages are processed successfully.</p>
<p>A Pulsar <em>message</em> consists of</p>
<ul>
<li><strong>value</strong>, payload data that message contains, while Pulsar messages contain payloads as unstructured byte array,
a <strong>schema</strong> is applied to write and read with an enforced data structure</li>
<li><strong>key</strong> of type string, used for partitioning</li>
<li><strong>properties</strong>, optional key/value map</li>
<li><strong>topic</strong>, the topic that the message is published to</li>
<li><strong>producer name</strong>, the name of the producer who produces the message</li>
<li><strong>message ID</strong>, the ID assigned by bookies to a message as soon as the message is persistently stored</li>
<li><strong>sequence ID</strong>, the ID assigned by producers, indicating its order in that sequence</li>
<li><strong>publish time</strong>, timestamp automatically added by the producer</li>
<li><strong>event time</strong>, optional timestamp added by the application</li>
</ul>
<p>A Pulsar cluster consists of
- One or more <strong>broker</strong>s, which are stateless components
- A <strong>metadata store</strong> for maintaining topic metadata, schema, coordination and cluster configuration.
By default, a Zookeeper cluster is used, except the standalone mode
- A ensemble of <strong>bookies</strong> used for persistent storage of messages</p>
<h2 id="pulsar-pulsar-using-the-pulsar-connector">Using the Pulsar Connector</h2>
<p>To use the Pulsar Connector, add the following dependency to your
project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-pulsar-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-pulsar<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-pulsar</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-pulsar-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#pulsar-pulsar-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="pulsar-receiving-pulsar-messages"><h1 id="pulsar-receiving-pulsar-messages-receiving-messages-from-pulsar">Receiving messages from Pulsar</h1>
<p>The Pulsar Connector connects to a Pulsar broker using a Pulsar client and creates consumers to
receive messages from Pulsar brokers and it maps each of them into Reactive Messaging <code>Messages</code>.</p>
<h2 id="pulsar-receiving-pulsar-messages-example">Example</h2>
<p>Letâ€™s imagine you have a Pulsar broker running, and accessible
using the <code>pulsar:6650</code> address (by default it would use
<code>localhost:6650</code>). Configure your application to receive Pulsar messages
on the <code>prices</code> channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-pulsar # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.prices.serviceUrl</span><span class="o">=</span><span class="s">pulsar://pulsar:6650 # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.prices.schema</span><span class="o">=</span><span class="s">DOUBLE # &lt;3&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.prices.subscriptionInitialPosition</span><span class="o">=</span><span class="s">Earliest # &lt;4&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Sets the connector for the <code>prices</code> channel</li>
<li>Configure the Pulsar broker service url.</li>
<li>Configure the schema to consume prices as Double.</li>
<li>Make sure consumer subscription starts receiving messages from the <code>Earliest</code> position.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the Pulsar topic, nor the consumer name.
By default, the connector uses the channel name (<code>prices</code>).
You can configure the <code>topic</code> and <code>consumerName</code> attributes to override them.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In Pulsar, consumers need to provide a <code>subscriptionName</code> for topic subscriptions.
If not provided the connector is generating a unique <strong>subscription name</strong>.</p>
</div>
<p>Then, your application can receive the <code>double</code> payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-receiving-pulsar-messages-consumer-configuration">Consumer Configuration</h2>
<p>The Pulsar Connector allows flexibly configuring the underlying Pulsar consumer.
One of the ways is to set consumer properties directly on the channel configuration.
The list of available configuration properties are listed in <a href="#pulsar-receiving-pulsar-messages-configuration-reference">Configuration Reference</a>.</p>
<p>See the <a href="#pulsar-client-configuration">Configuring Pulsar consumers, producers and clients</a> for more information.</p>
<h2 id="pulsar-receiving-pulsar-messages-deserialization-and-pulsar-schema">Deserialization and Pulsar Schema</h2>
<p>The Pulsar Connector allows configuring Schema configuration for the underlying Pulsar consumer.
See the <a href="#pulsar-schema-configuration">Configuring the schema used for Pulsar channels</a> for more information.</p>
<h2 id="pulsar-receiving-pulsar-messages-inbound-metadata">Inbound Metadata</h2>
<p>The incoming Pulsar messages include an instance of <code>PulsarIncomingMessageMetadata</code> in the metadata.
It provides the key, topic, partitions, headers and so on:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-3-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">PulsarIncomingMessageMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">PulsarIncomingMessageMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metadata</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="c1">// The topic</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTopicName</span><span class="p">();</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="c1">// The key</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="c1">// The event time</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getEventTime</span><span class="p">();</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="c1">// The raw data</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">rawData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getData</span><span class="p">();</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">    </span><span class="c1">// The underlying message</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">    </span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">pulsar</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">api</span><span class="p">.</span><span class="na">Message</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getMessage</span><span class="p">();</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-receiving-pulsar-messages-acknowledgement">Acknowledgement</h2>
<p>When a message produced from a Pulsar Message is <em>acknowledged</em>, the connector sends an <a href="https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#acknowledgment">acknowledgement request</a> to the Pulsar broker.
All Reactive Messaging messages need to be <em>acknowledged</em>, which is handled automatically in most cases.
Acknowledgement requests can be sent to the Pulsar broker using the following two strategies:</p>
<ul>
<li><strong>Individual acknowledgement</strong> is the default strategy, an acknowledgement request is to the broker for each message.</li>
<li><strong>Cumulative acknowledgement</strong>, configured using <code>ack-strategy=cumulative</code>, the consumer only acknowledges the last message it received.
All messages in the stream up to (and including) the provided message are not redelivered to that consumer.</li>
</ul>
<h2 id="pulsar-receiving-pulsar-messages-failure-management">Failure Management</h2>
<p>If a message produced from a Pulsar message is <em>nacked</em>, a failure strategy is applied.
The Pulsar connector supports 4 strategies:</p>
<ul>
<li><code>nack</code> <em>(default)</em> sends <a href="https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#negative-acknowledgment">negative acknowledgment</a> to the broker, triggering the broker to redeliver this message to the consumer.
The negative acknowledgment can be further configured using <code>negativeAckRedeliveryDelayMicros</code> and <code>negativeAck.redeliveryBackoff</code> properties.</li>
<li><code>fail</code> fail the application, no more messages will be processed.</li>
<li><code>ignore</code> the failure is logged, but the acknowledgement strategy will be applied and the processing will continue.</li>
<li><code>continue</code> the failure is logged, but processing continues without applying acknowledgement or negative acknowledgement. This strategy can be used with <a href="#pulsar-receiving-pulsar-messages-acknowledgement-timeout">acknowledgement timeout</a> configuration.</li>
<li><code>reconsume-later</code> sends the message to the <a href="https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#retry-letter-topic">retry letter topic</a> using the <code>reconsumeLater</code> API to be reconsumed with a delay.
The delay can be configured using the <code>reconsumeLater.delay</code> property and defaults to 3 seconds.
Custom delay or properties per message can be configured by adding an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-api/4.16.0/io/smallrye/reactive/messaging/pulsar/PulsarReconsumeLaterMetadata.html'>PulsarReconsumeLaterMetadata</a> to the failure metadata.</li>
</ul>
<p>For example the following configuration for the incoming channel <code>data</code> uses <code>reconsumer-later</code> failure strategy with default delays of 60 seconds:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="na">mp.messaging.incoming.data.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="na">mp.messaging.incoming.data.serviceUrl</span><span class="o">=</span><span class="s">pulsar://localhost:6650</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="na">mp.messaging.incoming.data.topic</span><span class="o">=</span><span class="s">data</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="na">mp.messaging.incoming.data.schema</span><span class="o">=</span><span class="s">INT32</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="na">mp.messaging.incoming.data.failure-strategy</span><span class="o">=</span><span class="s">reconsume-later</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="na">mp.messaging.incoming.data.retryEnable</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="na">mp.messaging.incoming.data.reconsumeLater.delay</span><span class="o">=</span><span class="s">60 // in seconds</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="na">mp.messaging.incoming.data.deadLetterPolicy.retryLetterTopic</span><span class="o">=</span><span class="s">data-retry</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="na">mp.messaging.incoming.data.deadLetterPolicy.maxRedeliverCount</span><span class="o">=</span><span class="s">2</span>
</code></pre></div></td></tr></table></div>
<h3 id="pulsar-receiving-pulsar-messages-acknowledgement-timeout">Acknowledgement timeout</h3>
<p>Similar to the negative acknowledgement, with the <a href="https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#acknowledgment-timeout">acknowledgment timeout</a> mechanism, the Pulsar client tracks the unacknowledged messages,
for the given <em>ackTimeout</em> period and sends <em>redeliver unacknowledged messages request</em> to the broker, thus the broker resends the unacknowledged messages to the consumer.</p>
<p>To configure the timeout and redelivery backoff mechanism you can set <code>ackTimeoutMillis</code> and <code>ackTimeout.redeliveryBackoff</code> properties.
The <code>ackTimeout.redeliveryBackoff</code> value accepts comma separated values of min delay in milliseconds, max delay in milliseconds and multiplier respectively:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="na">mp.messaging.incoming.data.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="na">mp.messaging.incoming.data.failure-strategy</span><span class="o">=</span><span class="s">continue</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="na">mp.messaging.incoming.data.ackTimeoutMillis</span><span class="o">=</span><span class="s">10000</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="na">mp.messaging.incoming.data.ackTimeout.redeliveryBackoff</span><span class="o">=</span><span class="s">1000,60000,2</span>
</code></pre></div></td></tr></table></div>
<h3 id="pulsar-receiving-pulsar-messages-dead-letter-topic">Dead-letter topic</h3>
<p>The <a href="https://pulsar.apache.org/docs/3.0.x/concepts-messaging/#dead-letter-topic">dead letter topic</a> pushes messages that are not consumed successfully to a dead letter topic an continue message consumption.
Note that dead letter topic can be used in different message redelivery methods, such as acknowledgment timeout, negative acknowledgment or retry letter topic.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-1">1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-2">2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-3">3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-4">4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-5">5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="na">mp.messaging.incoming.data.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="na">mp.messaging.incoming.data.failure-strategy</span><span class="o">=</span><span class="s">nack</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="na">mp.messaging.incoming.data.deadLetterPolicy.maxRedeliverCount</span><span class="o">=</span><span class="s">2</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="na">mp.messaging.incoming.data.deadLetterPolicy.deadLetterTopic</span><span class="o">=</span><span class="s">my-dead-letter-topic</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="na">mp.messaging.incoming.data.deadLetterPolicy.initialSubscriptionName</span><span class="o">=</span><span class="s">my-dlq-subscription</span>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="na">mp.messaging.incoming.data.subscriptionType</span><span class="o">=</span><span class="s">Shared</span>
</code></pre></div></td></tr></table></div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p><em>Negative acknowledgment</em> or <em>acknowledgment timeout</em> methods for redelivery will redeliver the whole batch of messages containing at least an unprocessed message.
See <a href="#pulsar-sending-messages-to-pulsar-producer-batching">producer batching</a> for more information.</p>
</div>
<h2 id="pulsar-receiving-pulsar-messages-receiving-pulsar-messages-in-batches">Receiving Pulsar Messages in Batches</h2>
<p>By default, incoming methods receive each Pulsar message individually.
You can enable batch mode using <code>batchReceive=true</code> property, or setting a <code>batchReceivePolicy</code> in consumer configuration.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-10">10</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-11">11</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-12">12</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-13">13</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-14">14</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-15">15</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-16">16</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-17">17</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-18">18</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-19">19</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-7-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumeMessage</span><span class="p">(</span><span class="n">PulsarIncomingBatchMessage</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PulsarMessage</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">PulsarIncomingMessageMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">metadata</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTopicName</span><span class="p">();</span>
<a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getEventTime</span><span class="p">();</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">            </span><span class="c1">//... process messages</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="c1">// ack will commit the latest offsets (per partition) of the batch.</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">messages</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumeRecords</span><span class="p">(</span><span class="n">Messages</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">messages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">        </span><span class="c1">//... process messages</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or you can directly receive the list of payloads to the consume method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-1">1</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-2">2</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-3">3</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-4">4</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-5">5</a></span>
<span class="normal"><a href="#pulsar-receiving-pulsar-messages-__codelineno-8-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">        </span><span class="c1">// process price</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-receiving-pulsar-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>ack-strategy</em></td>
<td style="text-align: left;">Specify the commit strategy to apply when a message produced from a record is acknowledged. Values can be <code>ack</code>, <code>cumulative</code>.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>ack</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ackTimeout.redeliveryBackoff</em></td>
<td style="text-align: left;">Comma separated values for configuring ack timeout MultiplierRedeliveryBackoff, min delay, max delay, multiplier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>batchReceive</em></td>
<td style="text-align: left;">Whether batch receive is used to consume messages</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Pulsar client configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>consumer-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Pulsar consumer configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>deadLetterPolicy.deadLetterTopic</em></td>
<td style="text-align: left;">Name of the dead letter topic where the failing messages will be sent</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>deadLetterPolicy.initialSubscriptionName</em></td>
<td style="text-align: left;">Name of the initial subscription name of the dead letter topic</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>deadLetterPolicy.maxRedeliverCount</em></td>
<td style="text-align: left;">Maximum number of times that a message will be redelivered before being sent to the dead letter topic</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>deadLetterPolicy.retryLetterTopic</em></td>
<td style="text-align: left;">Name of the retry topic where the failing messages will be sent</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from a record is acknowledged negatively (nack). Values can be <code>nack</code> (default), <code>fail</code>, <code>ignore</code> or <code>reconsume-later | string | false |</code>nack`</td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>negativeAck.redeliveryBackoff</em></td>
<td style="text-align: left;">Comma separated values for configuring negative ack MultiplierRedeliveryBackoff, min delay, max delay, multiplier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconsumeLater.delay</em></td>
<td style="text-align: left;">Default delay for reconsume failure-strategy, in seconds</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>3</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>schema</em></td>
<td style="text-align: left;">The Pulsar schema type of this channel. When configured a schema is built with the given SchemaType and used for the channel. When absent, the schema is resolved searching for a CDI bean typed <code>Schema</code> qualified with <code>@Identifier</code> and the channel name. As a fallback AUTO_CONSUME or AUTO_PRODUCE are used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>serviceUrl</em></td>
<td style="text-align: left;">The service URL for the Pulsar service</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pulsar://localhost:6650</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">The consumed / populated Pulsar topic. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
</tbody>
</table>
<p>In addition to the configuration properties provided by the connector,
following Pulsar consumer properties can also be set on the channel:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Config file</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>topicNames</em></td>
<td style="text-align: left;">Topic name</td>
<td style="text-align: center;">Set</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">[]</td>
</tr>
<tr>
<td style="text-align: left;"><em>topicsPattern</em></td>
<td style="text-align: left;">Topic pattern</td>
<td style="text-align: center;">Pattern</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>subscriptionName</em></td>
<td style="text-align: left;">Subscription name</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>subscriptionType</em></td>
<td style="text-align: left;">Subscription type.<br>Four subscription types are available:<br>* Exclusive<br>* Failover<br>* Shared<br>* Key_Shared</td>
<td style="text-align: center;">SubscriptionType</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">Exclusive</td>
</tr>
<tr>
<td style="text-align: left;"><em>subscriptionProperties</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Map</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>subscriptionMode</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">SubscriptionMode</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">Durable</td>
</tr>
<tr>
<td style="text-align: left;"><em>messageListener</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">MessageListener</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>consumerEventListener</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">ConsumerEventListener</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>negativeAckRedeliveryBackoff</em></td>
<td style="text-align: left;">Interface for custom message is negativeAcked policy. You can specify <code>RedeliveryBackoff</code> for a consumer.</td>
<td style="text-align: center;">RedeliveryBackoff</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ackTimeoutRedeliveryBackoff</em></td>
<td style="text-align: left;">Interface for custom message is ackTimeout policy. You can specify <code>RedeliveryBackoff</code> for a consumer.</td>
<td style="text-align: center;">RedeliveryBackoff</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>receiverQueueSize</em></td>
<td style="text-align: left;">Size of a consumer's receiver queue.<br><br>For example, the number of messages accumulated by a consumer before an application calls <code>Receive</code>.<br><br>A value higher than the default value increases consumer throughput, though at the expense of more memory utilization.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1000</td>
</tr>
<tr>
<td style="text-align: left;"><em>acknowledgementsGroupTimeMicros</em></td>
<td style="text-align: left;">Group a consumer acknowledgment for a specified time.<br><br>By default, a consumer uses 100ms grouping time to send out acknowledgments to a broker.<br><br>Setting a group time of 0 sends out acknowledgments immediately.<br><br>A longer ack group time is more efficient at the expense of a slight increase in message re-deliveries after a failure.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">100000</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxAcknowledgmentGroupSize</em></td>
<td style="text-align: left;">Group a consumer acknowledgment for the number of messages.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1000</td>
</tr>
<tr>
<td style="text-align: left;"><em>negativeAckRedeliveryDelayMicros</em></td>
<td style="text-align: left;">Delay to wait before redelivering messages that failed to be processed.<br><br>When an application uses <code>Consumer#negativeAcknowledge(Message)</code>, failed messages are redelivered after a fixed timeout.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60000000</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxTotalReceiverQueueSizeAcrossPartitions</em></td>
<td style="text-align: left;">The max total receiver queue size across partitions.<br><br>This setting reduces the receiver queue size for individual partitions if the total receiver queue size exceeds this value.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">50000</td>
</tr>
<tr>
<td style="text-align: left;"><em>consumerName</em></td>
<td style="text-align: left;">Consumer name</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ackTimeoutMillis</em></td>
<td style="text-align: left;">Timeout of unacked messages</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;"><em>tickDurationMillis</em></td>
<td style="text-align: left;">Granularity of the ack-timeout redelivery.<br><br>Using an higher <code>tickDurationMillis</code> reduces the memory overhead to track messages when setting ack-timeout to a bigger value (for example, 1 hour).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1000</td>
</tr>
<tr>
<td style="text-align: left;"><em>priorityLevel</em></td>
<td style="text-align: left;">Priority level for a consumer to which a broker gives more priority while dispatching messages in Shared subscription type.<br><br>The broker follows descending priorities. For example, 0=max-priority, 1, 2,...<br><br>In Shared subscription type, the broker <strong>first dispatches messages to the max priority level consumers if they have permits</strong>. Otherwise, the broker considers next priority level consumers.<br><br><strong>Example 1</strong><br>If a subscription has consumerA with <code>priorityLevel</code> 0 and consumerB with <code>priorityLevel</code> 1, then the broker <strong>only dispatches messages to consumerA until it runs out permits</strong> and then starts dispatching messages to consumerB.<br><br><strong>Example 2</strong><br>Consumer Priority, Level, Permits<br>C1, 0, 2<br>C2, 0, 1<br>C3, 0, 1<br>C4, 1, 2<br>C5, 1, 1<br><br>Order in which a broker dispatches messages to consumers is: C1, C2, C3, C1, C4, C5, C4.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxPendingChunkedMessage</em></td>
<td style="text-align: left;">The maximum size of a queue holding pending chunked messages. When the threshold is reached, the consumer drops pending messages to optimize memory utilization.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">10</td>
</tr>
<tr>
<td style="text-align: left;"><em>autoAckOldestChunkedMessageOnQueueFull</em></td>
<td style="text-align: left;">Whether to automatically acknowledge pending chunked messages when the threshold of <code>maxPendingChunkedMessage</code> is reached. If set to <code>false</code>, these messages will be redelivered by their broker.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>expireTimeOfIncompleteChunkedMessageMillis</em></td>
<td style="text-align: left;">The time interval to expire incomplete chunks if a consumer fails to receive all the chunks in the specified time period. The default value is 1 minute.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60000</td>
</tr>
<tr>
<td style="text-align: left;"><em>cryptoKeyReader</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">CryptoKeyReader</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>messageCrypto</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">MessageCrypto</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cryptoFailureAction</em></td>
<td style="text-align: left;">Consumer should take action when it receives a message that can not be decrypted.<br>* <strong>FAIL</strong>: this is the default option to fail messages until crypto succeeds.<br>* <strong>DISCARD</strong>:silently acknowledge and not deliver message to an application.<br>* <strong>CONSUME</strong>: deliver encrypted messages to applications. It is the application's responsibility to decrypt the message.<br><br>The decompression of message fails.<br><br>If messages contain batch messages, a client is not be able to retrieve individual messages in batch.<br><br>Delivered encrypted message contains <code>EncryptionContext</code> which contains encryption and compression information in it using which application can decrypt consumed message payload.</td>
<td style="text-align: center;">ConsumerCryptoFailureAction</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">FAIL</td>
</tr>
<tr>
<td style="text-align: left;"><em>properties</em></td>
<td style="text-align: left;">A name or value property of this consumer.<br><br><code>properties</code> is application defined metadata attached to a consumer.<br><br>When getting a topic stats, associate this metadata with the consumer stats for easier identification.</td>
<td style="text-align: center;">SortedMap</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">{}</td>
</tr>
<tr>
<td style="text-align: left;"><em>readCompacted</em></td>
<td style="text-align: left;">If enabling <code>readCompacted</code>, a consumer reads messages from a compacted topic rather than reading a full message backlog of a topic.<br><br>A consumer only sees the latest value for each key in the compacted topic, up until reaching the point in the topic message when compacting backlog. Beyond that point, send messages as normal.<br><br>Only enabling <code>readCompacted</code> on subscriptions to persistent topics, which have a single active consumer (like failure or exclusive subscriptions).<br><br>Attempting to enable it on subscriptions to non-persistent topics or on shared subscriptions leads to a subscription call throwing a <code>PulsarClientException</code>.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>subscriptionInitialPosition</em></td>
<td style="text-align: left;">Initial position at which to set cursor when subscribing to a topic at first time.</td>
<td style="text-align: center;">SubscriptionInitialPosition</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">Latest</td>
</tr>
<tr>
<td style="text-align: left;"><em>patternAutoDiscoveryPeriod</em></td>
<td style="text-align: left;">Topic auto discovery period when using a pattern for topic's consumer.<br><br>The default and minimum value is 1 minute.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60</td>
</tr>
<tr>
<td style="text-align: left;"><em>regexSubscriptionMode</em></td>
<td style="text-align: left;">When subscribing to a topic using a regular expression, you can pick a certain type of topics.<br><br>* <strong>PersistentOnly</strong>: only subscribe to persistent topics.<br>* <strong>NonPersistentOnly</strong>: only subscribe to non-persistent topics.<br>* <strong>AllTopics</strong>: subscribe to both persistent and non-persistent topics.</td>
<td style="text-align: center;">RegexSubscriptionMode</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">PersistentOnly</td>
</tr>
<tr>
<td style="text-align: left;"><em>deadLetterPolicy</em></td>
<td style="text-align: left;">Dead letter policy for consumers.<br><br>By default, some messages are probably redelivered many times, even to the extent that it never stops.<br><br>By using the dead letter mechanism, messages have the max redelivery count. <strong>When exceeding the maximum number of redeliveries, messages are sent to the Dead Letter Topic and acknowledged automatically</strong>.<br><br>You can enable the dead letter mechanism by setting <code>deadLetterPolicy</code>.<br><br><strong>Example</strong><br><code><br>client.newConsumer()<br>.deadLetterPolicy(DeadLetterPolicy.builder().maxRedeliverCount(10).build())<br>.subscribe();<br></code><br>Default dead letter topic name is <code>{TopicName}-{Subscription}-DLQ</code>.<br><br>To set a custom dead letter topic name:<br><code><br>client.newConsumer()<br>.deadLetterPolicy(DeadLetterPolicy.builder().maxRedeliverCount(10)<br>.deadLetterTopic("your-topic-name").build())<br>.subscribe();<br></code><br>When specifying the dead letter policy while not specifying <code>ackTimeoutMillis</code>, you can set the ack timeout to 30000 millisecond.</td>
<td style="text-align: center;">DeadLetterPolicy</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>retryEnable</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>batchReceivePolicy</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">BatchReceivePolicy</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>autoUpdatePartitions</em></td>
<td style="text-align: left;">If <code>autoUpdatePartitions</code> is enabled, a consumer subscribes to partition increasement automatically.<br><br><strong>Note</strong>: this is only for partitioned consumers.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">true</td>
</tr>
<tr>
<td style="text-align: left;"><em>autoUpdatePartitionsIntervalSeconds</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60</td>
</tr>
<tr>
<td style="text-align: left;"><em>replicateSubscriptionState</em></td>
<td style="text-align: left;">If <code>replicateSubscriptionState</code> is enabled, a subscription state is replicated to geo-replicated clusters.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>resetIncludeHead</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>keySharedPolicy</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">KeySharedPolicy</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>batchIndexAckEnabled</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>ackReceiptEnabled</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>poolMessages</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>payloadProcessor</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">MessagePayloadProcessor</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>startPaused</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>autoScaledReceiverQueueSizeEnabled</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>topicConfigurations</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">List</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">[]</td>
</tr>
</tbody>
</table></section><section class="print-page" id="pulsar-sending-messages-to-pulsar"><h1 id="pulsar-sending-messages-to-pulsar-sending-messages-to-pulsar">Sending messages to Pulsar</h1>
<p>The Pulsar Connector can write Reactive Messaging <code>Message</code>s as Pulsar Message.</p>
<h2 id="pulsar-sending-messages-to-pulsar-example">Example</h2>
<p>Letâ€™s imagine you have a Pulsar broker running, and accessible
using the <code>pulsar:6650</code> address (by default it would use
<code>localhost:1883</code>). Configure your application to write the messages from
the <code>prices</code> channel into a Pulsar Messages as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.outgoing.prices.connector</span><span class="o">=</span><span class="s">smallrye-pulsar # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.outgoing.prices.serviceUrl</span><span class="o">=</span><span class="s">pulsar://pulsar:6650 # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.outgoing.prices.schema</span><span class="o">=</span><span class="s">DOUBLE # &lt;3&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Sets the connector for the <code>prices</code> channel</li>
<li>Configure the Pulsar broker service url.</li>
<li>Configure the schema to consume prices as Double.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the Pulsar topic, nor the producer name.
By default, the connector uses the channel name (<code>prices</code>).
You can configure the <code>topic</code> and <code>producerName</code> attributes to override them.</p>
</div>
<p>Then, your application must send <code>Message&lt;Double&gt;</code> to the <code>prices</code>
channel. It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()));</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-sending-messages-to-pulsar-producer-configuration">Producer Configuration</h2>
<p>The Pulsar Connector allows flexibly configuring the underlying Pulsar producer.
One of the ways is to set producer properties directly on the channel configuration.
The list of available configuration properties are listed in <a href="#pulsar-sending-messages-to-pulsar-configuration-reference">Configuration Reference</a>.</p>
<p>See the <a href="#pulsar-client-configuration">Configuring Pulsar consumers, producers and clients</a> for more information.</p>
<h2 id="pulsar-sending-messages-to-pulsar-serialization-and-pulsar-schema">Serialization and Pulsar Schema</h2>
<p>The Pulsar Connector allows configuring Schema configuration for the underlying Pulsar producer.
See the <a href="#pulsar-schema-configuration">Configuring the schema used for Pulsar channels</a> for more information.</p>
<h2 id="pulsar-sending-messages-to-pulsar-sending-keyvalue-pairs">Sending key/value pairs</h2>
<p>In order to send Kev/Value pairs to Pulsar, you can configure the Pulsar producer Schema with a
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/org.apache.pulsar/pulsar-client-api/4.16.0/org/apache/pulsar/common/schema/KeyValue.html'>org.apache.pulsar.common.schema.KeyValue</a> type:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-6">6</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-7">7</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-8">8</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-3-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nd">@Produces</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="n">Schema</span><span class="o">&lt;</span><span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">KeyValue</span><span class="p">(</span><span class="n">Schema</span><span class="p">.</span><span class="na">STRING</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">INT64</span><span class="p">);</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kd">public</span><span class="w"> </span><span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KeyValue</span><span class="o">&lt;&gt;</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">in</span><span class="p">);</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If you need more control on the written records, use
<code>PulsarOutgoingMessageMetadata</code>.</p>
<h2 id="pulsar-sending-messages-to-pulsar-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Message</code>s, you can add an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-pulsar/4.16.0/io/smallrye/reactive/messaging/pulsar/PulsarOutgoingMessageMetadata.html'>PulsarOutgoingMessageMetadata</a>
to influence how the message is going to be written to Pulsar.
For example, configure the record key, and set message properties:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-4-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// Creates an PulsarOutgoingMessageMetadata</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="c1">// The type parameter is the type of the record&#39;s key</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="n">PulsarOutgoingMessageMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PulsarOutgoingMessageMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">        </span><span class="p">.</span><span class="na">withKey</span><span class="p">(</span><span class="s">&quot;my-key&quot;</span><span class="p">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">        </span><span class="p">.</span><span class="na">withProperties</span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;property-key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value&quot;</span><span class="p">))</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-sending-messages-to-pulsar-outgoingmessage">OutgoingMessage</h2>
<p>Using <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-pulsar/4.16.0/io/smallrye/reactive/messaging/pulsar/OutgoingMessage.html'>OutgoingMessage</a>,
is an easy way of customizing the Pulsar message to be published when dealing with payloads and not <code>Message</code>s.</p>
<p>You can create an <code>OutgoingMessage</code> with key and value, or from an incoming Pulsar Message:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#pulsar-sending-messages-to-pulsar-__codelineno-5-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;out&quot;</span><span class="p">)</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="n">OutgoingMessage</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">pulsar</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">api</span><span class="p">.</span><span class="na">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">OutgoingMessage</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">            </span><span class="p">.</span><span class="na">withValue</span><span class="p">(</span><span class="n">Long</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">in</span><span class="p">.</span><span class="na">getValue</span><span class="p">()));</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="pulsar-sending-messages-to-pulsar-acknowledgement">Acknowledgement</h2>
<p>Upon receiving a message from a Producer, a Pulsar broker assigns a <code>MessageId</code> to the message and sends it back to the producer,
confirming that the message is published.</p>
<p>By default, the connector does wait for Pulsar to acknowledge the record
to continue the processing (acknowledging the received <code>Message</code>).
You can disable this by setting the <code>waitForWriteCompletion</code> attribute to <code>false</code>.</p>
<p>If a record cannot be written, the message is <code>nacked</code>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Pulsar client automatically retries sending messages in case of failure, until the <em>send timeout</em> is reached.
The <em>send timeout</em> is configurable with <code>sendTimeoutMs</code> attribute and by default is is 30 seconds.</p>
</div>
<h2 id="pulsar-sending-messages-to-pulsar-back-pressure-and-inflight-records">Back-pressure and inflight records</h2>
<p>The Pulsar outbound connector handles back-pressure monitoring the number
of pending messages waiting to be written to the Pulsar broker.
The number of pending messages is configured using the
<code>maxPendingMessages</code> attribute and defaults to 1000.</p>
<p>The connector only sends that amount of messages concurrently. No other
messages will be sent until at least one pending message gets
acknowledged by the broker. Then, the connector writes a new message to
Pulsar when one of the brokerâ€™s pending messages get acknowledged.</p>
<p>You can also remove the limit of pending messages by setting <code>maxPendingMessages</code> to <code>0</code>.
Note that Pulsar also enables to configure the number of pending messages per partition using <code>maxPendingMessagesAcrossPartitions</code>.</p>
<h2 id="pulsar-sending-messages-to-pulsar-producer-batching">Producer Batching</h2>
<p>By default, the Pulsar producer batches individual messages together to be published to the broker.
You can configure batching parameters using <code>batchingMaxPublishDelayMicros</code>, <code>batchingPartitionSwitchFrequencyByPublishDelay</code>,
<code>batchingMaxMessages</code>, <code>batchingMaxBytes</code> configuration properties, or disable it completely with <code>batchingEnabled=false</code>.</p>
<p>When using <code>Key_Shared</code> consumer subscriptions, the <code>batcherBuilder</code> can be configured to <code>BatcherBuilder.KEY_BASED</code>.</p>
<h2 id="pulsar-sending-messages-to-pulsar-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>client-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Pulsar client configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>maxPendingMessages</em></td>
<td style="text-align: left;">The maximum size of a queue holding pending messages, i.e messages waiting to receive an acknowledgment from a broker</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>producer-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Pulsar producer configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>schema</em></td>
<td style="text-align: left;">The Pulsar schema type of this channel. When configured a schema is built with the given SchemaType and used for the channel. When absent, the schema is resolved searching for a CDI bean typed <code>Schema</code> qualified with <code>@Identifier</code> and the channel name. As a fallback AUTO_CONSUME or AUTO_PRODUCE are used.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>serviceUrl</em></td>
<td style="text-align: left;">The service URL for the Pulsar service</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pulsar://localhost:6650</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">The consumed / populated Pulsar topic. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>waitForWriteCompletion</em></td>
<td style="text-align: left;">Whether the client waits for the broker to acknowledge the written record before acknowledging the message</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
</tbody>
</table>
<p>In addition to the configuration properties provided by the connector,
following Pulsar producer properties can also be set on the channel:</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Config file</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>topicName</em></td>
<td style="text-align: left;">Topic name</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>producerName</em></td>
<td style="text-align: left;">Producer name</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>sendTimeoutMs</em></td>
<td style="text-align: left;">Message send timeout in ms.<br>If a message is not acknowledged by a server before the <code>sendTimeout</code> expires, an error occurs.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">30000</td>
</tr>
<tr>
<td style="text-align: left;"><em>blockIfQueueFull</em></td>
<td style="text-align: left;">If it is set to <code>true</code>, when the outgoing message queue is full, the <code>Send</code> and <code>SendAsync</code> methods of producer block, rather than failing and throwing errors.<br>If it is set to <code>false</code>, when the outgoing message queue is full, the <code>Send</code> and <code>SendAsync</code> methods of producer fail and <code>ProducerQueueIsFullError</code> exceptions occur.<br><br>The <code>MaxPendingMessages</code> parameter determines the size of the outgoing message queue.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxPendingMessages</em></td>
<td style="text-align: left;">The maximum size of a queue holding pending messages.<br><br>For example, a message waiting to receive an acknowledgment from a <a href="https://pulsar.apache.org/docs/reference-terminology#broker">broker</a>.<br><br>By default, when the queue is full, all calls to the <code>Send</code> and <code>SendAsync</code> methods fail <strong>unless</strong> you set <code>BlockIfQueueFull</code> to <code>true</code>.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxPendingMessagesAcrossPartitions</em></td>
<td style="text-align: left;">The maximum number of pending messages across partitions.<br><br>Use the setting to lower the max pending messages for each partition (<code>#setMaxPendingMessages(int)</code>) if the total number exceeds the configured value.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;"><em>messageRoutingMode</em></td>
<td style="text-align: left;">Message routing logic for producers on <a href="https://pulsar.apache.org/docs/concepts-architecture-overview#partitioned-topics">partitioned topics</a>.<br>Apply the logic only when setting no key on messages.<br>Available options are as follows:<br>* <code>pulsar.RoundRobinDistribution</code>: round robin<br>* <code>pulsar.UseSinglePartition</code>: publish all messages to a single partition<br>* <code>pulsar.CustomPartition</code>: a custom partitioning scheme</td>
<td style="text-align: center;">MessageRoutingMode</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>hashingScheme</em></td>
<td style="text-align: left;">Hashing function determining the partition where you publish a particular message (partitioned topics only).<br>Available options are as follows:<br>* <code>pulsar.JavastringHash</code>: the equivalent of <code>string.hashCode()</code> in Java<br>* <code>pulsar.Murmur3_32Hash</code>: applies the <a href="https://en.wikipedia.org/wiki/MurmurHash">Murmur3</a> hashing function<br>* <code>pulsar.BoostHash</code>: applies the hashing function from C++'s<a href="https://www.boost.org/doc/libs/1_62_0/doc/html/hash.html">Boost</a> library</td>
<td style="text-align: center;">HashingScheme</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">JavaStringHash</td>
</tr>
<tr>
<td style="text-align: left;"><em>cryptoFailureAction</em></td>
<td style="text-align: left;">Producer should take action when encryption fails.<br>* <strong>FAIL</strong>: if encryption fails, unencrypted messages fail to send.<br>* <strong>SEND</strong>: if encryption fails, unencrypted messages are sent.</td>
<td style="text-align: center;">ProducerCryptoFailureAction</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">FAIL</td>
</tr>
<tr>
<td style="text-align: left;"><em>customMessageRouter</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">MessageRouter</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>batchingMaxPublishDelayMicros</em></td>
<td style="text-align: left;">Batching time period of sending messages.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1000</td>
</tr>
<tr>
<td style="text-align: left;"><em>batchingPartitionSwitchFrequencyByPublishDelay</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">10</td>
</tr>
<tr>
<td style="text-align: left;"><em>batchingMaxMessages</em></td>
<td style="text-align: left;">The maximum number of messages permitted in a batch.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1000</td>
</tr>
<tr>
<td style="text-align: left;"><em>batchingMaxBytes</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">131072</td>
</tr>
<tr>
<td style="text-align: left;"><em>batchingEnabled</em></td>
<td style="text-align: left;">Enable batching of messages.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">true</td>
</tr>
<tr>
<td style="text-align: left;"><em>batcherBuilder</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">BatcherBuilder</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>chunkingEnabled</em></td>
<td style="text-align: left;">Enable chunking of messages.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>chunkMaxMessageSize</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">-1</td>
</tr>
<tr>
<td style="text-align: left;"><em>cryptoKeyReader</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">CryptoKeyReader</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>messageCrypto</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">MessageCrypto</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>encryptionKeys</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Set</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">[]</td>
</tr>
<tr>
<td style="text-align: left;"><em>compressionType</em></td>
<td style="text-align: left;">Message data compression type used by a producer.<br>Available options:<br>* <a href="https://github.com/lz4/lz4">LZ4</a><br>* <a href="https://zlib.net/">ZLIB</a><br>* <a href="https://facebook.github.io/zstd/">ZSTD</a><br>* <a href="https://google.github.io/snappy/">SNAPPY</a></td>
<td style="text-align: center;">CompressionType</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">NONE</td>
</tr>
<tr>
<td style="text-align: left;"><em>initialSequenceId</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>autoUpdatePartitions</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">true</td>
</tr>
<tr>
<td style="text-align: left;"><em>autoUpdatePartitionsIntervalSeconds</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60</td>
</tr>
<tr>
<td style="text-align: left;"><em>multiSchema</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">true</td>
</tr>
<tr>
<td style="text-align: left;"><em>accessMode</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">ProducerAccessMode</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">Shared</td>
</tr>
<tr>
<td style="text-align: left;"><em>lazyStartPartitionedProducers</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>properties</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">SortedMap</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">{}</td>
</tr>
<tr>
<td style="text-align: left;"><em>initialSubscriptionName</em></td>
<td style="text-align: left;">Use this configuration to automatically create an initial subscription when creating a topic. If this field is not set, the initial subscription is not created.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table></section><section class="print-page" id="pulsar-schema-configuration"><h1 id="pulsar-schema-configuration-configuring-the-schema-used-for-pulsar-channels">Configuring the schema used for Pulsar channels</h1>
<p>Pulsar messages are stored with payloads as unstructured byte array.
A Pulsar <strong>schema</strong> defines how to serialize structured data to the raw message bytes
The <strong>schema</strong> is applied in producers and consumers to write and read with an enforced data structure.
It serializes data into raw bytes before they are published to a topic and deserializes the raw bytes before they are delivered to consumers.</p>
<p>Pulsar uses a schema registry as a central repository to store the registered schema information,
which enables producers/consumers to coordinate the schema of a topic's messages through brokers.
By default the Apache BookKeeper is used to store schemas.</p>
<p>Pulsar API provides built-in schema information for a number of
<a href="https://pulsar.apache.org/docs/3.0.x/schema-understand#primitive-type">primitive types</a>
and <a href="https://pulsar.apache.org/docs/3.0.x/schema-understand#complex-type">complex types</a> such as Key/Value, Avro and Protobuf.</p>
<p>The Pulsar Connector allows specifying the schema as a primitive type using the <code>schema</code> property:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-schema-configuration-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.prices.schema</span><span class="o">=</span><span class="s">INT32</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.outgoing.prices-out.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">mp.messaging.outgoing.prices-out.schema</span><span class="o">=</span><span class="s">DOUBLE</span>
</code></pre></div></td></tr></table></div>
<p>If the value for the <code>schema</code> property matches a <a href="https://javadoc.io/doc/org.apache.pulsar/pulsar-client-api/latest/org/apache/pulsar/common/schema/SchemaType.html">Schema Type</a>
a simple schema will be created with that type and will be used for that channel.</p>
<p>The Pulsar Connector allows configuring complex schema types by providing <code>Schema</code> beans through CDI, identified with the <code>@Identifier</code> qualifier.</p>
<p>For example the following bean provides an Avro schema and a Key/Value schema:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-26">26</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-27">27</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-28">28</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-29">29</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-1-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.configuration</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.pulsar.client.api.Schema</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.pulsar.common.schema.KeyValue</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.pulsar.common.schema.KeyValueEncodingType</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarSchemaProvider</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;user-schema&quot;</span><span class="p">)</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="n">Schema</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">userSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">AVRO</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;a-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">    </span><span class="n">Schema</span><span class="o">&lt;</span><span class="n">KeyValue</span><span class="o">&lt;</span><span class="n">Integer</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">keyValueSchema</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">KeyValue</span><span class="p">(</span><span class="n">Schema</span><span class="p">.</span><span class="na">INT32</span><span class="p">,</span><span class="w"> </span><span class="n">Schema</span><span class="p">.</span><span class="na">JSON</span><span class="p">(</span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> </span><span class="n">KeyValueEncodingType</span><span class="p">.</span><span class="na">SEPARATED</span><span class="p">);</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">User</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<a id="__codelineno-1-27" name="__codelineno-1-27"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">age</span><span class="p">;</span>
<a id="__codelineno-1-28" name="__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To configure the incoming channel <code>users</code> with defined schema, you need to set the <code>schema</code> property to the identifier of the schema <code>user-schema</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-schema-configuration-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#pulsar-schema-configuration-__codelineno-2-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">mp.messaging.incoming.users.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="na">mp.messaging.incoming.users.schema</span><span class="o">=</span><span class="s">user-schema</span>
</code></pre></div></td></tr></table></div>
<p>If no <code>schema</code> property is found, the connector looks for <code>Schema</code> beans identified with the channel name.
For example, the outgoing channel <code>a-channel</code> will use the key/value schema.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-schema-configuration-__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="na">mp.messaging.outgoing.a-channel.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
</code></pre></div></td></tr></table></div>
<p>If no schema information is provided incoming channels will use <code>Schema.AUTO_CONSUME()</code>, whereas outgoing channels will use <code>Schema.AUTO_PRODUCE_BYTES()</code> schemas.</p></section><section class="print-page" id="pulsar-client-configuration"><h1 id="pulsar-client-configuration-configuring-pulsar-clients-consumers-and-producers">Configuring Pulsar clients, consumers and producers</h1>
<p>Pulsar clients, consumers and producers are very customizable to configure how a Pulsar client application behaves.</p>
<p>The Pulsar connector creates a Pulsar client and, a consumer or a producer per channel, each with sensible defaults to ease their configuration.
Although the creation is handled, all available configuration options remain configurable through Pulsar channels.</p>
<p>While idiomatic way of creating <code>PulsarClient</code>, <code>PulsarConsumer</code> or <code>PulsarProducer</code> are through builder APIs, in its essence
those APIs build each time a configuration object, to pass onto the implementation.
Those are <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/org.apache.pulsar/pulsar-client-original/4.16.0/org/apache/pulsar/client/impl/conf/ClientConfigurationData.html'>ClientConfigurationData</a>,
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/org.apache.pulsar/pulsar-client-original/4.16.0/org/apache/pulsar/client/impl/conf/ConsumerConfigurationData.html'>ConsumerConfigurationData</a>,
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/org.apache.pulsar/pulsar-client-original/4.16.0/org/apache/pulsar/client/impl/conf/ProducerConfigurationData.html'>ProducerConfigurationData</a>.</p>
<p>Pulsar Connector allows receiving properties for those configuration objects directly.
For example, the broker authentication information for <code>PulsarClient</code> is received using <code>authPluginClassName</code> and <code>authParams</code> properties.
In order to configure the authentication for the incoming channel <code>data</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.data.connector</span><span class="o">=</span><span class="s">smallrye-pulsar</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.data.serviceUrl</span><span class="o">=</span><span class="s">pulsar://localhost:6650</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.data.topic</span><span class="o">=</span><span class="s">topic</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.data.subscriptionInitialPosition</span><span class="o">=</span><span class="s">Earliest</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">mp.messaging.incoming.data.schema</span><span class="o">=</span><span class="s">INT32</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">mp.messaging.incoming.data.authPluginClassName</span><span class="o">=</span><span class="s">org.apache.pulsar.client.impl.auth.AuthenticationBasic</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="na">mp.messaging.incoming.data.authParams</span><span class="o">=</span><span class="s">{&quot;userId&quot;:&quot;superuser&quot;,&quot;password&quot;:&quot;admin&quot;}</span>
</code></pre></div></td></tr></table></div>
<p>Note that the Pulsar consumer property <code>subscriptionInitialPosition</code> is also configured with the <code>Earliest</code> value which represents with enum value <code>SubscriptionInitialPosition.Earliest</code>.</p>
<p>This approach covers most of the configuration cases.
However, non-serializable objects such as <code>CryptoKeyReader</code>, <code>ServiceUrlProvider</code> etc. cannot be configured this way.
The Pulsar Connector allows taking into account instances of Pulsar configuration data objects â€“
<code>ClientConfigurationData</code>, <code>ConsumerConfigurationData</code>, <code>ProducerConfigurationData</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-1-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-consumer-options&quot;</span><span class="p">)</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">ConsumerConfigurationData</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getConsumerConfig</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="n">ConsumerConfigurationData</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConsumerConfigurationData</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="na">setAckReceiptEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="na">setCryptoKeyReader</span><span class="p">(</span><span class="n">DefaultCryptoKeyReader</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="w">            </span><span class="c1">//...</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This instance is retrieved and used to configure the client used by the connector.
You need to indicate the name of the client using the <code>client-configuration</code>, <code>consumer-configuration</code> or <code>producer-configuration</code> attributes:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-configuration-__codelineno-2-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="na">mp.messaging.incoming.prices.consumer-configuration</span><span class="o">=</span><span class="s">my-consumer-options</span>
</code></pre></div></td></tr></table></div>
<p>If no <code>[client|consumer|producer]-configuration</code> is configured, the connector will look for instances identified with the channel name:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-3-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">ClientConfigurationData</span><span class="w"> </span><span class="nf">getClientConfig</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">ClientConfigurationData</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClientConfigurationData</span><span class="p">();</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="na">setEnableTransaction</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="n">data</span><span class="p">.</span><span class="na">setServiceUrlProvider</span><span class="p">(</span><span class="n">AutoClusterFailover</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">            </span><span class="c1">// ...</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">            </span><span class="p">.</span><span class="na">build</span><span class="p">());</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You also can provide a <code>Map&lt;String, Object&gt;</code> containing configuration values by key:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-7">7</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-8">8</a></span>
<span class="normal"><a href="#pulsar-client-configuration-__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getProducerconfig</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">map</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;batcherBuilder&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">BatcherBuilder</span><span class="p">.</span><span class="na">KEY_BASED</span><span class="p">);</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;sendTimeoutMs&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3000</span><span class="p">);</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="n">map</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="s">&quot;customMessageRouter&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PartialRoundRobinMessageRouterImpl</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">map</span><span class="p">;</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Different configuration sources are loaded in the following order of precedence, from the least important to the highest:</p>
<ol>
<li><code>Map&lt;String, Object&gt;</code> config map produced with default config identifier, <code>default-pulsar-client</code>, <code>default-pulsar-consumer</code>, <code>default-pulsar-producer</code>.</li>
<li><code>Map&lt;String, Object&gt;</code> config map produced with identifier in the configuration or channel name</li>
<li><code>[Client|Producer|Consuemr]ConfigurationData</code> object produced with identifier in the channel configuration or the channel name</li>
<li>Channel configuration properties named with <code>[Client|Producer|Consuemr]ConfigurationData</code> field names.</li>
</ol>
<p>Following is the configuration reference for the <code>PulsarClient</code>.</p>
<p>Corresponding sections list the <a href="#pulsar-receiving-pulsar-messages-configuration-reference">Consumer Configuration Reference</a> and
<a href="#pulsar-sending-messages-to-pulsar-configuration-reference">Producer Configuration Reference</a>.
Configuration properties not configurable in configuration files (non-serializable) is noted in the column <code>Config file</code>.</p>
<h2 id="pulsar-client-configuration-pulsarclient-configuration-reference"><code>PulsarClient</code> Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Config file</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>serviceUrl</em></td>
<td style="text-align: left;">Pulsar cluster HTTP URL to connect to a broker.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>serviceUrlProvider</em></td>
<td style="text-align: left;">The implementation class of ServiceUrlProvider used to generate ServiceUrl.</td>
<td style="text-align: center;">ServiceUrlProvider</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>authentication</em></td>
<td style="text-align: left;">Authentication settings of the client.</td>
<td style="text-align: center;">Authentication</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>authPluginClassName</em></td>
<td style="text-align: left;">Class name of authentication plugin of the client.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>authParams</em></td>
<td style="text-align: left;">Authentication parameter of the client.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>authParamMap</em></td>
<td style="text-align: left;">Authentication map of the client.</td>
<td style="text-align: center;">Map</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>operationTimeoutMs</em></td>
<td style="text-align: left;">Client operation timeout (in milliseconds).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">30000</td>
</tr>
<tr>
<td style="text-align: left;"><em>lookupTimeoutMs</em></td>
<td style="text-align: left;">Client lookup timeout (in milliseconds).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">-1</td>
</tr>
<tr>
<td style="text-align: left;"><em>statsIntervalSeconds</em></td>
<td style="text-align: left;">Interval to print client stats (in seconds).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60</td>
</tr>
<tr>
<td style="text-align: left;"><em>numIoThreads</em></td>
<td style="text-align: left;">Number of IO threads.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">10</td>
</tr>
<tr>
<td style="text-align: left;"><em>numListenerThreads</em></td>
<td style="text-align: left;">Number of consumer listener threads.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">10</td>
</tr>
<tr>
<td style="text-align: left;"><em>connectionsPerBroker</em></td>
<td style="text-align: left;">Number of connections established between the client and each Broker. A value of 0 means to disable connection pooling.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">1</td>
</tr>
<tr>
<td style="text-align: left;"><em>connectionMaxIdleSeconds</em></td>
<td style="text-align: left;">Release the connection if it is not used for more than [connectionMaxIdleSeconds] seconds. If  [connectionMaxIdleSeconds] &lt; 0, disabled the feature that auto release the idle connections</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">180</td>
</tr>
<tr>
<td style="text-align: left;"><em>useTcpNoDelay</em></td>
<td style="text-align: left;">Whether to use TCP NoDelay option.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">true</td>
</tr>
<tr>
<td style="text-align: left;"><em>useTls</em></td>
<td style="text-align: left;">Whether to use TLS.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsKeyFilePath</em></td>
<td style="text-align: left;">Path to the TLS key file.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsCertificateFilePath</em></td>
<td style="text-align: left;">Path to the TLS certificate file.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsTrustCertsFilePath</em></td>
<td style="text-align: left;">Path to the trusted TLS certificate file.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsAllowInsecureConnection</em></td>
<td style="text-align: left;">Whether the client accepts untrusted TLS certificates from the broker.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsHostnameVerificationEnable</em></td>
<td style="text-align: left;">Whether the hostname is validated when the client creates a TLS connection with brokers.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>concurrentLookupRequest</em></td>
<td style="text-align: left;">The number of concurrent lookup requests that can be sent on each broker connection. Setting a maximum prevents overloading a broker.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">5000</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxLookupRequest</em></td>
<td style="text-align: left;">Maximum number of lookup requests allowed on each broker connection to prevent overloading a broker.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">50000</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxLookupRedirects</em></td>
<td style="text-align: left;">Maximum times of redirected lookup requests.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">20</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxNumberOfRejectedRequestPerConnection</em></td>
<td style="text-align: left;">Maximum number of rejected requests of a broker in a certain time frame (60 seconds) after the current connection is closed and the client creating a new connection to connect to a different broker.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">50</td>
</tr>
<tr>
<td style="text-align: left;"><em>keepAliveIntervalSeconds</em></td>
<td style="text-align: left;">Seconds of keeping alive interval for each client broker connection.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">30</td>
</tr>
<tr>
<td style="text-align: left;"><em>connectionTimeoutMs</em></td>
<td style="text-align: left;">Duration of waiting for a connection to a broker to be established.If the duration passes without a response from a broker, the connection attempt is dropped.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">10000</td>
</tr>
<tr>
<td style="text-align: left;"><em>requestTimeoutMs</em></td>
<td style="text-align: left;">Maximum duration for completing a request.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60000</td>
</tr>
<tr>
<td style="text-align: left;"><em>readTimeoutMs</em></td>
<td style="text-align: left;">Maximum read time of a request.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60000</td>
</tr>
<tr>
<td style="text-align: left;"><em>autoCertRefreshSeconds</em></td>
<td style="text-align: left;">Seconds of auto refreshing certificate.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">300</td>
</tr>
<tr>
<td style="text-align: left;"><em>initialBackoffIntervalNanos</em></td>
<td style="text-align: left;">Initial backoff interval (in nanosecond).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">100000000</td>
</tr>
<tr>
<td style="text-align: left;"><em>maxBackoffIntervalNanos</em></td>
<td style="text-align: left;">Max backoff interval (in nanosecond).</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">60000000000</td>
</tr>
<tr>
<td style="text-align: left;"><em>enableBusyWait</em></td>
<td style="text-align: left;">Whether to enable BusyWait for EpollEventLoopGroup.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>listenerName</em></td>
<td style="text-align: left;">Listener name for lookup. Clients can use listenerName to choose one of the listeners as the service URL to create a connection to the broker as long as the network is accessible."advertisedListeners" must enabled in broker side.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>useKeyStoreTls</em></td>
<td style="text-align: left;">Set TLS using KeyStore way.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>sslProvider</em></td>
<td style="text-align: left;">The TLS provider used by an internal client to authenticate with other Pulsar brokers.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsKeyStoreType</em></td>
<td style="text-align: left;">TLS KeyStore type configuration.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">JKS</td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsKeyStorePath</em></td>
<td style="text-align: left;">Path of TLS KeyStore.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsKeyStorePassword</em></td>
<td style="text-align: left;">Password of TLS KeyStore.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsTrustStoreType</em></td>
<td style="text-align: left;">TLS TrustStore type configuration. You need to set this configuration when client authentication is required.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">JKS</td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsTrustStorePath</em></td>
<td style="text-align: left;">Path of TLS TrustStore.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsTrustStorePassword</em></td>
<td style="text-align: left;">Password of TLS TrustStore.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsCiphers</em></td>
<td style="text-align: left;">Set of TLS Ciphers.</td>
<td style="text-align: center;">Set</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">[]</td>
</tr>
<tr>
<td style="text-align: left;"><em>tlsProtocols</em></td>
<td style="text-align: left;">Protocols of TLS.</td>
<td style="text-align: center;">Set</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">[]</td>
</tr>
<tr>
<td style="text-align: left;"><em>memoryLimitBytes</em></td>
<td style="text-align: left;">Limit of client memory usage (in byte). The 64M default can guarantee a high producer throughput.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">67108864</td>
</tr>
<tr>
<td style="text-align: left;"><em>proxyServiceUrl</em></td>
<td style="text-align: left;">URL of proxy service. proxyServiceUrl and proxyProtocol must be mutually inclusive.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>proxyProtocol</em></td>
<td style="text-align: left;">Protocol of proxy service. proxyServiceUrl and proxyProtocol must be mutually inclusive.</td>
<td style="text-align: center;">ProxyProtocol</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>enableTransaction</em></td>
<td style="text-align: left;">Whether to enable transaction.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">false</td>
</tr>
<tr>
<td style="text-align: left;"><em>clock</em></td>
<td style="text-align: left;"></td>
<td style="text-align: center;">Clock</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dnsLookupBindAddress</em></td>
<td style="text-align: left;">The Pulsar client dns lookup bind address, default behavior is bind on 0.0.0.0</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dnsLookupBindPort</em></td>
<td style="text-align: left;">The Pulsar client dns lookup bind port, takes effect when dnsLookupBindAddress is configured, default value is 0.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;">0</td>
</tr>
<tr>
<td style="text-align: left;"><em>socks5ProxyAddress</em></td>
<td style="text-align: left;">Address of SOCKS5 proxy.</td>
<td style="text-align: center;">InetSocketAddress</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>socks5ProxyUsername</em></td>
<td style="text-align: left;">User name of SOCKS5 proxy.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>socks5ProxyPassword</em></td>
<td style="text-align: left;">Password of SOCKS5 proxy.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>description</em></td>
<td style="text-align: left;">The extra description of the client version. The length cannot exceed 64.</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table></section><section class="print-page" id="pulsar-health"><h1 id="pulsar-health-health-reporting">Health reporting</h1>
<p>The Pulsar connector reports the startup, readiness and liveness of each channel managed by the connector:</p>
<ul>
<li>
<p><strong>Startup &amp; Readiness</strong> For both inbound and outbound, probes report <em>OK</em> when the
  connection with the broker is established.</p>
</li>
<li>
<p><strong>Liveness</strong> For both inbound and outbound, the liveness check verifies that the
  connection is established <strong>AND</strong> that no failures have been caught.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To disable health reporting, set the <code>health-enabled</code> attribute for the
channel to <code>false</code>.</p>
</div>
<p>Note that a message processing failures <em>nacks</em> the message which is
then handled by the failure-strategy. It is the responsibility of the
failure-strategy to report the failure and influence the outcome of the
liveness checks. The <code>fail</code> failure strategy reports the failure and so
the liveness check will report the failure.</p></section><section class="print-page" id="pulsar-client-service"><h1 id="pulsar-client-service-pulsarclientservice">PulsarClientService</h1>
<p>For advanced use cases, SmallRye Reactive Messaging provides a bean of
type <code>PulsarClientService</code> that you can inject:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-client-service-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-client-service-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">PulsarClientService</span><span class="w"> </span><span class="n">pulsarClients</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>From there, you can obtain
<code>org.apache.pulsar.client.api.Consumer</code>,
<code>org.apache.pulsar.client.api.Producer</code> and <code>org.apache.pulsar.client.api.PulsarClient</code> by channel name.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Note that the <a href="https://pulsar.apache.org/docs/3.0.x/admin-api-get-started/"><code>PulsarAdmin</code></a> is a separate library and the Pulsar connector doesn't provide it out-of-the-box.
You'd need to explicitly add the dependency, i.e. <code>org.apache.pulsar:pulsar-client-admin-original</code> artifact.</p>
</div></section><section class="print-page" id="pulsar-transactions"><h1 id="pulsar-transactions-pulsar-transactions-and-exactly-once-processing">Pulsar Transactions and Exactly-Once Processing</h1>
<p><a href="https://pulsar.apache.org/docs/3.0.x/txn-why/">Pulsar transactions</a> enable event streaming applications to consume, process, and produce messages in one atomic operation.</p>
<p>Transactions allow one or multiple producers to send batch of messages to multiple topics where all messages in the batch are eventually visible to any consumer, or none is ever visible to consumers.</p>
<p>In order to be used, transaction support needs to be activated on the broker configuration:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-transactions-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># used to enable transaction coordinator</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">transactionCoordinatorEnabled</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="c1"># used to create systemTopic used for transaction buffer snapshot</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">systemTopicEnabled</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div></p>
<p>On the client side, the transaction support also needs to be enabled on <code>PulsarClient</code> configuration:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-transactions-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.outgoing.tx-producer.enableTransaction</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<p>Pulsar connector provides <code>PulsarTransactions</code> custom emitter for writing records inside a transaction.</p>
<p>It can be used as a regular emitter <code>@Channel</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-transactions-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-27">27</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-28">28</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-29">29</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-30">30</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-31">31</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-32">32</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-33">33</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-34">34</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-35">35</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-36">36</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-37">37</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-2-38">38</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.pulsar.OutgoingMessage</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.pulsar.transactions.PulsarTransactions</span><span class="p">;</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarTransactionalProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;tx-out-example&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="n">PulsarTransactions</span><span class="o">&lt;</span><span class="n">OutgoingMessage</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">txProducer</span><span class="p">;</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;other-producer&quot;</span><span class="p">)</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">    </span><span class="n">PulsarTransactions</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">producer</span><span class="p">;</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">emitInTransaction</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">txProducer</span><span class="p">.</span><span class="na">withTransaction</span><span class="p">(</span><span class="n">emitter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">OutgoingMessage</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">OutgoingMessage</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">            </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">OutgoingMessage</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">            </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;4&quot;</span><span class="p">);</span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">            </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;5&quot;</span><span class="p">);</span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">            </span><span class="n">producer</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">emitter</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;6&quot;</span><span class="p">);</span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">completionStage</span><span class="p">(</span><span class="n">in</span><span class="p">::</span><span class="n">ack</span><span class="p">);</span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The function given to the <code>withTransaction</code> method receives a <code>TransactionalEmitter</code> for producing records, and returns a <code>Uni</code> that provides the result of the transaction.
If the processing completes successfully, the producer is flushed and the transaction is committed.
If the processing throws an exception, returns a failing <code>Uni</code>, or marks the <code>TransactionalEmitter</code> for abort, the transaction is aborted.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Multiple transactional producers can participate in a single transaction.
This ensures all messages are sent using the started transaction and before the transaction is committed, all participating producers are flushed.</p>
</div>
<p>If this method is called on a Vert.x context, the processing function is also called on that context.
Otherwise, it is called on the sending thread of the producer.</p>
<h2 id="pulsar-transactions-exactly-once-processing">Exactly-Once Processing</h2>
<p>Pulsar Transactions API also allows managing consumer offsets inside a transaction, together with produced messages.
This in turn enables coupling a consumer with a transactional producer in a consume-transform-produce pattern,
also known as exactly-once processing.
It means that an application consumes messages, processes them, publishes the results to a topic, and commits offsets of the consumed messages in a transaction.</p>
<p>The <code>PulsarTransactions</code> emitter also provides a way to apply exactly-once processing to an incoming Pulsar message inside a transaction.</p>
<p>The following example includes a batch of Pulsar messages inside a transaction.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-transactions-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-3-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="w">    </span><span class="na">mp.messaging.outgoing.tx-out-example.enableTransaction</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="c1"># ...</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="na">mp.messaging.incoming.in-channel.enableTransaction</span><span class="o">=</span><span class="s">true</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="na">mp.messaging.incoming.in-channel.batchReceive</span><span class="o">=</span><span class="s">true</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#pulsar-transactions-__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-10">10</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-11">11</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-12">12</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-13">13</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-14">14</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-15">15</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-16">16</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-17">17</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-18">18</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-19">19</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-20">20</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-21">21</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-22">22</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-23">23</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-24">24</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-25">25</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-26">26</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-27">27</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-28">28</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-29">29</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-30">30</a></span>
<span class="normal"><a href="#pulsar-transactions-__codelineno-4-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">pulsar.outbound</span><span class="p">;</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.inject.Inject</span><span class="p">;</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Channel</span><span class="p">;</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.pulsar.PulsarIncomingBatchMessage</span><span class="p">;</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.pulsar.PulsarMessage</span><span class="p">;</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.pulsar.transactions.PulsarTransactions</span><span class="p">;</span>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">PulsarExactlyOnceProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="w">    </span><span class="nd">@Channel</span><span class="p">(</span><span class="s">&quot;tx-out-example&quot;</span><span class="p">)</span>
<a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">    </span><span class="n">PulsarTransactions</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">txProducer</span><span class="p">;</span>
<a id="__codelineno-4-20" name="__codelineno-4-20"></a>
<a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">emitInTransaction</span><span class="p">(</span><span class="n">PulsarIncomingBatchMessage</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">txProducer</span><span class="p">.</span><span class="na">withTransactionAndAck</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span><span class="w"> </span><span class="n">emitter</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">PulsarMessage</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">batch</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">                </span><span class="n">emitter</span><span class="p">.</span><span class="na">send</span><span class="p">(</span><span class="n">PulsarMessage</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="na">getPayload</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">getKey</span><span class="p">()));</span>
<a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-4-27" name="__codelineno-4-27"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="w">        </span><span class="p">});</span>
<a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-4-30" name="__codelineno-4-30"></a>
<a id="__codelineno-4-31" name="__codelineno-4-31"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>If the processing completes successfully, the message is acknowledged inside the transaction and the transaction is committed.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>When using exactly-once processing, messages can only be acked individually rather than cumulatively.</p>
</div>
<p>If the processing needs to abort, the message is nack'ed. One of the failure strategies can be employed in order to retry the processing or simply fail-stop.
Note that the <code>Uni</code> returned from the <code>#withTransaction</code> will yield a failure if the transaction fails and is aborted.</p>
<p>The application can choose to handle the error case, but for the message consumption to continue, <code>Uni</code> returned from the <code>@Incoming</code> method must not result in failure.
<code>PulsarTransactions#withTransactionAndAck</code> method will ack and nack the message but will not stop the reactive stream.
Ignoring the failure simply resets the consumer to the last committed offsets and resumes the processing from there.</p></section><h1 class='nav-section-title-end'>Ended: Pulsar</h1>
                        <h1 class='nav-section-title' id='section-apache-camel'>
                            Apache Camel <a class='headerlink' href='#section-apache-camel' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="camel-camel"><h1 id="camel-camel-apache-camel-connector">Apache Camel Connector</h1>
<p>The Camel connector adds support for Apache Camel to Reactive Messaging.</p>
<p><a href="https://camel.apache.org/">Camel</a> is an open source integration
framework let you integrate various systems consuming or producing data.
Camel implements the Enterprise Integration Patterns and provides
several hundred of components used to access databases, message queues,
APIs or basically <a href="https://camel.apache.org/components/latest/">anything under the
sun</a>.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Smallrye Reactive Messaging 4.x moved from <code>javax</code> to <code>jakarta</code> APIs therefore only supports Camel 4 releases.
Similarly, this connector drops the Java 11 support as this is the case for Camel 4.</p>
</div>
<h2 id="camel-camel-introduction">Introduction</h2>
<p>Camel is not a messaging broker. But, it allows your Reactive Messaging
application to retrieve data from almost anything and send data to
almost anything.</p>
<p>So if you want to send Reactive Messaging <code>Message</code> to Telegram or
retrieve data from Salesforce or SAP, this is the connector you need.</p>
<p>One of the Camel cornerstone is the <code>endpoint</code> and its <code>uri</code> encoding
the connection to an external system. For example,
<code>file:orders/?delete=true&amp;charset=utf-8</code> instructs Camel to read the
files from the <code>orders</code> directory. URI format and parameters are listed
on the component documentation, such as the <a href="https://camel.apache.org/components/latest/file-component.html">File
component</a>.</p>
<h2 id="camel-camel-using-the-camel-connector">Using the camel connector</h2>
<p>To you the camel Connector, add the following dependency to your
project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-camel-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-camel<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>You will also need the dependency of the Camel component you are using.
For example, if you want to process files, you would need to add the
Camel File Component artifact:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-camel-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>org.apache.camel<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>camel-file<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.3.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-camel</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-camel-__codelineno-2-1">1</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-2-2">2</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-2-3">3</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-2-4">4</a></span>
<span class="normal"><a href="#camel-camel-__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a># Inbound
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>mp.messaging.incoming.[channel-name].connector=smallrye-camel
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a># Outbound
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>mp.messaging.outgoing.[channel-name].connector=smallrye-camel
</code></pre></div></td></tr></table></div></section><section class="print-page" id="camel-receiving-messages-from-camel"><h1 id="camel-receiving-messages-from-camel-retrieving-data-using-camel">Retrieving data using Camel</h1>
<p>Camel provides many components. To keep this documentation focused on
the integration with Camel, we use the <a href="https://camel.apache.org/components/latest/file-component.html">File
component</a>.
This component let use read files from a directory. So the connector
configured with this component creates a <code>Message</code> for each file located
in the directory. As soon as a file is dropped in the directory, a new
<code>Message</code> is created.</p>
<h2 id="camel-receiving-messages-from-camel-example">Example</h2>
<p>Letâ€™s imagine you want to read the files from the <code>orders</code> directory and
send them to the <code>files</code> channel. Configuring the Camel connector to
gets the <em>file</em> from this directory only requires 2 properties:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.files.connector</span><span class="o">=</span><span class="s">smallrye-camel # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.files.endpoint-uri</span><span class="o">=</span><span class="s">file:orders/?delete=true&amp;charset=utf-8 # &lt;2&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Sets the connector for the <code>files</code> channel
2.  Configures the <code>endpoint-uri</code></p>
<p>Then, your application receives <code>Message&lt;GenericFile&lt;File&gt;&gt;</code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Camel File component produces
<code>org.apache.camel.component.file.GenericFile</code> instances. You can
retrieve the actual <code>File</code> using <code>getFile()</code>.</p>
</div>
<p>You can consume the payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-1-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.camel.component.file.GenericFile</span><span class="p">;</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CamelFileConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;files&quot;</span><span class="p">)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">GenericFile</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;</span><span class="w"> </span><span class="n">gf</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gf</span><span class="p">.</span><span class="na">getFile</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">        </span><span class="c1">// process the file</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can also retrieve the <code>Message&lt;GenericFile&lt;File&gt;&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-2-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.camel.component.file.GenericFile</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CamelFileMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;files&quot;</span><span class="p">)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">GenericFile</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getPayload</span><span class="p">().</span><span class="na">getFile</span><span class="p">();</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="c1">// process the file</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="camel-receiving-messages-from-camel-deserialization">Deserialization</h2>
<p>Each Camel component is producing specific objects. As we have seen, the
File component produces <code>GenericFile</code>.</p>
<p>Refer to the component documentation to check which type is produced.</p>
<h2 id="camel-receiving-messages-from-camel-inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from Camel contains an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-camel/4.16.0/io/smallrye/reactive/messaging/camel/IncomingExchangeMetadata.html'>IncomingExchangeMetadata</a>
in the metadata.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-18">18</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-19">19</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-20">20</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-21">21</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-22">22</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-23">23</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-24">24</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-25">25</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-26">26</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-27">27</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-28">28</a></span>
<span class="normal"><a href="#camel-receiving-messages-from-camel-__codelineno-3-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.inbound</span><span class="p">;</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.io.File</span><span class="p">;</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Optional</span><span class="p">;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.camel.Exchange</span><span class="p">;</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.camel.component.file.GenericFile</span><span class="p">;</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.camel.IncomingExchangeMetadata</span><span class="p">;</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">IncomingCamelMetadataExample</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a>
<a id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;files&quot;</span><span class="p">)</span>
<a id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">GenericFile</span><span class="o">&lt;</span><span class="n">File</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-21" name="__codelineno-3-21"></a><span class="w">        </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">IncomingExchangeMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingExchangeMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-3-22" name="__codelineno-3-22"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metadata</span><span class="p">.</span><span class="na">isPresent</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-23" name="__codelineno-3-23"></a><span class="w">            </span><span class="c1">// Retrieve the camel exchange:</span>
<a id="__codelineno-3-24" name="__codelineno-3-24"></a><span class="w">            </span><span class="n">Exchange</span><span class="w"> </span><span class="n">exchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">get</span><span class="p">().</span><span class="na">getExchange</span><span class="p">();</span>
<a id="__codelineno-3-25" name="__codelineno-3-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-26" name="__codelineno-3-26"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-3-27" name="__codelineno-3-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-28" name="__codelineno-3-28"></a>
<a id="__codelineno-3-29" name="__codelineno-3-29"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This object lets you retrieve the Camel <code>Exchange</code>.</p>
<h2 id="camel-receiving-messages-from-camel-failure-management">Failure Management</h2>
<p>If a message produced from a Camel exchange is <em>nacked</em>, a failure
strategy is applied. The Camel connector supports 3 strategies:</p>
<ul>
<li><code>fail</code> - fail the application, no more MQTT messages will be
    processed. (default) The offset of the record that has not been
    processed correctly is not committed.</li>
<li><code>ignore</code> - the failure is logged, but the processing continue.</li>
</ul>
<p>In both cases, the <code>exchange</code> is marked as rollback only and the nack
reason is attached to the exchange.</p>
<h2 id="camel-receiving-messages-from-camel-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>endpoint-uri</em></td>
<td style="text-align: left;">The URI of the Camel endpoint (read from or written to)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from a Camel exchange is nacked. Values can be <code>fail</code> (default) or <code>ignore</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>fail</code></td>
</tr>
</tbody>
</table></section><section class="print-page" id="camel-sending-messages-to-camel"><h1 id="camel-sending-messages-to-camel-sending-data-with-camel">Sending data with Camel</h1>
<p>You can use the Camel connector to send data to almost any type of
system.</p>
<p>To keep this document focused on the Camel connector, we use the Camel
File component. However, the connector can be used with any Camel
component.</p>
<h2 id="camel-sending-messages-to-camel-example">Example</h2>
<p>Letâ€™s imagine you want to write generated prices into files. Configure
your application to write the messages from the <code>prices</code> channel into a
files as follows:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.outgoing.prices.connector</span><span class="o">=</span><span class="s">smallrye-camel # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.outgoing.prices.endpoint-uri</span><span class="o">=</span><span class="s">file:prices/?fileName=${date:now:yyyyMMddssSS}.txt&amp;charset=utf-8 # &lt;2&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Sets the connector for the <code>prices</code> channel
2.  Configure the <code>endpoint-uri</code> to write into files in the <code>prices</code>
    directory</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Depending on your implementation of MicroProfile Reactive Messaging, the
<code>$</code> may need to be escaped as follows: <code>$${...}</code></p>
</div>
<p>Then, your application must send <code>Message&lt;String&gt;</code> to the <code>prices</code>
channel. It can use <code>String</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-25">25</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-1-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CamelPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">                </span><span class="p">.</span><span class="na">onOverflow</span><span class="p">().</span><span class="na">drop</span><span class="p">()</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">())</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Double</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">p</span><span class="p">));</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-26">26</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-2-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CamelPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">())</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Double</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">Message</span><span class="p">::</span><span class="n">of</span><span class="p">);</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="camel-sending-messages-to-camel-serialization">Serialization</h2>
<p>The serialization is handled by the Camel component. Refer to the Camel
documentation to check which payload type is supported by the component.</p>
<h2 id="camel-sending-messages-to-camel-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Messages</code>, you can add an instance
of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-camel/4.16.0/io/smallrye/reactive/messaging/camel/OutgoingExchangeMetadata.html'>OutgoingExchangeMetadata</a>
to the message metadata. You can then influence how the outbound Camel
<code>Exchange</code> is created, for example by adding properties:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#camel-sending-messages-to-camel-__codelineno-3-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">())</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">p</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Double</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">                </span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">OutgoingExchangeMetadata</span><span class="p">()</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">                        </span><span class="p">.</span><span class="na">putProperty</span><span class="p">(</span><span class="s">&quot;my-property&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my-value&quot;</span><span class="p">)));</span>
</code></pre></div></td></tr></table></div>
<h2 id="camel-sending-messages-to-camel-acknowledgement">Acknowledgement</h2>
<p>The incoming messages are acknowledged when the underlying Camel
exchange completes. If the exchange fails, the message is nacked.</p>
<h2 id="camel-sending-messages-to-camel-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>endpoint-uri</em></td>
<td style="text-align: left;">The URI of the Camel endpoint (read from or written to)</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>merge</em></td>
<td style="text-align: left;">Whether the connector should allow multiple upstreams</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
</tbody>
</table></section><section class="print-page" id="camel-camel-processor"><h1 id="camel-camel-processor-the-processor-pattern-using-camel">The processor pattern using Camel</h1>
<p>Using the processor pattern, you can consume on a channel using a Camel
component, and produce on a channel using another Camel component. In
that case, the headers present in the incoming metadata will be
forwarded in the outgoing metadata.</p>
<h2 id="camel-camel-processor-example">Example</h2>
<p>Letâ€™s imagine you want to read messages from a Nats subject, process it
and produce a message on a Kafka topic.</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-camel-processor-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-6">6</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-0-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.mynatssubject.connector</span><span class="o">=</span><span class="s">smallrye-camel # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.mynatssubject.endpoint-uri</span><span class="o">=</span><span class="s">nats:mynatssubject # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.outgoing.mykafkatopic.connector</span><span class="o">=</span><span class="s">smallrye-camel # &lt;3&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.outgoing.mykafkatopic.endpoint-uri</span><span class="o">=</span><span class="s">kafka:mykafkatopic# &lt;4&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">camel.component.nats.servers</span><span class="o">=</span><span class="s">127.0.0.1:5555 # &lt;5&gt;</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="na">camel.component.kafka.brokers</span><span class="o">=</span><span class="s">127.0.0.1:9092 # &lt;6&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Sets the connector for the <code>mynatssubject</code> channel
2.  Configures the <code>endpoint-uri</code> for nats subject
3.  Sets the connector for the <code>mykafkatopic</code> channel
4.  Configures the <code>endpoint-uri</code> for the kafka topic
5.  Sets the URL of the nats server to use
6.  Sets the URL of a kafka broker to use</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-camel-processor-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#camel-camel-processor-__codelineno-1-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">camel.processor</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CamelProcessor</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;mynatssubject&quot;</span><span class="p">)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;mykafkatopic&quot;</span><span class="p">)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="c1">// do some logic</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">;</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><section class="print-page" id="camel-using-existing-routes"><h1 id="camel-using-existing-routes-using-the-camel-api">Using the Camel API</h1>
<p>The Camel connector is based on the <a href="https://camel.apache.org/components/latest/reactive-streams-component.html">Reactive Streams
support</a>
from Camel. If you have an application already using the Camel API
(routes, <code>from</code>...), you can integrate it with Reactive Messaging.</p>
<h2 id="camel-using-existing-routes-getting-the-camelreactivestreamsservice">Getting the CamelReactiveStreamsService</h2>
<p>Once you add the Camel connector to your application, you can retrieve
the
<code>org.apache.camel.component.reactive.streams.api.CamelReactiveStreamsService</code>
object:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-0-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="n">CamelReactiveStreamsService</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">;</span>
</code></pre></div></td></tr></table></div>
<p>This <code>CamelReactiveStreamsService</code> lets you create <code>Publisher</code> and
<code>Subscriber</code> instances from existing routes.</p>
<h2 id="camel-using-existing-routes-using-camel-route-with-outgoing">Using Camel Route with @Outgoing</h2>
<p>If you have an existing Camel route, you can transform it as a
<code>Publisher</code> using the <code>CamelReactiveStreamsService</code>. Then, you can
return this <code>Publisher</code> from a method annotated with <code>@Outgoing</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-1-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;camel&quot;</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">Exchange</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">retrieveDataFromCamelRoute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;seda:camel&quot;</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can also expose a <code>RouteBuilder</code> bean, making sure to use the <code>Singleton</code> scope,
as <code>RouteBuilder</code> is no longer proxyable:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-2-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="nd">@Singleton</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyRouteBuilder</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">RouteBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="w">    </span><span class="n">CamelReactiveStreamsService</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getDataFromCamelRoute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">.</span><span class="na">fromStream</span><span class="p">(</span><span class="s">&quot;my-stream&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">        </span><span class="n">from</span><span class="p">(</span><span class="s">&quot;seda:camel&quot;</span><span class="p">).</span><span class="na">process</span><span class="p">(</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">                </span><span class="n">exchange</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">setBody</span><span class="p">(</span><span class="n">exchange</span><span class="p">.</span><span class="na">getIn</span><span class="p">().</span><span class="na">getBody</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">toUpperCase</span><span class="p">()))</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">                </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="s">&quot;reactive-streams:my-stream&quot;</span><span class="p">);</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Alternatively you can use the <code>LambdaRouteBuilder</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-10">10</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-11">11</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-12">12</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-13">13</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-14">14</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-15">15</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-16">16</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-17">17</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-3-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyLambdaRouteBuilder</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="nd">@Inject</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">CamelReactiveStreamsService</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">;</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;sink&quot;</span><span class="p">)</span>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">getDataFromCamelRoute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">.</span><span class="na">fromStream</span><span class="p">(</span><span class="s">&quot;my-stream&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nd">@BindToRegistry</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">LambdaRouteBuilder</span><span class="w"> </span><span class="nf">route</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">rb</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">rb</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="s">&quot;seda:camel&quot;</span><span class="p">).</span><span class="na">process</span><span class="p">(</span>
<a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="w">                </span><span class="n">exchange</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">setBody</span><span class="p">(</span><span class="n">exchange</span><span class="p">.</span><span class="na">getIn</span><span class="p">().</span><span class="na">getBody</span><span class="p">(</span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">).</span><span class="na">toUpperCase</span><span class="p">()))</span>
<a id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="w">                </span><span class="p">.</span><span class="na">to</span><span class="p">(</span><span class="s">&quot;reactive-streams:my-stream&quot;</span><span class="p">);</span>
<a id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h1 id="camel-using-existing-routes-using-camel-route-with-incoming">Using Camel Route with @Incoming</h1>
<p>If you have an existing Camel route, you can transform it as a
<code>Subscriber</code> using the <code>CamelReactiveStreamsService</code>. Then, you can
return this <code>Subscriber</code> from a method annotated with <code>@Incoming</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-4-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;to-camel&quot;</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sendDataToCamelRoute</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">reactiveStreamsService</span><span class="p">.</span><span class="na">subscriber</span><span class="p">(</span><span class="s">&quot;file:./target?fileName=values.txt&amp;fileExist=append&quot;</span><span class="p">,</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">            </span><span class="n">String</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can also use a producer:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-1">1</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-2">2</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-3">3</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-4">4</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-5">5</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-6">6</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-7">7</a></span>
<span class="normal"><a href="#camel-using-existing-routes-__codelineno-5-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Inject</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">CamelContext</span><span class="w"> </span><span class="n">camel</span><span class="p">;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;to-camel&quot;</span><span class="p">)</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">sink</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">camel</span><span class="p">.</span><span class="na">createProducerTemplate</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">            </span><span class="p">.</span><span class="na">asyncSendBody</span><span class="p">(</span><span class="s">&quot;file:./target?fileName=values.txt&amp;fileExist=append&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">).</span><span class="na">thenApply</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: Apache Camel</h1>
                        <h1 class='nav-section-title' id='section-jms'>
                            JMS <a class='headerlink' href='#section-jms' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="jms-jms"><h1 id="jms-jms-the-jms-connector">The JMS connector</h1>
<p>The JMS connector adds support for <a href="https://en.wikipedia.org/wiki/Jakarta_Messaging">Jakarta
Messaging</a> to Reactive
Messaging. It is designed to integrate with <em>JakartaEE</em> applications
that are sending or receiving Jakarta Messaging Messages.</p>
<p>Jakarta Messaging is a Java Message Oriented Middleware API for sending
messages between two or more clients. It is a programming model to
handle the producer-consumer messaging problem. It is a messaging
standard that allows application components based on Jakarta EE to
create, send, receive, and read messages. It allows the communication
between different components of a distributed application to be loosely
coupled, reliable, and asynchronous.</p>
<h1 id="jms-jms-using-the-jms-connector">Using the JMS connector</h1>
<p>To you the JMS Connector, add the following dependency to your project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-jms-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-jms<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-jms</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-jms-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-jms</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-jms</span>
</code></pre></div></td></tr></table></div>
<p>The JMS Connector requires a <code>jakarta.jms.ConnectionFactory</code> to be exposed
(as CDI bean). The connector looks for a <code>jakarta.jms.ConnectionFactory</code>
and delegate the interaction with the JMS server to this factory. In
other words, it creates the JMS connection and context using this
factory.</p>
<p>So, in order to use this connector you would need to expose a
<code>jakarta.jms.ConnectionFactory</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-jms-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#jms-jms-__codelineno-2-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.inject.Produces</span><span class="p">;</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.jms.ConnectionFactory</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.activemq.artemis.jms.client.ActiveMQJMSConnectionFactory</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ConnectionFactoryBean</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nd">@Produces</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="n">ConnectionFactory</span><span class="w"> </span><span class="nf">factory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ActiveMQJMSConnectionFactory</span><span class="p">(</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">                </span><span class="s">&quot;tcp://localhost:61616&quot;</span><span class="p">,</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">                </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The factory class may depend on your JMS connector/server.</p></section><section class="print-page" id="jms-receiving-jms-messages"><h1 id="jms-receiving-jms-messages-receiving-messages-from-jms">Receiving messages from JMS</h1>
<p>The JMS Connector retrieves JMS Message and maps each of them into
Reactive Messaging <code>Messages</code>.</p>
<h2 id="jms-receiving-jms-messages-example">Example</h2>
<p>Letâ€™s imagine you have a <code>jakarta.jms.ConnectionFactory</code> bean exposed and
connected to your JMS server. Donâ€™t forget that itâ€™s required to use the
JMS connector.</p>
<p>Configure your application to receive JMS messages on the <code>prices</code>
channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-jms</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the destination. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>destination</code> attribute to
override it.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default the connector uses a <code>queue</code>. You can configure it to use a
<code>topic</code> by setting <code>destination-type=topic</code>.</p>
</div>
<p>Then, your application receives <code>Message&lt;Double&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">jms.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JmsPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">jms.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JmsPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="jms-receiving-jms-messages-deserialization">Deserialization</h2>
<p>The content of the incoming JMS message is mapped to a Java object.</p>
<p>By default it extracts the JMS Message <em>body</em> as a <code>java.lang.Object</code>.
This can be changed by setting, in the incoming JMS Message:</p>
<ol>
<li>
<p>The <code>_classname</code> property</p>
</li>
<li>
<p>the <code>JMSType</code></p>
</li>
</ol>
<p>The value must be a fully qualified class name. The connector then load
the associated class.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The connector loads the associated <code>Class</code> using the <code>TCCL</code> and if not
found, the classloader used to load the connector.</p>
</div>
<p>If the target type is a primitive type ort <code>String</code>, the resulting
message contains the mapped payload.</p>
<p>If the target type is a class, the object is built using included JSON
deserializer (JSON-B and Jackson provided OOB, for more details see
<a href="#jms-receiving-jms-messages-serde">Serde</a>), from the <code>JMSType</code>. If not, the default behavior is
used (Java deserialization).</p>
<h2 id="jms-receiving-jms-messages-inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from JMS contains an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-jms/4.16.0/io/smallrye/reactive/messaging/jms/IncomingJmsMessageMetadata.html'>io.smallrye.reactive.messaging.jms.IncomingJmsMessageMetadata</a>  in the metadata.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#jms-receiving-jms-messages-__codelineno-3-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="n">Optional</span><span class="o">&lt;</span><span class="n">IncomingJmsMessageMetadata</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingJmsMessageMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="n">metadata</span><span class="p">.</span><span class="na">ifPresent</span><span class="p">(</span><span class="n">meta</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">expiration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getExpiration</span><span class="p">();</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">Destination</span><span class="w"> </span><span class="n">destination</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getDestination</span><span class="p">();</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="na">getStringProperty</span><span class="p">(</span><span class="s">&quot;my-property&quot;</span><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">});</span>
</code></pre></div></td></tr></table></div>
<h2 id="jms-receiving-jms-messages-acknowledgement">Acknowledgement</h2>
<p>When the Reactive Messaging <code>Message</code> gets acknowledged, the associated
JMS Message is acknowledged. As JMS acknowledgement is blocking, this
acknowledgement is delegated to a worker thread.</p>
<h2 id="jms-receiving-jms-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether or not the JMS message should be dispatched to multiple consumers</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id</em></td>
<td style="text-align: left;">The client id</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connection-factory-name</em></td>
<td style="text-align: left;">The name of the JMS connection factory  (<code>jakarta.jms.ConnectionFactory</code>) to be used. If not set, it uses any exposed JMS connection factory</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>destination</em></td>
<td style="text-align: left;">The name of the JMS destination. If not set the name of the channel is used</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>destination-type</em></td>
<td style="text-align: left;">The type of destination. It can be either <code>queue</code> or <code>topic</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>queue</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>durable</em></td>
<td style="text-align: left;">Set to <code>true</code> to use a durable subscription</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>no-local</em></td>
<td style="text-align: left;">Enable or disable local delivery</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em></td>
<td style="text-align: left;">The password to connect to to the JMS server</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>selector</em></td>
<td style="text-align: left;">The JMS selector</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>session-mode</em></td>
<td style="text-align: left;">The session mode. Accepted values are AUTO_ACKNOWLEDGE, SESSION_TRANSACTED, CLIENT_ACKNOWLEDGE, DUPS_OK_ACKNOWLEDGE</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>AUTO_ACKNOWLEDGE</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em></td>
<td style="text-align: left;">The username to connect to to the JMS server</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table></section><section class="print-page" id="jms-sending-jms-messages"><h1 id="jms-sending-jms-messages-sending-messages-to-jms">Sending messages to JMS</h1>
<p>The JMS Connector can send Reactive Messaging <code>Messages</code> as JMS Message.</p>
<h2 id="jms-sending-jms-messages-example">Example</h2>
<p>Letâ€™s imagine you have a <code>jakarta.jms.ConnectionFactory</code> bean exposed and
connected to your JMS server. Donâ€™t forget that itâ€™s required to use the
JMS connector.</p>
<p>Configure your application to write the messages from the <code>prices</code>
channel into a JMS Message as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-sending-jms-messages-__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.outgoing.prices.connector</span><span class="o">=</span><span class="s">smallrye-jms</span>
</code></pre></div></td></tr></table></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the destination. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>destination</code> attribute to
override it.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>By default the connector uses a <code>queue</code>. You can configure it to use a
<code>topic</code> by setting <code>destination-type=topic</code>.</p>
</div>
<p>Then, your application must send <code>Message&lt;Double&gt;</code> to the <code>prices</code>
channel. It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">jms.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JmsPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">jms.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">JmsPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()));</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="jms-sending-jms-messages-serialization">Serialization</h2>
<p>The connector serializes the incoming message payload into the body of
the outgoing JMS Message.</p>
<p>If the payload is a <code>String</code> or a primitive type, the payload is encoded
as <code>String</code> and the <code>JMSType</code> is set to the target class. The
<code>_classname</code> property is also set. The JMS Message is a <code>TextMessage</code>.</p>
<p>If the payload is a <code>byte[]</code>, itâ€™s passed as <code>byte[]</code> in a JMS
<code>BytesMessage</code>.</p>
<p>Otherwise, the payload is encoded using included JSON serializer (JSON-B
and Jackson provided OOB, for more details see <a href="#jms-sending-jms-messages-serde">Serde</a>). The
<code>JMSType</code> is set to the target class. The <code>_classname</code> property is also
set. The JMS Message is a <code>TextMessage</code>.</p>
<p>For example, the following code serialize the produced <code>Person</code> using
JSON-B.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-1">1</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-2">2</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-3">3</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-4">4</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-5">5</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-3-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;...&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;my-channel&quot;</span><span class="p">)</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Person</span><span class="w"> </span><span class="nf">sendToJms</span><span class="p">(...)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">  </span><span class="c1">// ...</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Person</span><span class="p">(</span><span class="s">&quot;bob&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">);</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>It requires that the <code>Person</code> class can be serialized to JSON. The
classname is passed in the <code>JMSType</code> property and <code>_classname</code> property.</p>
<h2 id="jms-sending-jms-messages-outbound-metadata">Outbound Metadata</h2>
<p>When sending <code>Messages</code>, you can add an instance of <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-jms/4.16.0/io/smallrye/reactive/messaging/jms/OutgoingJmsMessageMetadata.html'>OutgoingJmsMessageMetadata</a>
to influence how the message is going to be written to JMS.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-1">1</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-2">2</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-3">3</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-4">4</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-5">5</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-6">6</a></span>
<span class="normal"><a href="#jms-sending-jms-messages-__codelineno-4-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">OutgoingJmsMessageMetadata</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">OutgoingJmsMessageMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">        </span><span class="p">.</span><span class="na">withProperties</span><span class="p">(</span><span class="n">JmsProperties</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">with</span><span class="p">(</span><span class="s">&quot;some-property&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;some-value&quot;</span><span class="p">).</span><span class="na">build</span><span class="p">())</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="c1">// Create a new message from the `incoming` message</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="c1">// Add `metadata` to the metadata from the `incoming` message.</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="k">return</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">addMetadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">);</span>
</code></pre></div></td></tr></table></div>
<p>The metadata allow adding properties but also override the destination.</p>
<h2 id="jms-sending-jms-messages-acknowledgement">Acknowledgement</h2>
<p>Once the JMS message is sent to the JMS server, the message is
acknowledged. Sending a JMS message is a blocking operation. So, sending
is done on a worker thread.</p>
<h2 id="jms-sending-jms-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>client-id</em></td>
<td style="text-align: left;">The client id</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connection-factory-name</em></td>
<td style="text-align: left;">The name of the JMS connection factory  (<code>jakarta.jms.ConnectionFactory</code>) to be used. If not set, it uses any exposed JMS connection factory</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>correlation-id</em></td>
<td style="text-align: left;">The JMS Message correlation id</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delivery-delay</em></td>
<td style="text-align: left;">The delivery delay</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delivery-mode</em></td>
<td style="text-align: left;">The delivery mode. Either <code>persistent</code> or <code>non_persistent</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>destination</em></td>
<td style="text-align: left;">The name of the JMS destination. If not set the name of the channel is used</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>destination-type</em></td>
<td style="text-align: left;">The type of destination. It can be either <code>queue</code> or <code>topic</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>queue</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>disable-message-id</em></td>
<td style="text-align: left;">Omit the message id in the outbound JMS message</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>disable-message-timestamp</em></td>
<td style="text-align: left;">Omit the message timestamp in the outbound JMS message</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>merge</em></td>
<td style="text-align: left;">Whether the connector should allow multiple upstreams</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em></td>
<td style="text-align: left;">The password to connect to to the JMS server</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>priority</em></td>
<td style="text-align: left;">The JMS Message priority</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>reply-to</em></td>
<td style="text-align: left;">The reply to destination if any</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>reply-to-destination-type</em></td>
<td style="text-align: left;">The type of destination for the response. It can be either <code>queue</code> or <code>topic</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>queue</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>session-mode</em></td>
<td style="text-align: left;">The session mode. Accepted values are AUTO_ACKNOWLEDGE, SESSION_TRANSACTED, CLIENT_ACKNOWLEDGE, DUPS_OK_ACKNOWLEDGE</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>AUTO_ACKNOWLEDGE</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ttl</em></td>
<td style="text-align: left;">The JMS Message time-to-live</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em></td>
<td style="text-align: left;">The username to connect to to the JMS server</td>
<td style="text-align: center;">String</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table></section><section class="print-page" id="jms-advanced-jms"><h1 id="jms-advanced-jms-advanced-configuration">Advanced configuration</h1>
<h2 id="jms-advanced-jms-underlying-thread-pool">Underlying thread pool</h2>
<p>Lots of JMS operations are blocking and so not cannot be done on the
<em>caller</em> thread. For this reason, these blocking operations are executed
on a worker thread.</p>
<p>You can configure the thread pool providing these worker threads using
the following MicroProfile Config properties:</p>
<ul>
<li>
<p><code>smallrye.jms.threads.max-pool-size</code> - the max number of threads
    (Defaults to 10)</p>
</li>
<li>
<p><code>smallrye.jms.threads.ttl</code> - the ttl of the created threads
    (Defaults to 60 seconds)</p>
</li>
</ul>
<h2 id="jms-advanced-jms-selecting-the-connectionfactory">Selecting the ConnectionFactory</h2>
<p>The JMS Connector requires a <code>jakarta.jms.ConnectionFactory</code> to be exposed
as a CDI bean. The connector looks for a <code>jakarta.jms.ConnectionFactory</code>
and delegate the interaction with the JMS server to this factory.</p>
<p>In case you have several connection factories, you can use the
<code>@Identifier</code> qualifier on your factory to specify the name. Then, in
the channel configuration, configure the name as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#jms-advanced-jms-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#jms-advanced-jms-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#jms-advanced-jms-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#jms-advanced-jms-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#jms-advanced-jms-__codelineno-0-5">5</a></span>
<span class="normal"><a href="#jms-advanced-jms-__codelineno-0-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="c1"># Configure the connector globally</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.connector.smallrye-jms.connection-factory-name</span><span class="o">=</span><span class="s">my-factory-name</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="c1"># Configure a specific incoming channel</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.my-channel.connection-factory-name</span><span class="o">=</span><span class="s">my-factory-name</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1"># Configure a specific outgoing channel</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="na">mp.messaging.outgoing.my-channel.connection-factory-name</span><span class="o">=</span><span class="s">my-factory-name</span>
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: JMS</h1>
                        <h1 class='nav-section-title' id='section-mqtt'>
                            MQTT <a class='headerlink' href='#section-mqtt' title='Permanent link'>â†µ</a>
                        </h1>
                        <section class="print-page" id="mqtt-mqtt"><h1 id="mqtt-mqtt-mqtt-connector">MQTT Connector</h1>
<p>The MQTT connector adds support for MQTT to Reactive Messaging.</p>
<p>It lets you receive messages from an MQTT server or broker as well as
send MQTT messages. The MQTT connector is based on the <a href="https://vertx.io/docs/vertx-mqtt/java/#_vert_x_mqtt_client">Vert.x MQTT
Client</a>.</p>
<h2 id="mqtt-mqtt-introduction">Introduction</h2>
<p><a href="http://mqtt.org/">MQTT</a> is a machine-to-machine (M2M)/"Internet of
Things" connectivity protocol. It was designed as an extremely
lightweight publish/subscribe messaging transport.</p>
<p>The MQTT Connector allows consuming messages from MQTT as well as
sending MQTT messages.</p>
<h2 id="mqtt-mqtt-using-the-mqtt-connector">Using the MQTT connector</h2>
<p>To you the MQTT Connector, add the following dependency to your project:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-mqtt-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-0-3">3</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-0-4">4</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;dependency&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">  </span><span class="nt">&lt;groupId&gt;</span>io.smallrye.reactive<span class="nt">&lt;/groupId&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="w">  </span><span class="nt">&lt;artifactId&gt;</span>smallrye-reactive-messaging-mqtt<span class="nt">&lt;/artifactId&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">  </span><span class="nt">&lt;version&gt;</span>4.16.0<span class="nt">&lt;/version&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></td></tr></table></div>
<p>The connector name is: <code>smallrye-mqtt</code>.</p>
<p>So, to indicate that a channel is managed by this connector you need:
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-mqtt-__codelineno-1-1">1</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-1-2">2</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-1-3">3</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-1-4">4</a></span>
<span class="normal"><a href="#mqtt-mqtt-__codelineno-1-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># Inbound</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="na">mp.messaging.incoming.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-mqtt</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="c1"># Outbound</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="na">mp.messaging.outgoing.[channel-name].connector</span><span class="o">=</span><span class="s">smallrye-mqtt</span>
</code></pre></div></td></tr></table></div></p></section><section class="print-page" id="mqtt-receiving-mqtt-messages"><h1 id="mqtt-receiving-mqtt-messages-receiving-messages-from-mqtt">Receiving messages from MQTT</h1>
<p>The MQTT Connector connects to a MQTT broker or router, and forward the
messages to the Reactive Messaging application. It maps each of them
into Reactive Messaging <code>Messages</code>.</p>
<h2 id="mqtt-receiving-mqtt-messages-example">Example</h2>
<p>Letâ€™s imagine you have a MQTT server/broker running, and accessible
using the <code>mqtt:1883</code> address (by default it would use
<code>localhost:1883</code>). Configure your application to receive MQTT messages
on the <code>prices</code> channel as follows:</p>
<p><div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-mqtt # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.incoming.prices.host</span><span class="o">=</span><span class="s">mqtt # &lt;2&gt;</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.prices.port</span><span class="o">=</span><span class="s">1883 # &lt;3&gt;</span>
</code></pre></div></td></tr></table></div>
1.  Sets the connector for the <code>prices</code> channel
2.  Configure the broker/server host name.
3.  Configure the broker/server port. 1883 is the default.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the MQTT topic. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>topic</code> attribute to override it.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is generally recommended to set the <code>client-id</code>. By default, the connector is generating a unique <code>client-id</code>.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Message coming from MQTT have a <code>byte[]</code> payload.</p>
</div>
<p>Then, your application receives <code>Message&lt;byte[]&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-1-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">mqtt.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MqttPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">raw</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Double</span><span class="p">.</span><span class="na">parseDouble</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">raw</span><span class="p">));</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;byte[]&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#mqtt-receiving-mqtt-messages-__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">mqtt.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MqttPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The inbound topic can use the <a href="https://mosquitto.org/man/mqtt-7.html">MQTT
wildcards</a> (<code>+</code> and <code>#</code>).</p>
<h2 id="mqtt-receiving-mqtt-messages-deserialization">Deserialization</h2>
<p>The MQTT Connector does not handle the deserialization and creates a
<code>Message&lt;byte[]&gt;</code>.</p>
<h2 id="mqtt-receiving-mqtt-messages-inbound-metadata">Inbound Metadata</h2>
<p>The MQTT connector does not provide inbound metadata.</p>
<h2 id="mqtt-receiving-mqtt-messages-failure-management">Failure Management</h2>
<p>If a message produced from a MQTT message is <em>nacked</em>, a failure
strategy is applied. The MQTT connector supports 3 strategies:</p>
<ul>
<li>
<p><code>fail</code> - fail the application, no more MQTT messages will be
    processed. (default) The offset of the record that has not been
    processed correctly is not committed.</p>
</li>
<li>
<p><code>ignore</code> - the failure is logged, but the processing continue.</p>
</li>
</ul>
<h2 id="mqtt-receiving-mqtt-messages-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>auto-clean-session</em></td>
<td style="text-align: left;">Set to start with a clean session (<code>true</code> by default)</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-generated-client-id</em></td>
<td style="text-align: left;">Set if the MQTT client must generate clientId automatically</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-keep-alive</em></td>
<td style="text-align: left;">Set if the MQTT client must handle <code>PINGREQ</code> automatically</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether or not the messages should be dispatched to multiple consumers</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>buffer-size</em></td>
<td style="text-align: left;">The size buffer of incoming messages waiting to be processed</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>128</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id</em></td>
<td style="text-align: left;">Set the client identifier</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(mqtt-client-options-name)</em></td>
<td style="text-align: left;">The name of the MQTT Client Option bean (<code>io.smallrye.reactive.messaging.mqtt.session.MqttClientSessionOptions</code>) used to customize the MQTT client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connect-timeout-seconds</em></td>
<td style="text-align: left;">Set the connect timeout (in seconds)</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from a MQTT message is nacked. Values can be <code>fail</code> (default), or <code>ignore</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>fail</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em></td>
<td style="text-align: left;">Set the MQTT server host name/IP</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>keep-alive-seconds</em></td>
<td style="text-align: left;">Set the keep alive timeout in seconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>30</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-inflight-queue</em></td>
<td style="text-align: left;">Set max count of unacknowledged messages</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-message-size</em></td>
<td style="text-align: left;">Set max MQTT message size in bytes</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>8092</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em></td>
<td style="text-align: left;">Set the password to connect to the server</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em></td>
<td style="text-align: left;">Set the MQTT server port. Default to 8883 if ssl is enabled, or 1883 without ssl</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>qos</em></td>
<td style="text-align: left;">Set the QoS level when subscribing to the topic or when sending a message</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval-seconds</em></td>
<td style="text-align: left;">Set the reconnect interval in seconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>server-name</em></td>
<td style="text-align: left;">Set the SNI server name</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl</em></td>
<td style="text-align: left;">Set whether SSL/TLS is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.location</em></td>
<td style="text-align: left;">Set the keystore location. In case of <code>pem</code> type this is the server ca cert path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.password</em></td>
<td style="text-align: left;">Set the keystore password. In case of <code>pem</code> type this is the key path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.type</em></td>
<td style="text-align: left;">Set the keystore type [<code>pkcs12</code>, <code>jks</code>, <code>pem</code>]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pkcs12</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.location</em></td>
<td style="text-align: left;">Set the truststore location. In case of <code>pem</code> type this is the client cert path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.password</em></td>
<td style="text-align: left;">Set the truststore password. In case of <code>pem</code> type this is not necessary</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.type</em></td>
<td style="text-align: left;">Set the truststore type [<code>pkcs12</code>, <code>jks</code>, <code>pem</code>]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pkcs12</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">Set the MQTT topic. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-all</em></td>
<td style="text-align: left;">Set whether all server certificates should be trusted</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>unsubscribe-on-disconnection</em></td>
<td style="text-align: left;">This flag restore the old behavior to unsubscribe from the broken on disconnection</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em></td>
<td style="text-align: left;">Set the username to connect to the server</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-flag</em></td>
<td style="text-align: left;">Set if will information are provided on connection</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-qos</em></td>
<td style="text-align: left;">Set the QoS level for the will message</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-retain</em></td>
<td style="text-align: left;">Set if the will message must be retained</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
</tbody>
</table>
<p>The MQTT connector is based on the <a href="https://vertx.io/docs/vertx-mqtt/java/#_vert_x_mqtt_client">Vert.x MQTT
client</a>. So
you can pass any attribute supported by this client.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A single instance of <code>MqttClient</code> and a single connection is used for
each <code>host</code> / <code>port</code> / <code>server-name</code> / <code>client-id</code>. This client is
reused for both the inbound and outbound connectors.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Using <code>auto-clean-session=false</code> the MQTT Connector send Subscribe requests
to the broken only if a Persistent Session is not present (like on the first 
connection). This means that if a Session is already present (maybe for a 
previous run) and you add a new incoming channel, this will not be subscribed.
Beware to check always the subscription present on Broker when use 
<code>auto-clean-session=false</code>.</p>
</div></section><section class="print-page" id="mqtt-sending-messages-to-mqtt"><h1 id="mqtt-sending-messages-to-mqtt-sending-messages-to-mqtt">Sending messages to MQTT</h1>
<p>The MQTT Connector can write Reactive Messaging <code>Messages</code> as MQTT
Message.</p>
<h2 id="mqtt-sending-messages-to-mqtt-example">Example</h2>
<p>Letâ€™s imagine you have a MQTT server/broker running, and accessible
using the <code>mqtt:1883</code> address (by default it would use
<code>localhost:1883</code>). Configure your application to write the messages from
the <code>prices</code> channel into a MQTT Messages as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-0-1">1</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-0-2">2</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">mp.messaging.outgoing.prices.type</span><span class="o">=</span><span class="s">smallrye-mqtt</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="na">mp.messaging.outgoing.prices.host</span><span class="o">=</span><span class="s">mqtt</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.outgoing.prices.port</span><span class="o">=</span><span class="s">1883</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>Sets the connector for the <code>prices</code> channel</li>
<li>Configure the broker/server host name.</li>
<li>Configure the broker/server port. 1883 is the default.</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You donâ€™t need to set the MQTT topic. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>topic</code> attribute to override it.
NOTE: It is generally recommended to set the <code>client-id</code>. By default,
the connector is generating a unique <code>client-id</code>.</p>
</div>
<p>Then, your application must send <code>Message&lt;Double&gt;</code> to the <code>prices</code>
channel. It can use <code>double</code> payloads as in the following snippet:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-10">10</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-11">11</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-12">12</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-13">13</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-14">14</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-15">15</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-16">16</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-17">17</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-18">18</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-19">19</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-20">20</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-21">21</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-22">22</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-23">23</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-24">24</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-1-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">mqtt.outbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MqttPriceProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">());</span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a id="__codelineno-1-25" name="__codelineno-1-25"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can send <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-10">10</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-11">11</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-12">12</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-13">13</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-14">14</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-15">15</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-16">16</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-17">17</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-18">18</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-19">19</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-20">20</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-21">21</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-22">22</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-23">23</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-24">24</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-25">25</a></span>
<span class="normal"><a href="#mqtt-sending-messages-to-mqtt-__codelineno-2-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">mqtt.outbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.time.Duration</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Random</span><span class="p">;</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Outgoing</span><span class="p">;</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Multi</span><span class="p">;</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MqttPriceMessageProducer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Random</span><span class="w"> </span><span class="n">random</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Random</span><span class="p">();</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">    </span><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Multi</span><span class="o">&lt;</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">generate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">        </span><span class="c1">// Build an infinite stream of random prices</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">        </span><span class="c1">// It emits a price every second</span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Multi</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">ticks</span><span class="p">().</span><span class="na">every</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofSeconds</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">                </span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Message</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">random</span><span class="p">.</span><span class="na">nextDouble</span><span class="p">()));</span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="mqtt-sending-messages-to-mqtt-serialization">Serialization</h2>
<p>The <code>Message</code> sent to MQTT can have various payload types:</p>
<ul>
<li>
<p><a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonObject.html"><code>JsonObject</code></a>:
    JSON string encoded as <code>byte[]</code></p>
</li>
<li>
<p><a href="https://vertx.io/docs/apidocs/io/vertx/core/json/JsonArray.html"><code>JsonArray</code></a>:
    JSON string encoded as <code>byte[]</code></p>
</li>
<li>
<p><code>java.lang.String</code> and Java primitive types: <code>toString</code> encoded as
    <code>byte[]</code></p>
</li>
<li>
<p><code>byte[]</code></p>
</li>
<li>
<p>complex objects: The objects are encoded to JSON and passed as
    <code>byte[]</code></p>
</li>
</ul>
<h2 id="mqtt-sending-messages-to-mqtt-outbound-metadata">Outbound Metadata</h2>
<p>The MQTT connector does not provide outbound metadata.</p>
<h2 id="mqtt-sending-messages-to-mqtt-acknowledgement">Acknowledgement</h2>
<p>MQTT acknowledgement depends on the QoS level. The message is
acknowledged when the broker indicated the successful reception of the
message (or immediately if the level of QoS does not support
acknowledgment).</p>
<p>If a MQTT message cannot be sent to the broker, the message is <code>nacked</code>.</p>
<h2 id="mqtt-sending-messages-to-mqtt-configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>auto-clean-session</em></td>
<td style="text-align: left;">Set to start with a clean session (<code>true</code> by default)</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-generated-client-id</em></td>
<td style="text-align: left;">Set if the MQTT client must generate clientId automatically</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto-keep-alive</em></td>
<td style="text-align: left;">Set if the MQTT client must handle <code>PINGREQ</code> automatically</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id</em></td>
<td style="text-align: left;">Set the client identifier</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-options-name</em> <em>(mqtt-client-options-name)</em></td>
<td style="text-align: left;">The name of the MQTT Client Option bean (<code>io.smallrye.reactive.messaging.mqtt.session.MqttClientSessionOptions</code>) used to customize the MQTT client configuration</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>connect-timeout-seconds</em></td>
<td style="text-align: left;">Set the connect timeout (in seconds)</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>host</em></td>
<td style="text-align: left;">Set the MQTT server host name/IP</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>keep-alive-seconds</em></td>
<td style="text-align: left;">Set the keep alive timeout in seconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>30</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-inflight-queue</em></td>
<td style="text-align: left;">Set max count of unacknowledged messages</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-message-size</em></td>
<td style="text-align: left;">Set max MQTT message size in bytes</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>8092</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>merge</em></td>
<td style="text-align: left;">Whether the connector should allow multiple upstreams</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>password</em></td>
<td style="text-align: left;">Set the password to connect to the server</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>port</em></td>
<td style="text-align: left;">Set the MQTT server port. Default to 8883 if ssl is enabled, or 1883 without ssl</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>qos</em></td>
<td style="text-align: left;">Set the QoS level when subscribing to the topic or when sending a message</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>reconnect-interval-seconds</em></td>
<td style="text-align: left;">Set the reconnect interval in seconds</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>server-name</em></td>
<td style="text-align: left;">Set the SNI server name</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl</em></td>
<td style="text-align: left;">Set whether SSL/TLS is enabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.location</em></td>
<td style="text-align: left;">Set the keystore location. In case of <code>pem</code> type this is the server ca cert path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.password</em></td>
<td style="text-align: left;">Set the keystore password. In case of <code>pem</code> type this is the key path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.keystore.type</em></td>
<td style="text-align: left;">Set the keystore type [<code>pkcs12</code>, <code>jks</code>, <code>pem</code>]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pkcs12</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.location</em></td>
<td style="text-align: left;">Set the truststore location. In case of <code>pem</code> type this is the client cert path</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.password</em></td>
<td style="text-align: left;">Set the truststore password. In case of <code>pem</code> type this is not necessary</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>ssl.truststore.type</em></td>
<td style="text-align: left;">Set the truststore type [<code>pkcs12</code>, <code>jks</code>, <code>pem</code>]</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>pkcs12</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">Set the MQTT topic. If not set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>trust-all</em></td>
<td style="text-align: left;">Set whether all server certificates should be trusted</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>unsubscribe-on-disconnection</em></td>
<td style="text-align: left;">This flag restore the old behavior to unsubscribe from the broken on disconnection</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>username</em></td>
<td style="text-align: left;">Set the username to connect to the server</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-flag</em></td>
<td style="text-align: left;">Set if will information are provided on connection</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-qos</em></td>
<td style="text-align: left;">Set the QoS level for the will message</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>will-retain</em></td>
<td style="text-align: left;">Set if the will message must be retained</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
</tbody>
</table>
<p>The MQTT connector is based on the <a href="https://vertx.io/docs/vertx-mqtt/java/#_vert_x_mqtt_client">Vert.x MQTT
client</a>. So
you can pass any attribute supported by this client.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>A single instance of <code>MqttClient</code> and a single connection is used for
each <code>host</code> / <code>port</code> / <code>server-name</code> / <code>client-id</code>. This client is
reused for both the inbound and outbound connectors.</p>
</div></section><section class="print-page" id="mqtt-client-customization"><h1 id="mqtt-client-customization-customizing-the-underlying-mqtt-client">Customizing the underlying MQTT client</h1>
<p>You can customize the underlying MQTT Client configuration by
<em>producing</em> an instance of
<code>io.smallrye.reactive.messaging.mqtt.session.MqttClientSessionOptions</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-client-customization-__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-10">10</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-11">11</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-12">12</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-13">13</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-14">14</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-15">15</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-16">16</a></span>
<span class="normal"><a href="#mqtt-client-customization-__codelineno-0-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nd">@Produces</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-options&quot;</span><span class="p">)</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">MqttClientSessionOptions</span><span class="w"> </span><span class="nf">getOptions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="w">    </span><span class="c1">// You can use the produced options to configure the TLS connection</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="w">    </span><span class="n">PemKeyCertOptions</span><span class="w"> </span><span class="n">keycert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemKeyCertOptions</span><span class="p">()</span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">            </span><span class="p">.</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.crt&quot;</span><span class="p">)</span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">            </span><span class="p">.</span><span class="na">addKeyPath</span><span class="p">(</span><span class="s">&quot;./tls/tls.key&quot;</span><span class="p">);</span>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">    </span><span class="n">PemTrustOptions</span><span class="w"> </span><span class="n">trust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PemTrustOptions</span><span class="p">().</span><span class="na">addCertPath</span><span class="p">(</span><span class="s">&quot;./tlc/ca.crt&quot;</span><span class="p">);</span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MqttClientSessionOptions</span><span class="p">()</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">            </span><span class="p">.</span><span class="na">setSsl</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemKeyCertOptions</span><span class="p">(</span><span class="n">keycert</span><span class="p">)</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">            </span><span class="p">.</span><span class="na">setPemTrustOptions</span><span class="p">(</span><span class="n">trust</span><span class="p">)</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">            </span><span class="p">.</span><span class="na">setHostnameVerificationAlgorithm</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">            </span><span class="p">.</span><span class="na">setConnectTimeout</span><span class="p">(</span><span class="mi">30000</span><span class="p">)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">            </span><span class="p">.</span><span class="na">setReconnectInterval</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>This instance is retrieved and used to configure the client used by the
connector. You need to indicate the name of the client using the
<code>client-options-name</code> attribute:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#mqtt-client-customization-__codelineno-1-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="na">mp.messaging.incoming.prices.client-options-name</span><span class="o">=</span><span class="s">my-options</span>
</code></pre></div></td></tr></table></div></section><h1 class='nav-section-title-end'>Ended: MQTT</h1></div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" alt="Red Hat" src="https://github.com/jbossorg/website/raw/master/docs/img/redhat_reversed.svg"/></a> <br/> <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "/smallrye-reactive-messaging/4.16.0", "features": ["navigation.sections", "navigation.tracking", "navigation.indexes"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../assets/javascripts/bundle.81fa17fe.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
    
  </body>
</html>