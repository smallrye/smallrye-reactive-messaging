
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://smallrye.io/smallrye-reactive-messaging/4.30.0/kafka/receiving-kafka-records/">
      
      
        <link rel="prev" href="../kafka/">
      
      
        <link rel="next" href="../writing-kafka-records/">
      
      
      <link rel="icon" href="../../images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.8">
    
    
      
        <title>Receiving records - SmallRye Reactive Messaging</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.4b4a2bd9.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.356b1318.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Red+Hat+Text:300,300i,400,400i,700,700i%7CUbuntu+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Red Hat Text";--md-code-font:"Ubuntu Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../../css/print-site.css">
    
      <link rel="stylesheet" href="../../css/print-site-material.css">
    
      <link rel="stylesheet" href="../../css/smallrye.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#receiving-kafka-records" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SmallRye Reactive Messaging" class="md-header__button md-logo" aria-label="SmallRye Reactive Messaging" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SmallRye Reactive Messaging
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Receiving records
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_3" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m14.3 16-.7-2h-3.2l-.7 2H7.8L11 7h2l3.2 9h-1.9M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69m-9.15 3.96h2.3L12 9l-1.15 3.65Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="blue-grey" data-md-color-accent="blue"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_3">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/smallrye/smallrye-reactive-messaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SmallRye Reactive Messaging" class="md-nav__button md-logo" aria-label="SmallRye Reactive Messaging" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    SmallRye Reactive Messaging
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/smallrye/smallrye-reactive-messaging" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Core
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Concepts
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Concepts
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/model/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Development Model
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/emitter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Emitters and Channel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connectors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/contributing-connectors/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Contributing Connectors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/acknowledgement/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Acknowledgement
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/blocking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Blocking Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/signatures/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Method Signatures
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/skipping/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Skipping Messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/converters/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Message Converters
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/keyed-multi/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Keyed Streams
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/decorators/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Channel Decorators and Interceptors
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/broadcast/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Broadcast
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/merge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Merge channels
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/incoming-concurrency/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Incoming Channel Concurrency
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/incomings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    @Incomings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/outgoings/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    @Outgoings
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/testing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/logging/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/observability/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Observability API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/advanced-config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/message-context/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Message Context
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/incoming-metadata-injection/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Metadata Injection
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/generic-payloads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generic Payloads
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/pausable-channels/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pausable Channels
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Kafka
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Kafka
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kafka/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Kafka Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Receiving records
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Receiving records
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deserialization" class="md-nav__link">
    Deserialization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inbound-metadata" class="md-nav__link">
    Inbound Metadata
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgement" class="md-nav__link">
    Acknowledgement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failure-management" class="md-nav__link">
    Failure Management
  </a>
  
    <nav class="md-nav" aria-label="Failure Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dead-letter-queue" class="md-nav__link">
    Dead Letter Queue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delayed-retry-topic" class="md-nav__link">
    Delayed Retry Topic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-commit-and-failure-strategies" class="md-nav__link">
    Custom commit and failure strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrying-processing" class="md-nav__link">
    Retrying processing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-deserialization-failures" class="md-nav__link">
    Handling deserialization failures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#receiving-cloud-events" class="md-nav__link">
    Receiving Cloud Events
  </a>
  
    <nav class="md-nav" aria-label="Receiving Cloud Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary-cloud-events" class="md-nav__link">
    Binary Cloud Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structured-cloud-events" class="md-nav__link">
    Structured Cloud Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consumer-rebalance-listener" class="md-nav__link">
    Consumer Rebalance Listener
  </a>
  
    <nav class="md-nav" aria-label="Consumer Rebalance Listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#receiving-kafka-records-in-batches" class="md-nav__link">
    Receiving Kafka Records in Batches
  </a>
  
    <nav class="md-nav" aria-label="Receiving Kafka Records in Batches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accessing-metadata-of-batch-records" class="md-nav__link">
    Accessing metadata of batch records
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-topic-partition-assignment" class="md-nav__link">
    Manual topic-partition assignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stateful-processing-with-checkpointing" class="md-nav__link">
    Stateful processing with Checkpointing
  </a>
  
    <nav class="md-nav" aria-label="Stateful processing with Checkpointing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-state-stores" class="md-nav__link">
    Implementing State Stores
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-reference" class="md-nav__link">
    Configuration Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../writing-kafka-records/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Writing records
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../avro-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Avro
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../protobuf-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using Protobuf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../consumer-rebalance-listener/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Rebalance Listeners
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../kerberos/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kerberos authentication
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../client-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing the client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../default-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customizing Default Kafka Configuration
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../test-companion/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Test Companion for Kafka
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../transactions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Transactions and Exactly-Once Processing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../request-reply/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Kafka Request/Reply
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AMQP 1.0
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            AMQP 1.0
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/amqp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AMQP 1.0 Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/receiving-amqp-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/sending-amqp-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../amqp/rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using RabbitMQ
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    RabbitMQ
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            RabbitMQ
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RabbitMQ Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/receiving-messages-from-rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/sending-messages-to-rabbitmq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/rabbitmq-health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/rabbitmq-client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Client Customization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../rabbitmq/rabbitmq-cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Connecting to managed instances
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Pulsar
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Pulsar
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/pulsar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Pulsar Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/receiving-pulsar-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/sending-messages-to-pulsar/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/schema-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring the Schema
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/client-configuration/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Configuring the Pulsar client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/health/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Health Checks
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/client-service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accessing the client
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../pulsar/transactions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Pulsar Transactions and Exactly-Once Processing
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Apache Camel
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Apache Camel
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../camel/camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Apache Camel Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../camel/receiving-messages-from-camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving messages from Camel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../camel/sending-messages-to-camel/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending messages to Camel
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../camel/camel-processor/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Implementing Camel processor
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../camel/using-existing-routes/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Using existing Camel routes
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  <span class="md-ellipsis">
    JMS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            JMS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../jms/jms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    The JMS connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../jms/receiving-jms-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving JMS messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../jms/sending-jms-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending JMS messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../jms/advanced-jms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Advanced configuration
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="">
            
  
  <span class="md-ellipsis">
    MQTT
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            MQTT
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/mqtt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    MQTT Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/receiving-mqtt-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving MQTT messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/sending-messages-to-mqtt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending MQTT messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/client-customization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Customizing the MQTT client
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AWS SQS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            AWS SQS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sqs/sqs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS SQS Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sqs/receiving-aws-sqs-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Receiving AWS SQS messages
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sqs/sending-aws-sqs-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending AWS SQS messages
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
    
    
    
    
      
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="">
            
  
  <span class="md-ellipsis">
    AWS SNS
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            AWS SNS
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sns/sns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AWS SNS Connector
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sns/sending-aws-sns-messages/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Sending AWS SNS messages
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deserialization" class="md-nav__link">
    Deserialization
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inbound-metadata" class="md-nav__link">
    Inbound Metadata
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#acknowledgement" class="md-nav__link">
    Acknowledgement
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#failure-management" class="md-nav__link">
    Failure Management
  </a>
  
    <nav class="md-nav" aria-label="Failure Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dead-letter-queue" class="md-nav__link">
    Dead Letter Queue
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#delayed-retry-topic" class="md-nav__link">
    Delayed Retry Topic
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-commit-and-failure-strategies" class="md-nav__link">
    Custom commit and failure strategies
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#retrying-processing" class="md-nav__link">
    Retrying processing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-deserialization-failures" class="md-nav__link">
    Handling deserialization failures
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#receiving-cloud-events" class="md-nav__link">
    Receiving Cloud Events
  </a>
  
    <nav class="md-nav" aria-label="Receiving Cloud Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#binary-cloud-events" class="md-nav__link">
    Binary Cloud Events
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#structured-cloud-events" class="md-nav__link">
    Structured Cloud Events
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#consumer-rebalance-listener" class="md-nav__link">
    Consumer Rebalance Listener
  </a>
  
    <nav class="md-nav" aria-label="Consumer Rebalance Listener">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example_1" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#receiving-kafka-records-in-batches" class="md-nav__link">
    Receiving Kafka Records in Batches
  </a>
  
    <nav class="md-nav" aria-label="Receiving Kafka Records in Batches">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#accessing-metadata-of-batch-records" class="md-nav__link">
    Accessing metadata of batch records
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-topic-partition-assignment" class="md-nav__link">
    Manual topic-partition assignment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#stateful-processing-with-checkpointing" class="md-nav__link">
    Stateful processing with Checkpointing
  </a>
  
    <nav class="md-nav" aria-label="Stateful processing with Checkpointing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#implementing-state-stores" class="md-nav__link">
    Implementing State Stores
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration-reference" class="md-nav__link">
    Configuration Reference
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="receiving-kafka-records">Receiving Kafka Records</h1>
<p>The Kafka Connector retrieves Kafka Records from Kafka Brokers and maps
each of them to Reactive Messaging <code>Messages</code>.</p>
<h2 id="example">Example</h2>
<p>Let’s imagine you have a Kafka broker running, and accessible using the
<code>kafka:9092</code> address (by default it would use <code>localhost:9092</code>).
Configure your application to receive Kafka records from a Kafka <em>topic</em>
on the <code>prices</code> channel as follows:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="na">kafka.bootstrap.servers</span><span class="o">=</span><span class="s">kafka:9092 # &lt;1&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="na">mp.messaging.incoming.prices.connector</span><span class="o">=</span><span class="s">smallrye-kafka # &lt;2&gt;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><span class="na">mp.messaging.incoming.prices.value.deserializer</span><span class="o">=</span><span class="s">org.apache.kafka.common.serialization.DoubleDeserializer # &lt;3&gt;</span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="na">mp.messaging.incoming.prices.broadcast</span><span class="o">=</span><span class="s">true # &lt;4&gt;</span>
</code></pre></div></td></tr></table></div>
<ol>
<li>
<p>Configure the broker location. You can configure it globally or per
    channel</p>
</li>
<li>
<p>Configure the connector to manage the <code>prices</code> channel</p>
</li>
<li>
<p>Sets the (Kafka) deserializer to read the record’s value</p>
</li>
<li>
<p>Make sure that we can receive from more than one consumer (see
    <code>KafkaPriceConsumer</code> and <code>KafkaPriceMessageConsumer</code> below)</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You don’t need to set the Kafka topic. By default, it uses the channel
name (<code>prices</code>). You can configure the <code>topic</code> attribute to override it.</p>
</div>
<p>Then, your application receives <code>Message&lt;Double&gt;</code>. You can consume the
payload directly:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span>
<span class="normal"><a href="#__codelineno-2-15">15</a></span>
<span class="normal"><a href="#__codelineno-2-16">16</a></span>
<span class="normal"><a href="#__codelineno-2-17">17</a></span>
<span class="normal"><a href="#__codelineno-2-18">18</a></span>
<span class="normal"><a href="#__codelineno-2-19">19</a></span>
<span class="normal"><a href="#__codelineno-2-20">20</a></span>
<span class="normal"><a href="#__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaPriceMessageConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">price</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="w">        </span><span class="c1">// process your price.</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">        </span><span class="c1">// Acknowledge the incoming message (commit the offset)</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">price</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="deserialization">Deserialization</h2>
<p>The deserialization is handled by the underlying Kafka Client. You need
to configure the:</p>
<ul>
<li>
<p><code>mp.messaging.incoming.[channel-name].value.deserializer</code> to
    configure the value deserializer (mandatory)</p>
</li>
<li>
<p><code>mp.messaging.incoming.[channel-name].key.deserializer</code> to configure
    the key deserializer (optional, default to <code>String</code>)</p>
</li>
</ul>
<p>If you want to use a custom deserializer, add it to your <code>CLASSPATH</code> and
configure the associate attribute.</p>
<p>In addition, the Kafka Connector also provides a set of <em>message
converters</em>. So you can receive <em>payloads</em> representing records from
Kafka using:</p>
<ul>
<li><a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/Record.html'>Record</a> - a pair key/value</li>
<li><a href="https://kafka.apache.org/26/javadoc/index.html?org/apache/kafka/clients/consumer/ConsumerRecord.html">ConsumerRecord<K,V></a> -
    a structure representing the record with all its metadata</li>
</ul>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;topic-a&quot;</span><span class="p">)</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Record</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">key</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no key</span>
<a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no value</span>
<a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">}</span>
<a id="__codelineno-3-6" name="__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;topic-b&quot;</span><span class="p">)</span>
<a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-9" name="__codelineno-3-9"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">key</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no key</span>
<a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">value</span><span class="p">();</span><span class="w"> </span><span class="c1">// Can be `null` if the incoming record has no value</span>
<a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">topic</span><span class="p">();</span>
<a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">();</span>
<a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="inbound-metadata">Inbound Metadata</h2>
<p>Messages coming from Kafka contains an instance of
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/api/IncomingKafkaRecordMetadata.html'>IncomingKafkaRecordMetadata</a>
in the metadata. It provides the key, topic, partitions,
headers and so on:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">IncomingKafkaRecordMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">incoming</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingKafkaRecordMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">        </span><span class="p">.</span><span class="na">orElse</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metadata</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="c1">// The topic</span>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTopic</span><span class="p">();</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="c1">// The key</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getKey</span><span class="p">();</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="c1">// The timestamp</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">    </span><span class="n">Instant</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getTimestamp</span><span class="p">();</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="c1">// The underlying record</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getRecord</span><span class="p">();</span>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="c1">// ...</span>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="acknowledgement">Acknowledgement</h2>
<p>When a message produced from a Kafka record is acknowledged, the
connector invokes a <em>commit strategy</em>. These strategies decide when the
consumer offset for a specific topic/partition is committed. Committing
an offset indicates that all previous records have been processed. It is
also the position where the application would restart the processing
after a crash recovery or a restart.</p>
<p>Committing every offset has performance penalties as Kafka offset
management can be slow. However, not committing the offset often enough
may lead to message duplication if the application crashes between two
commits.</p>
<p>The Kafka connector supports three strategies:</p>
<ul>
<li>
<p><code>throttled</code> keeps track of received messages and commit to the next
    offset after the latest <em>acked</em> message in sequence. This strategy
    guarantees <em>at-least-once delivery</em> even if the channel performs
    asynchronous processing. The connector tracks the received records
    and periodically (period specified by <code>auto.commit.interval.ms</code>
    (default: 5000)) commits the highest consecutive offset. The
    connector will be marked as unhealthy if a message associated with a
    record is not acknowledged in
    <code>throttled.unprocessed-record-max-age.ms</code> (default: 60000). Indeed,
    this strategy cannot commit the offset as soon as a single record
    processing fails (see failure-strategy to configure what happens on
    failing processing). If <code>throttled.unprocessed-record-max-age.ms</code> is
    set to less than or equal to 0, it does not perform any health check
    verification. Such a setting might lead to running out of memory if
    there are poison pill messages. This strategy is the default if
    <code>enable.auto.commit</code> is not explicitly set to <code>true</code>.</p>
</li>
<li>
<p><code>checkpoint</code> allows persisting consumer offsets on a "state store",
    instead of committing them back to the Kafka broker. Using the
    <code>CheckpointMetadata</code> API, consumer code can persist a processing
    state with the offset to mark the progress of a consumer.
    When the processing continues from a previously persisted offset,
    it seeks the Kafka consumer to that offset and also restores the
    persisted state, continuing the stateful processing from where it
    left off. The <code>checkpoint</code> strategy holds locally the processing
    state associated with the latest offset, and persists it
    periodically to the state store (period specified by
    <code>auto.commit.interval.ms</code> (default: 5000)). The connector will be
    marked as unhealthy if no processing state is persisted to the state
    store in <code>checkpoint.unsynced-state-max-age.ms</code> (default: 10000).
    Using the <code>CheckpointMetadata</code> API the user code can force to persist
    the state on message ack. If <code>checkpoint.unsynced-state-max-age.ms</code>
    is set to less than or equal to 0, it does not perform any health
    check verification. For more information, see
    <a href="#stateful-processing-with-checkpointing">Stateful processing with Checkpointing</a></p>
</li>
<li>
<p><code>latest</code> commits the record offset received by the Kafka consumer as
    soon as the associated message is acknowledged (if the offset is
    higher than the previously committed offset). This strategy provides
    <em>at-least-once</em> delivery if the channel processes the message
    without performing any asynchronous processing. This strategy should
    not be used on high-load as offset commit is expensive. However, it
    reduces the risk of duplicates.</p>
</li>
<li>
<p><code>ignore</code> performs no commit. This strategy is the default strategy
    when the consumer is explicitly configured with <code>enable.auto.commit</code>
    to <code>true</code>. It delegates the offset commit to the Kafka client. When
    <code>enable.auto.commit</code> is <code>true</code> this strategy <strong>DOES NOT</strong> guarantee
    at-least-once delivery. However, if the processing failed between
    two commits, messages received after the commit and before the
    failure will be re-processed.</p>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The Kafka connector disables the Kafka <em>auto commit</em> if not explicitly
enabled. This behavior differs from the traditional Kafka consumer.</p>
</div>
<p>If high-throughout is important for you, and not limited by the
downstream, we recommend to either:</p>
<ul>
<li>Use the <code>throttled</code> policy</li>
<li>or set <code>enable.auto.commit</code> to <code>true</code> and annotate the consuming
    method with <code>@Acknowledgment(Acknowledgment.Strategy.NONE)</code></li>
</ul>
<h2 id="failure-management">Failure Management</h2>
<p>If a message produced from a Kafka record is <em>nacked</em>, a failure
strategy is applied. The Kafka connector supports 3 strategies:</p>
<ul>
<li>
<p><code>fail</code> - fail the application, no more records will be processed.
    (default) The offset of the record that has not been processed
    correctly is not committed.</p>
</li>
<li>
<p><code>ignore</code> - the failure is logged, but the processing continue. The
    offset of the record that has not been processed correctly is
    committed.</p>
</li>
<li>
<p><code>dead-letter-queue</code> - the offset of the record that has not been
    processed correctly is committed, but the record is written to a
    (Kafka) <em>dead letter queue</em> topic.</p>
</li>
<li>
<p><code>delayed-retry-topic</code> - the offset of the record that has not been
    processed correctly is still committed, but the record is written to
    a series of Kafka topics for retrying the processing with some delay.
    This allows retrying failed records by reconsuming them later without
    blocking the processing of the latest records.</p>
</li>
</ul>
<p>The strategy is selected using the <code>failure-strategy</code> attribute.</p>
<h3 id="dead-letter-queue">Dead Letter Queue</h3>
<p>In the case of <code>dead-letter-queue</code>, you can configure the following
attributes:</p>
<ul>
<li><code>dead-letter-queue.topic</code>: the topic to use to write the records not
    processed correctly, default is <code>dead-letter-topic-$channel</code>, with
    <code>$channel</code> being the name of the channel.</li>
<li>
<p><code>dead-letter-queue.producer-client-id</code>: the client id used by the kafka
producer when sending records to dead letter queue topic. If not specified
it will default to <code>kafka-dead-letter-topic-producer-$client-id</code>, with $client-id
being the value obtained from consumer client id.</p>
</li>
<li>
<p><code>dead-letter-queue.key.serializer</code>: the serializer used to write the
    record key on the dead letter queue. By default, it deduces the
    serializer from the key deserializer.</p>
</li>
<li>
<p><code>dead-letter-queue.value.serializer</code>: the serializer used to write
    the record value on the dead letter queue. By default, it deduces
    the serializer from the value deserializer.</p>
</li>
</ul>
<p>The record written on the dead letter topic contains the original
record’s headers, as well as a set of additional headers about the
original record:</p>
<ul>
<li>
<p><code>dead-letter-reason</code> - the reason of the failure (the <code>Throwable</code>
    passed to <code>nack()</code>)</p>
</li>
<li>
<p><code>dead-letter-cause</code> - the cause of the failure (the <code>getCause()</code> of
    the <code>Throwable</code> passed to <code>nack()</code>), if any</p>
</li>
<li>
<p><code>dead-letter-topic</code> - the original topic of the record</p>
</li>
<li>
<p><code>dead-letter-partition</code> - the original partition of the record
    (integer mapped to String)</p>
</li>
<li>
<p><code>dead-letter-offset</code> - the original offset of the record (long
    mapped to String)</p>
</li>
</ul>
<p>When using <code>dead-letter-queue</code>, it is also possible to change some
metadata of the record that is sent to the dead letter topic. To do
that, use the <code>Message.nack(Throwable, Metadata)</code> method:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span>
<span class="normal"><a href="#__codelineno-5-5">5</a></span>
<span class="normal"><a href="#__codelineno-5-6">6</a></span>
<span class="normal"><a href="#__codelineno-5-7">7</a></span>
<span class="normal"><a href="#__codelineno-5-8">8</a></span>
<span class="normal"><a href="#__codelineno-5-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;in&quot;</span><span class="p">)</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">nack</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">Exception</span><span class="p">(</span><span class="s">&quot;Failed!&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">Metadata</span><span class="p">.</span><span class="na">of</span><span class="p">(</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="n">OutgoingKafkaRecordMetadata</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">                    </span><span class="p">.</span><span class="na">withKey</span><span class="p">(</span><span class="s">&quot;failed-record&quot;</span><span class="p">)</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">                    </span><span class="p">.</span><span class="na">withHeaders</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">RecordHeaders</span><span class="p">()</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">                            </span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;my-header&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;my-header-value&quot;</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">)))</span>
<a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">                    </span><span class="p">.</span><span class="na">build</span><span class="p">()));</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>Metadata</code> may contain an instance of <code>OutgoingKafkaRecordMetadata</code>.
If the instance is present, the following properties will be used:</p>
<ul>
<li>
<p>key; if not present, the original record’s key will be used</p>
</li>
<li>
<p>topic; if not present, the configured dead letter topic will be used</p>
</li>
<li>
<p>partition; if not present, partition will be assigned automatically</p>
</li>
<li>
<p>headers; combined with the original record’s headers, as well as the
    <code>dead-letter-*</code> headers described above</p>
</li>
</ul>
<h3 id="delayed-retry-topic">Delayed Retry Topic</h3>
<div class="admonition experimental">
<p class="admonition-title">Experimental</p>
<p>Delayed retry topic feature is experimental.</p>
</div>
<p>The delayed retry topic strategy allows failed records to be automatically retried by forwarding them to a series of retry topics.
Each retry topic is associated with a specific delay time, which is expressed in milliseconds.
When a record processing fails, it is forwarded to the first retry topic.
The failure strategy then consumes these records and dispatches them to be retried again once the delay time of the topic has elapsed.</p>
<p>If the processing of a record fails again, the message is forwarded to the next topic in the list, with possibly a longer delay time.
If the processing of a record keeps failing, it will eventually be abandoned.
Alternatively, if the <code>dead-letter-queue.topic</code> property is configured, the record will be sent to the dead letter queue.</p>
<p>The Kafka producer client used when forwarding records to retry topics can be configured using the <em>dead-letter-queue</em> properties
namely, <code>dead-letter-queue.producer-client-id</code>, <code>dead-letter-queue.key.serializer</code> and <code>dead-letter-queue.value.serializer</code>.</p>
<p>Delayed retry topics and delays can be configured with following attributes:</p>
<ul>
<li>
<p><code>delayed-retry-topic.topics</code> :
The comma-separated list of retry topics, each one suffixed with <code>_[DELAY_IN_MILLISECONDS]</code> for indicating the delay time.
For example, <code>my_retry_topic_2000,my_retry_topic_4000,my_retry_topic_10000</code> will use three topics
<em>my_retry_topic_2000</em>, <em>my_retry_topic_4000</em> and <em>my_retry_topic_10000</em>, with 2000ms 4000ms and 10000ms respectively.</p>
<p>If not configured the source channel name is used, with 10, 20 and 50 seconds of delay,
ex. for a channel named <code>source</code>, retry topics will be <code>source_retry_10000</code>, <code>source_retry_20000</code>, <code>source_retry_50000</code>.</p>
</li>
<li>
<p><code>delayed-retry-topic.max-retries</code> :
The maximum number of retries before abandoning the retries.
If configured higher than the number of retry topics the last topic is used until maximum number of retries is reached.
This can be configured to use a single retry topic with a fixed delay and multiple retries.</p>
<p>For example, <code>delayed-retry-topic.topics=source_retry_10000</code> and <code>delayed-retry-topic.max-retries=4</code> will forward failed records
to the topic <em>source_retry_10000</em> with maximum of 4 retries.</p>
</li>
<li>
<p><code>delayed-retry-topic.timeout</code> :
The global timeout in milliseconds for a retried record.
The timeout is calculated from the first failure for a record.
If the next retry will reach the timeout, instead of forwarding to the retry topic the retry is abandoned and,
if configured, the record is forwarded to the dead letter queue.</p>
<p>The default is 120 seconds.</p>
</li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>While you can use <a href="#retrying-processing">Smallrye Fault Tolerance to retry processing</a>,
it will block the processing of further messages until the retried record is processed successfully, or abandoned.</p>
<p>Delayed retry topic failure strategy allows effectively implementing non-blocking retries.
But it will not preserve the order of messages inside a topic-partition.</p>
</div>
<p>The record written on the delayed retry topics will preserve the key and partition of the original record.
It also contains the original record’s headers, as well as a set of additional headers about the original record:</p>
<ul>
<li><code>delayed-retry-count</code> the current number of retries</li>
<li><code>delayed-retry-original-timestamp</code> the original timestamp of the record</li>
<li><code>delayed-retry-first-processing-timestamp</code> the first processing timestamp of the record</li>
<li><code>delayed-retry-reason</code> the reason of the failure (the <code>Throwable</code> passed to <code>nack()</code>)</li>
<li><code>delayed-retry-cause</code> the cause of the failure (the <code>getCause()</code> of the <code>Throwable</code> passed to <code>nack()</code>), if any</li>
<li><code>delayed-retry-topic</code> the original topic of the record</li>
<li><code>delayed-retry-partition</code> the original partition of the record</li>
<li><code>delayed-retry-offset</code> the original offset of the record</li>
<li><code>delayed-retry-exception-class-name</code> the class name of the throwable passed to <code>nack()</code></li>
<li><code>delayed-retry-cause-class-name</code> the class name of the the <code>getCause()</code> of the <code>Throwable</code> passed to <code>nack()</code>, if any</li>
</ul>
<p>As for the dead letter queue it is possible to change forwarded values by providing a <code>OutgoingKafkaRecordMetadata</code>
when the message is nacked using <code>Message.nack(Throwable, Metadata)</code>.</p>
<div class="admonition note">
<p class="admonition-title">Multiple partitions</p>
<p>The delayed retry topic strategy does not create retry topics automatically.
If the source topic has multiple partitions, delayed retry and dead letter queue topics would need to be setup with the same number of partitions.</p>
<p>It is possible to scale consumer application instances according to the number of partitions.
But it is not guaranteed that the retry topics consumer will be assigned the same partition(s) as the main topic consumer.
Therefore, retry processing of a record can happen in an other instance.</p>
</div>
<h2 id="custom-commit-and-failure-strategies">Custom commit and failure strategies</h2>
<p>In addition to provided strategies, it is possible to implement custom
commit and failure strategies and configure Kafka channels with them.</p>
<p>For example, for a custom commit strategy, implement the
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/commit/KafkaCommitHandler.html'>KafkaCommitHandler</a> interface,
and provide a managed bean implementing the <code>KafkaCommitHandler.Factory</code> interface,
identified using <code>@Identifier</code> qualifier.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span>
<span class="normal"><a href="#__codelineno-6-19">19</a></span>
<span class="normal"><a href="#__codelineno-6-20">20</a></span>
<span class="normal"><a href="#__codelineno-6-21">21</a></span>
<span class="normal"><a href="#__codelineno-6-22">22</a></span>
<span class="normal"><a href="#__codelineno-6-23">23</a></span>
<span class="normal"><a href="#__codelineno-6-24">24</a></span>
<span class="normal"><a href="#__codelineno-6-25">25</a></span>
<span class="normal"><a href="#__codelineno-6-26">26</a></span>
<span class="normal"><a href="#__codelineno-6-27">27</a></span>
<span class="normal"><a href="#__codelineno-6-28">28</a></span>
<span class="normal"><a href="#__codelineno-6-29">29</a></span>
<span class="normal"><a href="#__codelineno-6-30">30</a></span>
<span class="normal"><a href="#__codelineno-6-31">31</a></span>
<span class="normal"><a href="#__codelineno-6-32">32</a></span>
<span class="normal"><a href="#__codelineno-6-33">33</a></span>
<span class="normal"><a href="#__codelineno-6-34">34</a></span>
<span class="normal"><a href="#__codelineno-6-35">35</a></span>
<span class="normal"><a href="#__codelineno-6-36">36</a></span>
<span class="normal"><a href="#__codelineno-6-37">37</a></span>
<span class="normal"><a href="#__codelineno-6-38">38</a></span>
<span class="normal"><a href="#__codelineno-6-39">39</a></span>
<span class="normal"><a href="#__codelineno-6-40">40</a></span>
<span class="normal"><a href="#__codelineno-6-41">41</a></span>
<span class="normal"><a href="#__codelineno-6-42">42</a></span>
<span class="normal"><a href="#__codelineno-6-43">43</a></span>
<span class="normal"><a href="#__codelineno-6-44">44</a></span>
<span class="normal"><a href="#__codelineno-6-45">45</a></span>
<span class="normal"><a href="#__codelineno-6-46">46</a></span>
<span class="normal"><a href="#__codelineno-6-47">47</a></span>
<span class="normal"><a href="#__codelineno-6-48">48</a></span>
<span class="normal"><a href="#__codelineno-6-49">49</a></span>
<span class="normal"><a href="#__codelineno-6-50">50</a></span>
<span class="normal"><a href="#__codelineno-6-51">51</a></span>
<span class="normal"><a href="#__codelineno-6-52">52</a></span>
<span class="normal"><a href="#__codelineno-6-53">53</a></span>
<span class="normal"><a href="#__codelineno-6-54">54</a></span>
<span class="normal"><a href="#__codelineno-6-55">55</a></span>
<span class="normal"><a href="#__codelineno-6-56">56</a></span>
<span class="normal"><a href="#__codelineno-6-57">57</a></span>
<span class="normal"><a href="#__codelineno-6-58">58</a></span>
<span class="normal"><a href="#__codelineno-6-59">59</a></span>
<span class="normal"><a href="#__codelineno-6-60">60</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.function.BiConsumer</span><span class="p">;</span>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a>
<a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-6-7" name="__codelineno-6-7"></a>
<a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.TopicPartition</span><span class="p">;</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.IncomingKafkaRecord</span><span class="p">;</span>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConnectorIncomingConfiguration</span><span class="p">;</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumer</span><span class="p">;</span>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.KafkaCommitHandler</span><span class="p">;</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaCustomCommit</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-19" name="__codelineno-6-19"></a>
<a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="w">        </span><span class="c1">// called on message ack</span>
<a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-25" name="__codelineno-6-25"></a>
<a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="nf">received</span><span class="p">(</span><span class="n">IncomingKafkaRecord</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span><span class="w"> </span><span class="n">V</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">        </span><span class="c1">// called before message processing</span>
<a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">item</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-31" name="__codelineno-6-31"></a>
<a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">terminate</span><span class="p">(</span><span class="kt">boolean</span><span class="w"> </span><span class="n">graceful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="c1">// called on channel shutdown</span>
<a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-36" name="__codelineno-6-36"></a>
<a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">partitionsAssigned</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="c1">// called on partitions assignment</span>
<a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-41" name="__codelineno-6-41"></a>
<a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">partitionsRevoked</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="c1">// called on partitions revoked</span>
<a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-46" name="__codelineno-6-46"></a>
<a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;custom&quot;</span><span class="p">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Factory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-50" name="__codelineno-6-50"></a>
<a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">KafkaCommitHandler</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">KafkaConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="w">                </span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span>
<a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">                </span><span class="n">KafkaConsumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">                </span><span class="n">BiConsumer</span><span class="o">&lt;</span><span class="n">Throwable</span><span class="p">,</span><span class="w"> </span><span class="n">Boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="n">reportFailure</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">KafkaCustomCommit</span><span class="p">(</span><span class="cm">/* ... */</span><span class="p">);</span>
<a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-6-59" name="__codelineno-6-59"></a>
<a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Finally, to use the custom commit strategy,
set the <code>commit-strategy</code> attribute to the identifier of the commit handler factory:
<code>mp.messaging.incoming.$channel.commit-strategy=custom</code>.
Similarly, custom failure strategies can be configured using <code>failure-strategy</code> attribute.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the custom strategy implementation inherits
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/commit/ContextHolder.html'>ContextHolder</a> class it can access the
Vert.x event-loop context created for the Kafka consumer</p>
</div>
<h2 id="retrying-processing">Retrying processing</h2>
<p>You can combine Reactive Messaging with <a href="https://github.com/smallrye/smallrye-fault-tolerance">SmallRye Fault
Tolerance</a>, and
retry processing when it fails:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>You can configure the delay, the number of retries, the jitter...</p>
<p>If your method returns a <code>Uni</code>, you need to add the <code>@NonBlocking</code>
annotation:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nd">@Outgoing</span><span class="p">(</span><span class="s">&quot;processed&quot;</span><span class="p">)</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="nd">@NonBlocking</span>
<a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception or the returned Uni produce a failure</span>
<a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The incoming messages are acknowledged only once the processing
completes successfully. So, it commits the offset after the successful
processing. If after the retries the processing still failed, the
message is <em>nacked</em> and the failure strategy is applied.</p>
<p>You can also use <code>@Retry</code> on methods only consuming incoming messages:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;kafka&quot;</span><span class="p">)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nd">@Retry</span><span class="p">(</span><span class="n">delay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">   </span><span class="c1">// ... retry if this method throws an exception</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h2 id="handling-deserialization-failures">Handling deserialization failures</h2>
<p>Because deserialization happens before creating a <code>Message</code>, the failure
strategy presented above cannot be applied. However, when a
deserialization failure occurs, you can intercept it and provide a
fallback value. To achieve this, create a CDI bean implementing the
<a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/api/DeserializationFailureHandler.html'>DeserializationFailureHandler</a>
interface:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span>
<span class="normal"><a href="#__codelineno-10-13">13</a></span>
<span class="normal"><a href="#__codelineno-10-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;failure-retry&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// Set the name of the failure handler</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyDeserializationFailureHandler</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="kd">implements</span><span class="w"> </span><span class="n">DeserializationFailureHandler</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Specify the expected type</span>
<a id="__codelineno-10-5" name="__codelineno-10-5"></a>
<a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">JsonObject</span><span class="w"> </span><span class="nf">decorateDeserialization</span><span class="p">(</span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">JsonObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">deserialization</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isKey</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">deserializer</span><span class="p">,</span><span class="w"> </span><span class="kt">byte</span><span class="o">[]</span><span class="w"> </span><span class="n">data</span><span class="p">,</span>
<a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">            </span><span class="n">Headers</span><span class="w"> </span><span class="n">headers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">deserialization</span>
<a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">                    </span><span class="p">.</span><span class="na">onFailure</span><span class="p">().</span><span class="na">retry</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="w">                    </span><span class="p">.</span><span class="na">await</span><span class="p">().</span><span class="na">atMost</span><span class="p">(</span><span class="n">Duration</span><span class="p">.</span><span class="na">ofMillis</span><span class="p">(</span><span class="mi">200</span><span class="p">));</span>
<a id="__codelineno-10-13" name="__codelineno-10-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-14" name="__codelineno-10-14"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The bean must be exposed with the <code>@Identifier</code> qualifier specifying the
name of the bean. Then, in the connector configuration, specify the
following attribute:</p>
<ul>
<li>
<p><code>mp.messaging.incoming.$channel.key-deserialization-failure-handler</code>:
    name of the bean handling deserialization failures happening for the
    record’s key</p>
</li>
<li>
<p><code>mp.messaging.incoming.$channel.value-deserialization-failure-handler</code>:
    name of the bean handling deserialization failures happening for the
    record’s value,</p>
</li>
</ul>
<p>The handler is called with the deserialization action as a <code>Uni&lt;T&gt;</code>, the
record’s topic, a boolean indicating whether the failure happened on a
key, the class name of the deserializer that throws the exception, the
corrupted data, the exception, and the records headers augmented with
headers describing the failure (which ease the write to a dead letter).
On the deserialization <code>Uni</code> failure strategies like retry, providing a
fallback value or applying timeout can be implemented. Note that the
method must await on the result and return the deserialized object.
Alternatively, the handler can only implement
<code>handleDeserializationFailure</code> method and provide a fallback value,
which may be <code>null</code>.</p>
<p>If you don’t configure a deserialization failure handlers and a
deserialization failure happens, the application is marked unhealthy.
You can also ignore the failure, which will log the exception and
produce a <code>null</code> value. To enable this behavior, set the
<code>mp.messaging.incoming.$channel.fail-on-deserialization-failure</code>
attribute to <code>false</code>.</p>
<p>If the <code>fail-on-deserialization-failure</code> attribute is set to <code>false</code> and
the <code>failure-strategy</code> attribute is <code>dead-letter-queue</code> the failed record
will be sent to the corresponding <em>dead letter queue</em> topic.
The forwarded record will have the original key and value,
and the following headers set:</p>
<ul>
<li><code>deserialization-failure-reason</code>: The deserialization failure message</li>
<li><code>deserialization-failure-cause</code>: The deserialization failure cause if any</li>
<li><code>deserialization-failure-key</code>: Whether the deserialization failure happened on a key</li>
<li><code>deserialization-failure-topic</code>: The topic of the incoming message when a deserialization failure happen</li>
<li><code>deserialization-failure-deserializer</code>: The class name of the underlying deserializer</li>
<li><code>deserialization-failure-key-data</code>: If applicable the key data that was not able to be deserialized</li>
<li><code>deserialization-failure-value-data</code>: If applicable the value data that was not able to be deserialized</li>
</ul>
<h2 id="receiving-cloud-events">Receiving Cloud Events</h2>
<p>The Kafka connector supports <a href="https://cloudevents.io/">Cloud Events</a>.
When the connector detects a <em>structured</em> or <em>binary</em> Cloud Events, it
adds a <a class='docissimo, docissimo-javadoc' href='https://javadoc.io/doc/io.smallrye.reactive/smallrye-reactive-messaging-kafka/4.30.0/io/smallrye/reactive/messaging/kafka/IncomingKafkaCloudEventMetadata.html'>IncomingKafkaCloudEventMetadata</a> in the metadata of the
Message. <code>IncomingKafkaCloudEventMetadata</code> contains the various (mandatory and optional) Cloud Event attributes.</p>
<p>If the connector cannot extract the Cloud Event metadata, it sends the
Message without the metadata.</p>
<h3 id="binary-cloud-events">Binary Cloud Events</h3>
<p>For <code>binary</code> Cloud Events, <strong>all</strong> mandatory Cloud Event attributes must
be set in the record header, prefixed by <code>ce_</code> (as mandated by the
<a href="https://github.com/cloudevents/spec/blob/v1.0/kafka-protocol-binding.md">protocol
binding</a>).
The connector considers headers starting with the <code>ce_</code> prefix but not
listed in the specification as extensions. You can access them using the
<code>getExtension</code> method from <code>IncomingKafkaCloudEventMetadata</code>. You can
retrieve them as <code>String</code>.</p>
<p>The <code>datacontenttype</code> attribute is mapped to the <code>content-type</code> header
of the record. The <code>partitionkey</code> attribute is mapped to the record’s
key, if any.</p>
<p>Note that all headers are read as UTF-8.</p>
<p>With binary Cloud Events, the record’s key and value can use any
deserializer.</p>
<h3 id="structured-cloud-events">Structured Cloud Events</h3>
<p>For <code>structured</code> Cloud Events, the event is encoded in the record’s
value. Only JSON is supported, so your event must be encoded as JSON in
the record’s value.</p>
<p>Structured Cloud Event must set the <code>content-type</code> header of the record
to <code>application/cloudevents</code> or prefix the value with
<code>application/cloudevents</code> such as:
<code>application/cloudevents+json; charset=UTF-8</code>.</p>
<p>To receive structured Cloud Events, your value deserializer must be:</p>
<ul>
<li>
<p><code>org.apache.kafka.common.serialization.StringDeserializer</code></p>
</li>
<li>
<p><code>org.apache.kafka.common.serialization.ByteArrayDeserializer</code></p>
</li>
<li>
<p><code>io.vertx.kafka.client.serialization.JsonObjectDeserializer</code></p>
</li>
</ul>
<p>As mentioned previously, the value must be a valid JSON object
containing at least all the mandatory Cloud Events attributes.</p>
<p>If the record is a structured Cloud Event, the created Message’s payload
is the Cloud Event <code>data</code>.</p>
<p>The <code>partitionkey</code> attribute is mapped to the record’s key if any.</p>
<h2 id="consumer-rebalance-listener">Consumer Rebalance Listener</h2>
<p>To handle offset commit and assigned partitions yourself, you can
provide a consumer rebalance listener. To achieve this, implement the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface, make the implementing class a bean, and add the <code>@Identifier</code>
qualifier. A usual use case is to store offset in a separate data store
to implement exactly-once semantic, or starting the processing at a
specific offset.</p>
<p>The listener is invoked every time the consumer topic/partition
assignment changes. For example, when the application starts, it invokes
the <code>partitionsAssigned</code> callback with the initial set of
topics/partitions associated with the consumer. If, later, this set
changes, it calls the <code>partitionsRevoked</code> and <code>partitionsAssigned</code>
callbacks again, so you can implement custom logic.</p>
<p>Note that the rebalance listener methods are called from the Kafka
<em>polling</em> thread and must block the caller thread until completion.
That’s because the rebalance protocol has synchronization barriers, and
using asynchronous code in a rebalance listener may be executed after
the synchronization barrier.</p>
<p>When topics/partitions are assigned or revoked from a consumer, it
pauses the message delivery and restarts once the rebalance completes.</p>
<p>If the rebalance listener handles offset commit on behalf of the user
(using the <code>ignore</code> commit strategy), the rebalance listener <strong>must</strong>
commit the offset synchronously in the <code>partitionsRevoked</code> callback. We
also recommend applying the same logic when the application stops.</p>
<p>Unlike the <code>ConsumerRebalanceListener</code> from Apache Kafka, the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
methods pass the Kafka <code>Consumer</code> and the set of topics/partitions.</p>
<h3 id="example_1">Example</h3>
<p>In this example we set-up a consumer that always starts on messages from
at most 10 minutes ago (or offset 0). First we need to provide a bean
that implements the
<code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>
interface and is annotated with <code>@Identifier</code>. We then must configure
our inbound connector to use this named bean.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span>
<span class="normal"><a href="#__codelineno-11-24">24</a></span>
<span class="normal"><a href="#__codelineno-11-25">25</a></span>
<span class="normal"><a href="#__codelineno-11-26">26</a></span>
<span class="normal"><a href="#__codelineno-11-27">27</a></span>
<span class="normal"><a href="#__codelineno-11-28">28</a></span>
<span class="normal"><a href="#__codelineno-11-29">29</a></span>
<span class="normal"><a href="#__codelineno-11-30">30</a></span>
<span class="normal"><a href="#__codelineno-11-31">31</a></span>
<span class="normal"><a href="#__codelineno-11-32">32</a></span>
<span class="normal"><a href="#__codelineno-11-33">33</a></span>
<span class="normal"><a href="#__codelineno-11-34">34</a></span>
<span class="normal"><a href="#__codelineno-11-35">35</a></span>
<span class="normal"><a href="#__codelineno-11-36">36</a></span>
<span class="normal"><a href="#__codelineno-11-37">37</a></span>
<span class="normal"><a href="#__codelineno-11-38">38</a></span>
<span class="normal"><a href="#__codelineno-11-39">39</a></span>
<span class="normal"><a href="#__codelineno-11-40">40</a></span>
<span class="normal"><a href="#__codelineno-11-41">41</a></span>
<span class="normal"><a href="#__codelineno-11-42">42</a></span>
<span class="normal"><a href="#__codelineno-11-43">43</a></span>
<span class="normal"><a href="#__codelineno-11-44">44</a></span>
<span class="normal"><a href="#__codelineno-11-45">45</a></span>
<span class="normal"><a href="#__codelineno-11-46">46</a></span>
<span class="normal"><a href="#__codelineno-11-47">47</a></span>
<span class="normal"><a href="#__codelineno-11-48">48</a></span>
<span class="normal"><a href="#__codelineno-11-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.HashMap</span><span class="p">;</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.logging.Logger</span><span class="p">;</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.Consumer</span><span class="p">;</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.OffsetAndTimestamp</span><span class="p">;</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</span><span class="p">;</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;rebalanced-example.rebalancer&quot;</span><span class="p">)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumerRebalanceListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">KafkaConsumerRebalanceListener</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="n">LOGGER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">getLogger</span><span class="p">(</span><span class="n">KafkaRebalancedConsumerRebalanceListener</span><span class="p">.</span><span class="na">class</span><span class="p">.</span><span class="na">getName</span><span class="p">());</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="cm">     * When receiving a list of partitions will search for the earliest offset within 10 minutes</span>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a><span class="cm">     * and seek the consumer to it.</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a><span class="cm">     *</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a><span class="cm">     * @param consumer underlying consumer</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a><span class="cm">     * @param partitions set of assigned topic partitions</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a><span class="cm">     */</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-11-30" name="__codelineno-11-30"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onPartitionsAssigned</span><span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-11-31" name="__codelineno-11-31"></a><span class="w">            </span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-32" name="__codelineno-11-32"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">System</span><span class="p">.</span><span class="na">currentTimeMillis</span><span class="p">();</span>
<a id="__codelineno-11-33" name="__codelineno-11-33"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">600_000L</span><span class="p">;</span><span class="w"> </span><span class="c1">//10 minute ago</span>
<a id="__codelineno-11-34" name="__codelineno-11-34"></a>
<a id="__codelineno-11-35" name="__codelineno-11-35"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<a id="__codelineno-11-36" name="__codelineno-11-36"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-37" name="__codelineno-11-37"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Assigned &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">partition</span><span class="p">);</span>
<a id="__codelineno-11-38" name="__codelineno-11-38"></a><span class="w">            </span><span class="n">request</span><span class="p">.</span><span class="na">put</span><span class="p">(</span><span class="n">partition</span><span class="p">,</span><span class="w"> </span><span class="n">shouldStartAt</span><span class="p">);</span>
<a id="__codelineno-11-39" name="__codelineno-11-39"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-40" name="__codelineno-11-40"></a><span class="w">        </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">offsets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumer</span>
<a id="__codelineno-11-41" name="__codelineno-11-41"></a><span class="w">                </span><span class="p">.</span><span class="na">offsetsForTimes</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<a id="__codelineno-11-42" name="__codelineno-11-42"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">Map</span><span class="p">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">org</span><span class="p">.</span><span class="na">apache</span><span class="p">.</span><span class="na">kafka</span><span class="p">.</span><span class="na">common</span><span class="p">.</span><span class="na">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">OffsetAndTimestamp</span><span class="o">&gt;</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">offsets</span><span class="p">.</span><span class="na">entrySet</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-43" name="__codelineno-11-43"></a><span class="w">            </span><span class="kt">long</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="mi">0</span><span class="n">L</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getValue</span><span class="p">().</span><span class="na">offset</span><span class="p">();</span>
<a id="__codelineno-11-44" name="__codelineno-11-44"></a><span class="w">            </span><span class="n">LOGGER</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;Seeking position &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; for &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">());</span>
<a id="__codelineno-11-45" name="__codelineno-11-45"></a><span class="w">            </span><span class="n">consumer</span><span class="p">.</span><span class="na">seek</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="na">getKey</span><span class="p">(),</span><span class="w"> </span><span class="n">target</span><span class="p">);</span>
<a id="__codelineno-11-46" name="__codelineno-11-46"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-47" name="__codelineno-11-47"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-48" name="__codelineno-11-48"></a>
<a id="__codelineno-11-49" name="__codelineno-11-49"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span>
<span class="normal"><a href="#__codelineno-12-14">14</a></span>
<span class="normal"><a href="#__codelineno-12-15">15</a></span>
<span class="normal"><a href="#__codelineno-12-16">16</a></span>
<span class="normal"><a href="#__codelineno-12-17">17</a></span>
<span class="normal"><a href="#__codelineno-12-18">18</a></span>
<span class="normal"><a href="#__codelineno-12-19">19</a></span>
<span class="normal"><a href="#__codelineno-12-20">20</a></span>
<span class="normal"><a href="#__codelineno-12-21">21</a></span>
<span class="normal"><a href="#__codelineno-12-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletableFuture</span><span class="p">;</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.concurrent.CompletionStage</span><span class="p">;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Acknowledgment</span><span class="p">;</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Incoming</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.eclipse.microprofile.reactive.messaging.Message</span><span class="p">;</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">KafkaRebalancedConsumer</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>
<a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="w">    </span><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;rebalanced-example&quot;</span><span class="p">)</span>
<a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="nd">@Acknowledgment</span><span class="p">(</span><span class="n">Acknowledgment</span><span class="p">.</span><span class="na">Strategy</span><span class="p">.</span><span class="na">NONE</span><span class="p">)</span>
<a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-18" name="__codelineno-12-18"></a><span class="w">        </span><span class="c1">// We don&#39;t need to ACK messages because in this example we set offset during consumer re-balance</span>
<a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">CompletableFuture</span><span class="p">.</span><span class="na">completedFuture</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-21" name="__codelineno-12-21"></a>
<a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>To configure the inbound connector to use the provided listener we
either set the consumer rebalance listener’s name:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.consumer-rebalance-listener.name=rebalanced-example.rebalancer</code></li>
</ul>
<p>Or have the listener’s name be the same as the group id:</p>
<ul>
<li><code>mp.messaging.incoming.rebalanced-example.group.id=rebalanced-example.rebalancer</code></li>
</ul>
<p>Setting the consumer rebalance listener’s name takes precedence over
using the group id.</p>
<h2 id="receiving-kafka-records-in-batches">Receiving Kafka Records in Batches</h2>
<p>By default, incoming methods receive each Kafka record individually.
Under the hood, Kafka consumer clients poll the broker constantly and
receive records in batches, presented inside the <code>ConsumerRecords</code>
container.</p>
<p>In <strong>batch</strong> mode, your application can receive all the records returned
by the consumer <strong>poll</strong> in one go.</p>
<p>To achieve this you need to set
<code>mp.messaging.incoming.$channel.batch=true</code> <strong>and</strong> specify a compatible
container type to receive all the data:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1">1</a></span>
<span class="normal"><a href="#__codelineno-13-2">2</a></span>
<span class="normal"><a href="#__codelineno-13-3">3</a></span>
<span class="normal"><a href="#__codelineno-13-4">4</a></span>
<span class="normal"><a href="#__codelineno-13-5">5</a></span>
<span class="normal"><a href="#__codelineno-13-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">price</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">prices</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">        </span><span class="c1">// process price</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The incoming method can also receive <code>Message&lt;List&lt;Payload&gt;</code> or <code>ConsumerRecords&lt;Key, Payload&gt;</code> types, They
give access to record details such as offset or timestamp :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span>
<span class="normal"><a href="#__codelineno-14-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consumeMessage</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="n">IncomingKafkaRecordBatchMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">batchMetadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">getMetadata</span><span class="p">(</span><span class="n">IncomingKafkaRecordBatchMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">            </span><span class="p">.</span><span class="na">get</span><span class="p">();</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">batchMetadata</span><span class="p">.</span><span class="na">getRecords</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">partition</span><span class="p">();</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">offset</span><span class="p">();</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">timestamp</span><span class="p">();</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="c1">// ack will commit the latest offsets (per partition) of the batch.</span>
<a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="p">}</span>
<a id="__codelineno-14-13" name="__codelineno-14-13"></a>
<a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumeRecords</span><span class="p">(</span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">partitions</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">records</span><span class="p">(</span><span class="n">partition</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">            </span><span class="c1">//... process messages</span>
<a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Note that the successful processing of the incoming record batch will
commit the latest offsets for each partition received inside the batch.
The configured commit strategy will be applied for these records only.</p>
<p>Conversely, if the processing throws an exception, all messages are
<em>nacked</em>, applying the failure strategy for all the records inside the
batch.</p>
<h3 id="accessing-metadata-of-batch-records">Accessing metadata of batch records</h3>
<p>When receiving records in batch mode, the metadata of each record is accessible through the <code>IncomingKafkaRecordBatchMetadata</code> :</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">consumeRecords</span><span class="p">(</span><span class="n">ConsumerRecords</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">records</span><span class="p">,</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">        </span><span class="n">IncomingKafkaRecordBatchMetadata</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">TopicPartition</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">partitions</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ConsumerRecord</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">records</span><span class="p">.</span><span class="na">records</span><span class="p">(</span><span class="n">partition</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">            </span><span class="n">TracingMetadata</span><span class="w"> </span><span class="n">tracing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata</span><span class="p">.</span><span class="na">getMetadataForRecord</span><span class="p">(</span><span class="n">record</span><span class="p">,</span><span class="w"> </span><span class="n">TracingMetadata</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tracing</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">                </span><span class="n">tracing</span><span class="p">.</span><span class="na">getCurrentContext</span><span class="p">().</span><span class="na">makeCurrent</span><span class="p">();</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">            </span><span class="c1">//... process messages</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>Like in this example, this can be useful to propagate the tracing information of each record.</p>
<h2 id="manual-topic-partition-assignment">Manual topic-partition assignment</h2>
<p>The default behavior of Kafka incoming channels is to subscribe to one or more topics in order to receive records from the Kafka broker.
Channel attributes <code>topic</code> and <code>topics</code> allow specifying topics to subscribe to,
or <code>pattern</code> attribute allows to subscribe to all topics matching a regular expression.
Subscribing to topics allows partitioning consumption of topics by dynamically assigning (rebalancing) partitions between members of a consumer group.</p>
<p>The <code>assign-seek</code> configuration attribute allows manually assigning topic-partitions to a Kafka incoming channel,
and optionally seek to a specified offset in the partition to start consuming records.
If <code>assign-seek</code> is used, the consumer will not be dynamically subscribed to topics,
but instead will statically assign the described partitions.
In manual topic-partition rebalancing doesn't happen and therefore rebalance listeners are never called.</p>
<p>The attribute takes a list of triplets separated by commas: <code>&lt;topic&gt;:&lt;partition&gt;:&lt;offset&gt;</code>.</p>
<p>For example, the following configuration</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="na">mp.messaging.incoming.data.assign-seek</span><span class="o">=</span><span class="s">topic1:0:10, topic2:1:20</span>
</code></pre></div></td></tr></table></div>
<p>assigns the consumer to:
- Partition 0 of topic 'topic1', setting the initial position at offset 10.
- Partition 1 of topic 'topic2', setting the initial position at offset 20.</p>
<p>The topic, partition, and offset in each triplet can have the following variations:
- If the topic is omitted, the configured <code>topic</code> will be used.
- If the offset is omitted, partitions are assigned to the consumer but won't be seeked to offset.
- If offset is 0, it seeks to the beginning of the topic-partition.
- If offset is -1, it seeks to the end of the topic-partition.</p>
<h2 id="stateful-processing-with-checkpointing">Stateful processing with Checkpointing</h2>
<div class="admonition warning">
<p class="admonition-title">Experimental</p>
<p>Checkpointing is experimental, and APIs and features are subject
to change in the future.</p>
</div>
<p>The <code>checkpoint</code> commit strategy allows for a Kafka incoming channel to
manage topic-partition offsets, not by committing on the Kafka broker,
but by persisting consumers' advancement on a
<a href="#implementing-state-stores"><em>state store</em></a>.</p>
<p>In addition to that, if the consumer builds an internal state as
a result of consumed records, the topic-partition offset persisted
to the state store can be associated with a <em>processing state</em>,
saving the local state to the persistent store. When a consumer
restarts or consumer group instances scale, i.e. when new partitions
get assigned to the consumer, the checkpointing works by resuming the
processing from the latest offset and its saved state.</p>
<p>The <code>@Incoming</code> channel consumer code can manipulate the processing
state through the <code>CheckpointMetadata</code> API:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="nd">@Incoming</span><span class="p">(</span><span class="s">&quot;prices&quot;</span><span class="p">)</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">CompletionStage</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">consume</span><span class="p">(</span><span class="n">Message</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="c1">// Get the `CheckpointMetadata` from the incoming message</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="n">CheckpointMetadata</span><span class="o">&lt;</span><span class="n">Double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CheckpointMetadata</span><span class="p">.</span><span class="na">fromMessage</span><span class="p">(</span><span class="n">record</span><span class="p">);</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="c1">// `CheckpointMetadata` allows transforming the processing state</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="c1">// Applies the given function, starting from the value `0.0` when no previous state exists</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="n">checkpoint</span><span class="p">.</span><span class="na">transform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">getPayload</span><span class="p">(),</span><span class="w"> </span><span class="cm">/* persistOnAck */</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="c1">// `persistOnAck` flag set to true, ack will persist the processing state</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">    </span><span class="c1">// associated with the latest offset (per partition).</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="na">ack</span><span class="p">();</span>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The <code>transform</code> method allows applying a transformation function to
the current state, producing a changed state and registering it
locally for checkpointing. By default, the local state is synced
(persisted) to the state store periodically, period specified by
<code>auto.commit.interval.ms</code>, (default: 5000). If <code>persistOnAck</code> flag
is given, the latest state is persisted to the state store eagerly
on message acknowledgment. The <code>setNext</code> method works similarly
directly setting the latest state.</p>
<p>The <code>checkpoint</code> commit strategy tracks when a processing state
is last persisted for each topic-partition. If an outstanding state
change can not be persisted for <code>checkpoint.unsynced-state-max-age.ms</code>
(default: 10000), the channel is marked unhealthy.</p>
<p>Where and how processing states are persisted is decided by the
state store implementation. This can be configured on the incoming
channel using <code>checkpoint.state-store</code> configuration property,
using the state store factory identifier name.
The serialization of state objects depends on the state store
implementation. In order to instruct state stores for serialization
can require configuring the type name of state objects
using <code>checkpoint.state-type</code> property.</p>
<p>In order to keep Smallrye Reactive Messaging free of persistence-related
dependencies, this library includes only a default state store named <code>file</code>.
It is based on Vert.x Filesystem API and stores the processing state
in Json formatted files, in a local directory configured by the
<code>checkpoint.file.state-dir</code> property. State files follow the naming
scheme <code>[consumer-group-id]:[topic]:[partition]</code>.</p>
<h3 id="implementing-state-stores">Implementing State Stores</h3>
<p>State store implementations are required to implement <code>CheckpointStateStore</code>
interface, and provide a managed bean implementing
<code>CheckpointStateStore.Factory</code>, identified with <code>@Identifier</code> bean
qualifier indicating the name of the state-store.
The factory bean identifier indicates the name to configure on
<code>checkpoint.state-store</code> config property.
The factory is discovered as a CDI managed bean and state store is
created once per channel:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span>
<span class="normal"><a href="#__codelineno-18-42">42</a></span>
<span class="normal"><a href="#__codelineno-18-43">43</a></span>
<span class="normal"><a href="#__codelineno-18-44">44</a></span>
<span class="normal"><a href="#__codelineno-18-45">45</a></span>
<span class="normal"><a href="#__codelineno-18-46">46</a></span>
<span class="normal"><a href="#__codelineno-18-47">47</a></span>
<span class="normal"><a href="#__codelineno-18-48">48</a></span>
<span class="normal"><a href="#__codelineno-18-49">49</a></span>
<span class="normal"><a href="#__codelineno-18-50">50</a></span>
<span class="normal"><a href="#__codelineno-18-51">51</a></span>
<span class="normal"><a href="#__codelineno-18-52">52</a></span>
<span class="normal"><a href="#__codelineno-18-53">53</a></span>
<span class="normal"><a href="#__codelineno-18-54">54</a></span>
<span class="normal"><a href="#__codelineno-18-55">55</a></span>
<span class="normal"><a href="#__codelineno-18-56">56</a></span>
<span class="normal"><a href="#__codelineno-18-57">57</a></span>
<span class="normal"><a href="#__codelineno-18-58">58</a></span>
<span class="normal"><a href="#__codelineno-18-59">59</a></span>
<span class="normal"><a href="#__codelineno-18-60">60</a></span>
<span class="normal"><a href="#__codelineno-18-61">61</a></span>
<span class="normal"><a href="#__codelineno-18-62">62</a></span>
<span class="normal"><a href="#__codelineno-18-63">63</a></span>
<span class="normal"><a href="#__codelineno-18-64">64</a></span>
<span class="normal"><a href="#__codelineno-18-65">65</a></span>
<span class="normal"><a href="#__codelineno-18-66">66</a></span>
<span class="normal"><a href="#__codelineno-18-67">67</a></span>
<span class="normal"><a href="#__codelineno-18-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="kn">package</span><span class="w"> </span><span class="nn">kafka.inbound</span><span class="p">;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Collection</span><span class="p">;</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.Map</span><span class="p">;</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="kn">import</span><span class="w"> </span><span class="nn">jakarta.enterprise.context.ApplicationScoped</span><span class="p">;</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.clients.consumer.ConsumerConfig</span><span class="p">;</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="kn">import</span><span class="w"> </span><span class="nn">org.apache.kafka.common.TopicPartition</span><span class="p">;</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.common.annotation.Identifier</span><span class="p">;</span>
<a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.mutiny.Uni</span><span class="p">;</span>
<a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConnectorIncomingConfiguration</span><span class="p">;</span>
<a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.KafkaConsumer</span><span class="p">;</span>
<a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.CheckpointStateStore</span><span class="p">;</span>
<a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.smallrye.reactive.messaging.kafka.commit.ProcessingState</span><span class="p">;</span>
<a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="kn">import</span><span class="w"> </span><span class="nn">io.vertx.mutiny.core.Vertx</span><span class="p">;</span>
<a id="__codelineno-18-18" name="__codelineno-18-18"></a>
<a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyCheckpointStateStore</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-20" name="__codelineno-18-20"></a>
<a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">;</span>
<a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="p">;</span>
<a id="__codelineno-18-23" name="__codelineno-18-23"></a>
<a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MyCheckpointStateStore</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">,</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">consumerGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="p">;</span>
<a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">stateType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stateType</span><span class="p">;</span>
<a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-28" name="__codelineno-18-28"></a>
<a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">    </span><span class="cm">/**</span>
<a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="cm">     * Can be used with</span>
<a id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="cm">     * {@code mp.reactive.messaging.incoming.my-channel.commit-strategy=checkpoint}</span>
<a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="cm">     * {@code mp.reactive.messaging.incoming.my-channel.checkpoint.state-store=my-store}</span>
<a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="cm">     */</span>
<a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">    </span><span class="nd">@ApplicationScoped</span>
<a id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="w">    </span><span class="nd">@Identifier</span><span class="p">(</span><span class="s">&quot;my-store&quot;</span><span class="p">)</span>
<a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Factory</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="p">.</span><span class="na">Factory</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-37" name="__codelineno-18-37"></a>
<a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">        </span><span class="nd">@Override</span>
<a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">        </span><span class="kd">public</span><span class="w"> </span><span class="n">CheckpointStateStore</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="n">KafkaConnectorIncomingConfiguration</span><span class="w"> </span><span class="n">config</span><span class="p">,</span>
<a id="__codelineno-18-40" name="__codelineno-18-40"></a><span class="w">                </span><span class="n">Vertx</span><span class="w"> </span><span class="n">vertx</span><span class="p">,</span>
<a id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="w">                </span><span class="n">KafkaConsumer</span><span class="o">&lt;?</span><span class="p">,</span><span class="w"> </span><span class="o">?&gt;</span><span class="w"> </span><span class="n">consumer</span><span class="p">,</span>
<a id="__codelineno-18-42" name="__codelineno-18-42"></a><span class="w">                </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="n">stateType</span><span class="w"> </span><span class="cm">/* if configured, otherwise null */</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-43" name="__codelineno-18-43"></a><span class="w">            </span><span class="n">String</span><span class="w"> </span><span class="n">consumerGroupId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="w"> </span><span class="n">consumer</span><span class="p">.</span><span class="na">configuration</span><span class="p">().</span><span class="na">get</span><span class="p">(</span><span class="n">ConsumerConfig</span><span class="p">.</span><span class="na">GROUP_ID_CONFIG</span><span class="p">);</span>
<a id="__codelineno-18-44" name="__codelineno-18-44"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MyCheckpointStateStore</span><span class="p">(</span><span class="n">consumerGroupId</span><span class="p">,</span><span class="w"> </span><span class="n">stateType</span><span class="p">);</span>
<a id="__codelineno-18-45" name="__codelineno-18-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-18-46" name="__codelineno-18-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-47" name="__codelineno-18-47"></a>
<a id="__codelineno-18-48" name="__codelineno-18-48"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-18-49" name="__codelineno-18-49"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessingState</span><span class="o">&lt;?&gt;&gt;&gt;</span><span class="w"> </span><span class="n">fetchProcessingState</span><span class="p">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">partitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-50" name="__codelineno-18-50"></a><span class="w">        </span><span class="c1">// Called on Vert.x event loop</span>
<a id="__codelineno-18-51" name="__codelineno-18-51"></a><span class="w">        </span><span class="c1">// Return a Uni completing with the map of topic-partition to processing state</span>
<a id="__codelineno-18-52" name="__codelineno-18-52"></a><span class="w">        </span><span class="c1">// The Uni will be subscribed also on Vert.x event loop</span>
<a id="__codelineno-18-53" name="__codelineno-18-53"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">nullItem</span><span class="p">();</span>
<a id="__codelineno-18-54" name="__codelineno-18-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-55" name="__codelineno-18-55"></a>
<a id="__codelineno-18-56" name="__codelineno-18-56"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-18-57" name="__codelineno-18-57"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Uni</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">persistProcessingState</span><span class="p">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">TopicPartition</span><span class="p">,</span><span class="w"> </span><span class="n">ProcessingState</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-58" name="__codelineno-18-58"></a><span class="w">        </span><span class="c1">// Called on Vert.x event loop</span>
<a id="__codelineno-18-59" name="__codelineno-18-59"></a><span class="w">        </span><span class="c1">// Return a Uni completing with void when the given states are persisted</span>
<a id="__codelineno-18-60" name="__codelineno-18-60"></a><span class="w">        </span><span class="c1">// The Uni will be subscribed also on Vert.x event loop</span>
<a id="__codelineno-18-61" name="__codelineno-18-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">Uni</span><span class="p">.</span><span class="na">createFrom</span><span class="p">().</span><span class="na">voidItem</span><span class="p">();</span>
<a id="__codelineno-18-62" name="__codelineno-18-62"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-63" name="__codelineno-18-63"></a>
<a id="__codelineno-18-64" name="__codelineno-18-64"></a><span class="w">    </span><span class="nd">@Override</span>
<a id="__codelineno-18-65" name="__codelineno-18-65"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">close</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-66" name="__codelineno-18-66"></a><span class="w">        </span><span class="cm">/* Called when channel is closing, no-op by default */</span>
<a id="__codelineno-18-67" name="__codelineno-18-67"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-68" name="__codelineno-18-68"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>The checkpoint commit strategy calls the state store in following events:</p>
<ul>
<li><code>fetchProcessingState</code> : on partitions assigned, to seek the consumer to the latest offset.</li>
<li><code>persistProcessingState</code> on partitions revoked, to persist the state of last processed record.</li>
<li><code>persistProcessingState</code> on message acknowledgement, if a new state is set during the processing and <code>persistOnAck</code> flag is set.</li>
<li><code>persistProcessingState</code> on <code>auto.commit.interval.ms</code> intervals, if a new state is set during processing.</li>
<li><code>persistProcessingState</code> on channel shutdown.</li>
<li><code>close</code> on channel shutdown.</li>
</ul>
<h2 id="configuration-reference">Configuration Reference</h2>
<table>
<thead>
<tr>
<th style="text-align: left;">Attribute (<em>alias</em>)</th>
<th style="text-align: left;">Description</th>
<th style="text-align: center;">Type</th>
<th style="text-align: center;">Mandatory</th>
<th style="text-align: left;">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><em>assign-seek</em></td>
<td style="text-align: left;">Assign partitions and optionally seek to offsets, instead of subscribing to topics. A comma-separating list of triplets in form of <code>&lt;topic&gt;:|&lt;partition&gt;|:&lt;offset&gt;</code> to assign statically to the consumer and seek to the given offsets. Offset <code>0</code> seeks to beginning and offset <code>-1</code> seeks to the end of the topic-partition. If the topic is omitted the configured topic will be used. If the offset is omitted partitions are assigned to the consumer but won't be seeked to offset.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>auto.offset.reset</em></td>
<td style="text-align: left;">What to do when there is no initial offset in Kafka.Accepted values are earliest, latest and none</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>latest</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>batch</em></td>
<td style="text-align: left;">Whether the Kafka records are consumed in batch. The channel injection point must consume a compatible type, such as <code>List&lt;Payload&gt;</code> or <code>KafkaRecordBatch&lt;Payload&gt;</code>.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>bootstrap.servers</em> <em>(kafka.bootstrap.servers)</em></td>
<td style="text-align: left;">A comma-separated list of host:port to use for establishing the initial connection to the Kafka cluster.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>localhost:9092</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>broadcast</em></td>
<td style="text-align: left;">Whether the Kafka records should be dispatched to multiple consumer</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.state-store</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, the name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.StateStore.Factory</code> to specify the state store implementation.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.state-type</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, the fully qualified type name of the state object to persist in the state store. When provided, it can be used by the state store implementation to help persisting the processing state object.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>checkpoint.unsynced-state-max-age.ms</em></td>
<td style="text-align: left;">While using the <code>checkpoint</code> commit-strategy, specify the max age in milliseconds that the processing state must be persisted before the connector is marked as unhealthy. Setting this attribute to 0 disables this monitoring.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>10000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>client-id-prefix</em></td>
<td style="text-align: left;">Prefix for Kafka client <code>client.id</code> attribute. If defined configured or generated <code>client.id</code> will be prefixed with the given value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>cloud-events</em></td>
<td style="text-align: left;">Enables (default) or disables the Cloud Event support. If enabled on an <em>incoming</em> channel, the connector analyzes the incoming records and try to create Cloud Event metadata. If enabled on an <em>outgoing</em>, the connector sends the outgoing messages as Cloud Event if the message includes Cloud Event Metadata.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>commit-strategy</em></td>
<td style="text-align: left;">Specify the commit strategy to apply when a message produced from a record is acknowledged. Values can be <code>latest</code>, <code>ignore</code> or <code>throttled</code>. If <code>enable.auto.commit</code> is true then the default is <code>ignore</code> otherwise it is <code>throttled</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>consumer-rebalance-listener.name</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>. If set, this rebalance listener is applied to the consumer.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.key.serializer</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the key serializer to use. If not set the serializer associated to the key deserializer is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.producer-client-id</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates what client id the generated producer should use. Defaults is <code>kafka-dead-letter-topic-producer-$client-id</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.topic</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates on which topic the record is sent. Defaults is <code>dead-letter-topic-$channel</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>dead-letter-queue.value.serializer</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the value serializer to use. If not set the serializer associated to the value deserializer is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.max-retries</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates the maximum number of retries. If higher than the number of delayed retry topics, last topic is used.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.timeout</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates the global timeout per record.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>120000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>delayed-retry-topic.topics</em></td>
<td style="text-align: left;">When the <code>failure-strategy</code> is set to <code>delayed-retry-topic</code> indicates topics to use. If not set the source channel name is used, with 10, 20 and 50 seconds delayed topics.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>enable.auto.commit</em></td>
<td style="text-align: left;">If enabled, consumer's offset will be periodically committed in the background by the underlying Kafka client, ignoring the actual processing outcome of the records. It is recommended to NOT enable this setting and let Reactive Messaging handles the commit.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>fail-on-deserialization-failure</em></td>
<td style="text-align: left;">When no deserialization failure handler is set and a deserialization failure happens, report the failure and mark the application as unhealthy. If set to <code>false</code> and a deserialization failure happens, a <code>null</code> value is forwarded.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>failure-strategy</em></td>
<td style="text-align: left;">Specify the failure strategy to apply when a message produced from a record is acknowledged negatively (nack). Values can be <code>fail</code> (default), <code>ignore</code>, or <code>dead-letter-queue</code></td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>fail</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>fetch.min.bytes</em></td>
<td style="text-align: left;">The minimum amount of data the server should return for a fetch request. The default setting of 1 byte means that fetch requests are answered as soon as a single byte of data is available or the fetch request times out waiting for data to arrive.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>graceful-shutdown</em></td>
<td style="text-align: left;">Whether or not a graceful shutdown should be attempted when the application terminates.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>group.id</em></td>
<td style="text-align: left;">A unique string that identifies the consumer group the application belongs to. If not set, a unique, generated id is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-enabled</em></td>
<td style="text-align: left;">Whether health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-enabled</em></td>
<td style="text-align: left;">Whether readiness health reporting is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-timeout</em></td>
<td style="text-align: left;"><em>deprecated</em> - During the readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready. Deprecated: Use 'health-topic-verification-timeout' instead.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-readiness-topic-verification</em></td>
<td style="text-align: left;"><em>deprecated</em> - Whether the readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin connection. Deprecated: Use 'health-topic-verification-enabled' instead.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-enabled</em></td>
<td style="text-align: left;">Whether the startup and readiness check should verify that topics exist on the broker. Default to false. Enabling it requires an admin client connection.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-readiness-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the readiness health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-startup-disabled</em></td>
<td style="text-align: left;">Whether the topic verification is disabled for the startup health check.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>health-topic-verification-timeout</em></td>
<td style="text-align: left;">During the startup and readiness health check, the connector connects to the broker and retrieves the list of topics. This attribute specifies the maximum duration (in ms) for the retrieval. If exceeded, the channel is considered not-ready.</td>
<td style="text-align: center;">long</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>kafka-configuration</em></td>
<td style="text-align: left;">Identifier of a CDI bean that provides the default Kafka consumer/producer configuration for this channel. The channel configuration can still override any attribute. The bean must have a type of Map<String, Object> and must use the @io.smallrye.common.annotation.Identifier qualifier to set the identifier.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key-deserialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.DeserializationFailureHandler</code>. If set, deserialization failure happening when deserializing keys are delegated to this handler which may retry or provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>key.deserializer</em></td>
<td style="text-align: left;">The deserializer classname used to deserialize the record's key</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>org.apache.kafka.common.serialization.StringDeserializer</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>lazy-client</em></td>
<td style="text-align: left;">Whether Kafka client is created lazily or eagerly.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>max-queue-size-factor</em></td>
<td style="text-align: left;">Multiplier factor to determine maximum number of records queued for processing, using <code>max.poll.records</code> * <code>max-queue-size-factor</code>. Defaults to 2. In <code>batch</code> mode <code>max.poll.records</code> is considered <code>1</code>.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>2</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>partitions</em></td>
<td style="text-align: left;">The number of partitions to be consumed concurrently. The connector creates the specified amount of Kafka consumers. It should match the number of partition of the targeted topic</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>pattern</em></td>
<td style="text-align: left;">Indicate that the <code>topic</code> property is a regular expression. Must be used with the <code>topic</code> property. Cannot be used with the <code>topics</code> property</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>pause-if-no-requests</em></td>
<td style="text-align: left;">Whether the polling must be paused when the application does not request items and resume when it does. This allows implementing back-pressure based on the application capacity. Note that polling is not stopped, but will not retrieve any records when paused.</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>poll-timeout</em></td>
<td style="text-align: left;">The polling timeout in milliseconds. When polling records, the poll will wait at most that duration before returning records. Default is 1000ms</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>1000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>requests</em></td>
<td style="text-align: left;">When <code>partitions</code> is greater than 1, this attribute allows configuring how many records are requested by each consumers every time.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>128</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry</em></td>
<td style="text-align: left;">Whether or not the connection to the broker is re-attempted in case of failure</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry-attempts</em></td>
<td style="text-align: left;">The maximum number of reconnection before failing. -1 means infinite retry</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>-1</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>retry-max-wait</em></td>
<td style="text-align: left;">The max delay (in seconds) between 2 reconnects</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>30</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>throttled.unprocessed-record-max-age.ms</em></td>
<td style="text-align: left;">While using the <code>throttled</code> commit-strategy, specify the max age in milliseconds that an unprocessed message can be before the connector is marked as unhealthy. Setting this attribute to 0 disables this monitoring.</td>
<td style="text-align: center;">int</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>60000</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>topic</em></td>
<td style="text-align: left;">The consumed / populated Kafka topic. If neither this property nor the <code>topics</code> properties are set, the channel name is used</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>topics</em></td>
<td style="text-align: left;">A comma-separating list of topics to be consumed. Cannot be used with the <code>topic</code> or <code>pattern</code> properties</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>tracing-enabled</em></td>
<td style="text-align: left;">Whether tracing is enabled (default) or disabled</td>
<td style="text-align: center;">boolean</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"><code>true</code></td>
</tr>
<tr>
<td style="text-align: left;"><em>value-deserialization-failure-handler</em></td>
<td style="text-align: left;">The name set in <code>@Identifier</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.DeserializationFailureHandler</code>. If set, deserialization failure happening when deserializing values are delegated to this handler which may retry or provide a fallback value.</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">false</td>
<td style="text-align: left;"></td>
</tr>
<tr>
<td style="text-align: left;"><em>value.deserializer</em></td>
<td style="text-align: left;">The deserializer classname used to deserialize the record's value</td>
<td style="text-align: center;">string</td>
<td style="text-align: center;">true</td>
<td style="text-align: left;"></td>
</tr>
</tbody>
</table>
<p>You can also pass any property supported by the underlying <a href="https://kafka.apache.org/documentation/#consumerconfigs">Kafka
consumer</a>.</p>
<p>For example, to configure the <code>max.poll.records</code> property, use:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="na">mp.messaging.incoming.[channel].max.poll.records</span><span class="o">=</span><span class="s">1000</span>
</code></pre></div></td></tr></table></div>
<p>Some consumer client properties are configured to sensible default
values:</p>
<p>If not set, <code>reconnect.backoff.max.ms</code> is set to <code>10000</code> to avoid high
load on disconnection.</p>
<p>If not set, <code>key.deserializer</code> is set to
<code>org.apache.kafka.common.serialization.StringDeserializer</code>.</p>
<p>The consumer <code>client.id</code> is configured according to the number of
clients to create using <code>mp.messaging.incoming.[channel].partitions</code>
property.</p>
<ul>
<li>
<p>If a <code>client.id</code> is provided, it is used as-is or suffixed with
    client index if <code>partitions</code> property is set.</p>
</li>
<li>
<p>If a <code>client.id</code> is not provided, it is generated as
    <code>kafka-consumer-[channel][-index]</code>.</p>
</li>
</ul>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Sponsored by <a href="https://www.redhat.com"><img style="vertical-align: middle; height: 2.5em;" alt="Red Hat" src="https://github.com/jbossorg/website/raw/master/docs/img/redhat_reversed.svg"/></a> <br/> <a href="https://creativecommons.org/licenses/by/3.0/">CC by 3.0</a> | <a href="https://www.redhat.com/en/about/privacy-policy">Privacy Policy</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.tracking", "navigation.indexes"], "search": "../../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.81fa17fe.min.js"></script>
      
        <script src="../../js/print-site.js"></script>
      
    
  </body>
</html>